# Flagging logic service

Task: DRV-102

## Steps

1. Review spec sections and current services to confirm inputs/outputs, boundary rules (exact cutoff and thresholds), and notification hooks.
2. Implement checkAndApplyFlag in src/lib/server/services/flagging.ts with threshold evaluation, flag/unflag behavior, re-flagging handling, warning notification, and reward logic precedence.
3. Implement grace-period enforcement and weeklyCap reduction with idempotency and a minimum floor of 1.
4. Add or update tests for cutoff logic, unflag/re-flag behavior, grace period idempotency, weeklyCap floor, and reward precedence.
5. Run relevant tests or scripts if available.

## Acceptance Criteria

- Driver flagged when attendance drops below threshold
- Correct threshold applied based on total shifts (10 is the cutoff)
- Threshold boundary cases documented and tested (exact cutoff and exact threshold)
- flagWarningDate set on first flag
- flagWarningDate reset on re-flagging after unflag
- Driver unflagged when attendance meets or exceeds threshold
- Grace period is 7 days from flagWarningDate
- If still below threshold after grace: weeklyCap reduced by 1
- weeklyCap never reduced below 1
- weeklyCap reduction is idempotent per grace period
- Warning notification sent when flagged
- Flagged drivers excluded from bidding (enforced elsewhere)
- Reward: if 20+ shifts and attendance >= 95%, weeklyCap = 6
- Reward precedence relative to flagging is defined and tested

# Bidding Service Production Audit

Task: DRV-4ue
Scope: `src/lib/server/services/bidding.ts`
Date: 2026-02-10

## Policy Baseline

- Authoritative scoring/mode constants source: `src/lib/config/dispatchPolicy.ts`.
- Runtime scoring implementation source of truth: `calculateBidScoreParts(...)` in `src/lib/config/dispatchPolicy.ts` and `calculateBidScore(...)` in `src/lib/server/services/bidding.ts`.

## Lifecycle Invariants Audited

- Allowed mode progression: `competitive -> instant -> (resolved|closed)` and `emergency -> (resolved|closed)`.
- Forbidden transition: no reverse transition from `instant|emergency` back to `competitive`.
- Resolution idempotency expectation: a window should be resolved/closed exactly once, with a single winner assignment.
- Assignment invariant: one non-cancelled assignment per driver per date.

## Severity Rubric

- `critical`: can create incorrect production state with direct dispatch impact (wrong winner, duplicate active windows, broken assignment integrity).
- `high`: likely to cause fairness/integrity defects under realistic concurrency or lifecycle conditions.
- `medium`: degrades reliability/observability or causes incorrect API/UI representation without immediate dispatch corruption.
- `low`: clarity/maintainability gaps with limited immediate runtime impact.

## Per-Criterion Evidence Table

| Criterion                                                  | Code Path(s)                                                                                                                                                                                                                                                                   | Method                                           | Finding                                                                                                                                                                                                                                                                                                                          | Severity | Confidence      | Recommended fix                                                                                                                                      |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------ | ------------------------------- |
| Race conditions in competitive resolution                  | `src/lib/server/services/bidding.ts:409`, `src/lib/server/services/bidding.ts:547`, `src/routes/api/dashboard/+server.ts:51`, `src/routes/api/bids/available/+server.ts:30`, `src/routes/api/bid-windows/+server.ts:66`, `src/routes/api/cron/close-bid-windows/+server.ts:51` | Static control-flow + concurrency surface review | **Non-idempotent resolver race**: multiple endpoints invoke `resolveBidWindow(...)`; resolver reads `status=open` before transaction and does not lock the `bid_windows` row or perform conditional state transition (`...WHERE status='open' RETURNING`). Concurrent calls can both proceed and overwrite winner/notifications. | critical | confirmed       | Lock row in `resolveBidWindow` (`FOR UPDATE`) and gate transition by status in one atomic update; if 0 rows updated, return `not_open` immediately.  |
| Transaction safety (window creation)                       | `src/lib/server/services/bidding.ts:185`, `src/lib/server/services/bidding.ts:232`, `src/lib/server/db/schema.ts:230`                                                                                                                                                          | Query/constraint audit                           | **Duplicate-open-window race**: "check then insert" for open window is not atomic and schema has no unique open-window constraint. Concurrent creators can open multiple active windows for one assignment.                                                                                                                      | critical | confirmed       | Add DB-level protection (partial unique index on open windows) and handle conflict in create path (`ON CONFLICT`/retry-safe return).                 |
| Mode transition correctness                                | `src/lib/server/services/bidding.ts:459`, `src/lib/server/services/bidding.ts:470`, `src/lib/server/services/bidding.ts:520`, `src/lib/server/services/bidding.ts:724`                                                                                                         | Transition-path audit                            | Competitive no-bid and all-conflicted paths correctly transition to instant; instant/emergency no-bid paths close. No reverse transition exists in current service flow.                                                                                                                                                         | low      | confirmed       | Keep current flow; add regression tests for all-conflicted transition and post-transition close behavior.                                            |
| Scoring vs policy weights                                  | `src/lib/server/services/bidding.ts:366`, `src/lib/server/services/bidding.ts:391`, `src/lib/config/dispatchPolicy.ts:26`, `src/lib/config/dispatchPolicy.ts:114`                                                                                                              | Formula traceability                             | Scoring implementation matches configured policy weights and normalization caps; score composition is centralized in `calculateBidScoreParts`.                                                                                                                                                                                   | low      | confirmed       | Preserve centralization; add a golden test that asserts score parts against policy constants.                                                        |
| Edge case: no bids/single bid/tied scores                  | `src/lib/server/services/bidding.ts:456`, `src/lib/server/services/bidding.ts:493`, `src/lib/server/services/bidding.ts:497`                                                                                                                                                   | Branch analysis                                  | No-bids and single-bid paths are handled. Tie break is earliest `bidAt`, but equal timestamp ties depend on incoming row order (no secondary deterministic key), which can be unstable under exact-time ties.                                                                                                                    | medium   | probable        | Add deterministic tertiary key (for example `bid.id`) and enforce ordered pending-bid query.                                                         |
| Edge case: self-bid on dropped shift + lifecycle integrity | `src/lib/server/services/bidding.ts:212`, `src/lib/server/services/scheduling.ts:347`, `src/routes/api/assignments/[id]/cancel/+server.ts:137`, `src/routes/api/cron/auto-drop-unconfirmed/+server.ts:99`                                                                      | Cross-service invariant check                    | `createBidWindow(...)` changes assignment status to `unfilled` but does not clear `userId`; weekly-cap checks count non-cancelled assignments by `userId`, so dropped/cancelled driver can remain counted as assigned during bidding window lifecycle.                                                                           | high     | confirmed       | When moving assignment to `unfilled`, clear `userId` atomically in the same update; add regression tests for auto-drop/cancel eligibility outcomes.  |
| Transaction safety (one-shift-per-day)                     | `src/lib/server/services/bidding.ts:500`, `src/lib/server/services/bidding.ts:780`, `src/lib/server/db/schema.ts:165`                                                                                                                                                          | Invariant enforcement review                     | Same-day conflict checks occur in application queries, but no DB uniqueness constraint prevents concurrent dual assignment on same date for same driver. Competing instant/resolution transactions can pass checks concurrently.                                                                                                 | high     | high-confidence | Add DB constraint for non-cancelled (`userId`, `date`) uniqueness (partial index) and handle constraint violation with deterministic loser fallback. |
| Error handling and logging coverage                        | `src/lib/server/services/bidding.ts:610`, `src/lib/server/services/bidding.ts:617`, `src/lib/server/services/bidding.ts:623`, `src/lib/server/services/bidding.ts:629`, `src/lib/server/services/bidding.ts:636`                                                               | Side-effect failure-path review                  | Post-commit side effects in `resolveBidWindow` (notifications/broadcasts) are not isolated; failures throw after DB commit and surface as resolution errors, producing false-negative operational signals.                                                                                                                       | medium   | confirmed       | Wrap notification/broadcast side effects in best-effort `try/catch` with structured logs; keep DB resolution result authoritative.                   |
| API status fidelity                                        | `src/lib/server/services/bidding.ts:962`                                                                                                                                                                                                                                       | Return-shape audit                               | `getBidWindowDetail` maps any non-open status to `resolved`, so `closed` windows are misreported.                                                                                                                                                                                                                                | medium   | confirmed       | Return exact enum (`open                                                                                                                             | closed | resolved`) from detail payload. |

## Prioritized Must-Fix-Before-Production (Confirmed / High-Confidence)

1. **[critical] Make bid-window creation race-safe**
   - Add DB-level uniqueness for open windows and update `createBidWindow` to be atomic/retry-safe.

2. **[critical] Make `resolveBidWindow` single-winner idempotent under concurrency**
   - Lock/gate by status transition in one atomic step; do not allow two resolvers to proceed.

3. **[high] Enforce one-shift-per-driver-per-date at DB level**
   - Add partial uniqueness and handle conflict outcomes deterministically for instant/competitive paths.

4. **[high] Clear stale `assignment.userId` when transitioning to `unfilled` in bidding lifecycle**
   - Prevent weekly-cap and eligibility distortion after cancellation/auto-drop/no-show.

5. **[medium] Isolate post-commit side-effect failures in `resolveBidWindow`**
   - Notifications/broadcast failures should not invalidate successful DB resolution.

6. **[medium] Fix `getBidWindowDetail` status mapping for `closed` windows**
   - Prevent manager/UI misrepresentation of unresolved-but-closed outcomes.

## Notes

- Documentation mismatch exists between legacy bidding formula in `documentation/adr/002-replacement-bidding-system.md` / `documentation/specs/SPEC.md` and runtime scoring policy in `src/lib/config/dispatchPolicy.ts`; this is documentation drift, not runtime formula drift.

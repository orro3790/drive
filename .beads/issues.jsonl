{"id":"DRV-102","title":"Flagging logic service","description":"Source: docs/specs/SPEC.md § Performance \u0026 Flagging\nSchema: docs/specs/data-model.md § users table (isFlagged, flagWarningDate)\n\n## Objective\nImplement the driver flagging logic based on attendance thresholds.\n\n## Scope\n- Service function: checkAndApplyFlag(userId: string)\n- Flag thresholds per spec:\n  - Before 10 shifts: flag if attendance \u003c 80%\n  - After 10 shifts: flag if attendance \u003c 70%\n- Flag consequences:\n  1. Set isFlagged = true\n  2. Set flagWarningDate = now (starts 1-week grace period)\n  3. Send warning notification to driver\n- Grace period logic:\n  - If flagged AND flagWarningDate + 7 days has passed AND still below threshold:\n  - Reduce weeklyCap by 1 (minimum 1)\n\n## Spec References\n- docs/specs/SPEC.md: Lines 195-200 (Flag thresholds table)\n- docs/specs/SPEC.md: Lines 202-211 (Flag consequences)\n- docs/specs/SPEC.md: Lines 213-215 (Reward threshold)\n- docs/specs/SPEC.md: Line 277 (warning notification)\n\n## Acceptance Criteria\n- Driver flagged when attendance drops below threshold\n- Correct threshold applied based on total shifts (10 is the cutoff)\n- flagWarningDate set on first flag\n- Grace period is 7 days from flagWarningDate\n- If still below threshold after grace: weeklyCap reduced by 1\n- weeklyCap never reduced below 1\n- Warning notification sent when flagged\n- Flagged drivers excluded from bidding (enforced elsewhere)\n- Reward: if 20+ shifts and attendance \u003e= 95%, weeklyCap = 6\n\n## Technical Constraints\n- Service in src/lib/server/services/flagging.ts\n- Called by daily performance check cron\n- Must handle re-flagging (driver improves, gets unflagged, drops again)\n- Reward logic also lives here","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:27:53.6740903+09:00","created_by":"Matt","updated_at":"2026-02-02T21:27:53.6740903+09:00","dependencies":[{"issue_id":"DRV-102","depends_on_id":"DRV-8v4","type":"blocks","created_at":"2026-02-02T21:27:53.6865842+09:00","created_by":"Matt"}]}
{"id":"DRV-11x","title":"Driver management (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § users, driverMetrics tables\n\n## Objective\nImplement driver management for managers: view drivers, metrics, flag status, adjust caps.\n\n## Scope\n- API endpoints:\n  - GET /api/drivers - List all drivers with metrics\n  - PATCH /api/drivers/[id] - Update driver (weeklyCap, unflag)\n  - POST /api/drivers/[id]/unflag - Remove flag from driver\n- UI page at src/routes/(manager)/drivers/+page.svelte\n- Display: name, email, phone, attendance rate, completion rate, weekly cap, flag status\n- Actions: adjust weekly cap (1-6), unflag driver\n\n## Spec References\n- docs/specs/SPEC.md: Line 246 (Manager drivers route)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps table)\n- docs/specs/SPEC.md: Lines 202-211 (Flag consequences)\n- docs/specs/SPEC.md: Lines 255-256 (Unflag and adjust cap capabilities)\n- docs/specs/data-model.md: Lines 46-59 (users table)\n- docs/specs/data-model.md: Lines 143-150 (driverMetrics table)\n\n## Acceptance Criteria\n- Manager can view all users with role='driver'\n- Drivers display with their metrics (attendance_rate, completion_rate)\n- Flag status clearly visible (flagged/not flagged, warning date if set)\n- Manager can adjust weekly cap between 1-6\n- Manager can unflag a driver (sets isFlagged=false, clears flagWarningDate)\n- Phone numbers visible to manager only\n- All changes logged to auditLogs\n\n## Technical Constraints\n- Join users with driverMetrics for display\n- Only show drivers (role='driver'), not managers\n- Audit log unflag actions with actor_id","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:23:40.0831106+09:00","created_by":"Matt","updated_at":"2026-02-02T21:23:40.0831106+09:00","dependencies":[{"issue_id":"DRV-11x","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:23:40.092006+09:00","created_by":"Matt"}]}
{"id":"DRV-20m","title":"SSE real-time updates for manager","description":"Source: docs/specs/SPEC.md § Real-Time Updates (SSE)\n\n## Objective\nImplement Server-Sent Events endpoint for real-time manager dashboard updates.\n\n## Scope\n- SSE endpoint at src/routes/api/sse/manager/+server.ts\n- Events to push:\n  - assignment:updated (status changes)\n  - bid_window:opened (new bid window)\n  - bid_window:closed (bid resolved)\n  - driver:flagged (driver flagged)\n- Client-side: connect on manager dashboard load, update UI on events\n- Connection handling: 30-second heartbeat, auto-reconnect\n\n## Spec References\n- docs/specs/SPEC.md: Lines 319-340 (Real-Time Updates section)\n- docs/specs/SPEC.md: Lines 35 (SSE in tech stack)\n\n## Acceptance Criteria\n- SSE endpoint returns text/event-stream content type\n- Only authenticated managers can connect\n- Events sent when assignments/bids/flags change\n- Heartbeat every 30 seconds (\":keepalive\" comment)\n- Client auto-reconnects on disconnect\n- Dashboard tables update without page refresh\n- Multiple manager connections supported\n\n## Technical Constraints\n- SvelteKit streaming response pattern\n- Store active connections (Map or Set)\n- Broadcast function called from other services when data changes\n- Manager role check on connection\n- Proper cleanup on disconnect","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:30:33.4530988+09:00","created_by":"Matt","updated_at":"2026-02-02T21:30:33.4530988+09:00","dependencies":[{"issue_id":"DRV-20m","depends_on_id":"DRV-zxp","type":"blocks","created_at":"2026-02-02T21:30:33.4588779+09:00","created_by":"Matt"}]}
{"id":"DRV-36d","title":"Better Auth integration","description":"Source: docs/specs/SPEC.md § Tech Stack, § Security\nPatterns: docs/agent-guidelines.md § Auth Guards\n\n## Objective\nComplete Better Auth integration with session-based authentication, role enforcement, and invite code signup gate.\n\n## Scope\n- Configure Better Auth in src/lib/server/auth.ts (partially exists)\n- Implement auth guards in src/hooks.server.ts\n- Create sign-in page at src/routes/(auth)/sign-in/+page.svelte\n- Create sign-up page at src/routes/(auth)/sign-up/+page.svelte\n- Implement invite code validation for driver signup (env: BETTER_AUTH_INVITE_CODE)\n- Set up auth client in src/lib/auth-client.ts\n\n## Spec References\n- docs/specs/SPEC.md: Lines 31 (Better Auth in tech stack)\n- docs/specs/SPEC.md: Lines 344-351 (Security requirements)\n- docs/agent-guidelines.md: Lines 240-278 (Auth guards pattern)\n- CLAUDE.md: § Better Auth Implementation (URL auto-detection)\n\n## Acceptance Criteria\n- Users can sign up with email/password (drivers require invite code)\n- Users can sign in and receive session cookie\n- Protected routes redirect to /sign-in if not authenticated\n- API routes return 401 if not authenticated\n- Session available in event.locals.user and event.locals.session\n- Role (driver/manager) accessible from session\n\n## Technical Constraints\n- Use $env/static/private for BETTER_AUTH_SECRET only\n- Use $env/dynamic/private for optional vars (BETTER_AUTH_URL, BETTER_AUTH_INVITE_CODE)\n- Trust origins: localhost:5173 and *.vercel.app","notes":"Fixed auth pages UI to match Snapgrade design system:\n- Added app.css import to root layout (was missing entirely)\n- Removed broken print.css import\n- Simplified auth layout to use design tokens instead of hardcoded hex colors\n- Rewrote InlineEditor component to match Snapgrade's .ie-row container pattern\n- Fixed button sizes from 'large' to 'standard'\n- Auth pages now have proper dark theme with radial gradient, bordered input containers, and accent-colored buttons","status":"closed","priority":0,"issue_type":"task","assignee":"drive","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:22:34.2892226+09:00","created_by":"Matt","updated_at":"2026-02-03T01:40:24.4870924+09:00","closed_at":"2026-02-03T01:40:24.4870924+09:00","close_reason":"Better Auth integration complete. Added auth-schema.ts for Better Auth tables (user, session, account, verification). Sign-up requires invite code via x-invite-code header. Users have role field (default: driver). Protected routes redirect to /sign-in, API routes return 401.","dependencies":[{"issue_id":"DRV-36d","depends_on_id":"DRV-zq5","type":"blocks","created_at":"2026-02-02T21:22:34.309793+09:00","created_by":"Matt"}]}
{"id":"DRV-4w6","title":"Schedule generation algorithm","description":"Source: docs/specs/SPEC.md § Scheduling System \u003e Schedule Generation Algorithm\nADR: docs/adr/003-scheduling-model.md\n\n## Objective\nImplement the automatic schedule generation algorithm that runs at preference lock time.\n\n## Scope\n- Service function: generateWeekSchedule(targetWeekStart: Date)\n- For each day in target week, for each route:\n  1. Find eligible drivers: prefers this day + prefers this route + under weekly cap + not flagged\n  2. Sort by: route familiarity (desc) → completion rate (desc) → attendance rate (desc)\n  3. Assign top driver to route for that day\n  4. If no eligible driver: create assignment with userId=null, status='unfilled'\n- Create Assignment records for all route-day combinations\n- Trigger bid window creation for any unfilled assignments\n\n## Spec References\n- docs/specs/SPEC.md: Lines 86-92 (Schedule generation algorithm)\n- docs/specs/SPEC.md: Lines 94-98 (New driver handling)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps)\n- docs/adr/003-scheduling-model.md: Full decision rationale\n- docs/specs/data-model.md: Lines 92-103 (assignments table)\n\n## Acceptance Criteria\n- Algorithm creates 7 days × N routes = 7N assignment records\n- Drivers only assigned on days they prefer\n- Drivers only assigned to routes they prefer (top 3)\n- Flagged drivers (isFlagged=true) are excluded\n- Weekly cap respected (count existing assignments for that week)\n- Route familiarity determined from routeCompletions table\n- Unfilled assignments created with status='unfilled' and userId=null\n- Assignment.assignedBy = 'algorithm' for all auto-generated\n\n## Technical Constraints\n- Must be idempotent (running twice for same week doesn't duplicate)\n- Check for existing assignments before creating\n- Toronto timezone for all date calculations\n- Service lives in src/lib/server/services/scheduling.ts","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:24:26.5939496+09:00","created_by":"Matt","updated_at":"2026-02-02T21:24:26.5939496+09:00","dependencies":[{"issue_id":"DRV-4w6","depends_on_id":"DRV-5y4","type":"blocks","created_at":"2026-02-02T21:24:26.601433+09:00","created_by":"Matt"}]}
{"id":"DRV-5eo","title":"Bid window closure cron job","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement cron job that runs every minute to close expired bid windows.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/close-bid-windows/+server.ts\n- Vercel Cron schedule: every minute (*/1 * * * *)\n- Job logic:\n  1. Find all bid windows where status='open' AND closesAt \u003c= now\n  2. For windows with bids: call resolveBidWindow()\n  3. For windows without bids: keep open (indefinite per spec)\n  4. Log each resolution\n\n## Spec References\n- docs/specs/SPEC.md: Line 294 (Cron job table entry)\n- docs/specs/SPEC.md: Line 119 (No bids = stays open indefinitely)\n- docs/specs/SPEC.md: Lines 131 (Resolution timing)\n\n## Acceptance Criteria\n- Cron runs every minute\n- Expired windows with bids are resolved\n- Expired windows without bids remain open (status stays 'open')\n- Multiple windows can be processed in single run\n- Job is idempotent\n- Errors on one window don't block others\n- Job execution logged with count of processed windows\n\n## Technical Constraints\n- Query: status='open' AND closesAt \u003c= NOW() AND has at least one bid\n- Process each window independently (try/catch)\n- Verify CRON_SECRET header\n- Keep execution under 60 seconds (Vercel limit)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:26:43.4517426+09:00","created_by":"Matt","updated_at":"2026-02-02T21:26:43.4517426+09:00","dependencies":[{"issue_id":"DRV-5eo","depends_on_id":"DRV-n6q","type":"blocks","created_at":"2026-02-02T21:26:43.4643155+09:00","created_by":"Matt"}]}
{"id":"DRV-5iz","title":"Manager manual assignment","description":"Source: docs/specs/SPEC.md § Bidding System \u003e Manager Override\n\n## Objective\nImplement ability for managers to manually assign drivers to routes, bypassing bidding.\n\n## Scope\n- API endpoint: POST /api/assignments/[id]/assign\n- Request body: { userId: string }\n- UI: button in assignment details panel → modal to select driver\n- Validation:\n  - Target driver not flagged\n  - Target driver under weekly cap\n  - Assignment currently unfilled or in bidding\n\n## Spec References\n- docs/specs/SPEC.md: Lines 155-157 (Manager override)\n- docs/specs/SPEC.md: Line 255 (Manually assign capability)\n- docs/specs/SPEC.md: Lines 19-20 (assignedByEnum includes 'manager')\n\n## Acceptance Criteria\n- Manager can assign any eligible driver to unfilled route\n- If bid window exists, it's closed and marked resolved\n- Assignment.assignedBy set to 'manager'\n- Assignment.assignedAt set to now\n- Driver receives notification of assignment\n- Audit log records manual assignment with manager as actor\n- Cannot assign flagged driver (validation error)\n- Cannot assign driver over weekly cap (validation error)\n\n## Technical Constraints\n- Close existing bid window if any (set status='resolved', no winner)\n- Mark any pending bids as 'lost'\n- Service in src/lib/server/services/assignments.ts","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:30:14.5876283+09:00","created_by":"Matt","updated_at":"2026-02-02T21:30:14.5876283+09:00","dependencies":[{"issue_id":"DRV-5iz","depends_on_id":"DRV-zxp","type":"blocks","created_at":"2026-02-02T21:30:14.6017067+09:00","created_by":"Matt"}]}
{"id":"DRV-5y4","title":"Driver preferences UI","description":"Source: docs/specs/SPEC.md § Scheduling System, § User Interfaces \u003e Driver App\nSchema: docs/specs/data-model.md § driverPreferences table\n\n## Objective\nImplement driver preferences management: select preferred work days and top 3 routes.\n\n## Scope\n- API endpoints:\n  - GET /api/preferences - Get current user's preferences\n  - PUT /api/preferences - Update preferences (if not locked)\n- UI in src/routes/(app)/settings/+page.svelte\n- Preference fields:\n  - preferredDays: checkboxes for Mon-Sun (stored as int[] where Sunday=0)\n  - preferredRoutes: searchable route selector, max 3 routes\n- Display countdown to next lock deadline (Sunday 23:59)\n- Show lock status: can edit if Week N+2 preferences not yet locked\n\n## Spec References\n- docs/specs/SPEC.md: Line 238 (Settings route description)\n- docs/specs/SPEC.md: Lines 79-84 (Preference lock cycle)\n- docs/specs/SPEC.md: Lines 67-75 (Two-week lookahead model)\n- docs/specs/data-model.md: Lines 82-89 (driverPreferences table)\n\n## Acceptance Criteria\n- Driver can select which days they prefer to work (0-7 days)\n- Driver can select up to 3 preferred routes from searchable list\n- Preferences auto-saved on change (optimistic UI)\n- Lock deadline countdown displayed prominently\n- If preferences locked for current cycle, show read-only view with \"locked until\" message\n- New drivers start with empty preferences\n\n## Technical Constraints\n- preferredDays stored as integer array [0-6] where 0=Sunday\n- preferredRoutes stored as UUID array\n- lockedAt timestamp indicates when preferences were frozen\n- Check Week N+2 lock status before allowing edits","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:24:02.7971367+09:00","created_by":"Matt","updated_at":"2026-02-02T21:24:02.7971367+09:00","dependencies":[{"issue_id":"DRV-5y4","depends_on_id":"DRV-b9t","type":"blocks","created_at":"2026-02-02T21:24:02.8031778+09:00","created_by":"Matt"}]}
{"id":"DRV-65d","title":"Shift start and complete flow","description":"Source: docs/specs/SPEC.md § Core Concepts \u003e Entities (Shift)\nSchema: docs/specs/data-model.md § shifts table\n\n## Objective\nImplement the shift lifecycle: start shift with parcel count, complete shift with delivery metrics.\n\n## Scope\n- API endpoints:\n  - POST /api/shifts/start - Start shift (parcel count input)\n  - POST /api/shifts/complete - Complete shift (delivered/returned counts)\n- UI flow in driver dashboard:\n  - If today has assignment and shift not started: show \"Start Shift\" button\n  - Start: prompt for parcels_start count\n  - Active shift: show \"Complete Shift\" button\n  - Complete: prompt for parcels_delivered and parcels_returned\n- Update assignment status through lifecycle: scheduled → active → completed\n\n## Spec References\n- docs/specs/SPEC.md: Lines 51-52 (Shift entity description)\n- docs/specs/SPEC.md: Line 236 (Dashboard shows today's shift)\n- docs/specs/data-model.md: Lines 106-118 (shifts table)\n- docs/specs/data-model.md: Lines 19 (assignmentStatusEnum)\n\n## Acceptance Criteria\n- Driver can start shift only on assignment date\n- Start shift creates Shift record with parcels_start and startedAt\n- Assignment status changes to 'active' on start\n- Driver can complete active shift\n- Complete requires parcels_delivered (parcels_returned optional, default 0)\n- Assignment status changes to 'completed' on complete\n- Shift completedAt timestamp set\n- Cannot start already-started shift\n- Cannot complete already-completed shift\n\n## Technical Constraints\n- Shift has 1:1 relationship with Assignment\n- parcels_delivered + parcels_returned should not exceed parcels_start (warn but allow)\n- All timestamps in Toronto timezone\n- Completion triggers metrics update (separate bead)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:27:08.4004607+09:00","created_by":"Matt","updated_at":"2026-02-02T21:27:08.4004607+09:00","dependencies":[{"issue_id":"DRV-65d","depends_on_id":"DRV-xgp","type":"blocks","created_at":"2026-02-02T21:27:08.4095085+09:00","created_by":"Matt"}]}
{"id":"DRV-69a","title":"Push notification infrastructure","description":"Source: docs/specs/SPEC.md § Notifications \u003e Push Notifications\nConfig: CLAUDE.md § Firebase Configuration\n\n## Objective\nImplement Firebase Cloud Messaging integration for sending push notifications.\n\n## Scope\n- Server-side FCM service using Firebase Admin SDK\n- Service function: sendPushNotification(userId: string, type: NotificationType, data: object)\n- Store FCM tokens per user (add fcmToken column to users or separate table)\n- Notification types per spec:\n  - bid_open, bid_won, bid_lost\n  - shift_reminder, shift_cancelled\n  - warning, urgent_unfilled\n\n## Spec References\n- docs/specs/SPEC.md: Lines 266-278 (Push notification table)\n- docs/specs/SPEC.md: Lines 33 (FCM in tech stack)\n- CLAUDE.md: § Firebase Configuration (Admin SDK vs Web SDK)\n\n## Acceptance Criteria\n- FCM Admin SDK initialized with service account credentials\n- Users can register their FCM token (endpoint: POST /api/users/fcm-token)\n- sendPushNotification sends to user's registered token\n- Notification includes title and body per type\n- Failed sends logged but don't throw (user may have invalid token)\n- Notification also persisted to notifications table for in-app display\n\n## Technical Constraints\n- Use FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, FIREBASE_PRIVATE_KEY from env\n- Service in src/lib/server/services/notifications.ts\n- FCM tokens can change; client re-registers on app open\n- Handle users without FCM token (skip push, still create in-app notification)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:28:34.4265895+09:00","created_by":"Matt","updated_at":"2026-02-02T21:28:34.4265895+09:00","dependencies":[{"issue_id":"DRV-69a","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:28:34.4316178+09:00","created_by":"Matt"}]}
{"id":"DRV-8v4","title":"Metrics calculation service","description":"Source: docs/specs/SPEC.md § Performance \u0026 Flagging \u003e Metrics Tracked\nSchema: docs/specs/data-model.md § driverMetrics, routeCompletions tables\n\n## Objective\nImplement service to recalculate driver metrics after shift completion.\n\n## Scope\n- Service function: updateDriverMetrics(userId: string)\n- Metrics to calculate:\n  - attendance_rate = completed_shifts / total_assigned_shifts\n  - completion_rate = avg(parcels_delivered / parcels_start) across all shifts\n  - totalShifts, completedShifts counts\n- Also update routeCompletions table:\n  - Increment completion_count for the route\n  - Update lastCompletedAt\n\n## Spec References\n- docs/specs/SPEC.md: Lines 187-193 (Metrics tracked table)\n- docs/specs/SPEC.md: Line 141 (Route familiarity normalization)\n- docs/specs/data-model.md: Lines 143-150 (driverMetrics table)\n- docs/specs/data-model.md: Lines 153-160 (routeCompletions table)\n\n## Acceptance Criteria\n- Metrics recalculated after each shift completion\n- attendance_rate: count assignments where shift exists and completedAt set / total assignments\n- completion_rate: average of (parcels_delivered / parcels_start) for all completed shifts\n- Route familiarity incremented for completed route\n- Handles edge cases: zero assignments (rate = 0), zero parcels_start (skip that shift)\n- driverMetrics.updatedAt reflects recalculation time\n\n## Technical Constraints\n- Service in src/lib/server/services/metrics.ts\n- Called automatically after shift completion\n- Must handle division by zero gracefully\n- Consider no-shows: assignment exists but no shift (counts against attendance)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:27:30.5216768+09:00","created_by":"Matt","updated_at":"2026-02-02T21:27:30.5216768+09:00","dependencies":[{"issue_id":"DRV-8v4","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:27:30.5281302+09:00","created_by":"Matt"}]}
{"id":"DRV-9l2","title":"Driver settings page","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\n\n## Objective\nImplement driver settings page with account info and preferences.\n\n## Scope\n- UI page at src/routes/(app)/settings/+page.svelte\n- Sections:\n  1. Account info: name, email, phone (editable)\n  2. Password change\n  3. Preferences (embedded from preferences bead)\n- FCM token registration (for push notifications)\n\n## Spec References\n- docs/specs/SPEC.md: Line 238 (Driver settings route)\n\n## Acceptance Criteria\n- Driver can view and update account info\n- Driver can change password\n- Preferences section integrated (from DRV-5y4)\n- FCM token registered on page load (for push notifications)\n- Form validation and error handling\n\n## Technical Constraints\n- Combine account management with preferences UI\n- Call /api/users/fcm-token on load if token available\n- Use optimistic UI for updates","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:32:29.7662523+09:00","created_by":"Matt","updated_at":"2026-02-02T21:32:29.7662523+09:00","dependencies":[{"issue_id":"DRV-9l2","depends_on_id":"DRV-5y4","type":"blocks","created_at":"2026-02-02T21:32:29.7707295+09:00","created_by":"Matt"},{"issue_id":"DRV-9l2","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:32:29.7780289+09:00","created_by":"Matt"}]}
{"id":"DRV-9y0","title":"App shell and navigation","description":"Source: docs/specs/SPEC.md § User Interfaces\nPatterns: docs/agent-guidelines.md § Project Organization\n\n## Objective\nImplement the app shell with role-based navigation for drivers and managers.\n\n## Scope\n- Layout groups:\n  - src/routes/(auth)/ - Public auth pages (sign-in, sign-up)\n  - src/routes/(app)/ - Protected driver routes with driver sidebar\n  - src/routes/(manager)/ - Protected manager routes with manager sidebar\n- Sidebar navigation using AppSidebar component\n- Driver nav: Dashboard, Schedule, Settings, Notifications\n- Manager nav: Routes, Drivers, Warehouses, Notifications, Settings\n- Role-based redirect: drivers → /dashboard, managers → /routes\n\n## Spec References\n- docs/specs/SPEC.md: Lines 232-249 (User interfaces section)\n- docs/agent-guidelines.md: Lines 10-29 (Project organization)\n- CLAUDE.md: § UI Components (available components)\n\n## Acceptance Criteria\n- Auth pages accessible without login\n- Driver routes protected, redirect to sign-in if not authenticated\n- Manager routes protected, redirect if not authenticated or not manager role\n- Sidebar shows correct navigation items per role\n- Current route highlighted in sidebar\n- Mobile-responsive sidebar (hamburger menu)\n- Logo in sidebar header (placeholder for now)\n\n## Technical Constraints\n- Use existing AppSidebar, SidebarItem, PageHeader components\n- Layout files: +layout.svelte in each route group\n- Server-side role check in +layout.server.ts\n- Use hooks.server.ts for auth middleware","status":"open","priority":0,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:31:16.2025503+09:00","created_by":"Matt","updated_at":"2026-02-02T21:31:16.2025503+09:00","dependencies":[{"issue_id":"DRV-9y0","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:31:16.2089262+09:00","created_by":"Matt"}]}
{"id":"DRV-a1e","title":"Warehouse CRUD (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § warehouses table\n\n## Objective\nImplement warehouse management for managers: list, create, edit, delete warehouses.\n\n## Scope\n- API endpoints:\n  - GET /api/warehouses - List all warehouses\n  - POST /api/warehouses - Create warehouse\n  - PATCH /api/warehouses/[id] - Update warehouse\n  - DELETE /api/warehouses/[id] - Delete warehouse (if no routes attached)\n- UI page at src/routes/(manager)/warehouses/+page.svelte\n- Use DataTable component for listing\n- Use Modal + InlineEditor for create/edit forms\n\n## Spec References\n- docs/specs/SPEC.md: Line 247 (Manager warehouse route)\n- docs/specs/SPEC.md: Line 260 (Edit routes and warehouses capability)\n- docs/specs/data-model.md: Lines 62-69 (warehouses table schema)\n- docs/agent-guidelines.md: § API Endpoint Pattern\n\n## Acceptance Criteria\n- Manager can view list of all warehouses\n- Manager can create new warehouse (name, address required)\n- Manager can edit existing warehouse\n- Manager can delete warehouse only if no routes reference it\n- createdBy field populated with current user ID\n- All changes logged to auditLogs table\n- Non-managers receive 403 on all endpoints\n\n## Technical Constraints\n- Role check: user.role === 'manager'\n- Audit logging for all mutations\n- Optimistic UI updates per agent-guidelines.md § Optimistic UI Pattern","notes":"PR: https://github.com/orro3790/drive/pull/1","status":"closed","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:22:56.2685927+09:00","created_by":"Matt","updated_at":"2026-02-03T02:26:08.0070797+09:00","closed_at":"2026-02-03T02:26:08.0070797+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-a1e","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:22:56.2790534+09:00","created_by":"Matt"}]}
{"id":"DRV-ai2","title":"Manager settings page","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\n\n## Objective\nImplement manager account settings page.\n\n## Scope\n- UI page at src/routes/(manager)/settings/+page.svelte\n- Account info: name, email, phone (editable)\n- Password change functionality\n- No manager-specific system settings for MVP\n\n## Spec References\n- docs/specs/SPEC.md: Line 249 (Manager settings route)\n\n## Acceptance Criteria\n- Manager can view their account info\n- Manager can update name, phone\n- Manager can change password (current password required)\n- Form validation for all fields\n- Success/error toasts on save\n\n## Technical Constraints\n- Reuse form patterns from driver settings if applicable\n- Use Better Auth password change flow","status":"open","priority":3,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:32:11.8754145+09:00","created_by":"Matt","updated_at":"2026-02-02T21:32:11.8754145+09:00","dependencies":[{"issue_id":"DRV-ai2","depends_on_id":"DRV-9y0","type":"blocks","created_at":"2026-02-02T21:32:11.8803998+09:00","created_by":"Matt"}]}
{"id":"DRV-b6o","title":"Create password reset email template","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Create #1)\n\nCreate HTML email template for password reset emails.\n\nFILE TO CREATE: src/lib/server/emails/resetPassword.ts\n\nIMPLEMENTATION:\nExport a const resetPasswordHtml containing an HTML email template string.\nBase structure on Snapgrade pattern: C:\\Users\\matto\\projects\\Snapgrade\\src\\lib\\server\\emails\\resetPassword.ts\n\nTemplate must include these placeholders (use {{ placeholder }} syntax):\n- {{ handlerUrl }} - The password reset URL\n- {{ year }} - Current year for footer  \n- {{ appOrigin }} - App origin URL for footer\n\nKEY CHANGES FROM SNAPGRADE:\n- Replace Snapgrade with Drive in all text\n- Keep same HTML structure and inline styles\n- Keep same placeholder syntax for consistency\n\nACCEPTANCE CRITERIA:\n- File exports resetPasswordHtml const\n- All three placeholders present (handlerUrl, year, appOrigin)\n- HTML is valid and renders correctly in email clients\n- Branding says Drive not Snapgrade","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-03T09:13:30.9335971+09:00","created_by":"Matt","updated_at":"2026-02-03T09:13:30.9335971+09:00"}
{"id":"DRV-b9t","title":"Route CRUD (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § routes table\n\n## Objective\nImplement route management for managers: list, create, edit, delete routes.\n\n## Scope\n- API endpoints:\n  - GET /api/routes - List routes (with warehouse info)\n  - POST /api/routes - Create route\n  - PATCH /api/routes/[id] - Update route\n  - DELETE /api/routes/[id] - Delete route (if no future assignments)\n- UI page at src/routes/(manager)/routes/+page.svelte (this is the manager dashboard home)\n- Filter by warehouse, status (assigned/unfilled), date\n- DataTable with route name, warehouse, current assignment status\n\n## Spec References\n- docs/specs/SPEC.md: Line 245 (Manager routes overview)\n- docs/specs/SPEC.md: Lines 253-260 (Manager capabilities)\n- docs/specs/data-model.md: Lines 72-79 (routes table schema)\n- docs/specs/SPEC.md: Line 49 (Route entity description)\n\n## Acceptance Criteria\n- Manager can view all routes with warehouse association\n- Manager can filter routes by warehouse\n- Manager can create route (name required, warehouse required)\n- Manager can edit route name or reassign to different warehouse\n- Manager can delete route only if no future assignments exist\n- Routes display current day's assignment status (assigned/unfilled/bidding)\n- All changes logged to auditLogs\n\n## Technical Constraints\n- Routes have many-to-one relationship with warehouses\n- Route names should be unique within a warehouse\n- Include warehouse name in route listings via join","notes":"PR: https://github.com/orro3790/drive/pull/2; /verify blocked pending manager credentials","status":"in_progress","priority":1,"issue_type":"task","assignee":"drive","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:23:15.7964204+09:00","created_by":"Matt","updated_at":"2026-02-03T03:37:45.1469299+09:00","dependencies":[{"issue_id":"DRV-b9t","depends_on_id":"DRV-a1e","type":"blocks","created_at":"2026-02-02T21:23:15.8025154+09:00","created_by":"Matt"}]}
{"id":"DRV-e30","title":"Preference lock cron job","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nADR: docs/adr/003-scheduling-model.md\n\n## Objective\nImplement the weekly cron job that locks preferences and triggers schedule generation.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/lock-preferences/+server.ts\n- Vercel Cron schedule: Sunday 23:59 Toronto time\n- Job sequence:\n  1. Set lockedAt timestamp on all driverPreferences for Week N+2\n  2. Call schedule generation algorithm for Week N+2\n  3. Create notifications for all drivers with new assignments\n  4. Log job completion\n\n## Spec References\n- docs/specs/SPEC.md: Lines 79-84 (Preference lock cycle)\n- docs/specs/SPEC.md: Line 293 (Cron job table entry)\n- docs/specs/SPEC.md: Lines 280-285 (In-app notifications)\n\n## Acceptance Criteria\n- Cron runs every Sunday at 23:59 Toronto time\n- All driver preferences have lockedAt set for the target week\n- Schedule generation runs automatically after lock\n- Each driver receives notification about their new assignments\n- Job is idempotent (re-running doesn't duplicate work)\n- Job execution logged for debugging\n\n## Technical Constraints\n- Use Vercel Cron syntax in vercel.json\n- Toronto timezone = America/Toronto\n- Cron endpoint must verify CRON_SECRET header (Vercel provides this)\n- Calculate Week N+2 start date from current time","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:24:46.2827285+09:00","created_by":"Matt","updated_at":"2026-02-02T21:24:46.2827285+09:00","dependencies":[{"issue_id":"DRV-e30","depends_on_id":"DRV-4w6","type":"blocks","created_at":"2026-02-02T21:24:46.288817+09:00","created_by":"Matt"}]}
{"id":"DRV-jnk","title":"Driver dashboard","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\n\n## Objective\nImplement the driver's main dashboard showing today's shift, schedule overview, metrics, and pending bids.\n\n## Scope\n- UI page at src/routes/(app)/+page.svelte\n- Sections:\n  1. Today's shift card (if any): route, warehouse, start/complete buttons\n  2. This week schedule summary\n  3. Next week schedule summary\n  4. Personal metrics: attendance rate, completion rate\n  5. Pending bids: list of open bids with countdown\n- New driver banner: \"Your first scheduled shifts will appear in ~2 weeks\"\n\n## Spec References\n- docs/specs/SPEC.md: Line 236 (Dashboard route description)\n- docs/specs/SPEC.md: Lines 94-98 (New driver handling)\n- docs/specs/SPEC.md: Lines 187-193 (Metrics display)\n\n## Acceptance Criteria\n- Dashboard loads user's assignments, metrics, pending bids\n- Today's shift prominently displayed with action buttons\n- Week summaries show assigned days\n- Metrics displayed as percentages\n- Pending bids show route and time until window closes\n- New drivers (no scheduled shifts) see explanation banner\n- Mobile-first responsive design\n\n## Technical Constraints\n- Aggregate data from assignments, driverMetrics, bids tables\n- Toronto timezone for \"today\" calculation\n- Consider data loading strategy (parallel fetches)\n- Use existing primitives (Chip for status, Card patterns from design system)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:29:34.8954746+09:00","created_by":"Matt","updated_at":"2026-02-02T21:29:34.8954746+09:00","dependencies":[{"issue_id":"DRV-jnk","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:29:34.9005988+09:00","created_by":"Matt"},{"issue_id":"DRV-jnk","depends_on_id":"DRV-vth","type":"blocks","created_at":"2026-02-02T21:29:34.9061025+09:00","created_by":"Matt"}]}
{"id":"DRV-mhl","title":"Service worker for offline caching","description":"Source: docs/specs/SPEC.md § Offline Strategy\n\n## Objective\nImplement service worker for caching schedule and metrics data.\n\n## Scope\n- Service worker registration\n- Cache strategy: stale-while-revalidate for:\n  - GET /api/assignments/mine\n  - GET /api/preferences\n  - GET /api/metrics (driver metrics)\n- Offline detection banner\n- Cache invalidation on connectivity return\n\n## Spec References\n- docs/specs/SPEC.md: Lines 300-315 (Offline strategy section)\n\n## Acceptance Criteria\n- Service worker registered on app load\n- Cached endpoints available offline\n- \"You're offline\" banner when navigator.onLine is false\n- Stale data served immediately, background refresh when online\n- Cache refreshed when connectivity returns\n- Write operations show \"requires connectivity\" message when offline\n\n## Technical Constraints\n- Use SvelteKit service worker patterns (if available) or manual registration\n- Capacitor may provide its own offline handling\n- Consider Workbox for cache management\n- Test on mobile with airplane mode","status":"open","priority":3,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:33:10.7844524+09:00","created_by":"Matt","updated_at":"2026-02-02T21:33:10.7844524+09:00","dependencies":[{"issue_id":"DRV-mhl","depends_on_id":"DRV-jnk","type":"blocks","created_at":"2026-02-02T21:33:10.7923981+09:00","created_by":"Matt"}]}
{"id":"DRV-mzp","title":"In-app notification inbox","description":"Source: docs/specs/SPEC.md § Notifications \u003e In-App Notifications\nSchema: docs/specs/data-model.md § notifications table\n\n## Objective\nImplement the notification inbox for viewing and managing in-app notifications.\n\n## Scope\n- API endpoints:\n  - GET /api/notifications - List user's notifications (paginated)\n  - PATCH /api/notifications/[id]/read - Mark as read\n  - POST /api/notifications/mark-all-read - Mark all as read\n- UI pages:\n  - Driver: src/routes/(app)/notifications/+page.svelte\n  - Manager: src/routes/(manager)/notifications/+page.svelte\n- Display: title, body, timestamp, read status\n- Unread count badge in sidebar navigation\n\n## Spec References\n- docs/specs/SPEC.md: Lines 280-285 (In-app notifications)\n- docs/specs/SPEC.md: Lines 239, 248 (Notification routes for driver/manager)\n- docs/specs/data-model.md: Lines 163-172 (notifications table)\n\n## Acceptance Criteria\n- User sees list of their notifications, newest first\n- Unread notifications visually distinct\n- Clicking notification marks it as read\n- \"Mark all as read\" button clears all unread\n- Sidebar shows unread count badge\n- Pagination for users with many notifications\n- Both drivers and managers have notification inbox\n\n## Technical Constraints\n- Query: userId = current user, ORDER BY createdAt DESC\n- Use index idx_notifications_user_read for performance\n- Unread count query for badge: count where read=false\n- Consider SSE for real-time badge updates (separate bead)","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:28:55.3165707+09:00","created_by":"Matt","updated_at":"2026-02-02T21:28:55.3165707+09:00","dependencies":[{"issue_id":"DRV-mzp","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:28:55.3259423+09:00","created_by":"Matt"}]}
{"id":"DRV-n1y","title":"Daily shift reminder cron","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\n\n## Objective\nImplement daily cron job that sends shift reminders to drivers with assignments today.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/shift-reminders/+server.ts\n- Vercel Cron schedule: daily morning (suggest 06:00 Toronto time)\n- Job logic:\n  1. Get all assignments for today where status='scheduled' and userId is not null\n  2. For each: send push notification (type: shift_reminder)\n  3. Log count of reminders sent\n\n## Spec References\n- docs/specs/SPEC.md: Line 296 (Cron job table entry)\n- docs/specs/SPEC.md: Line 275 (shift_reminder notification type)\n\n## Acceptance Criteria\n- Cron runs daily in morning\n- All drivers with assignments today receive reminder\n- Reminder includes route name and warehouse\n- Only scheduled (not cancelled) assignments get reminders\n- Already-started shifts don't get reminders\n- Job execution logged\n\n## Technical Constraints\n- Toronto timezone for \"today\" calculation\n- Keep under 60 seconds\n- Verify CRON_SECRET header\n- Batch notifications if many drivers","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:29:12.3881497+09:00","created_by":"Matt","updated_at":"2026-02-02T21:29:12.3881497+09:00","dependencies":[{"issue_id":"DRV-n1y","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:29:12.3931617+09:00","created_by":"Matt"}]}
{"id":"DRV-n6q","title":"Bid scoring and resolution","description":"Source: docs/specs/SPEC.md § Bidding System \u003e Scoring Algorithm\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement the bid scoring algorithm and winner selection when bid windows close.\n\n## Scope\n- Service function: resolveBidWindow(bidWindowId: string)\n- Scoring formula per SPEC.md:\n  score = (completion_rate × 0.4) +\n          (route_familiarity_normalized × 0.3) +\n          (attendance_rate × 0.2) +\n          (route_preference_bonus × 0.1)\n- Resolution logic:\n  1. Get all pending bids for window\n  2. Calculate score for each bidder\n  3. Sort by score desc, then bidAt asc (tie-breaker)\n  4. Winner: update bid status='won', assignment.userId, assignment.assignedBy='bid'\n  5. Losers: update bid status='lost'\n  6. Send notifications to winner and losers\n\n## Spec References\n- docs/specs/SPEC.md: Lines 129-146 (Scoring algorithm with formula)\n- docs/specs/SPEC.md: Lines 148-153 (Resolution steps)\n- docs/specs/SPEC.md: Lines 272-274 (bid_won, bid_lost notifications)\n- docs/adr/002-replacement-bidding-system.md: Scoring weights rationale\n- docs/specs/data-model.md: Lines 278-314 (calculateBidScore query)\n\n## Acceptance Criteria\n- Scores calculated correctly per formula\n- Highest score wins\n- Ties broken by earliest bid timestamp\n- Winner's bid marked 'won', others marked 'lost'\n- Assignment updated with winner's userId\n- Assignment.assignedBy set to 'bid'\n- Winner receives push notification \"You won [Route] for [Date]\"\n- Losers receive push notification \"[Route] assigned to another driver\"\n- BidWindow status set to 'resolved', winnerId set\n\n## Technical Constraints\n- route_familiarity_normalized = min(completions / 20, 1)\n- route_preference_bonus = 1.0 if route in preferredRoutes, else 0\n- All rates are 0-1 scale\n- Handle edge case: no bids when window closes (window stays open per spec)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:26:21.6920733+09:00","created_by":"Matt","updated_at":"2026-02-02T21:26:21.6920733+09:00","dependencies":[{"issue_id":"DRV-n6q","depends_on_id":"DRV-vth","type":"blocks","created_at":"2026-02-02T21:26:21.6979426+09:00","created_by":"Matt"}]}
{"id":"DRV-obx","title":"Bid window creation service","description":"Source: docs/specs/SPEC.md § Bidding System\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement service to create bid windows when assignments become unfilled.\n\n## Scope\n- Service function: createBidWindow(assignmentId: string)\n- Triggers:\n  - Driver cancels assignment\n  - No-show detected\n  - Schedule generation creates unfilled assignment\n- Window duration logic:\n  - If shift \u003e 30 min away: closesAt = now + 30 minutes\n  - If shift ≤ 30 min away: closesAt = shift date start time\n  - If shift already passed: no window created\n- Send push notification to eligible drivers\n\n## Spec References\n- docs/specs/SPEC.md: Lines 106-111 (Bid window triggers)\n- docs/specs/SPEC.md: Lines 113-119 (Bid window duration table)\n- docs/specs/SPEC.md: Lines 121-127 (Notification rules)\n- docs/adr/002-replacement-bidding-system.md: Window mechanics rationale\n- docs/specs/data-model.md: Lines 133-140 (bidWindows table)\n\n## Acceptance Criteria\n- Bid window created with correct closesAt based on time until shift\n- Assignment status updated to 'unfilled' if not already\n- BidWindow record created with status='open'\n- Push notification sent to all eligible drivers (under cap, not flagged)\n- Notification includes route name, date, window close time\n- No duplicate windows for same assignment\n\n## Technical Constraints\n- Service in src/lib/server/services/bidding.ts\n- Calculate time difference in Toronto timezone\n- \"30 minutes away\" means assignment.date as datetime vs now\n- Eligible drivers query: role='driver' AND isFlagged=false AND under weekly cap","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:25:33.8924132+09:00","created_by":"Matt","updated_at":"2026-02-02T21:25:33.8924132+09:00","dependencies":[{"issue_id":"DRV-obx","depends_on_id":"DRV-xgp","type":"blocks","created_at":"2026-02-02T21:25:33.8980793+09:00","created_by":"Matt"}]}
{"id":"DRV-qen","title":"Daily performance check cron","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nDependencies: Metrics service, Flagging service\n\n## Objective\nImplement daily cron job that recalculates metrics and applies flagging logic.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/performance-check/+server.ts\n- Vercel Cron schedule: daily (suggest 02:00 Toronto time, after day's shifts complete)\n- Job logic:\n  1. Get all drivers (role='driver')\n  2. For each driver: call updateDriverMetrics()\n  3. For each driver: call checkAndApplyFlag()\n  4. Log summary: drivers checked, newly flagged, caps reduced, rewards granted\n\n## Spec References\n- docs/specs/SPEC.md: Line 295 (Cron job table entry)\n- docs/specs/SPEC.md: Lines 185-215 (Performance \u0026 Flagging section)\n\n## Acceptance Criteria\n- Cron runs daily at configured time\n- All driver metrics recalculated\n- Flag logic applied to all drivers\n- Reward logic applied (20+ shifts, 95%+ attendance → cap = 6)\n- Job execution logged with statistics\n- Errors on one driver don't block others\n\n## Technical Constraints\n- Process drivers in batches to avoid timeout\n- Keep under 60 seconds (Vercel Cron limit)\n- Verify CRON_SECRET header\n- Consider running after midnight Toronto time","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:28:13.1944573+09:00","created_by":"Matt","updated_at":"2026-02-02T21:28:13.1944573+09:00","dependencies":[{"issue_id":"DRV-qen","depends_on_id":"DRV-102","type":"blocks","created_at":"2026-02-02T21:28:13.1989474+09:00","created_by":"Matt"}]}
{"id":"DRV-vha","title":"Audit logging service","description":"Source: docs/specs/SPEC.md § Security\nSchema: docs/specs/data-model.md § auditLogs table\n\n## Objective\nImplement centralized audit logging service for tracking all data changes.\n\n## Scope\n- Service function: createAuditLog(params)\n- Parameters:\n  - entityType: 'assignment' | 'user' | 'route' | 'warehouse' | etc.\n  - entityId: UUID of affected entity\n  - action: 'created' | 'updated' | 'assigned' | 'cancelled' | 'flagged' | etc.\n  - actorId: UUID of user who made change (null for system)\n  - actorType: 'user' | 'system'\n  - changes: { before: {...}, after: {...} }\n- Integrate into all mutation endpoints/services\n\n## Spec References\n- docs/specs/SPEC.md: Lines 347-350 (Audit logging requirements)\n- docs/specs/data-model.md: Lines 175-184 (auditLogs table)\n- docs/specs/data-model.md: Line 43 (actorTypeEnum)\n\n## Acceptance Criteria\n- All assignment changes logged (create, cancel, assign, complete)\n- All flag/unflag actions logged\n- All manager overrides logged with manager as actor\n- System actions (cron jobs) logged with actorType='system'\n- Changes include before/after state for updates\n- Logs queryable by entity for debugging\n- High-volume operations (bid scoring) may batch or skip detailed logging\n\n## Technical Constraints\n- Service in src/lib/server/services/audit.ts\n- Use jsonb for changes field\n- Index on entityType, entityId for queries\n- Called from within transaction when possible","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:31:36.3101416+09:00","created_by":"Matt","updated_at":"2026-02-02T21:31:36.3101416+09:00","dependencies":[{"issue_id":"DRV-vha","depends_on_id":"DRV-zq5","type":"blocks","created_at":"2026-02-02T21:31:36.3170743+09:00","created_by":"Matt"}]}
{"id":"DRV-vhg","title":"Vercel cron configuration","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\n\n## Objective\nConfigure Vercel Cron schedules in vercel.json for all scheduled jobs.\n\n## Scope\n- Create/update vercel.json with cron configuration\n- Cron jobs:\n  - /api/cron/lock-preferences: Sunday 23:59 Toronto\n  - /api/cron/close-bid-windows: Every minute\n  - /api/cron/performance-check: Daily 02:00 Toronto\n  - /api/cron/shift-reminders: Daily 06:00 Toronto\n- Set up CRON_SECRET environment variable\n- Document timezone handling\n\n## Spec References\n- docs/specs/SPEC.md: Lines 289-296 (Scheduled jobs table)\n- docs/adr/001-tech-stack.md: Lines 56-57 (Vercel Cron rationale)\n\n## Acceptance Criteria\n- vercel.json contains all cron schedules\n- Schedules use correct Vercel cron syntax\n- Toronto timezone handled correctly (Vercel uses UTC)\n- CRON_SECRET configured in Vercel dashboard\n- All cron endpoints verify CRON_SECRET header\n- Documentation of cron schedule calculations\n\n## Technical Constraints\n- Vercel cron uses UTC; convert Toronto times\n- Sunday 23:59 Toronto = Monday 04:59 UTC (EST) or 03:59 UTC (EDT)\n- Consider DST transitions\n- Max 60 second execution time per job","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:32:51.0843917+09:00","created_by":"Matt","updated_at":"2026-02-02T21:32:51.0843917+09:00","dependencies":[{"issue_id":"DRV-vhg","depends_on_id":"DRV-e30","type":"blocks","created_at":"2026-02-02T21:32:51.1033161+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-5eo","type":"blocks","created_at":"2026-02-02T21:32:51.2966019+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-qen","type":"blocks","created_at":"2026-02-02T21:32:51.3062435+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-n1y","type":"blocks","created_at":"2026-02-02T21:32:51.3631388+09:00","created_by":"Matt"}]}
{"id":"DRV-vth","title":"Driver bid submission","description":"Source: docs/specs/SPEC.md § Bidding System\nSchema: docs/specs/data-model.md § bids table\n\n## Objective\nImplement ability for drivers to submit bids on open assignments.\n\n## Scope\n- API endpoints:\n  - GET /api/bids/available - List open bid windows for eligible driver\n  - POST /api/bids - Submit bid on an assignment\n  - GET /api/bids/mine - Get driver's pending/past bids\n- UI component for bid submission (in driver dashboard)\n- Validation:\n  - Driver not flagged\n  - Driver under weekly cap for that week\n  - Bid window still open\n  - Driver hasn't already bid on this assignment\n\n## Spec References\n- docs/specs/SPEC.md: Lines 121-127 (Notification/eligibility rules)\n- docs/specs/SPEC.md: Line 146 (Tie-breaking by earliest bid)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps)\n- docs/specs/data-model.md: Lines 121-130 (bids table)\n- docs/specs/data-model.md: Lines 316-342 (canDriverBid query)\n\n## Acceptance Criteria\n- Driver can see list of open bid windows they're eligible for\n- Driver can submit bid with single tap/click\n- Bid rejected if driver is flagged\n- Bid rejected if driver already at weekly cap\n- Bid rejected if window is closed\n- Bid rejected if driver already bid on this assignment\n- Bid timestamp recorded for tie-breaking\n- Driver can see their pending bids with countdown to resolution\n\n## Technical Constraints\n- Bid.status starts as 'pending'\n- Bid.windowClosesAt copied from BidWindow.closesAt\n- Weekly cap check must count all non-cancelled assignments for that week\n- Use optimistic UI for bid submission","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:25:58.0639983+09:00","created_by":"Matt","updated_at":"2026-02-02T21:25:58.0639983+09:00","dependencies":[{"issue_id":"DRV-vth","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:25:58.0723411+09:00","created_by":"Matt"}]}
{"id":"DRV-xgp","title":"Driver schedule view","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\nSchema: docs/specs/data-model.md § assignments table\n\n## Objective\nImplement the driver's schedule view showing this week, next week, and ability to cancel.\n\n## Scope\n- API endpoints:\n  - GET /api/assignments/mine - Get current user's assignments\n  - POST /api/assignments/[id]/cancel - Cancel an assignment\n- UI page at src/routes/(app)/schedule/+page.svelte\n- Display:\n  - This week's assignments (Week N)\n  - Next week's assignments (Week N+1)\n  - Each assignment shows: date, route name, warehouse, status\n- Actions:\n  - Cancel assignment (with reason selection)\n\n## Spec References\n- docs/specs/SPEC.md: Line 237 (Schedule route description)\n- docs/specs/SPEC.md: Lines 161-181 (Availability \u0026 Confirmation)\n- docs/specs/SPEC.md: Lines 167-173 (Cancellation rules)\n- docs/specs/data-model.md: Lines 92-103 (assignments table)\n- docs/specs/data-model.md: Lines 23-31 (cancelReasonEnum)\n\n## Acceptance Criteria\n- Driver sees all their assignments for current and next week\n- Assignments show date, route, warehouse name, status\n- Driver can cancel any future assignment\n- Cancellation requires selecting a reason from enum\n- Late cancellation (\u003c 48h) shows warning that it affects metrics\n- Cancelled assignment triggers bid window for replacement\n- Assignment status updates to 'cancelled' immediately\n\n## Technical Constraints\n- Toronto timezone for \"today\" calculation\n- Join with routes and warehouses for display\n- Cancellation creates audit log entry\n- Cancellation must trigger bid window creation (call bidding service)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:25:10.7974004+09:00","created_by":"Matt","updated_at":"2026-02-02T21:25:10.7974004+09:00","dependencies":[{"issue_id":"DRV-xgp","depends_on_id":"DRV-4w6","type":"blocks","created_at":"2026-02-02T21:25:10.8012643+09:00","created_by":"Matt"}]}
{"id":"DRV-xtb","title":"No-show detection","description":"Source: docs/specs/SPEC.md § Availability \u0026 Confirmation \u003e No-Show Definition\n\n## Objective\nImplement automatic no-show detection when driver doesn't start or cancel by shift time.\n\n## Scope\n- Service function: detectNoShows()\n- Logic: Find assignments where:\n  - date = today\n  - status = 'scheduled' (not started, not cancelled)\n  - shift start time has passed\n  - No shift record exists OR shift.startedAt is null\n- Action on no-show:\n  - Create bid window for replacement\n  - Count against driver's attendance (no explicit marking needed, just absence of shift)\n  - Consider: send manager notification?\n\n## Spec References\n- docs/specs/SPEC.md: Lines 175-181 (No-show definition)\n- docs/specs/SPEC.md: Lines 106-111 (Bid window triggers)\n- docs/specs/SPEC.md: Line 191 (Attendance rate calculation)\n\n## Acceptance Criteria\n- Assignments past start time without shift are detected\n- Bid window created for each no-show\n- Manager notified of no-shows (urgent_unfilled)\n- No-show affects attendance rate (absence of completedShift)\n- Detection can run multiple times without duplicate actions\n- Handles edge case: driver starts shift late (check startedAt exists)\n\n## Technical Constraints\n- Could be cron job OR triggered by bid window cron checking for stale assignments\n- \"Shift start time\" = assignment.date at some default hour (e.g., 07:00 Toronto)\n- Or: assignment doesn't have explicit time, just date — define cutoff (e.g., noon?)\n- Service in src/lib/server/services/noshow.ts\n\nNote: Spec doesn't define exact shift start time. May need to add default or make configurable.","status":"open","priority":2,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:30:55.9918667+09:00","created_by":"Matt","updated_at":"2026-02-02T21:30:55.9918667+09:00","dependencies":[{"issue_id":"DRV-xtb","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:30:55.9990626+09:00","created_by":"Matt"},{"issue_id":"DRV-xtb","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:30:56.0505827+09:00","created_by":"Matt"}]}
{"id":"DRV-zq5","title":"Database schema migration","description":"Source: docs/specs/data-model.md (Full schema)\nSpec: docs/specs/SPEC.md § Core Concepts \u003e Entities\n\n## Objective\nCreate the initial database migration with all tables, enums, relations, and indexes defined in data-model.md.\n\n## Scope\nImplement the complete Drizzle schema in src/lib/server/db/schema.ts:\n- 9 enums: userRoleEnum, assignmentStatusEnum, assignedByEnum, bidStatusEnum, bidWindowStatusEnum, cancelReasonEnum, notificationTypeEnum, actorTypeEnum\n- 11 tables: users, warehouses, routes, driverPreferences, assignments, shifts, bids, bidWindows, driverMetrics, routeCompletions, notifications, auditLogs\n- All relations defined in usersRelations, routesRelations, warehousesRelations, assignmentsRelations\n- 8 performance-critical indexes (see data-model.md lines 349-359)\n\n## Spec References\n- docs/specs/data-model.md: Lines 9-239 (complete schema definition)\n- docs/specs/data-model.md: Lines 349-359 (indexes)\n- docs/specs/SPEC.md: Lines 43-57 (entity descriptions)\n\n## Acceptance Criteria\n- All enums created and exported\n- All tables created with correct column types, constraints, defaults\n- All relations defined for query builder support\n- drizzle-kit generate produces clean migration\n- drizzle-kit push succeeds against Neon database\n- No TypeScript errors in schema file\n\n## Technical Constraints\n- Use uuid for all primary keys with defaultRandom()\n- All timestamps must include { withTimezone: true }\n- Use real (not decimal) for rate fields (0-1 range)\n- Arrays use .array() syntax for preferredDays and preferredRoutes","status":"closed","priority":0,"issue_type":"task","assignee":"drive","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:22:12.3925658+09:00","created_by":"Matt","updated_at":"2026-02-02T22:20:29.1743728+09:00","closed_at":"2026-02-02T22:20:29.1743728+09:00"}
{"id":"DRV-zxp","title":"Manager routes overview dashboard","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\n\n## Objective\nImplement the manager's main dashboard showing route coverage status with filtering.\n\n## Scope\n- UI page at src/routes/(manager)/+page.svelte (redirects to routes overview)\n- DataTable displaying all routes with:\n  - Route name, warehouse name\n  - Today's assignment status (assigned/unfilled/bidding)\n  - Assigned driver name (if any)\n  - Bid window status (if bidding)\n- Filters: warehouse, status, date picker\n- Row click: open side panel with details\n\n## Spec References\n- docs/specs/SPEC.md: Line 245 (Manager routes overview)\n- docs/specs/SPEC.md: Lines 253-260 (Manager capabilities)\n- docs/agent-guidelines.md: § TanStack Table patterns\n\n## Acceptance Criteria\n- All routes displayed with current day's assignment status\n- Filter by warehouse (dropdown)\n- Filter by status: all, assigned, unfilled, bidding\n- Filter by date (date picker, default today)\n- Table sortable by route name, warehouse, status\n- Row click shows assignment details in side panel\n- Real-time updates via SSE (separate bead)\n\n## Technical Constraints\n- Join routes, assignments, warehouses, users for display\n- Use DataTable component with column helpers\n- Side panel uses Drawer component\n- Default date = today (Toronto timezone)","status":"open","priority":1,"issue_type":"task","owner":"mattorrock@gmail.com","created_at":"2026-02-02T21:29:54.6926101+09:00","created_by":"Matt","updated_at":"2026-02-02T21:29:54.6926101+09:00","dependencies":[{"issue_id":"DRV-zxp","depends_on_id":"DRV-b9t","type":"blocks","created_at":"2026-02-02T21:29:54.6977807+09:00","created_by":"Matt"},{"issue_id":"DRV-zxp","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:29:54.703247+09:00","created_by":"Matt"}]}

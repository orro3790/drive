{"id":"DRV-02z","title":"Join signup TOCTOU: user created despite reservation revocation","description":"Signup pipeline is not atomic across user creation and reservation consumption. A manager revocation between reservation acquisition and after-hook finalize can still result in a persisted, organization-assigned account. Source: logs/nightly/2026-02-18/drv-xnb.5-onboarding-allowlist-toctou-and-signup-atomicity-audit.md Finding #1","notes":"PR: https://github.com/orro3790/drive/pull/165","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:06:44.9042403+09:00","created_by":"Matt","updated_at":"2026-02-18T19:57:20.9978426+09:00","closed_at":"2026-02-18T19:56:42.5607292+09:00","close_reason":"Closed","labels":["auth","onboarding","security"],"dependencies":[{"issue_id":"DRV-02z","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:58.5153064+09:00","created_by":"unknown"}]}
{"id":"DRV-04g","title":"API: /api/app-version auto-tracks GitHub Releases","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Make GET /api/app-version resolve currentVersion + downloadUrl automatically from GitHub Releases (stable latest), while keeping minVersion manually controlled.\n\nFiles\n- Update: src/routes/api/app-version/+server.ts\n\nImplementation Details\n- minVersion:\n  - Read env.APP_MIN_VERSION (default '0').\n  - Parse int base-10.\n  - Clamp invalid/NaN/negative to 0.\n- currentVersion + downloadUrl:\n  - Call src/lib/server/githubRelease.ts helper.\n  - Use helper.versionCode for currentVersion.\n  - Use helper.downloadUrl for downloadUrl.\n- Caching headers (important for Vercel + GitHub rate limits):\n  - Cache-Control: public, max-age=0, s-maxage=600, stale-while-revalidate=3600\n- Failure mode:\n  - If helper provides cached lastKnownGood: return it.\n  - Else return 503 with:\n    - Retry-After: 60\n    - JSON body: { message: string }\n  - Do not return a broken URL like drive-v1.0.0.apk.\n- Optional debugging:\n  - Add a response header like X-Drive-AppVersion-Source: github|cache|error.\n  - Do not add extra JSON fields.\n\nAcceptance Criteria\n- Endpoint returns valid tag-scoped APK URL and currentVersion matches tag-derived versionCode.\n- Endpoint response includes the Cache-Control header described above.\n- When GitHub is unavailable and no cached value exists, endpoint returns 503 with Retry-After.","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-15T22:57:02.6914152+09:00","created_by":"Matt","updated_at":"2026-02-15T23:12:25.5923195+09:00","closed_at":"2026-02-15T23:12:25.5923195+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-04g","depends_on_id":"DRV-69n","type":"blocks","created_at":"2026-02-15T22:58:02.1194875+09:00","created_by":"unknown"}]}
{"id":"DRV-09a","title":"Implement cancellation scenarios S7-S8","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Scenarios S7-S8)\n\n## Objective\nTest early vs late cancellation flows and verify correct metric/bid window behavior.\n\n## File to Modify\nscripts/nightly/lifecycle-e2e.test.ts\n\n## Scenarios\n\n### S7: Early cancellation (\u003e48h before shift)\n- Find a scheduled assignment for a future date \u003e48h from frozen now (different from S1 assignment)\n- If none: query for any scheduled assignment \u003e48h out and use that\n- Capture driverMetrics.lateCancellations before\n- Import src/routes/api/assignments/[id]/cancel/+server.ts\n- Call POST with body: { reason: \"personal_emergency\" }\n- Assert: status 200\n- Assert: response.assignment.status = 'cancelled'\n- Assert: cancelType = 'driver' (not 'late')\n- Assert DB: driverMetrics.lateCancellations unchanged (NOT incremented)\n- Assert DB: bid_windows row created with trigger = 'cancellation'\n- Assert DB: bid_windows.mode = 'competitive' (\u003e24h out)\n- advanceTimeByMs(1000)\n\n### S8: Late cancellation (within 48h of shift)\n- Find a scheduled + confirmed assignment for tomorrow (within 48h)\n- If none found: \n  1. Find any scheduled tomorrow assignment\n  2. Confirm it first via confirm endpoint\n  3. Then cancel\n- Capture driverMetrics.lateCancellations before\n- Call POST cancel with body: { reason: \"vehicle_breakdown\" }\n- Assert: status 200\n- Assert: cancelType = 'late'\n- Assert DB: driverMetrics.lateCancellations incremented by 1\n- Assert DB: bid_windows row created with trigger = 'cancellation'\n\n## Key Differences Verified\n| Aspect | Early (S7) | Late (S8) |\n|--------|------------|-----------|\n| cancelType | 'driver' | 'late' |\n| lateCancellations metric | unchanged | +1 |\n| bid window mode | competitive | instant or competitive based on time |\n\n## Edge Cases Handled\n- If no suitable assignments exist, prime by confirming one\n- Use different assignments from S1-S6 to avoid conflicts\n\n## Dependencies\n- DRV-t3r (shift lifecycle scenarios)\n\n## Acceptance Criteria\n- [ ] S7 passes: early cancel doesn't increment lateCancellations\n- [ ] S8 passes: late cancel increments lateCancellations\n- [ ] Both scenarios create bid windows\n- [ ] cancelType correctly reflects early vs late","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:43:36.459462+09:00","created_by":"Matt","updated_at":"2026-02-14T20:30:09.5046447+09:00","closed_at":"2026-02-14T20:30:09.5046447+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-09a","depends_on_id":"DRV-t3r","type":"blocks","created_at":"2026-02-14T19:45:25.4069622+09:00","created_by":"Matt"}]}
{"id":"DRV-0au","title":"Weekly reports and stale shift guard","description":"Managers need aggregated parcel delivery totals per operational week for billing. Also fixes lifecycle gap where drivers can start new shifts without closing incomplete ones. Plan: .claude/plans/delightful-swinging-stearns.md","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-11T15:39:36.4128025+09:00","created_by":"Matt","updated_at":"2026-02-11T19:29:52.4039392+09:00","closed_at":"2026-02-11T19:29:52.4039392+09:00","close_reason":"Closed","labels":["billing","manager-ui","shift-lifecycle"]}
{"id":"DRV-0au.1","title":"Weekly reports — types, time utility, i18n keys","description":"Foundation work for weekly reports: add getWeekStartFromDateString() to toronto.ts, create shared types in schemas/weeklyReports.ts, add all i18n message keys to en/zh/zh-Hant. Plan steps A1, A2, A8.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T15:39:44.9040331+09:00","created_by":"Matt","updated_at":"2026-02-11T20:07:43.063015+09:00","closed_at":"2026-02-11T20:07:43.063015+09:00","close_reason":"Closed","labels":["backend","i18n"],"dependencies":[{"issue_id":"DRV-0au.1","depends_on_id":"DRV-0au","type":"parent-child","created_at":"2026-02-11T15:39:44.90913+09:00","created_by":"Matt"}]}
{"id":"DRV-0au.2","title":"Weekly reports — summary and detail API endpoints","description":"Create GET /api/weekly-reports (aggregated week summaries) and GET /api/weekly-reports/[weekStart] (individual shifts for a week). Groups by assignments.date for billing attribution. Validates weekStart is a Monday. Plan steps A3, A4.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T15:39:52.4240372+09:00","created_by":"Matt","updated_at":"2026-02-11T20:07:44.3056993+09:00","closed_at":"2026-02-11T20:07:44.3056993+09:00","close_reason":"Closed","labels":["api","backend"],"dependencies":[{"issue_id":"DRV-0au.2","depends_on_id":"DRV-0au","type":"parent-child","created_at":"2026-02-11T15:39:52.4279456+09:00","created_by":"Matt"},{"issue_id":"DRV-0au.2","depends_on_id":"DRV-0au.1","type":"blocks","created_at":"2026-02-11T15:39:52.4376828+09:00","created_by":"Matt"}]}
{"id":"DRV-0au.3","title":"Weekly reports — page, detail table, sidebar nav","description":"Create WeeklyReportDetailTable component (follows DriverShiftHistoryTable pattern), weekly-reports page with tab system (follows drivers page pattern), and add Reports nav item with BarChart icon to manager sidebar. Plan steps A5, A6, A7.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T15:39:59.7653568+09:00","created_by":"Matt","updated_at":"2026-02-11T20:07:45.686174+09:00","closed_at":"2026-02-11T20:07:45.686174+09:00","close_reason":"Closed","labels":["frontend","manager-ui"],"dependencies":[{"issue_id":"DRV-0au.3","depends_on_id":"DRV-0au","type":"parent-child","created_at":"2026-02-11T15:39:59.7695621+09:00","created_by":"Matt"},{"issue_id":"DRV-0au.3","depends_on_id":"DRV-0au.2","type":"blocks","created_at":"2026-02-11T15:39:59.779144+09:00","created_by":"Matt"}]}
{"id":"DRV-0au.4","title":"Stale shift guard — block arrive/start with incomplete shift","description":"Add incomplete shift check to both /api/shifts/arrive and /api/shifts/start. Query for any shift with arrivedAt set, completedAt null, cancelledAt null for the user. Allow operations on the current assignment. Filter by assignments.status IN (active, scheduled) to avoid false blocks from cancelled assignments. Plan step B1.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T15:40:08.04783+09:00","created_by":"Matt","updated_at":"2026-02-11T20:07:47.3189142+09:00","closed_at":"2026-02-11T20:07:47.3189142+09:00","close_reason":"Closed","labels":["api","shift-lifecycle"],"dependencies":[{"issue_id":"DRV-0au.4","depends_on_id":"DRV-0au","type":"parent-child","created_at":"2026-02-11T15:40:08.05222+09:00","created_by":"Matt"}]}
{"id":"DRV-0au.5","title":"Stale shift reminder cron and dashboard surfacing","description":"Add stale_shift_reminder to notification_type enum (migration). Create hourly cron at /api/cron/stale-shift-reminder with CRON_SECRET auth, dedupeKey pattern (same as send-confirmation-reminders), 12-hour repeat. Surface incomplete shifts in dashboard API response so drivers can complete them. Add cron schedule to vercel.json. Plan steps B2, B3, B4, B5.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T15:40:16.9240355+09:00","created_by":"Matt","updated_at":"2026-02-11T20:07:48.5185196+09:00","closed_at":"2026-02-11T20:07:48.5185196+09:00","close_reason":"Closed","labels":["api","cron","notifications"],"dependencies":[{"issue_id":"DRV-0au.5","depends_on_id":"DRV-0au","type":"parent-child","created_at":"2026-02-11T15:40:16.9304769+09:00","created_by":"Matt"},{"issue_id":"DRV-0au.5","depends_on_id":"DRV-0au.4","type":"blocks","created_at":"2026-02-11T15:40:16.9614775+09:00","created_by":"Matt"}]}
{"id":"DRV-0c5","title":"Witness checks run even when cron drill failed (gating mismatch)","description":"Orchestrator always runs cron + lifecycle, then runs witness UI if dev server is reachable, independent of cron pass/fail. Witness runner only warns on failed cron overall and continues. Witness output can be produced from a failed upstream drill, weakening confidence that UI checks validate a known-good DB state. Source: logs/nightly/2026-02-18/drv-b1l.12-agent-browser-witness-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:07:22.9435991+09:00","created_by":"Matt","updated_at":"2026-02-18T23:06:33.9770904+09:00","closed_at":"2026-02-18T23:06:33.9770904+09:00","close_reason":"Fixed and merged in PR #175","labels":["gating","nightly","witness"],"dependencies":[{"issue_id":"DRV-0c5","depends_on_id":"DRV-bjka","type":"parent-child","created_at":"2026-02-18T12:48:09.5494877+09:00","created_by":"unknown"}],"comments":[{"id":67,"issue_id":"DRV-0c5","author":"DESKTOP-V2O36N0\\matto","text":"Merged in PR #175: https://github.com/orro3790/drive/pull/175. Witness UI now refuses to run when cron report failed unless explicit override is set; orchestrator also gates witness on upstream pass.","created_at":"2026-02-18T14:06:32Z"}]}
{"id":"DRV-102","title":"Flagging logic service","description":"Source: docs/specs/SPEC.md § Performance \u0026 Flagging\nSchema: docs/specs/data-model.md § users table (isFlagged, flagWarningDate)\n\n## Objective\nImplement the driver flagging logic based on attendance thresholds.\n\n## Scope\n- Service function: checkAndApplyFlag(userId: string)\n- Flag thresholds per spec:\n  - Before 10 shifts: flag if attendance \u003c 80%\n  - After 10 shifts: flag if attendance \u003c 70%\n- Flag consequences:\n  1. Set isFlagged = true\n  2. Set flagWarningDate = now (starts 1-week grace period)\n  3. Send warning notification to driver\n- Grace period logic:\n  - If flagged AND flagWarningDate + 7 days has passed AND still below threshold:\n  - Reduce weeklyCap by 1 (minimum 1)\n\n## Spec References\n- docs/specs/SPEC.md: Lines 195-200 (Flag thresholds table)\n- docs/specs/SPEC.md: Lines 202-211 (Flag consequences)\n- docs/specs/SPEC.md: Lines 213-215 (Reward threshold)\n- docs/specs/SPEC.md: Line 277 (warning notification)\n\n## Acceptance Criteria\n- Driver flagged when attendance drops below threshold\n- Correct threshold applied based on total shifts (10 is the cutoff)\n- flagWarningDate set on first flag\n- Grace period is 7 days from flagWarningDate\n- If still below threshold after grace: weeklyCap reduced by 1\n- weeklyCap never reduced below 1\n- Warning notification sent when flagged\n- Flagged drivers excluded from bidding (enforced elsewhere)\n- Reward: if 20+ shifts and attendance \u003e= 95%, weeklyCap = 6\n\n## Technical Constraints\n- Service in src/lib/server/services/flagging.ts\n- Called by daily performance check cron\n- Must handle re-flagging (driver improves, gets unflagged, drops again)\n- Reward logic also lives here","notes":"PR: https://github.com/orro3790/drive/pull/14","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:27:53.6740903+09:00","created_by":"Matt","updated_at":"2026-02-04T02:54:13.3668389+09:00","closed_at":"2026-02-04T02:54:13.3668389+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-102","depends_on_id":"DRV-8v4","type":"blocks","created_at":"2026-02-02T21:27:53.6865842+09:00","created_by":"Matt"}]}
{"id":"DRV-10p","title":"Add real-DB HLT-001/HLT-002/HLT-003 health scoring scenarios","description":"DRV-b1l.4 Audit Finding #1/#2: The planned HLT-* matrix requires HLT-001 (daily isolation), HLT-002 (weekly streak progression/reset), and HLT-003 (hard-stop/intervention without tenant bleed), but only mocked service tests exist. Nightly health cron checks prove execution/idempotency but not deterministic expected score/streak transitions. Add explicit real-DB HLT-001, HLT-002, HLT-003 scenarios under tests/integration/health/ that assert expected per-driver score/streak/star transitions for seeded org A and explicit non-interference for org B. Source: logs/nightly/2026-02-18/drv-b1l.4-health-scoring-and-intervention-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:07:25.3172908+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:22.3894255+09:00","closed_at":"2026-02-18T23:17:22.3894255+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","health","testing-matrix"],"dependencies":[{"issue_id":"DRV-10p","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:37.3117317+09:00","created_by":"unknown"}]}
{"id":"DRV-11x","title":"Driver management (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § users, driverMetrics tables\n\n## Objective\nImplement driver management for managers: view drivers, metrics, flag status, adjust caps.\n\n## Scope\n- API endpoints:\n  - GET /api/drivers - List all drivers with metrics\n  - PATCH /api/drivers/[id] - Update driver (weeklyCap, unflag)\n  - POST /api/drivers/[id]/unflag - Remove flag from driver\n- UI page at src/routes/(manager)/drivers/+page.svelte\n- Display: name, email, phone, attendance rate, completion rate, weekly cap, flag status\n- Actions: adjust weekly cap (1-6), unflag driver\n\n## Spec References\n- docs/specs/SPEC.md: Line 246 (Manager drivers route)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps table)\n- docs/specs/SPEC.md: Lines 202-211 (Flag consequences)\n- docs/specs/SPEC.md: Lines 255-256 (Unflag and adjust cap capabilities)\n- docs/specs/data-model.md: Lines 46-59 (users table)\n- docs/specs/data-model.md: Lines 143-150 (driverMetrics table)\n\n## Acceptance Criteria\n- Manager can view all users with role='driver'\n- Drivers display with their metrics (attendance_rate, completion_rate)\n- Flag status clearly visible (flagged/not flagged, warning date if set)\n- Manager can adjust weekly cap between 1-6\n- Manager can unflag a driver (sets isFlagged=false, clears flagWarningDate)\n- Phone numbers visible to manager only\n- All changes logged to auditLogs\n\n## Technical Constraints\n- Join users with driverMetrics for display\n- Only show drivers (role='driver'), not managers\n- Audit log unflag actions with actor_id","notes":"PR: https://github.com/orro3790/drive/pull/22","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:23:40.0831106+09:00","created_by":"Matt","updated_at":"2026-02-04T16:09:31.7152313+09:00","closed_at":"2026-02-04T16:09:31.7152313+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-11x","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:23:40.092006+09:00","created_by":"Matt"}]}
{"id":"DRV-12y","title":"Missing test coverage for /api/preferences lock enforcement","description":"Existing tests focus on auth/org guards only. No end-to-end lock enforcement tests through driver preferences API. Source: logs/nightly/2026-02-18/drv-xnb.4 finding #4.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:03:34.5119571+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:14.76878+09:00","closed_at":"2026-02-19T19:54:14.76878+09:00","close_reason":"Closed","labels":["lock","preferences","testing"]}
{"id":"DRV-1514","title":"Invalid FCM tokens not cleared on terminal send errors","description":"Notification send path acknowledges invalid-token failures but does not clear stale tokens when terminal errors occur. Token nulling exists only in explicit registration/unregistration routes. Stale tokens persist indefinitely causing repeated terminal failures. Source: logs/nightly/2026-02-18/drv-xnb.8-notification-reliability-and-fcm-error-taxonomy-audit.md Finding #2","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:10:43.1049002+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:17.6365277+09:00","closed_at":"2026-02-18T22:55:17.6365277+09:00","close_reason":"Covered by DRV-vii implementation (PR #168): FCM taxonomy, terminal token cleanup, and aggregate reliability counters added.","labels":["data-hygiene","fcm","notifications"],"dependencies":[{"issue_id":"DRV-1514","depends_on_id":"DRV-1sft","type":"parent-child","created_at":"2026-02-18T12:47:23.7730971+09:00","created_by":"unknown"}]}
{"id":"DRV-17l","title":"Launch Readiness North Star","description":"Single anchor bead for final launch-day execution. Tracks workstreams: (1) Capacitor packaging and signed mobile release build with private distribution and installer SOP. (2) Manager-facing confidence system with capability matrix, automated test mapping, and verification evidence. (3) High-value deterministic tests for core services, APIs, and cron logic. (4) Cron validation via direct endpoint invocation and workflow_dispatch runs. (5) Signup abuse hardening via stricter rate limits and invite model hardening. (6) Dual-session manager/driver E2E verification and final go/no-go report.","acceptance_criteria":"All launch-critical workstreams have linked child beads with status tracking. A manager-facing launch checklist and confidence report exist and are up to date. Mobile packaging and private distribution are validated end-to-end. Critical lifecycle and cron behaviors have passing deterministic tests and verification evidence. Final go/no-go report is completed with risks and mitigations.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-09T11:35:48.78534+09:00","created_by":"Matt","updated_at":"2026-02-19T19:55:52.7415342+09:00","closed_at":"2026-02-19T19:55:52.7415342+09:00","close_reason":"Closed","labels":["launch","north-star","release-readiness"]}
{"id":"DRV-17l.1","title":"Capacitor Android packaging and private distribution baseline","description":"Source: ralph/plans/DRV-17l.1.md\n\nBootstrap Capacitor in this repo, generate Android project, configure build/sync workflow, produce signed release artifact, and define a non-technical install/update path for drivers using private distribution (not public listing).","acceptance_criteria":"Capacitor config and Android project are committed. Build and sync commands are documented and reproducible. At least one signed release artifact is generated successfully. Private distribution path is selected and documented with a manager-friendly install SOP and rollback notes.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T11:36:04.1905517+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:40.5878304+09:00","closed_at":"2026-02-09T14:11:40.5878304+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T11:36:04.1938157+09:00","created_by":"Matt"}],"comments":[{"id":7,"issue_id":"DRV-17l.1","author":"Matt","text":"DRV-17l.1 completion evidence (2026-02-09): AC1 (config/project committed) satisfied via capacitor.config.ts + android/ baseline with hardened release signing path in android/app/build.gradle and manifest backup posture in android/app/src/main/AndroidManifest.xml. AC2 (reproducible sync/build docs) satisfied via package scripts + expanded SOP in documentation/mobile/android-private-distribution.md, with successful pnpm mobile:android:doctor and CAP_SERVER_URL-driven sync/build runs. AC3 (signed artifact) satisfied via generated app-release.aab + app-release.apk, SHA256 (a634bf1cb2ea5fa455875859b3c3bda6f78da4264171d6168b8a8203d4f996de / 200c2a7ac5311a832ac9165a377bf77f6aec0fa276d98070066ce7b7e91b002b), signer DN CN=Drive Ops..., and SHA256 cert fingerprint 832516992e67d56e113f3fde593e0d995498c7cc0e09d8aa8a0f8f4fc98562f4. AC4 (private distribution SOP + rollback) satisfied via manager-facing Closed Testing install/update/rollback playbook + communication templates in documentation/mobile/android-private-distribution.md.","created_at":"2026-02-09T05:11:40Z"},{"id":8,"issue_id":"DRV-17l.1","author":"Matt","text":"Merged PRs: https://github.com/orro3790/drive/pull/66 (repo formatting/validation baseline) and https://github.com/orro3790/drive/pull/67 (DRV-17l.1 Android release baseline).","created_at":"2026-02-09T05:32:50Z"}]}
{"id":"DRV-17l.1.1","title":"Audit and harden Capacitor/Android release baseline","description":"Source: ralph/plans/DRV-17l.1.md (Workstream A, Sections 3-4)\n\nObjective\nValidate and harden the existing Capacitor + Android baseline so release behavior is deterministic and launch-safe.\n\nImplementation details\n- Audit dependency and script alignment in `package.json` for Capacitor tooling (`@capacitor/core`, `@capacitor/cli`, `@capacitor/android`) and local CLI usage.\n- Validate runtime config assumptions in `capacitor.config.ts`:\n  - `appId` consistency with Android `applicationId`.\n  - `CAP_SERVER_URL` flow and release expectations (HTTPS only).\n- Audit Android release wiring in `android/app/build.gradle`:\n  - release signing path must not silently degrade to non-release behavior.\n  - identify and remove any release-risky fallback behavior discovered during audit.\n- Review Android manifest/config files for release-risky defaults in this scope:\n  - `android/app/src/main/AndroidManifest.xml`\n  - `android/variables.gradle`\n- Run and capture environment diagnostics with `pnpm mobile:android:doctor`.\n\nDependencies\n- None (first executable child for DRV-17l.1).\n\nAcceptance criteria\n- Audit findings are implemented or explicitly documented as intentional.\n- `pnpm mobile:android:doctor` passes with Android healthy.\n- All touched files are updated with release-safe defaults and no ambiguity on intended behavior.\n- Parent bead comment includes concise evidence of what was validated and what was changed.\n\nTechnical constraints\n- Do not commit secrets or local keystore values.\n- Keep compatibility with existing Capacitor v8 project structure.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T13:36:44.4173577+09:00","created_by":"Matt","updated_at":"2026-02-09T14:10:57.1532539+09:00","closed_at":"2026-02-09T14:10:57.1532539+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1.1","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:36:44.422459+09:00","created_by":"Matt"}],"comments":[{"id":1,"issue_id":"DRV-17l.1.1","author":"Matt","text":"Baseline audit complete (2026-02-09T14:10:26+09:00): verified Capacitor dependency/script alignment, confirmed appId/applicationId match (com.orro.drive), removed release signing debug fallback in android/app/build.gradle, added keystore placeholder validation + missing-keystore failure path, hardened AndroidManifest allowBackup=false, and confirmed pnpm mobile:android:doctor passes.","created_at":"2026-02-09T05:10:56Z"}]}
{"id":"DRV-17l.1.2","title":"Enforce release preflight in Android build pipeline","description":"Source: ralph/plans/DRV-17l.1.md (Workstream B.3/B.4, Workstream E.2)\n\nObjective\nAdd hard preflight checks so release builds fail fast when runtime URL/signing prerequisites are unsafe or incomplete.\n\nImplementation details\n- Update `scripts/mobile/android-gradle.mjs` to enforce release-task gates for `assembleRelease` and `bundleRelease`:\n  - require `CAP_SERVER_URL` to be set.\n  - require `CAP_SERVER_URL` to start with `https://` for release tasks.\n  - fail with actionable error message when URL is missing/unsafe.\n- Enforce release signing prerequisites before invoking Gradle release tasks:\n  - verify `android/keystore.properties` exists.\n  - verify required keys are present and not placeholder values.\n- Preserve current behavior for non-release tasks (e.g., debug flows) while keeping release checks strict.\n- Verify package scripts in `package.json` still call the wrapper correctly:\n  - `mobile:android:bundle:release`\n  - `mobile:android:apk:release`\n- Document any new preflight behavior in `documentation/mobile/android-private-distribution.md` if command expectations change.\n\nDependencies\n- Depends on `DRV-17l.1.1` findings for final release-safe behavior alignment.\n\nAcceptance criteria\n- Release commands fail fast on missing/invalid `CAP_SERVER_URL` and missing/invalid signing inputs.\n- Release commands continue to run when valid inputs are present.\n- Error messages tell operators exactly what to fix.\n- No regression for debug/non-release execution paths.\n\nTechnical constraints\n- Keep script cross-platform (Windows and Unix shell environments).\n- Do not log secret values in error output.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T13:36:56.507616+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:03.9833184+09:00","closed_at":"2026-02-09T14:11:03.9833184+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1.2","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:36:56.5137267+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.2","depends_on_id":"DRV-17l.1.1","type":"blocks","created_at":"2026-02-09T13:37:49.5214417+09:00","created_by":"Matt"}],"comments":[{"id":2,"issue_id":"DRV-17l.1.2","author":"Matt","text":"Release preflight enforcement complete: scripts/mobile/android-gradle.mjs now hard-fails release tasks when CAP_SERVER_URL is missing/non-HTTPS, android/keystore.properties is missing, required signing fields are missing/placeholder, or keystore file path is invalid. Verified failure paths with missing CAP_SERVER_URL and http:// URL, and documented operator workflow updates in documentation/mobile/android-private-distribution.md.","created_at":"2026-02-09T05:11:03Z"}]}
{"id":"DRV-17l.1.3","title":"Generate signed Android artifacts and record verifiable evidence","description":"Source: ralph/plans/DRV-17l.1.md (Workstream C, Section 6 AC3)\n\nObjective\nProduce signed release artifacts (AAB/APK), verify signing identity and hashes, and attach reproducible evidence to the parent bead.\n\nImplementation details\n- Execute release flow with production-like runtime URL:\n  - set `CAP_SERVER_URL` to target HTTPS host.\n  - run `pnpm mobile:android:sync`.\n  - run `pnpm mobile:android:bundle:release`.\n  - run `pnpm mobile:android:apk:release`.\n- Verify artifact outputs exist:\n  - `android/app/build/outputs/bundle/release/app-release.aab`\n  - `android/app/build/outputs/apk/release/app-release.apk`\n- Verify signing identity matches expected upload key:\n  - APK: use `apksigner verify --print-certs` or equivalent on host.\n  - AAB: use `jarsigner -verify -verbose -certs` or equivalent.\n- Compute and record SHA256 for each produced artifact.\n- Add evidence comment on `DRV-17l.1` using template fields:\n  - timestamp\n  - commands run\n  - artifact paths\n  - SHA256 values\n  - signer fingerprint/alias\n\nDependencies\n- Depends on `DRV-17l.1.1` (baseline audit/hardening).\n- Depends on `DRV-17l.1.2` (release preflight enforcement).\n\nAcceptance criteria\n- At least one signed release artifact is generated successfully.\n- Signing verification confirms expected key identity.\n- Artifact hashes are captured in bead evidence comment.\n- No artifact binaries or secrets are committed.\n\nTechnical constraints\n- Treat any signing mismatch as a hard failure.\n- Keep evidence human-readable for launch go/no-go review.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T13:37:05.7560501+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:12.1025232+09:00","closed_at":"2026-02-09T14:11:12.1025232+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1.3","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:37:05.7602877+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.3","depends_on_id":"DRV-17l.1.1","type":"blocks","created_at":"2026-02-09T13:37:49.9632707+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.3","depends_on_id":"DRV-17l.1.2","type":"blocks","created_at":"2026-02-09T13:37:50.4151906+09:00","created_by":"Matt"}],"comments":[{"id":3,"issue_id":"DRV-17l.1.3","author":"Matt","text":"Signed artifact evidence (2026-02-09): commands run -\u003e GRADLE_USER_HOME=\"/c/Users/matto/projects/drive/.gradle-home\" CAP_SERVER_URL=\"https://drive.example.com\" CAP_GRADLE_MAX_WORKERS=1 pnpm mobile:android:sync; ...bundle:release; ...apk:release. Artifacts: android/app/build/outputs/bundle/release/app-release.aab and android/app/build/outputs/apk/release/app-release.apk. SHA256: aab=a634bf1cb2ea5fa455875859b3c3bda6f78da4264171d6168b8a8203d4f996de, apk=200c2a7ac5311a832ac9165a377bf77f6aec0fa276d98070066ce7b7e91b002b. Signer DN (AAB+APK): CN=Drive Ops, OU=Mobile, O=Orro, L=Toronto, ST=ON, C=CA. SHA-256 cert fingerprint: 832516992e67d56e113f3fde593e0d995498c7cc0e09d8aa8a0f8f4fc98562f4. jarsigner result: jar verified.","created_at":"2026-02-09T05:11:11Z"}]}
{"id":"DRV-17l.1.4","title":"Harden Closed Testing manager SOP and rollback playbook","description":"Source: ralph/plans/DRV-17l.1.md (Workstream D, Section 4.1, Section 8)\n\nObjective\nFinalize manager-facing documentation for private Android distribution through Google Play Closed Testing, including rollout operations and rollback-by-hotfix.\n\nImplementation details\n- Update `documentation/mobile/android-private-distribution.md` with launch-ready operating instructions:\n  - exact Closed Testing upload/release flow.\n  - driver tester-group onboarding and install path.\n  - first-3-install verification checklist.\n  - plain-language release note template managers can send directly.\n- Add explicit rollback procedure aligned to Play constraints:\n  - halt rollout immediately.\n  - publish hotfix with higher `versionCode` (or promote pre-staged fallback with higher code).\n  - do not rely on downgrade to lower `versionCode`.\n  - include manager/driver communication template and incident log fields.\n- Document versioning responsibility and where `versionCode`/`versionName` are updated (`android/app/build.gradle`).\n\nDependencies\n- Can run in parallel with technical implementation beads.\n\nAcceptance criteria\n- SOP can be followed by a non-technical manager without Android tooling expertise.\n- Rollout and rollback instructions are explicit, ordered, and operationally testable.\n- Versioning and communication responsibilities are clearly assigned.\n- Document includes no contradictory guidance about Play rollback behavior.\n\nTechnical constraints\n- Keep instructions consistent with actual project scripts/paths.\n- Keep sensitive credentials out of docs.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T13:37:14.2061682+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:18.6601969+09:00","closed_at":"2026-02-09T14:11:18.6601969+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1.4","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:37:14.2120931+09:00","created_by":"Matt"}],"comments":[{"id":4,"issue_id":"DRV-17l.1.4","author":"Matt","text":"Manager SOP hardened in documentation/mobile/android-private-distribution.md: explicit Closed Testing upload flow, tester onboarding/install steps, first-3-install verification checklist, manager release-note template, rollback-by-hotfix runbook requiring higher versionCode, rollback communications template, and incident-log field checklist.","created_at":"2026-02-09T05:11:17Z"}]}
{"id":"DRV-17l.1.5","title":"Add security/compliance guardrails for Android release baseline","description":"Source: ralph/plans/DRV-17l.1.md (Workstream E, Sections 4.3 and 7)\n\nObjective\nCapture and enforce security/compliance guardrails for release readiness: key custody expectations, runtime safety defaults, and Android manifest backup/export posture.\n\nImplementation details\n- Review and update guardrails in documentation:\n  - `documentation/mobile/android-private-distribution.md`\n  - `README.md` mobile/release references if needed\n- Add explicit key-management notes:\n  - Play App Signing vs upload key responsibilities.\n  - storage/custody expectations for keystore and signing props.\n  - incident/recovery contact path for lost/rotated upload keys.\n- Add runtime safety guardrails:\n  - release builds require HTTPS runtime URL.\n  - cleartext and broad allow-navigation settings are dev-only exceptions.\n- Review Android manifest release posture in `android/app/src/main/AndroidManifest.xml`:\n  - `allowBackup` and related backup/export settings are explicitly reviewed and either hardened or documented as intentional.\n\nDependencies\n- Depends on `DRV-17l.1.1` for baseline audit context.\n\nAcceptance criteria\n- Security/compliance guardrails are documented and unambiguous.\n- Manifest backup/export stance is explicitly verified for release.\n- No secret material introduced in tracked files.\n- Parent bead has a concise security review note linked to changed files.\n\nTechnical constraints\n- Do not introduce behavior-breaking manifest changes without documenting rationale.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-09T13:37:23.4299027+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:25.3963947+09:00","closed_at":"2026-02-09T14:11:25.3963947+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile","security"],"dependencies":[{"issue_id":"DRV-17l.1.5","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:37:23.4425057+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.5","depends_on_id":"DRV-17l.1.1","type":"blocks","created_at":"2026-02-09T13:37:50.8965825+09:00","created_by":"Matt"}],"comments":[{"id":5,"issue_id":"DRV-17l.1.5","author":"Matt","text":"Security/compliance guardrails captured: release HTTPS-only CAP_SERVER_URL requirement documented, cleartext/allowNavigation policy documented as dev-only exception, key custody guidance added (Play App Signing vs upload key ownership and escalation path), and manifest backup posture hardened via android:allowBackup=false in android/app/src/main/AndroidManifest.xml.","created_at":"2026-02-09T05:11:24Z"}]}
{"id":"DRV-17l.1.6","title":"Finalize AC evidence map and close DRV-17l.1","description":"Source: ralph/plans/DRV-17l.1.md (Workstream F, Section 6, Go/No-Go checklist)\n\nObjective\nCompile final acceptance evidence across all DRV-17l.1 child tasks, map each acceptance criterion to concrete proof, and close the parent bead with launch-ready context.\n\nImplementation details\n- Collect evidence produced by sibling tasks (`DRV-17l.1.1` to `DRV-17l.1.5`):\n  - command outputs,\n  - file paths changed,\n  - artifact/signing/hash evidence,\n  - SOP/guardrail documentation links.\n- Build a concise AC mapping in parent comments:\n  - AC1 -\u003e committed config/project proof\n  - AC2 -\u003e reproducible command proof\n  - AC3 -\u003e signed artifact + signer/hash proof\n  - AC4 -\u003e private distribution + rollback SOP proof\n- Verify no unresolved blockers/dependencies remain.\n- Close `DRV-17l.1` only after all AC evidence is present and consistent.\n\nDependencies\n- Depends on completion of:\n  - `DRV-17l.1.3`\n  - `DRV-17l.1.4`\n  - `DRV-17l.1.5`\n\nAcceptance criteria\n- Parent bead comment contains explicit AC-to-evidence mapping.\n- All child tasks required for ACs are complete.\n- `DRV-17l.1` is closed with clear handoff context for launch tracking.\n\nTechnical constraints\n- Evidence must be reproducible from repository files and command history.\n- Do not close parent if any AC proof is missing or contradictory.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-09T13:37:32.9268579+09:00","created_by":"Matt","updated_at":"2026-02-09T14:11:32.5920995+09:00","closed_at":"2026-02-09T14:11:32.5920995+09:00","close_reason":"Closed","labels":["capacitor","launch","mobile"],"dependencies":[{"issue_id":"DRV-17l.1.6","depends_on_id":"DRV-17l.1","type":"parent-child","created_at":"2026-02-09T13:37:32.9303047+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.6","depends_on_id":"DRV-17l.1.3","type":"blocks","created_at":"2026-02-09T13:37:51.4275829+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.6","depends_on_id":"DRV-17l.1.4","type":"blocks","created_at":"2026-02-09T13:37:51.8716087+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.1.6","depends_on_id":"DRV-17l.1.5","type":"blocks","created_at":"2026-02-09T13:37:52.2964945+09:00","created_by":"Matt"}],"comments":[{"id":6,"issue_id":"DRV-17l.1.6","author":"Matt","text":"AC evidence map prepared for parent closure: AC1 -\u003e capacitor.config.ts + android project tracked and release wiring hardened in android/app/build.gradle + AndroidManifest.xml; AC2 -\u003e reproducible command flow and release preflight behavior documented in documentation/mobile/android-private-distribution.md with verified doctor/sync/build runs; AC3 -\u003e signed AAB/APK built with SHA256 and signer fingerprint evidence recorded in DRV-17l.1.3; AC4 -\u003e Closed Testing manager SOP + rollback/hotfix communications documented in documentation/mobile/android-private-distribution.md. Remaining repo-wide validation failures are pre-existing (prettier drift and existing svelte-check errors unrelated to this bead).","created_at":"2026-02-09T05:11:32Z"}]}
{"id":"DRV-17l.10","title":"Fix cron auto-drop integrity and reminder idempotency","description":"Implement fixes from audit-api-cron and audit-services-scheduling-pipeline: make auto-drop side effects transactional with successful bid-window creation; add dedupe keys for send-confirmation-reminders and shift-reminders; align workflow schedules with Toronto-time intent (or update contracts/docs explicitly).","acceptance_criteria":"Auto-drop never records penalties/notifications without a created replacement window; reminder retries do not emit duplicates; schedule definitions and documented timing are consistent and verified.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:35:03.0565666+09:00","created_by":"Matt","updated_at":"2026-02-10T10:58:50.0114951+09:00","closed_at":"2026-02-10T10:58:50.0114951+09:00","close_reason":"Auto-drop now gates penalties/audit on successful bid-window creation; reminder crons now dedupe via deterministic keys and dual-UTC schedule alignment verified with cron endpoint tests.","labels":["audit-2026-02-10","cron","nightly-remediation","reliability"],"dependencies":[{"issue_id":"DRV-17l.10","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:03.0684509+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.10","depends_on_id":"DRV-17l.9","type":"blocks","created_at":"2026-02-10T09:43:49.0963065+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.10","depends_on_id":"DRV-17l.11","type":"blocks","created_at":"2026-02-10T09:43:49.8013223+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.11","title":"Normalize Toronto boundary math across lifecycle services","description":"Implement fixes from audit-services-scheduling-pipeline, audit-services-remaining, and audit-api-shifts: construct schedule/confirmation/late-cancel/no-show instants explicitly in America/Toronto; enforce 9:00 AM arrival cutoff with correct error mapping; remove midnight-based boundary calculations.","acceptance_criteria":"Confirmation and cancellation windows are timezone-safe and deterministic across host timezones; arrival after 9:00 Toronto is rejected by policy; boundary behavior is validated with DST transition tests.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:35:07.9775361+09:00","created_by":"Matt","updated_at":"2026-02-10T10:34:54.2933099+09:00","closed_at":"2026-02-10T10:34:54.2933099+09:00","close_reason":"Implemented Toronto-safe boundary math for scheduling/confirmation/lifecycle/no-show, enforced 9 AM arrival cutoff with 400/409 mapping, and added DST regression tests.","labels":["audit-2026-02-10","lifecycle","nightly-remediation","timezone"],"dependencies":[{"issue_id":"DRV-17l.11","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:07.990236+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.12","title":"Repair health service policy and migration drift","description":"Implement fixes from audit-services-health: filter hard-stop late-cancel logic by cancelType='late'; add forward migration for missing health columns used by runtime; align documented scoring model and persisted snapshot rates with implementation; make hard-stop reset timing consistent and add stale-write protection between daily and event paths.","acceptance_criteria":"Health cron/service runs on a clean migrated DB without missing-column errors; late-cancel hard-stop applies only to true late cancels; score/stars reset behavior is consistent across trigger paths; scoring model and docs are aligned.","notes":"Source: ralph/plans/DRV-17l.12.md","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:35:14.2542517+09:00","created_by":"Matt","updated_at":"2026-02-10T13:40:49.0995999+09:00","closed_at":"2026-02-10T13:40:49.0995999+09:00","close_reason":"Implemented health hard-stop fixes, migration drift repair, and docs alignment.","labels":["audit-2026-02-10","data-integrity","health","nightly-remediation"],"dependencies":[{"issue_id":"DRV-17l.12","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:14.2684249+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.13","title":"Harden management endpoint auth and mutation atomicity","description":"Implement fixes from audit-api-management and audit-services-remaining: enforce target-warehouse authorization on route reassignment; make manual assignment updates atomic with status-guarded writes; scope bid-window selection deterministically to open windows; standardize invalid JSON/UUID rejection before DB calls.","acceptance_criteria":"Managers cannot mutate resources across unauthorized warehouses; concurrent manager actions cannot double-assign or stale-overwrite state; invalid JSON/UUID inputs return controlled client errors instead of 500s.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T09:35:19.7556983+09:00","created_by":"Matt","updated_at":"2026-02-10T17:37:14.7856982+09:00","closed_at":"2026-02-10T17:37:14.7856982+09:00","close_reason":"Closed","labels":["api-hardening","audit-2026-02-10","authorization","nightly-remediation"],"dependencies":[{"issue_id":"DRV-17l.13","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:19.76816+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.13","depends_on_id":"DRV-17l.9","type":"blocks","created_at":"2026-02-10T09:43:50.5053705+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.14","title":"Add launch-critical tests for security, bidding, and cron idempotency","description":"Implement the highest-risk gaps from audit-test-coverage: add direct route tests for /api/users/* and onboarding revoke; add resolveBidWindow competitive/tie/concurrency tests; add run-twice idempotency tests for cron handlers; add DST boundary tests for confirmation/no-show/arrival windows.","acceptance_criteria":"Security-critical endpoints and bidding resolver are directly covered by deterministic tests; cron handlers prove idempotent behavior on repeated runs; DST boundary regressions are covered in CI.","notes":"PR: https://github.com/orro3790/drive/pull/95","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T09:35:24.6082526+09:00","created_by":"Matt","updated_at":"2026-02-10T17:48:56.5978152+09:00","closed_at":"2026-02-10T17:47:43.1215866+09:00","close_reason":"Closed","labels":["audit-2026-02-10","nightly-remediation","quality-gate","tests"],"dependencies":[{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:24.6121508+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.7","type":"blocks","created_at":"2026-02-10T09:43:51.2160281+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.8","type":"blocks","created_at":"2026-02-10T09:43:51.9204569+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.9","type":"blocks","created_at":"2026-02-10T09:43:52.6542922+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.10","type":"blocks","created_at":"2026-02-10T09:43:53.4351283+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.11","type":"blocks","created_at":"2026-02-10T09:43:54.224017+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.12","type":"blocks","created_at":"2026-02-10T09:43:54.9903126+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.14","depends_on_id":"DRV-17l.13","type":"blocks","created_at":"2026-02-10T09:43:55.8005665+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.15","title":"Harden store reliability for offline and race scenarios","description":"Implement follow-ups from audit-stores: enforce ensureOnlineForWrite across all mutation stores; add runtime response schema validation before state assignment; add mutation-version/request-order protection for optimistic rollback and polling overlap.","acceptance_criteria":"Offline mutation behavior is consistent across driver and manager stores; malformed API payloads are rejected before state commit; rapid successive actions cannot rollback newer successful state.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T09:35:30.0828441+09:00","created_by":"Matt","updated_at":"2026-02-10T18:50:37.3051969+09:00","closed_at":"2026-02-10T18:50:37.3051969+09:00","close_reason":"Closed","labels":["audit-2026-02-10","nightly-remediation","reliability","stores"],"dependencies":[{"issue_id":"DRV-17l.15","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:30.0902345+09:00","created_by":"Matt"}],"comments":[{"id":37,"issue_id":"DRV-17l.15","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/96","created_at":"2026-02-10T09:52:39Z"}]}
{"id":"DRV-17l.16","title":"Close high-impact accessibility and interaction semantics gaps","description":"Implement follow-ups from audit-components-primitives, audit-components-driver-settings, and audit-components-data-table: add focus trap/restore for Modal/Drawer; remove nested interactive controls (button+link/button+checkbox); add aria-sort and valid table/dialog semantics; enforce \u003e=44px touch targets for critical mobile controls.","acceptance_criteria":"Keyboard/screen-reader behavior is valid for dialogs, tables, notifications, and filter menus; interactive semantics pass accessibility lint/manual checks; coarse-pointer controls meet touch-target baseline.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T09:35:35.5385622+09:00","created_by":"Matt","updated_at":"2026-02-10T19:13:57.1840067+09:00","closed_at":"2026-02-10T19:13:57.1840067+09:00","close_reason":"Closed accessibility remediation: dialog focus management/semantics, nested-interactive fixes, aria-sort + table semantics alignment, and coarse-pointer touch-target enforcement validated with full quality gates.","labels":["accessibility","audit-2026-02-10","nightly-remediation","ui"],"dependencies":[{"issue_id":"DRV-17l.16","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:35.5526872+09:00","created_by":"Matt"}],"comments":[{"id":38,"issue_id":"DRV-17l.16","author":"Matt","text":"Implemented accessibility/semantics remediation across primitives, notifications, and data-table: added shared focus-trap + focus-restore utility applied to Modal/Drawer with dialog role/aria-describedby on container; removed nested interactive patterns by restructuring NotificationItem (article + dedicated mark-read button + CTA link) and converting DataTable filter/column controls to single Checkbox controls; added aria-sort on sortable table headers and removed row role=button overrides on table rows; enforced coarse-pointer touch targets (\u003e=44px) for Toggle hit area plus Select/Combobox/InlineEditor controls. Validation: pnpm validate (prettier+eslint+svelte-check: 0 errors/0 warnings) and pnpm test (45 files, 256 tests passing).","created_at":"2026-02-10T10:13:51Z"}]}
{"id":"DRV-17l.17","title":"Execute dead-code and dependency cleanup from nightly audit","description":"Implement low-risk cleanup from audit-dead-code: remove duplicate src/paraglide tree if confirmed orphaned, trim unused exports/utilities, and remove truly unused dependencies after validation gates.","acceptance_criteria":"Chosen removals are validated by pnpm check/build and smoke-tested on core auth/dashboard flows; removed files/dependencies have no runtime regressions.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-10T09:35:41.0780429+09:00","created_by":"Matt","updated_at":"2026-02-10T18:32:38.9011488+09:00","closed_at":"2026-02-10T18:32:38.9011488+09:00","close_reason":"Closed","labels":["audit-2026-02-10","cleanup","nightly-remediation","tech-debt"],"dependencies":[{"issue_id":"DRV-17l.17","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:35:41.0819887+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.17","depends_on_id":"DRV-17l.14","type":"blocks","created_at":"2026-02-10T09:43:56.7835597+09:00","created_by":"Matt"}]}
{"id":"DRV-17l.2","title":"Launch capability matrix and manager-facing confidence checklist","description":"Create one manager-readable source of truth listing app capabilities, expected behaviors, ownership, automated/manual verification coverage, edge cases, and current pass/fail confidence.","acceptance_criteria":"A single document exists in-repo with capability IDs, verification methods, latest status, and evidence links. Managers can read it without implementation context. It is updated as workstreams complete.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T11:36:09.6001566+09:00","created_by":"Matt","updated_at":"2026-02-09T14:47:56.7212486+09:00","closed_at":"2026-02-09T14:47:56.7212486+09:00","close_reason":"Closed","labels":["documentation","launch","qa"],"dependencies":[{"issue_id":"DRV-17l.2","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T11:36:09.6033672+09:00","created_by":"Matt"}],"comments":[{"id":9,"issue_id":"DRV-17l.2","author":"Matt","text":"Completed manager-facing launch capability matrix in documentation/launch/launch-capability-matrix.md. Document includes capability IDs LC-01..LC-07, expected behaviors, owners, verification coverage (automated/manual), edge cases, current status/confidence roll-up, and evidence register links (including DRV-17l.1 signed artifact proof). README documentation index updated to include the new launch confidence doc.","created_at":"2026-02-09T05:47:53Z"}]}
{"id":"DRV-17l.3","title":"Deterministic test coverage for critical services, APIs, and cron rules","description":"Expand high-value Vitest coverage for lifecycle services, API contract boundaries, and cron decision logic using deterministic fixtures/time controls, with explicit edge-case coverage and failure-mode checks.","acceptance_criteria":"Critical lifecycle and cron behaviors are covered by deterministic automated tests. Test suite maps to capability matrix IDs. Edge cases and idempotency checks are included, and failures are actionable.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T11:36:15.2802476+09:00","created_by":"Matt","updated_at":"2026-02-09T15:02:57.266102+09:00","closed_at":"2026-02-09T15:02:57.266102+09:00","close_reason":"LC-05 deterministic lifecycle/API/cron coverage landed with passing Vitest evidence","labels":["launch","testing","vitest"],"dependencies":[{"issue_id":"DRV-17l.3","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T11:36:15.285155+09:00","created_by":"Matt"}],"comments":[{"id":10,"issue_id":"DRV-17l.3","author":"Matt","text":"Completed LC-05 deterministic coverage. Added no-show cron service tests (boundary-time skip before 9 AM Toronto, idempotent skip when open bid window exists, successful emergency path, and error-counter failure path) in tests/server/noShowDetectionService.test.ts; added cron API boundary tests (auth required, success payload, 500 fallback) in tests/server/noShowDetectionCronApi.test.ts; expanded lifecycle and confirm API coverage with LC-05 mapping in tests/server/assignmentLifecycle.test.ts and tests/server/assignmentsConfirmApi.test.ts. Updated documentation/launch/launch-capability-matrix.md to mark LC-05 PASS with evidence links and updated roll-up. Verification: pnpm test -- tests/server/assignmentLifecycle.test.ts tests/server/assignmentsConfirmApi.test.ts tests/server/noShowDetectionService.test.ts tests/server/noShowDetectionCronApi.test.ts (passing).","created_at":"2026-02-09T06:01:53Z"},{"id":11,"issue_id":"DRV-17l.3","author":"Matt","text":"Added deterministic LC-05 coverage for assignment lifecycle idempotency and cancellation edges, assignment confirm API boundary checks, and cron decision logic for auto-drop + close-bid windows. Verified with pnpm test (44 passing). Evidence: tests/server/assignmentLifecycle.test.ts, tests/server/assignmentsConfirmApi.test.ts, tests/server/cronAutoDropUnconfirmedApi.test.ts, tests/server/cronCloseBidWindowsApi.test.ts, documentation/launch/launch-capability-matrix.md.","created_at":"2026-02-09T06:02:52Z"},{"id":12,"issue_id":"DRV-17l.3","author":"Matt","text":"Added LC-05 follow-on deterministic coverage: tests/server/cronSendConfirmationRemindersApi.test.ts (deterministic reminder date, null-user guard, per-send error isolation), tests/server/cronCloseBidWindowsApi.test.ts (resolve/transition/close/error branch accounting), and expanded idempotency mapping in tests/server/assignmentsConfirmApi.test.ts (Assignment already confirmed -\u003e 400). Updated documentation/launch/launch-capability-matrix.md with LC-05 test map and evidence links. Verification: pnpm test (12 files, 48 tests passing).","created_at":"2026-02-09T06:03:36Z"}]}
{"id":"DRV-17l.4","title":"Production signup abuse hardening","description":"Harden signup against abuse with strict Better Auth rate limits, production-safe storage for rate limit counters, and invite/onboarding controls that avoid shared static codes.","acceptance_criteria":"Signup and sign-in endpoints enforce explicit rate limits with persistent storage. Production signup policy is defined and implemented (invite/allowlist/approval flow). Expected abuse scenarios are documented with mitigations and monitoring signals.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T11:36:23.3379191+09:00","created_by":"Matt","updated_at":"2026-02-09T15:23:10.7958003+09:00","closed_at":"2026-02-09T15:23:10.7958003+09:00","close_reason":"LC-06 signup abuse hardening implemented with persistent auth rate limits, allowlist onboarding policy, documentation, and passing automated validation","labels":["auth","launch","security"],"dependencies":[{"issue_id":"DRV-17l.4","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T11:36:23.3663523+09:00","created_by":"Matt"}],"comments":[{"id":13,"issue_id":"DRV-17l.4","author":"Matt","text":"Implemented LC-06 signup abuse hardening: added production allowlist/onboarding policy and strict persistent Better Auth rate limits (database storage) in src/lib/server/auth-abuse-hardening.ts and wired via src/lib/server/auth.ts. Added auth rate-limit monitoring signal logging (auth_rate_limit_exceeded) in src/hooks.server.ts, introduced auth rate-limit persistence table in src/lib/server/db/auth-schema.ts with migration drizzle/0008_conscious_randall_flagg.sql, and documented threat model/approval flow/signals in documentation/launch/signup-abuse-hardening.md plus launch matrix updates in documentation/launch/launch-capability-matrix.md. Added automated coverage in tests/server/authAbuseHardening.test.ts. Verification: pnpm test (13 files, 58 tests passing) and pnpm validate (lint + svelte-check clean).","created_at":"2026-02-09T06:23:03Z"},{"id":14,"issue_id":"DRV-17l.4","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/68","created_at":"2026-02-09T06:24:34Z"}]}
{"id":"DRV-17l.5","title":"Dual-session E2E verification and launch go/no-go report","description":"Run end-to-end verification with concurrent manager and driver sessions, validate real-time interaction expectations, execute cron dry-runs safely, and produce final go/no-go launch report.","acceptance_criteria":"Manager and driver dual-session flows are verified with evidence. Cron dry-runs are completed with expected outcomes. Open defects are triaged by severity with owners. Final go/no-go report is published with explicit launch decision.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-09T11:36:30.2997478+09:00","created_by":"Matt","updated_at":"2026-02-09T16:43:44.3495012+09:00","closed_at":"2026-02-09T16:43:44.3495012+09:00","close_reason":"Closed","labels":["e2e","launch","verification"],"dependencies":[{"issue_id":"DRV-17l.5","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T11:36:30.3031025+09:00","created_by":"Matt"},{"issue_id":"DRV-17l.5","depends_on_id":"DRV-17l.6","type":"blocks","created_at":"2026-02-09T16:18:24.2354608+09:00","created_by":"Matt"}],"comments":[{"id":15,"issue_id":"DRV-17l.5","author":"Matt","text":"LC-07 verification run completed on branch DRV-17l.5/implementation. Cron dry-runs passed: /auto-drop-unconfirmed, /send-confirmation-reminders, /close-bid-windows, /no-show-detection, /shift-reminders (all 200, no endpoint errors). Dual-session manager+driver verification is currently blocked by auth runtime 500s on sign-in/sign-up. Evidence report: documentation/launch/lc-07-dual-session-go-no-go-report-2026-02-09.md. Blocking defect: DRV-17l.6 (P0). Launch decision: NO-GO until DRV-17l.6 is fixed and LC-07 is rerun.","created_at":"2026-02-09T07:18:42Z"},{"id":18,"issue_id":"DRV-17l.5","author":"Matt","text":"LC-07 rerun complete after DRV-17l.6 fix. Dual-session evidence: manager routes view filtered to 2026-02-11 showed SE-005 assigned to Mandy; driver session cancelled assignment 023104fc-0a6a-46f1-9ed7-8a8528e16d00; manager session updated in-session to Bidding without manual refresh. Cron dry-runs revalidated and all passed. Final report updated at documentation/launch/lc-07-dual-session-go-no-go-report-2026-02-09.md with DECISION_READY verdict.","created_at":"2026-02-09T07:43:43Z"}]}
{"id":"DRV-17l.6","title":"Auth runtime 500 blocks manager/driver login","description":"During DRV-17l.5 verification, both manager and driver sign-in returned HTTP 500 (\"Internal Error\") from /api/auth/sign-in/email, blocking dual-session launch verification entirely.\\n\\nEvidence:\\n- POST /api/auth/sign-in/email with manager@drive.test/test1234 -\u003e 500\\n- POST /api/auth/sign-in/email with mandy.torp43@driver.test/test1234 -\u003e 500\\n- POST /api/auth/sign-up/email (with invite header) -\u003e 500\\n- Database introspection shows auth_rate_limit table missing in public schema while auth hardening expects persistent rate-limit storage.\\n\\nExpected:\\n- Sign-in and sign-up return normal auth responses (200/4xx) and allow manager/driver sessions.\\n\\nScope:\\n- Verify migration/application of auth_rate_limit schema in active runtime DB\\n- Ensure Better Auth rate-limit storage fails safe if table absent\\n- Add startup/runtime guardrails so missing table is surfaced as actionable error before launch verification.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-09T16:16:52.2668005+09:00","created_by":"Matt","updated_at":"2026-02-09T16:43:30.2984528+09:00","closed_at":"2026-02-09T16:43:30.2984528+09:00","close_reason":"Closed","labels":["auth","blocker","launch"],"dependencies":[{"issue_id":"DRV-17l.6","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-09T16:16:52.2788636+09:00","created_by":"Matt"}],"comments":[{"id":17,"issue_id":"DRV-17l.6","author":"Matt","text":"Verification note: applied missing auth schema to runtime DB using drizzle-kit push. Confirmed table public.rate_limit exists via to_regclass query. Post-fix auth probes returned 200 for manager and driver sign-in; login 500 is no longer reproducible.","created_at":"2026-02-09T07:43:37Z"}]}
{"id":"DRV-17l.7","title":"Fix Better Auth password and reset hardening gaps","description":"Implement fixes from audit-api-auth-security: replace custom /api/users/password hashing with Better Auth-compatible flow; make forgot/reset routes usable while signed out with query-preserving redirects; retarget reset rate-limit and 429 monitoring to /request-password-reset; split trustedOrigins by environment.","acceptance_criteria":"Password changes remain sign-in compatible with Better Auth; signed-out reset flow works end-to-end; reset endpoint throttling is verified on the live path; trusted origins are environment-scoped and documented.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:34:46.8547786+09:00","created_by":"Matt","updated_at":"2026-02-10T15:04:05.2241958+09:00","closed_at":"2026-02-10T15:04:05.2241958+09:00","close_reason":"Closed","labels":["audit-2026-02-10","auth","nightly-remediation","security"],"dependencies":[{"issue_id":"DRV-17l.7","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:34:46.860977+09:00","created_by":"Matt"}],"comments":[{"id":31,"issue_id":"DRV-17l.7","author":"Matt","text":"Source: ralph/plans/DRV-17l.7.md | Plan drafted and reviewed; entering implementation.","created_at":"2026-02-10T05:47:06Z"},{"id":32,"issue_id":"DRV-17l.7","author":"Matt","text":"Implemented auth hardening changes and added tests; pnpm test, svelte-check, and pnpm validate all pass.","created_at":"2026-02-10T05:58:43Z"},{"id":33,"issue_id":"DRV-17l.7","author":"Matt","text":"Browser verification (agent-browser) complete: /sign-in shows Forgot password link; signed-out /forgot-password and /reset-password?token=... are accessible; protected-route redirect preserves query (/app/settings?from=security\u0026x=1 -\u003e /sign-in?redirect=%2Fapp%2Fsettings%3Ffrom%3Dsecurity%26x%3D1). API probe confirms /api/auth/request-password-reset responds and rate-limits with 429; legacy /api/auth/forget-password returns 404. Evidence screenshots: logs/nightly/2026-02-10/drv-17l7-sign-in.png, logs/nightly/2026-02-10/drv-17l7-reset-public.png, logs/nightly/2026-02-10/drv-17l7-query-preserved-redirect.png","created_at":"2026-02-10T06:03:47Z"},{"id":35,"issue_id":"DRV-17l.7","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/92","created_at":"2026-02-10T06:22:28Z"}]}
{"id":"DRV-17l.8","title":"Close onboarding allowlist TOCTOU and consume atomically","description":"Implement fixes from audit-services-notifications-onboarding and audit-api-management: make production signup authorization and onboarding consume atomic (or compensating rollback on consume failure), add DB-level uniqueness for pending onboarding entries, and normalize malformed onboarding JSON to explicit 400 responses.","acceptance_criteria":"Production allowlist cannot create unauthorized accounts through race/revoke windows; pending onboarding duplicates are prevented at DB level; malformed JSON returns controlled 400 error contract.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:34:52.70702+09:00","created_by":"Matt","updated_at":"2026-02-10T16:04:27.0509065+09:00","closed_at":"2026-02-10T16:04:27.0509065+09:00","close_reason":"Closed","labels":["audit-2026-02-10","nightly-remediation","onboarding","security"],"dependencies":[{"issue_id":"DRV-17l.8","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:34:52.7145461+09:00","created_by":"Matt"}],"comments":[{"id":34,"issue_id":"DRV-17l.8","author":"Matt","text":"Source: ralph/plans/DRV-17l.8.md | Plan drafted and reviewer-approved (Ready). Beginning implementation next.","created_at":"2026-02-10T06:12:30Z"},{"id":36,"issue_id":"DRV-17l.8","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/93","created_at":"2026-02-10T07:05:47Z"}]}
{"id":"DRV-17l.9","title":"Make bidding lifecycle race-safe and window-scoped","description":"Implement fixes from audit-services-bidding and audit-api-bidding: enforce single-open-window creation atomically; lock and conditionally transition resolve/assign/close mutations; add bidWindowId linkage for bids and scope duplicate checks to active windows; enforce one-shift-per-driver-per-date at DB level with deterministic conflict handling.","acceptance_criteria":"Concurrent bidding and manager mutations cannot produce duplicate open windows, double winners, or stale overwrites; reopened windows remain biddable correctly; DB constraints prevent duplicate active assignments per driver/day.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T09:34:58.1236204+09:00","created_by":"Matt","updated_at":"2026-02-10T10:08:18.0056916+09:00","closed_at":"2026-02-10T10:08:18.0056916+09:00","close_reason":"Implemented bidding race-safety, window scoping, and DB constraints with full test pass","labels":["audit-2026-02-10","bidding","concurrency","nightly-remediation"],"dependencies":[{"issue_id":"DRV-17l.9","depends_on_id":"DRV-17l","type":"parent-child","created_at":"2026-02-10T09:34:58.1291777+09:00","created_by":"Matt"}]}
{"id":"DRV-1bl","title":"createBidWindow non-atomic: assignment unfilled before bid-window insert","description":"createBidWindow mutates assignment to unfilled and writes audit before bid-window insert. On insert failure, side effects commit without replacement window. Source: logs/nightly/2026-02-18/drv-xnb.1-delta-reverification-critical-high.md finding #1, drv-xnb.3 findings #2-3.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:00:26.0877637+09:00","created_by":"Matt","updated_at":"2026-02-18T13:14:53.5633598+09:00","closed_at":"2026-02-18T13:14:53.5633598+09:00","close_reason":"Implemented transactional createBidWindow core and added regression tests","labels":["atomicity","auto-drop","bidding"],"dependencies":[{"issue_id":"DRV-1bl","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:48.947374+09:00","created_by":"unknown"}],"comments":[{"id":54,"issue_id":"DRV-1bl","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/158","created_at":"2026-02-18T04:17:27Z"}]}
{"id":"DRV-1gdu","title":"Late-cancel penalty boundaries anchored to global 07:00, not per-route start time","description":"Confirmation/late-cancel deadline built from fixed shift hour. Cancel API does not load route start time for lifecycle evaluation. Need to plumb routeStartTime through cancellation/lifecycle and align penalty/bid-window boundary decisions to route-level shift start. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.7 audit)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:10:29.3775539+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:15.522855+09:00","closed_at":"2026-02-18T22:55:15.522855+09:00","close_reason":"Covered by DRV-brh implementation (PR #167): route-specific start time now drives late-cancel boundary.","labels":["cancellation","routes","scheduling"],"dependencies":[{"issue_id":"DRV-1gdu","depends_on_id":"DRV-5zym","type":"parent-child","created_at":"2026-02-18T12:47:07.7632632+09:00","created_by":"unknown"}]}
{"id":"DRV-1q46","title":"Add Playwright UI-* critical journey e2e suite","description":"DRV-b1l.6 Audit Finding #4: Selected UI e2e journeys (Playwright) are missing. No tests/e2e files were found, and no Playwright config file exists. A UI witness runner exists but it is agent-browser automation, not Playwright suite coverage as specified in the implementation plan. Add selected UI-* critical journeys under a formal e2e suite (tests/e2e/*.spec.ts) for manager override and driver critical flows, with deterministic seed/clock setup. Wire the new API/UI suite into CI so the smoke/full split validates Milestone C outcomes. Source: logs/nightly/2026-02-18/drv-b1l.6-api-and-critical-ui-multi-tenant-journeys-audit.md","notes":"Implemented in PR #177: introduced Playwright critical journeys (UI-001, UI-002), deterministic DB seeding harness, smoke script, and CI integration for Playwright smoke.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:26.3390129+09:00","created_by":"Matt","updated_at":"2026-02-18T23:33:40.0605669+09:00","closed_at":"2026-02-18T23:33:40.0605669+09:00","close_reason":"Completed in merged PR #177","labels":["e2e-testing","playwright","ui"],"dependencies":[{"issue_id":"DRV-1q46","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:51.0931771+09:00","created_by":"unknown"}]}
{"id":"DRV-1s7","title":"Witness PASS can mask upstream cron FAIL","description":"Witness runner only warns when cron report shows FAIL but continues. Witness overall.passed is computed only from witness flow checks, not from cron report verdict. Same date can show cron FAIL while witness returns PASS/exit 0. Source: logs/nightly/2026-02-18/drv-xnb.11-nightly-orchestrator-result-report-consistency-audit.md Finding 3","status":"closed","priority":2,"issue_type":"bug","assignee":"drive","created_at":"2026-02-18T12:05:24.2053623+09:00","created_by":"Matt","updated_at":"2026-02-19T11:11:16.1821853+09:00","closed_at":"2026-02-19T11:10:55.5689725+09:00","close_reason":"Closed","external_ref":"https://github.com/orro3790/drive/pull/183","labels":["nightly","observability","testing"]}
{"id":"DRV-1sft","title":"Nightly 2026-02-18: FCM Notification Reliability","description":"Parent epic for FCM/notification reliability findings from nightly audit 2026-02-18. High: missing error taxonomy, token cleanup, delivery metrics.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-18T12:45:12.8777048+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:21.4037078+09:00","closed_at":"2026-02-18T22:55:21.4037078+09:00","close_reason":"All FCM reliability child findings are now implemented and closed.","labels":["fcm","nightly-audit","notifications","observability"]}
{"id":"DRV-1xt","title":"Create nightly orchestrator script","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Files to Modify section 5)\n\n## Objective\nCreate an orchestrator script that runs all nightly drills in sequence.\n\n## File to Create\nscripts/nightly/orchestrate.ts (~80 lines)\n\n## Implementation\n\n### 1. Imports\n```typescript\nimport { execSync, spawnSync } from 'child_process';\nimport { existsSync, mkdirSync, writeFileSync } from 'fs';\nimport { join } from 'path';\n```\n\n### 2. Date/Log Directory Setup\n```typescript\nconst today = new Date().toISOString().slice(0, 10);\nconst logDir = join(process.cwd(), 'logs', 'nightly', today);\nif (!existsSync(logDir)) mkdirSync(logDir, { recursive: true });\n```\n\n### 3. Run Function\n```typescript\nfunction runDrill(name: string, command: string): { passed: boolean; duration: number } {\n  const start = Date.now();\n  console.log(`\\n=== Running ${name} ===\\n`);\n  try {\n    execSync(command, { stdio: 'inherit', cwd: process.cwd() });\n    return { passed: true, duration: Date.now() - start };\n  } catch (err) {\n    console.error(`${name} failed`);\n    return { passed: false, duration: Date.now() - start };\n  }\n}\n```\n\n### 4. Drill Sequence\n```typescript\nconst results: Record\u003cstring, { passed: boolean; duration: number }\u003e = {};\n\n// 1. Cron E2E (seeds + tests cron automation)\nresults.cronE2E = runDrill('Cron E2E', 'pnpm nightly:cron-e2e');\n\n// 2. Lifecycle E2E (reuses seed, tests driver endpoints)\nresults.lifecycleE2E = runDrill('Lifecycle E2E', 'pnpm nightly:lifecycle-e2e');\n\n// 3. Witness UI (optional — only if dev server running)\nconst devServerRunning = checkDevServer(); // fetch http://localhost:5173/\nif (devServerRunning) {\n  results.witnessUI = runDrill('Witness UI', 'pnpm nightly:witness-ui');\n} else {\n  console.log('\\n=== Skipping Witness UI (dev server not detected) ===\\n');\n  results.witnessUI = { passed: true, duration: 0 }; // skip is not failure\n}\n```\n\n### 5. Dev Server Check\n```typescript\nasync function checkDevServer(): Promise\u003cboolean\u003e {\n  try {\n    const res = await fetch('http://localhost:5173/', { \n      method: 'HEAD',\n      signal: AbortSignal.timeout(2000)\n    });\n    return res.ok || res.status === 302;\n  } catch {\n    return false;\n  }\n}\n```\n\n### 6. Summary Report\n```typescript\nconst allPassed = Object.values(results).every(r =\u003e r.passed);\nconst summary = {\n  date: today,\n  passed: allPassed,\n  drills: results\n};\n\nwriteFileSync(join(logDir, 'orchestrator-summary.json'), JSON.stringify(summary, null, 2));\nconsole.log('\\n=== Orchestrator Summary ===');\nconsole.log(JSON.stringify(summary, null, 2));\n\nprocess.exit(allPassed ? 0 : 1);\n```\n\n### 7. package.json — add script\n\"nightly\": \"tsx scripts/nightly/orchestrate.ts\"\n\n## Dependencies\n- DRV-w6x (all test scenarios implemented)\n\n## Acceptance Criteria\n- [ ] orchestrate.ts created and compiles\n- [ ] pnpm nightly runs both drills in sequence\n- [ ] Skips witness-ui gracefully if dev server not running\n- [ ] Exit code reflects overall pass/fail\n- [ ] Summary written to logs/nightly/{date}/orchestrator-summary.json","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:44:47.4789914+09:00","created_by":"Matt","updated_at":"2026-02-14T21:11:48.1467466+09:00","closed_at":"2026-02-14T21:11:48.1467466+09:00","close_reason":"Implemented orchestrator; pnpm nightly passes cron + lifecycle (witness skipped when script missing).","dependencies":[{"issue_id":"DRV-1xt","depends_on_id":"DRV-w6x","type":"blocks","created_at":"2026-02-14T19:45:37.5632603+09:00","created_by":"Matt"}]}
{"id":"DRV-1yr","title":"API error envelope contract fragmented across endpoints","description":"Error envelopes vary ({message}, {error}, {code+message}) across API surface with no single contract. Affects onboarding, password, profile, override, route stores, bid stores, account settings. Source: logs/nightly/2026-02-18/drv-xnb.9-api-input-and-error-contract-consistency-audit.md Finding 3","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:03:27.8271362+09:00","created_by":"Matt","updated_at":"2026-02-18T12:03:27.8271362+09:00","labels":["api","dx","error-handling"]}
{"id":"DRV-20m","title":"SSE real-time updates for manager","description":"Source: docs/specs/SPEC.md § Real-Time Updates (SSE)\n\n## Objective\nImplement Server-Sent Events endpoint for real-time manager dashboard updates.\n\n## Scope\n- SSE endpoint at src/routes/api/sse/manager/+server.ts\n- Events to push:\n  - assignment:updated (status changes)\n  - bid_window:opened (new bid window)\n  - bid_window:closed (bid resolved)\n  - driver:flagged (driver flagged)\n- Client-side: connect on manager dashboard load, update UI on events\n- Connection handling: 30-second heartbeat, auto-reconnect\n\n## Spec References\n- docs/specs/SPEC.md: Lines 319-340 (Real-Time Updates section)\n- docs/specs/SPEC.md: Lines 35 (SSE in tech stack)\n\n## Acceptance Criteria\n- SSE endpoint returns text/event-stream content type\n- Only authenticated managers can connect\n- Events sent when assignments/bids/flags change\n- Heartbeat every 30 seconds (\":keepalive\" comment)\n- Client auto-reconnects on disconnect\n- Dashboard tables update without page refresh\n- Multiple manager connections supported\n\n## Technical Constraints\n- SvelteKit streaming response pattern\n- Store active connections (Map or Set)\n- Broadcast function called from other services when data changes\n- Manager role check on connection\n- Proper cleanup on disconnect","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:30:33.4530988+09:00","created_by":"Matt","updated_at":"2026-02-05T12:56:08.8581361+09:00","closed_at":"2026-02-05T12:56:08.8581361+09:00","close_reason":"Closed","labels":["checkpoint"],"dependencies":[{"issue_id":"DRV-20m","depends_on_id":"DRV-zxp","type":"blocks","created_at":"2026-02-02T21:30:33.4588779+09:00","created_by":"Matt"}]}
{"id":"DRV-22t7","title":"Wire health scenarios into consistent evidence contract for runbook triage","description":"DRV-b1l.4 Audit Finding #5: Health failure diagnostics do not meet the full scenario-evidence contract. Plan/runbook expects scenario-level outputs with scenarioId, invariantId, organizationUnderTest, keyEntityIds, and evidence rows/snapshots. Lifecycle report model tracks status/statusCode/message/keyEntityIds but not invariant-level evidence objects. Wire health scenarios into a consistent evidence contract by capturing per-failure DB snapshots using scenarioId/invariantId keys suitable for runbook triage. Source: logs/nightly/2026-02-18/drv-b1l.4-health-scoring-and-intervention-e2e-matrix-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:08:07.6896374+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:06.4784888+09:00","closed_at":"2026-02-19T19:54:06.4784888+09:00","close_reason":"Closed","labels":["diagnostics","e2e-testing","health"]}
{"id":"DRV-2au","title":"Spec: Android update pipeline contract","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Treat ralph/plans/MOB-android-update-pipeline.md as the canonical contract for Android update discovery.\n- Ensure the policy choices are explicit and stable (no prereleases, versionCode scheme, asset selection, caching, fallback).\n\nImplementation Details\n- Review/update ralph/plans/MOB-android-update-pipeline.md to ensure it includes:\n  - Prerelease policy: stable releases only via GitHub /releases/latest.\n  - Tag parsing rules: accept vX.Y.Z or X.Y.Z only.\n  - versionCode formula: major*10000 + minor*100 + patch; constraints documented.\n  - Deterministic asset selection priority.\n  - /api/app-version contract: JSON shape + caching headers.\n  - /download contract: must point to tag-scoped URL; if redirect, no-store.\n  - GitHub request headers + timeout + optional GITHUB_TOKEN.\n  - Fallback rules: last-known-good cache, else 503 with Retry-After.\n  - CI requirement: verify APK embedded versionName/versionCode matches tag.\n\nDependencies\n- None\n\nAcceptance Criteria\n- ralph/plans/MOB-android-update-pipeline.md exists, is accurate, and is referenced by all implementation issues below.","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-02-15T22:56:08.3985191+09:00","created_by":"Matt","updated_at":"2026-02-19T19:18:32.4978929+09:00","closed_at":"2026-02-19T19:18:32.4978929+09:00","close_reason":"Closed"}
{"id":"DRV-2w2","title":"Create lifecycle E2E infrastructure files","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Files to Create sections 2-4)\n\n## Objective\nSet up Vitest configuration and setup files for the lifecycle E2E test suite.\n\n## Files to Create\n\n### 1. scripts/nightly/lifecycle-e2e.setup.ts\nCopy of cron-e2e.setup.ts — vi.mock of $lib/server/db to use node-postgres Pool:\n```typescript\nimport { vi } from 'vitest';\n\nvi.mock('$lib/server/db', async () =\u003e {\n  const { config } = await import('dotenv');\n  config();\n  const { Pool } = await import('pg');\n  const { drizzle } = await import('drizzle-orm/node-postgres');\n  const schema = await import('$lib/server/db/schema');\n  const databaseUrl = process.env.DATABASE_URL;\n  if (!databaseUrl) throw new Error('[lifecycle-e2e] DATABASE_URL is not set');\n  console.info('[lifecycle-e2e] DB client: node-postgres (vi.mock)');\n  const pool = new Pool({ connectionString: databaseUrl });\n  return { db: drizzle(pool, { schema }) };\n});\n```\n\n### 2. vitest.lifecycle-e2e.config.ts (project root)\nSame structure as vitest.cron-e2e.config.ts:\n- plugins: paraglideVitePlugin + sveltekit\n- include: scripts/nightly/lifecycle-e2e.test.ts\n- setupFiles: scripts/nightly/lifecycle-e2e.setup.ts\n- testTimeout/hookTimeout: 12 minutes\n- pool: forks, maxWorkers: 1, fileParallelism: false, isolate: true\n\n### 3. package.json — add script\n\"nightly:lifecycle-e2e\": \"cross-env NIGHTLY_LIFECYCLE_E2E=1 vitest run -c vitest.lifecycle-e2e.config.ts\"\n\n## Dependencies\nNone (first bead)\n\n## Acceptance Criteria\n- [ ] scripts/nightly/lifecycle-e2e.setup.ts exists\n- [ ] vitest.lifecycle-e2e.config.ts exists at project root\n- [ ] package.json has nightly:lifecycle-e2e script\n- [ ] pnpm nightly:lifecycle-e2e fails with \"no tests found\" (expected until test file created)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:41:35.8864061+09:00","created_by":"Matt","updated_at":"2026-02-14T19:54:50.87281+09:00","closed_at":"2026-02-14T19:54:50.87281+09:00","close_reason":"Closed"}
{"id":"DRV-34m","title":"Phase 1: Mandatory Confirmations + Bidding Window Overhaul","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1)\n\nIntroduce mandatory shift confirmations and overhaul the bidding window system.\n\nDrivers must manually confirm shifts 48h before start (confirmable up to 7 days out).\nUnconfirmed shifts are auto-dropped, opening a competitive bidding window.\nBid windows use a 24-hour competitive phase followed by instant (FCFS) fallback.\n\nKey outcomes:\n- Unreliable commitments caught 48h in advance\n- Longer bid windows (24h competitive vs current 30min)\n- Instant assignment when \u003c24h remains\n- New metrics: confirmation rate, auto-drops, late cancellations, bid pickups\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-06T17:09:15.9820488+09:00","created_by":"Matt","updated_at":"2026-02-06T18:16:38.074711+09:00","closed_at":"2026-02-06T18:16:38.074711+09:00","close_reason":"Closed"}
{"id":"DRV-34m.1","title":"Schema migration: confirmations + bidding overhaul","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e Schema Changes)\n\nDatabase schema migration for the confirmation and bidding overhaul.\n\n## Changes\n\n### assignments table — add column:\n- `confirmedAt` timestamp(tz) nullable — when driver manually confirmed\n\n### bidWindows table — add columns + relax constraint:\n- `mode` enum('competitive','instant','emergency') default 'competitive' — new pgEnum `bid_window_mode`\n- `trigger` text nullable — values: 'cancellation', 'auto_drop', 'no_show', 'manager'\n- `payBonusPercent` integer default 0 — e.g. 20 for emergency routes\n- DROP UNIQUE constraint on `assignmentId` (allows multiple bid rounds per assignment)\n\n### driverMetrics table — add columns:\n- `totalAssigned` integer default 0\n- `confirmedShifts` integer default 0\n- `autoDroppedShifts` integer default 0\n- `lateCancellations` integer default 0\n- `noShows` integer default 0\n- `bidPickups` integer default 0\n\n### notificationTypeEnum — add values:\n- 'confirmation_reminder'\n- 'shift_auto_dropped'\n- 'emergency_route_available'\n\n## Files to modify\n- `src/lib/server/db/schema.ts` — all changes above\n\n## Implementation\n1. Add `bidWindowModeEnum` pgEnum\n2. Add columns to assignments, bidWindows, driverMetrics tables\n3. Add new values to notificationTypeEnum\n4. Remove `.unique()` from bidWindows.assignmentId\n5. Run `pnpm drizzle-kit generate` to create migration SQL\n6. Run `pnpm drizzle-kit migrate` to apply\n\n## Acceptance criteria\n- Migration generates cleanly with `drizzle-kit generate`\n- Migration applies to Neon without errors\n- All existing data is preserved (new columns have defaults or are nullable)\n- TypeScript types are updated and app compiles without errors\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:09:51.0364727+09:00","created_by":"Matt","updated_at":"2026-02-06T17:26:28.7632901+09:00","closed_at":"2026-02-06T17:26:28.7632901+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.1","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:09:51.0420039+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.10","title":"Schedule page UI: confirm button + status badges","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e UI Changes \u003e Schedule page)\n\nAdd confirmation UI to the driver schedule page.\n\n## File: src/routes/(driver)/schedule/+page.svelte\n\n### Changes to assignment cards:\n\nEach scheduled assignment card should show confirmation state based on timing:\n\n1. **7+ days out** (before confirmation window opens):\n   - Grey Chip: \"Confirmation opens {opensAt date}\"\n   - No action button\n\n2. **2-7 days out** (within confirmation window, not confirmed):\n   - Yellow/amber Chip: \"Confirm by {deadline date}\"\n   - Prominent \"Confirm\" Button (variant=\"primary\", fill)\n   - On click: call scheduleStore.confirmShift(assignmentId)\n\n3. **Confirmed**:\n   - Green Chip: \"Confirmed\" (with checkmark icon)\n   - No action button needed\n\n4. **Past deadline (auto-dropped)**:\n   - Assignment will have status='unfilled', won't show for this driver\n\n### Implementation notes:\n- Use existing Chip component from src/lib/components/primitives/Chip.svelte\n- Use existing Button component\n- Derive confirmation state from assignment.confirmedAt, confirmationOpensAt, confirmationDeadline\n- Follow existing card layout pattern (route name, warehouse, date, status)\n\n## File: src/lib/stores/scheduleStore.svelte.ts\n\n### Add confirmShift method:\n- Similar to dashboardStore.confirmShift\n- POST /api/assignments/{id}/confirm\n- Update local assignment state on success\n- Show toast\n\n## Dependencies\n- Dashboard API + store (confirmation data in response)\n- Confirmation service + endpoint\n\n## Acceptance criteria\n- Assignments show correct confirmation state based on timing\n- Confirm button only appears within 7-day to 48h window\n- Clicking Confirm calls API, updates UI to show \"Confirmed\" badge\n- Toast shown on success/failure\n- Already-confirmed shifts show green badge, no button\n- Mobile-friendly layout (drivers use phones)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:12:07.5675361+09:00","created_by":"Matt","updated_at":"2026-02-06T17:45:25.5951877+09:00","closed_at":"2026-02-06T17:45:25.5951877+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.10","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:12:07.6169738+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.10","depends_on_id":"DRV-34m.9","type":"blocks","created_at":"2026-02-06T17:15:25.1436311+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.11","title":"Dashboard UI: needs-confirmation section","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e UI Changes \u003e Dashboard)\n\nAdd a \"Needs Confirmation\" section to the driver dashboard.\n\n## File: src/routes/(driver)/dashboard/+page.svelte\n\n### New section: placed between \"Today's Shift\" and \"This Week\" summary\n\nConditionally rendered when dashboardStore.unconfirmedShifts.length \u003e 0.\n\n### Layout:\n- Section heading: \"Needs Confirmation\" with a warning icon\n- Card per unconfirmed shift:\n  - Route name, warehouse name, date (formatted like existing cards)\n  - Countdown: \"Confirm by {deadline}\" with relative time (\"in 2 days\")\n  - Prominent \"Confirm\" button (Button variant=\"primary\", fill)\n  - On click: dashboardStore.confirmShift(assignmentId)\n\n### Behavior:\n- When confirmed, card animates out / disappears from the list\n- If all confirmed, section disappears\n- Toast notification on success: \"Shift confirmed!\"\n\n### Design:\n- Use existing design tokens (var(--status-warning) for section accent)\n- Use existing NoticeBanner or card pattern\n- Mobile-first: full-width cards, large tap targets\n\n## Dependencies\n- Dashboard API + store (unconfirmedShifts data)\n\n## Acceptance criteria\n- Section appears only when there are unconfirmed shifts\n- Each card shows route, warehouse, date, deadline countdown\n- Confirm button calls API, removes card from list\n- Section disappears when all shifts confirmed\n- Works on mobile (large buttons, readable text)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:12:16.0352924+09:00","created_by":"Matt","updated_at":"2026-02-06T17:50:36.0155128+09:00","closed_at":"2026-02-06T17:50:36.0155128+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.11","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:12:16.0388944+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.11","depends_on_id":"DRV-34m.9","type":"blocks","created_at":"2026-02-06T17:15:25.9340649+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.2","title":"Confirmation service + API endpoint","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e API Endpoints)\n\nCreate the shift confirmation service and REST endpoint.\n\n## New service: src/lib/server/services/confirmations.ts\n\n### calculateConfirmationDeadline(assignmentDate: string)\n- Input: assignment date string 'YYYY-MM-DD'\n- Shift start = parseISO(date) at 07:00 Toronto time\n- Returns { opensAt: shiftStart - 7 days, deadline: shiftStart - 48 hours }\n- Use date-fns-tz for Toronto timezone handling (same pattern as noshow.ts)\n\n### confirmShift(assignmentId: string, userId: string)\n- Validate assignment exists and belongs to userId\n- Validate assignment.status = 'scheduled'\n- Validate confirmedAt IS NULL (not already confirmed)\n- Calculate confirmation window, validate current time is between opensAt and deadline\n- Set assignments.confirmedAt = now()\n- Create audit log entry\n- Return success\n\n### getUnconfirmedAssignments(userId: string)\n- Query assignments where: status='scheduled', userId=userId, confirmedAt IS NULL\n- Join with routes for route name\n- For each, calculate confirmation window timing\n- Return only those within the confirmation window (opensAt \u003c= now \u003c= deadline)\n\n## New endpoint: POST /api/assignments/[id]/confirm\n\nFile: src/routes/api/assignments/[id]/confirm/+server.ts\n\n- Auth: driver only (locals.user.role === 'driver')\n- Validate locals.user.id owns the assignment\n- Call confirmShift(params.id, locals.user.id)\n- Return json({ success: true, confirmedAt: \u003ctimestamp\u003e })\n- Error 400 if outside confirmation window with message explaining when window opens/closes\n- Error 400 if already confirmed\n\n## Dependencies\n- Schema migration (DRV-34m child: confirmedAt column must exist)\n\n## Acceptance criteria\n- Confirming a shift 5 days out succeeds\n- Confirming a shift 8 days out returns 400 \"Confirmation window not yet open\"\n- Confirming a shift 1 day out returns 400 \"Confirmation deadline has passed\"\n- Confirming an already-confirmed shift returns 400\n- Confirming another driver's shift returns 403\n- confirmedAt is set in the database after successful confirmation\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:10:03.8298236+09:00","created_by":"Matt","updated_at":"2026-02-06T17:28:38.9257496+09:00","closed_at":"2026-02-06T17:28:38.9257496+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.2","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:10:03.8347854+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.2","depends_on_id":"DRV-34m.1","type":"blocks","created_at":"2026-02-06T17:15:18.0667867+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.3","title":"Bidding service overhaul: mode system + instant resolution","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e Bidding Service Changes)\n\nOverhaul the bidding service to support competitive, instant, and emergency modes.\n\n## File: src/lib/server/services/bidding.ts\n\n### Modify createBidWindow(assignmentId, options)\n\nCurrent signature: createBidWindow(assignmentId: string, options?: { allowPastShift?: boolean })\n\nNew options interface:\n```typescript\ninterface CreateBidWindowOptions {\n  mode?: 'competitive' | 'instant' | 'emergency';\n  trigger?: 'cancellation' | 'auto_drop' | 'no_show' | 'manager';\n  payBonusPercent?: number;\n  allowPastShift?: boolean;\n}\n```\n\nChanges:\n1. Accept mode, trigger, payBonusPercent parameters\n2. Change existing window check (lines 143-150): filter by `status = 'open'` instead of any window\n   - Old: `eq(bidWindows.assignmentId, assignmentId)`\n   - New: `and(eq(bidWindows.assignmentId, assignmentId), eq(bidWindows.status, 'open'))`\n3. Mode selection at creation time:\n   - If mode explicitly provided, use it\n   - Else if time until shift \u003e 24h → competitive\n   - Else → instant\n4. closesAt calculation (replace calculateWindowClosesAt):\n   - Competitive: shiftDate 07:00 minus 24 hours\n   - Instant: shiftDate 07:00 (shift start time)\n   - Emergency: shiftDate 07:00 (or end of day if shift already started)\n5. Store mode, trigger, payBonusPercent on the bidWindow record\n6. For emergency mode, call notifyAvailableDriversForEmergency() instead of notifyEligibleDrivers()\n\n### New function: transitionToInstantMode(windowId: string)\n- Update bidWindow: mode = 'instant', closesAt = shift start time\n- Send fresh 'bid_open' notification to eligible drivers (not already bid)\n- Create audit log entry\n\n### Modify resolveBidWindow(bidWindowId)\n- Competitive mode: existing scored resolution (no change)\n- Add handling: if competitive window has no bids, call transitionToInstantMode() instead of closing\n\n### New function: instantAssign(assignmentId, userId, window)\n- Used by bid placement endpoint for instant/emergency mode\n- In a transaction with SELECT FOR UPDATE on bidWindow:\n  1. Verify window.status = 'open'\n  2. Create bid with status = 'won'\n  3. Update assignment: userId = winner, status = 'scheduled', assignedBy = 'bid'\n  4. Update bidWindow: status = 'resolved', winnerId = userId\n  5. Delete any incomplete shift record for this assignment (for reassignment cases)\n  6. Mark all other pending bids as 'lost'\n  7. Send bid_won notification to winner, bid_lost to losers\n  8. Increment bidPickups metric for winner\n  9. Return { instantlyAssigned: true, bid, assignment }\n\n## Dependencies\n- Schema migration (mode column, trigger column, payBonusPercent column)\n\n## Acceptance criteria\n- createBidWindow with \u003e24h remaining creates competitive window\n- createBidWindow with \u003c24h remaining creates instant window\n- createBidWindow with explicit emergency mode creates emergency window\n- Existing open window blocks new window creation\n- Resolved/closed windows do NOT block new window creation\n- transitionToInstantMode updates mode and closesAt\n- instantAssign atomically assigns driver and closes window\n- Concurrent instantAssign calls: first wins, second gets error\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:10:25.5758713+09:00","created_by":"Matt","updated_at":"2026-02-06T17:34:30.0261915+09:00","closed_at":"2026-02-06T17:34:30.0261915+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.3","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:10:25.5907301+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.3","depends_on_id":"DRV-34m.1","type":"blocks","created_at":"2026-02-06T17:15:18.8391254+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.4","title":"Bid placement endpoint: instant mode support","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e API Endpoints \u003e POST /api/bids)\n\nModify the bid placement endpoint to support instant and emergency mode assignment.\n\n## File: src/routes/api/bids/+server.ts\n\n### Current behavior (lines 16-122):\n- Validates driver, checks flagged status, checks weekly cap\n- Finds open bid window, checks not expired\n- Creates pending bid\n- Returns bid details\n\n### New behavior:\nAfter the existing validation (flagged check, weekly cap, duplicate bid check), add mode-aware logic:\n\n1. Fetch bidWindow with mode field (add to SELECT at line 52-58)\n2. Also check: if current time \u003c 24h before shift AND window.mode is still 'competitive', treat as instant (belt-and-suspenders for cron timing)\n3. If mode is 'competitive':\n   - Existing behavior: create pending bid, return { status: 'pending' }\n4. If mode is 'instant' or 'emergency':\n   - Call instantAssign() from bidding service (wraps in transaction with FOR UPDATE)\n   - Return { status: 'won', assignmentId, bonusPercent: window.payBonusPercent }\n   - If instantAssign throws (window already resolved): return 400 \"Route already assigned\"\n\n### Transaction safety for instant mode:\n- instantAssign() handles the transaction internally\n- SELECT ... FOR UPDATE on bidWindows row serializes concurrent requests\n- Second concurrent request sees window.status = 'resolved' → throws error\n- No duplicate winners possible\n\n## Dependencies\n- Bidding service overhaul (instantAssign function must exist)\n\n## Acceptance criteria\n- Bid on competitive window creates pending bid (status: pending)\n- Bid on instant window immediately assigns driver (status: won)\n- Bid on emergency window immediately assigns driver with bonusPercent\n- Two simultaneous bids on instant window: first wins, second gets 400\n- Bid on already-resolved window returns 400\n- Existing validations still work (flagged, weekly cap, duplicate bid)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:10:47.5698943+09:00","created_by":"Matt","updated_at":"2026-02-06T17:35:36.0364755+09:00","closed_at":"2026-02-06T17:35:36.0364755+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.4","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:10:47.5733033+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.4","depends_on_id":"DRV-34m.3","type":"blocks","created_at":"2026-02-06T17:15:21.5654206+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.5","title":"Cancel endpoint: late cancellation tracking","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e API Endpoints \u003e POST /api/assignments/[id]/cancel)\n\nModify the cancel endpoint to track late cancellations and create mode-appropriate bid windows.\n\n## File: src/routes/api/assignments/[id]/cancel/+server.ts\n\n### Changes:\n\n1. After existing validation, check for late cancellation:\n   ```typescript\n   const { deadline } = calculateConfirmationDeadline(assignment.date);\n   const now = new Date();\n   const isLateCancellation = assignment.confirmedAt \u0026\u0026 now \u003e deadline;\n   ```\n\n2. If late cancellation, increment lateCancellations metric:\n   ```typescript\n   if (isLateCancellation) {\n     await db.update(driverMetrics)\n       .set({ lateCancellations: sql`late_cancellations + 1` })\n       .where(eq(driverMetrics.userId, locals.user.id));\n   }\n   ```\n\n3. Create bid window with appropriate mode:\n   - Calculate time until shift start (date 07:00 Toronto)\n   - If \u003e 24h remaining: createBidWindow({ mode: 'competitive', trigger: 'cancellation' })\n   - If \u003c= 24h remaining: createBidWindow({ mode: 'instant', trigger: 'cancellation' })\n\n4. Include trigger in audit log changes object\n\n## Dependencies\n- Confirmation service (calculateConfirmationDeadline function)\n- Bidding service overhaul (mode parameter support)\n- Schema migration (lateCancellations column)\n\n## Acceptance criteria\n- Cancel \u003e 48h before shift: no lateCancellation increment, competitive bid window\n- Cancel \u003c 48h with confirmedAt set: lateCancellations incremented, bid window mode based on time\n- Cancel \u003c 24h before shift: instant bid window created\n- Cancel without confirmedAt: no lateCancellation increment (was never confirmed)\n- Audit log includes trigger='cancellation'\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:10:57.0171703+09:00","created_by":"Matt","updated_at":"2026-02-06T17:38:09.1220745+09:00","closed_at":"2026-02-06T17:38:09.1220745+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.5","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:10:57.0216037+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.5","depends_on_id":"DRV-34m.3","type":"blocks","created_at":"2026-02-06T17:15:22.3074991+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.5","depends_on_id":"DRV-34m.2","type":"blocks","created_at":"2026-02-06T17:15:23.6729113+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.6","title":"Cron: confirmation reminders (72h)","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e Cron Jobs)\n\nNew cron job to send confirmation reminders 72 hours before shift.\n\n## File: src/routes/api/cron/send-confirmation-reminders/+server.ts\n\n### Schedule: daily 11:00 UTC (06:00 Toronto EST / 07:00 EDT)\n\n### Logic:\n1. Verify CRON_SECRET header (same pattern as existing crons)\n2. Calculate target date = today + 3 days (Toronto time)\n3. Query assignments where:\n   - status = 'scheduled'\n   - userId IS NOT NULL\n   - confirmedAt IS NULL\n   - date = target date\n   - date \u003e= DEPLOYMENT_DATE (grandfathering filter)\n4. For each unconfirmed assignment:\n   - Join with routes table for route name\n   - Send 'confirmation_reminder' notification via sendNotification()\n   - Template: title=\"Confirm Your Shift\", body=\"Your shift on {date} at {routeName} needs confirmation within 24 hours.\"\n   - Include data: { assignmentId, routeName, date }\n5. Return json({ sent: count, date: targetDate })\n\n### Notification template addition:\nAdd to src/lib/server/services/notifications.ts NOTIFICATION_TEMPLATES:\n```typescript\nconfirmation_reminder: {\n  title: 'Confirm Your Shift',\n  body: 'Your upcoming shift needs confirmation within 24 hours.'\n}\n```\n\n### vercel.json addition:\n```json\n{ \"path\": \"/api/cron/send-confirmation-reminders\", \"schedule\": \"0 11 * * *\" }\n```\n\n## Dependencies\n- Schema migration (confirmedAt column, notification type)\n- Confirmation service (for deadline calculation reference)\n\n## Acceptance criteria\n- Cron sends notifications only for shifts exactly 3 days out\n- Notifications not sent for already-confirmed shifts\n- Notifications not sent for assignments without a driver\n- Notifications not sent for pre-deployment assignments\n- Push notification delivered via FCM\n- In-app notification record created\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:11:07.3116927+09:00","created_by":"Matt","updated_at":"2026-02-06T17:38:59.4625178+09:00","closed_at":"2026-02-06T17:38:59.4625178+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.6","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:11:07.3155307+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.6","depends_on_id":"DRV-34m.1","type":"blocks","created_at":"2026-02-06T17:15:19.7283936+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.7","title":"Cron: auto-drop unconfirmed shifts (48h)","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e Cron Jobs)\n\nNew cron job to auto-drop drivers who haven't confirmed within the 48h deadline.\n\n## File: src/routes/api/cron/auto-drop-unconfirmed/+server.ts\n\n### Schedule: hourly (0 * * * *)\n\n### Logic:\n1. Verify CRON_SECRET header\n2. Get current Toronto time\n3. Query assignments where:\n   - status = 'scheduled'\n   - userId IS NOT NULL\n   - confirmedAt IS NULL\n   - date \u003e= DEPLOYMENT_DATE (grandfathering)\n   - Shift start (date at 07:00 Toronto) minus now \u003c= 48 hours\n4. For each unconfirmed assignment past deadline:\n   a. Store original userId for metrics/notifications\n   b. Update assignment: status = 'unfilled' (keep userId for audit trail in audit_logs)\n   c. Increment autoDroppedShifts on original driver's driverMetrics\n   d. Create bid window: createBidWindow(assignmentId, { mode: 'competitive', trigger: 'auto_drop' })\n      - If \u003c 24h remaining, createBidWindow will auto-select instant mode\n   e. Send 'shift_auto_dropped' notification to original driver:\n      - Title: \"Shift Dropped\"\n      - Body: \"Your shift on {date} at {routeName} was dropped because it wasn't confirmed in time.\"\n   f. bid_open notifications sent by createBidWindow to eligible drivers\n   g. Create audit log: entityType='assignment', action='auto_drop', changes includes original userId\n5. Return json({ dropped: count, bidWindowsCreated: count })\n\n### Notification template addition:\nAdd to NOTIFICATION_TEMPLATES:\n```typescript\nshift_auto_dropped: {\n  title: 'Shift Dropped',\n  body: 'Your shift was dropped because it wasn\\'t confirmed in time.'\n}\n```\n\n### vercel.json addition:\n```json\n{ \"path\": \"/api/cron/auto-drop-unconfirmed\", \"schedule\": \"0 * * * *\" }\n```\n\n### DEPLOYMENT_DATE constant:\nDefine in src/lib/server/services/confirmations.ts:\n```typescript\nexport const CONFIRMATION_DEPLOYMENT_DATE = '2026-XX-XX'; // Set at rollout\n```\n\n## Dependencies\n- Schema migration (confirmedAt column, notification types)\n- Bidding service overhaul (mode parameter support)\n\n## Acceptance criteria\n- Assignments past 48h deadline without confirmation are dropped\n- Original driver receives shift_auto_dropped notification\n- Competitive bid window created (or instant if \u003c 24h)\n- Driver metrics updated (autoDroppedShifts incremented)\n- Pre-deployment assignments are skipped\n- Audit log created with auto_drop action\n- Already-unfilled assignments are not processed\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:11:28.017985+09:00","created_by":"Matt","updated_at":"2026-02-06T17:37:16.4757816+09:00","closed_at":"2026-02-06T17:37:16.4757816+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.7","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:11:28.0231634+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.7","depends_on_id":"DRV-34m.1","type":"blocks","created_at":"2026-02-06T17:15:20.8026762+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.8","title":"Cron: close-bid-windows overhaul (mode transitions)","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e Cron Jobs \u003e close-bid-windows)\n\nUpdate the close-bid-windows cron to handle mode transitions and run more frequently.\n\n## File: src/routes/api/cron/close-bid-windows/+server.ts\n\n### Schedule change: every 15 minutes (*/15 * * * *)\n\n### Updated logic:\n\n1. Query bid windows where status = 'open' AND closesAt \u003c= now\n\n2. For each expired window, handle by mode:\n\n   **Competitive windows (mode = 'competitive'):**\n   - If bids exist: call resolveBidWindow() (existing scored resolution)\n   - If NO bids: call transitionToInstantMode(windowId)\n     - Updates mode to 'instant'\n     - Sets new closesAt = shift start time (date 07:00 Toronto)\n     - Sends fresh bid_open notifications to eligible drivers\n     - Does NOT close the window\n\n   **Instant windows (mode = 'instant'):**\n   - closesAt has passed = shift time has passed\n   - Close window: status = 'closed', no winner\n   - Assignment stays 'unfilled'\n   - Send 'route_unfilled' manager alert\n\n   **Emergency windows (mode = 'emergency'):**\n   - Same as instant: close if past shift time, alert manager\n   - These should have been resolved at bid-placement time\n\n3. Return json({ resolved, transitioned, closed, errors })\n\n### vercel.json update:\nChange close-bid-windows schedule from \"0 0 * * *\" to \"*/15 * * * *\"\n\n## Dependencies\n- Bidding service overhaul (transitionToInstantMode function)\n- Schema migration (mode column)\n\n## Acceptance criteria\n- Competitive windows with bids: scored resolution (existing behavior preserved)\n- Competitive windows without bids: transition to instant mode, new closesAt set\n- Instant windows past closesAt: closed, manager alerted\n- Emergency windows past closesAt: closed, manager alerted\n- Cron runs every 15 minutes (vercel.json updated)\n- No duplicate processing (already-resolved windows skipped)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:11:38.8933656+09:00","created_by":"Matt","updated_at":"2026-02-06T17:40:02.1812626+09:00","closed_at":"2026-02-06T17:40:02.1812626+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.8","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:11:38.8984621+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.8","depends_on_id":"DRV-34m.3","type":"blocks","created_at":"2026-02-06T17:15:22.961156+09:00","created_by":"Matt"}]}
{"id":"DRV-34m.9","title":"Dashboard API + store: confirmation data","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 1 \u003e UI Changes)\n\nUpdate the dashboard API and store to include confirmation data.\n\n## File: src/routes/api/dashboard/+server.ts\n\n### Changes to GET /api/dashboard response:\n\n1. Add confirmedAt and confirmationDeadline to each assignment in todayShift, thisWeek, nextWeek:\n   ```typescript\n   // For each assignment, compute:\n   const { opensAt, deadline } = calculateConfirmationDeadline(assignment.date);\n   // Include in response:\n   confirmedAt: assignment.confirmedAt,\n   confirmationDeadline: deadline.toISOString(),\n   confirmationOpensAt: opensAt.toISOString(),\n   isConfirmable: !assignment.confirmedAt \u0026\u0026 now \u003e= opensAt \u0026\u0026 now \u003c= deadline,\n   ```\n\n2. Add new field to response: unconfirmedShifts\n   ```typescript\n   // Query: scheduled assignments for this driver within confirmation window, not yet confirmed\n   const unconfirmedShifts = await getUnconfirmedAssignments(userId);\n   ```\n\n3. Include unconfirmedShifts in response object\n\n## File: src/lib/stores/dashboardStore.svelte.ts\n\n### Add confirmation support:\n\n1. Add to state:\n   ```typescript\n   unconfirmedShifts: [] as DashboardAssignment[]\n   ```\n\n2. Update load() to store unconfirmedShifts from response\n\n3. New method: confirmShift(assignmentId: string)\n   - ensureOnlineForWrite() guard\n   - POST /api/assignments/{assignmentId}/confirm\n   - On success: remove from unconfirmedShifts, update assignment in thisWeek/nextWeek\n   - Toast: \"Shift confirmed!\"\n   - On error: toast error message\n\n## Dependencies\n- Confirmation service (calculateConfirmationDeadline, getUnconfirmedAssignments)\n- Schema migration (confirmedAt column)\n\n## Acceptance criteria\n- Dashboard response includes confirmedAt and confirmation timing for all assignments\n- isConfirmable is true only when within 7-day to 48h window and not yet confirmed\n- unconfirmedShifts array contains only assignments within confirmation window\n- Store confirmShift() calls API, updates local state, shows toast\n- Offline guard prevents confirmation when offline\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:11:49.7277213+09:00","created_by":"Matt","updated_at":"2026-02-06T17:42:20.6427229+09:00","closed_at":"2026-02-06T17:42:20.6427229+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-34m.9","depends_on_id":"DRV-34m","type":"parent-child","created_at":"2026-02-06T17:11:49.732751+09:00","created_by":"Matt"},{"issue_id":"DRV-34m.9","depends_on_id":"DRV-34m.2","type":"blocks","created_at":"2026-02-06T17:15:24.4339273+09:00","created_by":"Matt"}]}
{"id":"DRV-34w","title":"Scope routes API by warehouse access","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nUpdate src/routes/api/routes/+server.ts to filter routes by manager warehouse access and add managerId support.\n\n## Changes to GET /api/routes\n\n### Import manager service\n```typescript\nimport { getManagerWarehouseIds } from \"$lib/server/services/managers\";\n```\n\n### Filter by warehouse access\nBefore the query, get accessible warehouses:\n```typescript\nconst accessibleWarehouses = await getManagerWarehouseIds(locals.user.id);\n\nif (accessibleWarehouses.length === 0) {\n  return json({ routes: [], date });\n}\n```\n\nModify the base query to filter:\n```typescript\nconst baseQuery = db\n  .select({\n    id: routes.id,\n    name: routes.name,\n    warehouseId: warehouses.id,\n    warehouseName: warehouses.name,\n    managerId: routes.managerId,\n    createdAt: routes.createdAt,\n    updatedAt: routes.updatedAt\n  })\n  .from(routes)\n  .innerJoin(warehouses, eq(routes.warehouseId, warehouses.id))\n  .where(inArray(routes.warehouseId, accessibleWarehouses))\n  .orderBy(routes.name);\n```\n\n### Add isMyRoute flag to response\n```typescript\nconst routesWithStatus = routeRows\n  .map((route) =\u003e {\n    const assignment = assignmentMap.get(route.id);\n    const status = resolveStatus(assignment);\n    return {\n      ...route,\n      status,\n      isMyRoute: route.managerId === locals.user.id,\n      assignmentId: assignment?.assignmentId ?? null,\n      // ... rest unchanged\n    };\n  })\n```\n\n## Changes to POST /api/routes\n\n### Accept managerId in body\nUpdate routeCreateSchema in src/lib/schemas/route.ts:\n```typescript\nmanagerId: z.string().optional()\n```\n\n### Validate warehouse access\n```typescript\nconst canAccess = await canManagerAccessWarehouse(locals.user.id, warehouseId);\nif (!canAccess) {\n  throw error(403, \"No access to this warehouse\");\n}\n```\n\n### Set managerId on create\n```typescript\nconst [created] = await db\n  .insert(routes)\n  .values({\n    name,\n    warehouseId,\n    managerId: result.data.managerId ?? locals.user.id,\n    createdBy: locals.user.id\n  })\n  .returning();\n```\n\n## Files to Modify\n- src/routes/api/routes/+server.ts\n- src/lib/schemas/route.ts (add managerId to create schema)\n\n## Dependencies\n- DRV-4jy (manager access service)\n\n## Acceptance Criteria\n- [ ] GET only returns routes from accessible warehouses\n- [ ] GET returns empty array if no warehouse access\n- [ ] GET includes isMyRoute flag\n- [ ] POST validates warehouse access\n- [ ] POST accepts and saves managerId\n- [ ] POST defaults managerId to current user\n- [ ] Existing tests still pass","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:24:10.8220761+09:00","created_by":"Matt","updated_at":"2026-02-04T14:16:22.9505826+09:00","closed_at":"2026-02-04T14:16:22.9505826+09:00","dependencies":[{"issue_id":"DRV-34w","depends_on_id":"DRV-4jy","type":"blocks","created_at":"2026-02-04T11:26:25.1498536+09:00","created_by":"Matt"},{"issue_id":"DRV-34w","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:27.0869176+09:00","created_by":"Matt"}]}
{"id":"DRV-36d","title":"Better Auth integration","description":"Source: docs/specs/SPEC.md § Tech Stack, § Security\nPatterns: docs/agent-guidelines.md § Auth Guards\n\n## Objective\nComplete Better Auth integration with session-based authentication, role enforcement, and invite code signup gate.\n\n## Scope\n- Configure Better Auth in src/lib/server/auth.ts (partially exists)\n- Implement auth guards in src/hooks.server.ts\n- Create sign-in page at src/routes/(auth)/sign-in/+page.svelte\n- Create sign-up page at src/routes/(auth)/sign-up/+page.svelte\n- Implement invite code validation for driver signup (env: BETTER_AUTH_INVITE_CODE)\n- Set up auth client in src/lib/auth-client.ts\n\n## Spec References\n- docs/specs/SPEC.md: Lines 31 (Better Auth in tech stack)\n- docs/specs/SPEC.md: Lines 344-351 (Security requirements)\n- docs/agent-guidelines.md: Lines 240-278 (Auth guards pattern)\n- CLAUDE.md: § Better Auth Implementation (URL auto-detection)\n\n## Acceptance Criteria\n- Users can sign up with email/password (drivers require invite code)\n- Users can sign in and receive session cookie\n- Protected routes redirect to /sign-in if not authenticated\n- API routes return 401 if not authenticated\n- Session available in event.locals.user and event.locals.session\n- Role (driver/manager) accessible from session\n\n## Technical Constraints\n- Use $env/static/private for BETTER_AUTH_SECRET only\n- Use $env/dynamic/private for optional vars (BETTER_AUTH_URL, BETTER_AUTH_INVITE_CODE)\n- Trust origins: localhost:5173 and *.vercel.app","notes":"Fixed auth pages UI to match Snapgrade design system:\n- Added app.css import to root layout (was missing entirely)\n- Removed broken print.css import\n- Simplified auth layout to use design tokens instead of hardcoded hex colors\n- Rewrote InlineEditor component to match Snapgrade's .ie-row container pattern\n- Fixed button sizes from 'large' to 'standard'\n- Auth pages now have proper dark theme with radial gradient, bordered input containers, and accent-colored buttons","status":"closed","priority":0,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:22:34.2892226+09:00","created_by":"Matt","updated_at":"2026-02-03T01:40:24.4870924+09:00","closed_at":"2026-02-03T01:40:24.4870924+09:00","close_reason":"Better Auth integration complete. Added auth-schema.ts for Better Auth tables (user, session, account, verification). Sign-up requires invite code via x-invite-code header. Users have role field (default: driver). Protected routes redirect to /sign-in, API routes return 401.","dependencies":[{"issue_id":"DRV-36d","depends_on_id":"DRV-zq5","type":"blocks","created_at":"2026-02-02T21:22:34.309793+09:00","created_by":"Matt"}]}
{"id":"DRV-37q","title":"Create forgot-password page","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Create #3)\n\nCreate the forgot password request page.\n\nFILE TO CREATE: src/routes/(auth)/forgot-password/+page.svelte\n\nPATTERN REFERENCE: src/routes/(auth)/sign-in/+page.svelte (lines 1-254)\n\nCOMPONENT STRUCTURE:\n1. Script section with:\n   - Import authClient from $lib/auth-client\n   - Import InlineEditor, Button, Icon, NoticeBanner from components\n   - Import Mail, ArrowLeft icons\n   - Import * as m from $lib/paraglide/messages.js\n   - State: email, errorMessage, isSubmitting, isSuccess (all with $state())\n\n2. handleSubmit function:\n   - Guard: if (isSubmitting) return\n   - Set errorMessage = null, isSubmitting = true\n   - Call: authClient.requestPasswordReset({ email, redirectTo: window.location.origin + /reset-password })\n   - On error: set errorMessage from error.message or m.auth_forgot_password_error()\n   - On success: set isSuccess = true\n   - Finally: isSubmitting = false\n\n3. Template:\n   - .auth-card container (copy styles from sign-in)\n   - Header with h2 using m.auth_forgot_password_title() and subtitle\n   - If isSuccess: Show NoticeBanner variant=success with success message and back link\n   - Else: Show form with email InlineEditor and submit Button\n   - Back to sign in link using ArrowLeft icon\n\n4. Styles:\n   - Copy .auth-card, .auth-header, h2, .subtitle, .auth-form from sign-in\n   - Add .back-link style for the return link\n\nINLINE EDITOR PROPS (copy from sign-in email field):\n- id=email, name=email, inputType=email\n- autocomplete=email\n- mode=form, variant=bordered, size=base\n- placeholder and ariaLabel from i18n\n\nACCEPTANCE CRITERIA:\n- Page renders at /forgot-password\n- Email input uses InlineEditor with proper props\n- Submit calls authClient.requestPasswordReset\n- Success state shows banner and hides form\n- Error state shows warning banner\n- Back link navigates to /sign-in\n- All text uses i18n messages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:14:32.809697+09:00","created_by":"Matt","updated_at":"2026-02-03T09:23:58.2249085+09:00","closed_at":"2026-02-03T09:23:58.2249085+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-37q","depends_on_id":"DRV-dma","type":"blocks","created_at":"2026-02-03T09:15:30.1603393+09:00","created_by":"Matt"}]}
{"id":"DRV-37u","title":"Realign SCH scenario naming to match implementation plan","description":"DRV-b1l.3 Audit Finding #3: Scenario ID traceability has drifted from the plan. SCH-002 currently asserts notification creation while flagged-driver behavior is tracked under SCH-FLAG-001. Realign invariant/scenario naming so SCH-002 maps to flagged/cross-org behavior as specified, and keep notification assertions under NOTIF-* identifiers. Anchor existing SCH-CAP-001 and SCH-FLAG-001 checks to the plan's SCH-* traceability table. Source: logs/nightly/2026-02-18/drv-b1l.3-scheduling-and-eligibility-e2e-matrix-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:06:01.0295632+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:09.4724551+09:00","closed_at":"2026-02-19T19:54:09.4724551+09:00","close_reason":"Closed","labels":["documentation","e2e-testing","scheduling"]}
{"id":"DRV-3ads","title":"Nightly 2026-02-18: Store and API Safety","description":"Parent epic for store/API safety findings from nightly audit 2026-02-18. High: optimistic rollback races, unguarded JSON parsing, missing UUID validation.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-18T12:45:47.727287+09:00","created_by":"Matt","updated_at":"2026-02-18T23:08:44.8040805+09:00","closed_at":"2026-02-18T23:08:44.8040805+09:00","close_reason":"All child store/API safety findings are implemented and closed (DRV-8rv, DRV-e5g, DRV-e5n, DRV-qlr).","labels":["api","input-validation","nightly-audit","stores"]}
{"id":"DRV-3o8","title":"Audit all Svelte stores","description":"Production readiness audit of all 12 Svelte 5 stores in src/lib/stores/*.svelte.ts. Review for: Svelte 5 runes correctness ($state, $derived, $effect usage), optimistic update rollback on failed mutations, API failure error handling and user surfacing, race conditions (rapid successive actions, stale closures), loading/error/success state management, connectivity guards (ensureOnlineForWrite on all writes), memory leaks (effect cleanup, subscription management), API response type validation before storing, store initialization failure handling. Write findings to logs/nightly/2026-02-10/audit-stores.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/82","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:35.4427149+09:00","created_by":"Matt","updated_at":"2026-02-10T04:20:37.2248091+09:00","closed_at":"2026-02-10T04:19:40.4973644+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-3vh","title":"Update route PATCH to support managerId changes","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nUpdate src/routes/api/routes/[id]/+server.ts to support managerId updates.\n\n## Changes to PATCH /api/routes/[id]\n\n### Update route schema\nIn src/lib/schemas/route.ts, update routeUpdateSchema:\n```typescript\nexport const routeUpdateSchema = z.object({\n  name: z.string().min(1).max(100).optional(),\n  managerId: z.string().nullable().optional()  // Allow setting or clearing\n});\n```\n\n### Validate access to route\nBefore updating, verify manager has access:\n```typescript\nimport { canManagerAccessWarehouse } from \"$lib/server/services/managers\";\n\n// Get existing route first\nconst [existing] = await db\n  .select({ \n    id: routes.id, \n    warehouseId: routes.warehouseId,\n    managerId: routes.managerId \n  })\n  .from(routes)\n  .where(eq(routes.id, id));\n\nif (!existing) {\n  throw error(404, \"Route not found\");\n}\n\nconst canAccess = await canManagerAccessWarehouse(locals.user.id, existing.warehouseId);\nif (!canAccess) {\n  throw error(403, \"No access to this route\");\n}\n```\n\n### Apply managerId update\n```typescript\nconst updates: Partial\u003ctypeof routes.$inferInsert\u003e = {\n  updatedAt: new Date()\n};\n\nif (result.data.name !== undefined) {\n  updates.name = result.data.name;\n}\n\nif (result.data.managerId !== undefined) {\n  updates.managerId = result.data.managerId;  // Can be null to clear\n}\n\nconst [updated] = await db\n  .update(routes)\n  .set(updates)\n  .where(eq(routes.id, id))\n  .returning();\n```\n\n### Audit log the change\n```typescript\nawait db.insert(auditLogs).values({\n  entityType: \"route\",\n  entityId: id,\n  action: \"update\",\n  actorType: \"user\",\n  actorId: locals.user.id,\n  changes: {\n    before: { managerId: existing.managerId },\n    after: { managerId: result.data.managerId }\n  }\n});\n```\n\n## Files to Modify\n- src/routes/api/routes/[id]/+server.ts\n- src/lib/schemas/route.ts (if not already updated)\n\n## Dependencies\n- DRV-4jy (manager access service)\n- DRV-34w (routes API scoping)\n\n## Acceptance Criteria\n- [ ] PATCH validates warehouse access\n- [ ] PATCH allows setting managerId\n- [ ] PATCH allows clearing managerId (set to null)\n- [ ] Changes are audit logged\n- [ ] Response includes updated managerId","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:24:24.9050035+09:00","created_by":"Matt","updated_at":"2026-02-04T14:22:37.0334598+09:00","closed_at":"2026-02-04T14:22:37.0340274+09:00","dependencies":[{"issue_id":"DRV-3vh","depends_on_id":"DRV-4jy","type":"blocks","created_at":"2026-02-04T11:26:29.0263793+09:00","created_by":"Matt"},{"issue_id":"DRV-3vh","depends_on_id":"DRV-34w","type":"blocks","created_at":"2026-02-04T11:26:35.7757314+09:00","created_by":"Matt"},{"issue_id":"DRV-3vh","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:27.6752371+09:00","created_by":"Matt"}]}
{"id":"DRV-43w","title":"Create lifecycle E2E test scaffolding and helpers","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Setup/Teardown + Helpers sections)\n\n## Objective\nCreate the test file scaffolding: beforeAll, afterAll, auth mocking helpers, and invokeEndpoint helper.\n\n## File to Create\nscripts/nightly/lifecycle-e2e.test.ts (initial scaffolding ~200 lines)\n\n## Implementation Details\n\n### 1. Imports\n- vitest: describe, it, beforeAll, afterAll, expect\n- date-fns, date-fns-tz for time handling\n- drizzle-orm operators (eq, and, isNull, isNotNull, etc.)\n- Schema imports from $lib/server/db/schema\n- createRequestEvent from tests/harness/requestEvent\n- freezeTime, resetTime, advanceTimeByMs from tests/harness/time\n- dispatchPolicy from $lib/config/dispatchPolicy\n\n### 2. Environment Guards (beforeAll)\n- Assert NIGHTLY_LIFECYCLE_E2E=1\n- Assert DATABASE_URL not production (reuse assertSafeDatabaseUrl pattern from cron-e2e)\n\n### 3. Weekday Anchor Computation\n```typescript\nfunction computeWeekdayAnchor(): string {\n  const now = new Date();\n  let candidate = now;\n  while (candidate.getDay() === 0 || candidate.getDay() === 6) {\n    candidate = addDays(candidate, 1);\n  }\n  return format(candidate, 'yyyy-MM-dd');\n}\n```\n\n### 4. Seed Check/Run (beforeAll)\n- Query organizations for slug='seed-org-a'\n- If exists: skip reseed, log \"Reusing existing seed\"\n- If not: run pnpm seed -- --deterministic --seed=20260302 --anchor-date={anchorDate}\n\n### 5. Advisory Lock (beforeAll/afterAll)\n- Same acquireAdvisoryLock pattern as cron-e2e (lockKey: 931_112_011)\n\n### 6. Auth Mocking Helpers\n```typescript\nfunction createDriverLocals(userId: string, orgId: string): App.Locals {\n  return {\n    user: {\n      id: userId,\n      role: 'driver',\n      organizationId: orgId,\n      name: 'Test Driver',\n      email: 'test@driver.test',\n      emailVerified: true,\n      image: null,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      phone: null,\n      weeklyCap: 4,\n      isFlagged: false,\n      flagWarningDate: null\n    },\n    organizationId: orgId\n  };\n}\n\nfunction createManagerLocals(managerId: string, orgId: string): App.Locals\n// Same structure with role: 'manager'\n```\n\n### 7. invokeEndpoint Helper\n```typescript\nasync function invokeEndpoint(params: {\n  method: string;\n  url: string;\n  handler: (event: any) =\u003e Promise\u003cResponse\u003e;\n  locals: App.Locals;\n  body?: Record\u003cstring, unknown\u003e;\n  params?: Record\u003cstring, string\u003e;\n}): Promise\u003c{ status: number; body: any }\u003e {\n  const event = createRequestEvent({\n    method: params.method,\n    url: 'http://localhost' + params.url,\n    locals: params.locals,\n    params: params.params ?? {},\n    body: params.body ?? undefined\n  });\n  try {\n    const response = await params.handler(event as any);\n    let body: any = null;\n    try { body = await response.json(); } catch { body = null; }\n    return { status: response.status, body };\n  } catch (err: any) {\n    // SvelteKit error() throws HttpError\n    if (err?.status) return { status: err.status, body: { message: err.body?.message } };\n    throw err;\n  }\n}\n```\n\n### 8. Shared Test State\n```typescript\nlet orgAId: string;\nlet testDriverId: string;\nlet testAssignmentId: string;\nlet unreliableDriverId: string;\nlet managerId: string;\nlet anchorDate: string;\n```\n\n### 9. Report Types + afterAll\nSame CronE2EReport-style structure. Write JSON + MD to logs/nightly/{date}/.\n\n### 10. Empty describe block\n```typescript\ndescribe('lifecycle E2E drill', () =\u003e {\n  // Scenarios will be added by subsequent beads\n  it.todo('S1: Confirm shift');\n  it.todo('S2: Arrive');\n  // ... S3-S11\n});\n```\n\n## Dependencies\n- DRV-2w2 (infrastructure files)\n\n## Acceptance Criteria\n- [ ] Test file compiles without errors\n- [ ] pnpm nightly:lifecycle-e2e runs and skips all .todo tests\n- [ ] Seed check works (logs \"Reusing existing seed\" if org exists)\n- [ ] Advisory lock acquired/released without errors\n- [ ] Report files written to logs/nightly/{date}/","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:42:32.4553947+09:00","created_by":"Matt","updated_at":"2026-02-14T20:02:08.2527934+09:00","closed_at":"2026-02-14T20:02:08.2527934+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-43w","depends_on_id":"DRV-2w2","type":"blocks","created_at":"2026-02-14T19:45:14.3635421+09:00","created_by":"Matt"}]}
{"id":"DRV-443","title":"Per-route start times and return exceptions","description":"Two customer-demanded changes before release: (1) Replace global 9 AM arrival cutoff with per-route startTime (HH:MM precision). Each route has its own fixed start time. (2) Allow drivers to declare returned parcels as exceptions (holidays, business closures) that don't count against health scoring. Exceptions include count + notes, manager notified read-only. See plan: .claude/plans/expressive-giggling-wand.md","acceptance_criteria":"All routes have a startTime field. No-show detection, health scoring, arrival enforcement, and metrics use per-route deadlines. Drivers can file return exceptions during completion and edit. Managers are notified of exceptions. Adjusted completion rates exclude excepted returns.","notes":"PR: https://github.com/orro3790/drive/pull/97","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-10T21:01:46.6139519+09:00","created_by":"Matt","updated_at":"2026-02-10T22:46:46.5610452+09:00","closed_at":"2026-02-10T22:45:42.336212+09:00","close_reason":"Closed","labels":["pre-launch","schema-change"]}
{"id":"DRV-443.1","title":"Schema migration, validation schemas, and config utilities","description":"Foundation layer for both features. (1) Add routes.startTime text column with default '09:00'. (2) Add shifts.exceptedReturns integer default 0 and shifts.exceptionNotes text. (3) Add 'return_exception' to notificationTypeEnum. (4) Generate and apply Drizzle migration. (5) Update route Zod schemas (routeCreateSchema: required startTime, routeUpdateSchema: optional startTime). (6) Update shift Zod schemas (shiftCompleteSchema: exceptedReturns + exceptionNotes with refine, shiftEditSchema: same fields optional). (7) Add parseRouteStartTime() to dispatchPolicy.ts. (8) Update assignmentLifecycle.ts — add routeStartTime to input, update calculateArrivalDeadline to accept and use it.","acceptance_criteria":"Migration runs clean. Existing routes backfilled with '09:00'. Zod schemas validate HH:MM format and exception constraints. calculateArrivalDeadline uses per-route time when provided.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-10T21:01:59.9341713+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:37.2899678+09:00","closed_at":"2026-02-11T19:48:37.2899678+09:00","close_reason":"Closed","labels":["migration","schema"],"dependencies":[{"issue_id":"DRV-443.1","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:01:59.9402137+09:00","created_by":"Matt"}]}
{"id":"DRV-443.2","title":"Server services — per-route start time integration","description":"Update server services to use per-route start times instead of global 9 AM. (1) noshow.ts: Remove global skip guard, add routes.startTime to SELECT, per-route deadline filtering, update audit log reason. (2) health.ts arrived-on-time query: Replace extract(hour) \u003c 9 with route-aware timestamp comparison via JOIN to routes, use COALESCE for NULL safety. (3) All callers verified: noshow service, arrive endpoint, dashboard API, assignments/mine API.","acceptance_criteria":"No-show detection flags per-route based on each route's startTime. Health scoring counts on-time arrivals against the correct per-route deadline.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-10T21:02:12.1215571+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:38.4669551+09:00","closed_at":"2026-02-11T19:48:38.4669551+09:00","close_reason":"Closed","labels":["backend","health","no-show"],"dependencies":[{"issue_id":"DRV-443.2","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:02:12.1291267+09:00","created_by":"Matt"},{"issue_id":"DRV-443.2","depends_on_id":"DRV-443.1","type":"blocks","created_at":"2026-02-10T21:02:12.1405594+09:00","created_by":"Matt"}]}
{"id":"DRV-443.3","title":"Server services — return exception scoring adjustments","description":"Update health scoring and metrics to exclude excepted returns. (1) health.ts high-delivery query: change to (parcelsStart - parcelsReturned + exceptedReturns) / parcelsStart \u003e= 0.95. (2) health.ts weekly completion rate: add parcelsReturned + exceptedReturns to weekShifts SELECT, compute adjusted rate. (3) metrics.ts completion rate: update avg() to use adjusted formula. (4) notifications.ts: add return_exception to NotificationType, ManagerAlertType, and NOTIFICATION_TEMPLATES. Note: parcelsDelivered in DB stays as actual count; adjustment only in scoring queries.","acceptance_criteria":"High delivery flag, weekly star evaluation, and driver metrics all use adjusted rates that exclude excepted returns. Return exception notification template exists.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-10T21:02:26.3807074+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:39.7010029+09:00","closed_at":"2026-02-11T19:48:39.7010029+09:00","close_reason":"Closed","labels":["backend","health","metrics"],"dependencies":[{"issue_id":"DRV-443.3","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:02:26.3872442+09:00","created_by":"Matt"},{"issue_id":"DRV-443.3","depends_on_id":"DRV-443.1","type":"blocks","created_at":"2026-02-10T21:02:26.4019335+09:00","created_by":"Matt"}]}
{"id":"DRV-443.4","title":"API endpoints — route CRUD, shift lifecycle, dashboard","description":"Update all API endpoints. ROUTE CRUD: (1) GET /api/routes: add startTime to SELECT+response. (2) POST /api/routes: accept+store startTime. (3) PATCH /api/routes/[id]: allow updating startTime. SHIFT LIFECYCLE: (4) POST /api/shifts/arrive: join routes for startTime, compute per-route deadline, dynamic error message, pass routeStartTime to lifecycle. (5) POST /api/shifts/complete: accept exceptedReturns+exceptionNotes, validate excepted\u003c=returned, update high-delivery check with adjusted rate, send manager notification if exceptions\u003e0. (6) PATCH /api/shifts/[assignmentId]/edit: accept exceptions, cross-field validation after computing finals, notify manager only on 0→\u003e0 transition. DASHBOARD+SCHEDULE: (7) GET /api/dashboard: add routeStartTime+exception fields, pass routeStartTime to lifecycle. (8) GET /api/assignments/mine: add routeStartTime to SELECT, pass to lifecycle for correct isArrivable.","acceptance_criteria":"Route CRUD persists startTime. Arrive endpoint enforces per-route deadline. Complete+edit accept and validate exceptions. Dashboard and schedule APIs return routeStartTime.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-10T21:02:40.696526+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:40.8657386+09:00","closed_at":"2026-02-11T19:48:40.8657386+09:00","close_reason":"Closed","labels":["api","backend"],"dependencies":[{"issue_id":"DRV-443.4","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:02:40.7025407+09:00","created_by":"Matt"},{"issue_id":"DRV-443.4","depends_on_id":"DRV-443.2","type":"blocks","created_at":"2026-02-10T21:02:40.7174456+09:00","created_by":"Matt"},{"issue_id":"DRV-443.4","depends_on_id":"DRV-443.3","type":"blocks","created_at":"2026-02-10T21:02:40.7284008+09:00","created_by":"Matt"}]}
{"id":"DRV-443.5","title":"Stores and manager UI for route start times","description":"Update stores and build manager UI. STORES: (1) routeStore: add startTime to RouteWithWarehouse type, schema, and optimistic create. (2) dashboardStore: add exceptedReturns, exceptionNotes, routeStartTime to types+response schema, update completeShift/editShift signatures. (3) scheduleStore: add routeStartTime to assignment type if applicable. MANAGER UI: (4) Route create modal: add native \u003cinput type='time'\u003e styled with design tokens (InlineEditor lacks time support). Default '07:00'. (5) Route data table: add 'Start Time' column after route name, formatted as 12-hour (e.g., '7:00 AM'). (6) Route edit panel: allow editing startTime.","acceptance_criteria":"Stores accept new fields without validation errors. Managers can set and edit route start times. Data table displays start time column.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-10T21:02:53.7047905+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:42.119206+09:00","closed_at":"2026-02-11T19:48:42.119206+09:00","close_reason":"Closed","labels":["frontend","manager-ui"],"dependencies":[{"issue_id":"DRV-443.5","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:02:53.7147427+09:00","created_by":"Matt"},{"issue_id":"DRV-443.5","depends_on_id":"DRV-443.4","type":"blocks","created_at":"2026-02-10T21:02:53.7386856+09:00","created_by":"Matt"}]}
{"id":"DRV-443.6","title":"Driver UI for return exceptions and start time display","description":"Driver-facing UI changes. COMPLETION: (1) Show 'Return Exceptions' section when parcelsReturned\u003e0 — number input for count (max=parcelsReturned) + textarea for notes (required when count\u003e0). (2) Client-side validation mirrors server rules. (3) Pass to dashboardStore.completeShift(). EDIT MODE: (4) Same exception fields pre-populated from existing shift data. DISPLAY: (5) Show exception count+notes in completed-editable and completed-locked states. (6) Replace hardcoded '9:00 AM' references with route's actual startTime from dashboard response. Format as 12-hour. I18N: (7) Add keys to en.json and zh-Hant.json: shift_exception_count_label, shift_exception_notes_label, shift_exception_notes_required, shift_exception_exceeds_returned, route_start_time_label, shift_arrival_cutoff (with {time} param).","acceptance_criteria":"Drivers can file exceptions during completion and edit. Exception data displays after completion. Arrival cutoff shows route-specific time. Both languages have new message keys.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-10T21:03:09.7397029+09:00","created_by":"Matt","updated_at":"2026-02-11T20:35:27.2968512+09:00","closed_at":"2026-02-11T20:35:27.2968512+09:00","close_reason":"Closed","labels":["driver-ui","frontend","i18n"],"dependencies":[{"issue_id":"DRV-443.6","depends_on_id":"DRV-443","type":"parent-child","created_at":"2026-02-10T21:03:09.7435276+09:00","created_by":"Matt"},{"issue_id":"DRV-443.6","depends_on_id":"DRV-443.5","type":"blocks","created_at":"2026-02-10T21:03:09.7550296+09:00","created_by":"Matt"}]}
{"id":"DRV-49o","title":"Mobile-first driver UX redesign around lifecycle states","description":"Redesign driver flows around lifecycle states, prioritize mobile action paths, and replace bespoke controls with approved primitives and tokens.","acceptance_criteria":"Driver pages use a unified lifecycle action model, preserve design language, and meet i18n and accessibility criteria.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-07T17:05:04.9371451+09:00","created_by":"Matt","updated_at":"2026-02-08T13:45:56.9583268+09:00","closed_at":"2026-02-08T13:45:56.9583268+09:00","dependencies":[{"issue_id":"DRV-49o","depends_on_id":"DRV-uoh","type":"blocks","created_at":"2026-02-07T17:06:31.0865231+09:00","created_by":"Matt"}]}
{"id":"DRV-49o.1","title":"Define lifecycle state-to-action IA contract for driver routes","description":"Codify lifecycle states, primary actions, and route responsibilities across dashboard, schedule, and bids with a mobile-first focus.","acceptance_criteria":"State-to-action mapping is explicit and implemented consistently across driver navigation surfaces.","notes":"Implemented shared driver lifecycle IA contract and wired dashboard/schedule/bids to consume canonical action mapping. Added unit tests for state/action and route ownership coverage.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:39.0848701+09:00","created_by":"Matt","updated_at":"2026-02-08T13:45:57.4892545+09:00","closed_at":"2026-02-08T13:45:57.4892545+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-49o.1","depends_on_id":"DRV-49o","type":"parent-child","created_at":"2026-02-07T17:05:39.0888702+09:00","created_by":"Matt"}]}
{"id":"DRV-49o.2","title":"Refactor dashboard into mobile-first action hub","description":"Restructure dashboard to prioritize daily lifecycle actions and reduce duplicated flow logic.","acceptance_criteria":"Driver can complete the primary daily shift flow from dashboard with clear next actions in each state.","notes":"Refactored dashboard into a mobile-first action hub by deriving a single primary lifecycle action per state, surfacing a prominent next-action strip, and routing lifecycle CTAs through canonical action handlers.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:39.6520757+09:00","created_by":"Matt","updated_at":"2026-02-08T13:45:58.1563761+09:00","closed_at":"2026-02-08T13:45:58.1563761+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-49o.2","depends_on_id":"DRV-49o","type":"parent-child","created_at":"2026-02-07T17:05:39.656046+09:00","created_by":"Matt"},{"issue_id":"DRV-49o.2","depends_on_id":"DRV-49o.1","type":"blocks","created_at":"2026-02-07T17:06:40.7385257+09:00","created_by":"Matt"}]}
{"id":"DRV-49o.3","title":"Normalize schedule and bids to shared lifecycle components","description":"Refactor schedule and bids to reuse shared lifecycle presentation blocks and align behavior with dashboard conventions.","acceptance_criteria":"Schedule and bids use consistent lifecycle semantics and no conflicting action logic remains.","notes":"Extracted shared lifecycle label config (lifecycleLabels.ts), shared CancelShiftModal component, and shared formatAssignmentDate utility. Dashboard, schedule, and bids pages now import from shared modules instead of duplicating status maps, cancel reason options, and date formatting.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:40.23634+09:00","created_by":"Matt","updated_at":"2026-02-08T13:45:58.8997711+09:00","closed_at":"2026-02-08T13:45:58.8997711+09:00","dependencies":[{"issue_id":"DRV-49o.3","depends_on_id":"DRV-49o","type":"parent-child","created_at":"2026-02-07T17:05:40.2398469+09:00","created_by":"Matt"},{"issue_id":"DRV-49o.3","depends_on_id":"DRV-49o.1","type":"blocks","created_at":"2026-02-07T17:06:41.4150055+09:00","created_by":"Matt"}]}
{"id":"DRV-49o.4","title":"Primitive, token, and i18n remediation in driver nav scope","description":"Replace raw numeric inputs with approved primitives, remove non-canonical CSS tokens, and eliminate hardcoded user-facing strings in driver flows.","acceptance_criteria":"No raw numeric controls or forbidden tokens remain in driver pages and user text is i18n-backed.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:40.8421749+09:00","created_by":"Matt","updated_at":"2026-02-08T13:45:59.6621716+09:00","closed_at":"2026-02-08T13:45:59.6621716+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-49o.4","depends_on_id":"DRV-49o","type":"parent-child","created_at":"2026-02-07T17:05:40.8454695+09:00","created_by":"Matt"},{"issue_id":"DRV-49o.4","depends_on_id":"DRV-49o.2","type":"blocks","created_at":"2026-02-07T17:06:42.0911494+09:00","created_by":"Matt"},{"issue_id":"DRV-49o.4","depends_on_id":"DRV-49o.3","type":"blocks","created_at":"2026-02-07T17:06:42.7576411+09:00","created_by":"Matt"}]}
{"id":"DRV-4ff","title":"Audit auth, user, and security-critical endpoints","description":"Production readiness security audit of src/routes/(auth)/ pages (sign-in, sign-up, forgot-password, reset-password), src/routes/api/users/ endpoints (me, password, fcm-token), src/lib/server/auth.ts, and rate limiting (drizzle/0010_refresh_rate_limit_schema.sql). Review for: Better Auth config (session expiry, cookie settings, CSRF), signup allowlist enforcement in production, password reset (token expiry, rate limiting, account enumeration prevention), FCM token registration auth, rate limiting on login/password reset/API, session security (httpOnly, sameSite, secure), XSS in auth pages, trusted origins for prod vs dev, rate limit schema correctness. Write findings to logs/nightly/2026-02-10/audit-api-auth-security.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:13.4669242+09:00","created_by":"Matt","updated_at":"2026-02-10T05:30:01.2233263+09:00","closed_at":"2026-02-10T05:30:01.2233263+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":28,"issue_id":"DRV-4ff","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/87","created_at":"2026-02-09T20:31:25Z"}]}
{"id":"DRV-4jr","title":"Manager onboarding controls in settings","description":"Source: documentation/launch/signup-abuse-hardening.md (Manager approval flow)\\n\\nObjective\\nAdd an in-app manager onboarding section so signup approvals can be managed in product (no env var edits/redeploy), with explicit approve/revoke/consume lifecycle and auditability.\\n\\nImplementation details\\n- Add a manager-only onboarding section in settings (new section under src/routes/(manager)/settings/+page.svelte or a dedicated sub-route) with:\\n  - approved email list\\n  - invite issuance controls\\n  - revoke controls\\n  - status badges (pending, consumed, revoked, expired).\\n- Introduce DB-backed onboarding model (allowlist/invite entities) with lifecycle fields:\\n  - email, status, createdBy, createdAt, expiresAt, consumedAt, consumedByUserId.\\n- Replace env-based signup allowlist dependency in auth guard with DB-backed checks for production mode.\\n- Ensure invite/approval consumption is atomic on successful signup to avoid replay.\\n- Add manager authz checks and API boundaries for onboarding operations.\\n- Add deterministic tests for:\\n  - approve then signup success\\n  - revoked/expired invite rejection\\n  - one-time consume behavior\\n  - concurrent signup race on same invite/email.\\n\\nAcceptance criteria\\n- Manager can approve or revoke onboarding from UI without deployment changes.\\n- Approved/issued entries are visible with clear status and timestamps.\\n- Signup policy enforces DB-backed approvals in production.\\n- One-time tokens (if used) are consumed exactly once and cannot be replayed.\\n- Failed/partial signup does not leave an unusable orphan state.\\n- Audit trail is available for who approved/revoked/consumed and when.\\n\\nTechnical constraints\\n- Keep manager-only access consistent with existing role guard patterns.\\n- Preserve deterministic test style used across tests/server.\\n- Avoid storing raw invite secrets; store hashed values if tokenized invites are implemented.","notes":"PR: https://github.com/orro3790/drive/pull/70","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-09T15:59:43.5379016+09:00","created_by":"Matt","updated_at":"2026-02-09T17:30:44.9681023+09:00","closed_at":"2026-02-09T17:22:45.1176929+09:00","close_reason":"Closed","labels":["auth","manager","onboarding"]}
{"id":"DRV-4jy","title":"Create manager access service","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nCreate src/lib/server/services/managers.ts with helper functions for warehouse access control.\n\n## File: src/lib/server/services/managers.ts\n\n\\\n## Import Requirements\nAdd \\ to drizzle-orm imports in the file.\n\n## Dependencies\n- DRV-sww (schema must be migrated)\n\n## Acceptance Criteria\n- [ ] getManagerWarehouseIds returns correct warehouse IDs\n- [ ] canManagerAccessWarehouse returns true for valid pairs, false otherwise\n- [ ] getRouteManager returns managerId or null\n- [ ] All functions exported\n- [ ] TypeScript types correct","notes":"PR: https://github.com/orro3790/drive/pull/20","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:23:38.2282964+09:00","created_by":"Matt","updated_at":"2026-02-04T13:10:27.9027067+09:00","closed_at":"2026-02-04T13:10:27.9027067+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-4jy","depends_on_id":"DRV-sww","type":"blocks","created_at":"2026-02-04T11:26:09.380706+09:00","created_by":"Matt"},{"issue_id":"DRV-4jy","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:19.4393888+09:00","created_by":"Matt"}]}
{"id":"DRV-4ue","title":"Audit bidding service","description":"Production readiness audit of src/lib/server/services/bidding.ts (967 lines) — the largest and most complex service. Review for: race conditions in competitive bid resolution, mode transition correctness (competitive→instant→emergency), bid scoring calculation accuracy vs dispatch policy weights, edge cases (no bids, single bid, tied scores, self-bid on dropped shift), error handling completeness, transaction safety, input validation, logging coverage. Write findings to logs/nightly/2026-02-10/audit-services-bidding.md with severity ratings (critical/high/medium/low).","notes":"PR: https://github.com/orro3790/drive/pull/83","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:24.5738732+09:00","created_by":"Matt","updated_at":"2026-02-10T04:32:02.0554891+09:00","closed_at":"2026-02-10T04:30:34.4072235+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-4w0","title":"Add warehouseManagers table and managerId to routes","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nAdd the warehouse_managers many-to-many table and managerId column to routes table for manager scoping.\n\n## Schema Changes (src/lib/server/db/schema.ts)\n\n### 1. Add warehouseManagers table after routes table:\n```typescript\nexport const warehouseManagers = pgTable('warehouse_managers', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  warehouseId: uuid('warehouse_id').notNull().references(() =\u003e warehouses.id, { onDelete: 'cascade' }),\n  userId: text('user_id').notNull().references(() =\u003e user.id, { onDelete: 'cascade' }),\n  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow()\n}, (table) =\u003e ({\n  uniquePair: unique().on(table.warehouseId, table.userId),\n  idxWarehouse: index('idx_warehouse_managers_warehouse').on(table.warehouseId)\n}));\n```\n\n### 2. Add managerId column to routes table:\n```typescript\nmanagerId: text('manager_id').references(() =\u003e user.id, { onDelete: 'set null' })\n```\n\n### 3. Add index to routes table (in the callback):\n```typescript\nidxRouteManager: index('idx_routes_manager').on(table.managerId)\n```\n\n### 4. Add relations for warehouseManagers:\n```typescript\nexport const warehouseManagersRelations = relations(warehouseManagers, ({ one }) =\u003e ({\n  warehouse: one(warehouses, {\n    fields: [warehouseManagers.warehouseId],\n    references: [warehouses.id]\n  }),\n  user: one(user, {\n    fields: [warehouseManagers.userId],\n    references: [user.id]\n  })\n}));\n```\n\n### 5. Update warehousesRelations to include managers:\n```typescript\nmanagers: many(warehouseManagers)\n```\n\n### 6. Update routesRelations to include manager:\n```typescript\nmanager: one(user, {\n  fields: [routes.managerId],\n  references: [user.id]\n})\n```\n\n## Import Requirements\nAdd `unique` to drizzle-orm/pg-core imports.\n\n## Dependencies\n- Must be on develop branch where 355-line schema exists\n- Requires auth-schema.ts with user table\n\n## Acceptance Criteria\n- [ ] warehouseManagers table defined with composite unique constraint\n- [ ] routes.managerId column with onDelete: 'set null'\n- [ ] Index on routes.managerId\n- [ ] Index on warehouse_managers.warehouse_id\n- [ ] All relations updated\n- [ ] No TypeScript errors","notes":"PR: https://github.com/orro3790/drive/pull/19","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:22:58.7352166+09:00","created_by":"Matt","updated_at":"2026-02-04T12:12:16.9823886+09:00","closed_at":"2026-02-04T12:12:16.9823886+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-4w0","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:10.7678399+09:00","created_by":"Matt"}]}
{"id":"DRV-4w6","title":"Schedule generation algorithm","description":"Source: docs/specs/SPEC.md § Scheduling System \u003e Schedule Generation Algorithm\nADR: docs/adr/003-scheduling-model.md\n\n## Objective\nImplement the automatic schedule generation algorithm that runs at preference lock time.\n\n## Scope\n- Service function: generateWeekSchedule(targetWeekStart: Date)\n- For each day in target week, for each route:\n  1. Find eligible drivers: prefers this day + prefers this route + under weekly cap + not flagged\n  2. Sort by: route familiarity (desc) → completion rate (desc) → attendance rate (desc)\n  3. Assign top driver to route for that day\n  4. If no eligible driver: create assignment with userId=null, status='unfilled'\n- Create Assignment records for all route-day combinations\n- Trigger bid window creation for any unfilled assignments\n\n## Spec References\n- docs/specs/SPEC.md: Lines 86-92 (Schedule generation algorithm)\n- docs/specs/SPEC.md: Lines 94-98 (New driver handling)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps)\n- docs/adr/003-scheduling-model.md: Full decision rationale\n- docs/specs/data-model.md: Lines 92-103 (assignments table)\n\n## Acceptance Criteria\n- Algorithm creates 7 days × N routes = 7N assignment records\n- Drivers only assigned on days they prefer\n- Drivers only assigned to routes they prefer (top 3)\n- Flagged drivers (isFlagged=true) are excluded\n- Weekly cap respected (count existing assignments for that week)\n- Route familiarity determined from routeCompletions table\n- Unfilled assignments created with status='unfilled' and userId=null\n- Assignment.assignedBy = 'algorithm' for all auto-generated\n\n## Technical Constraints\n- Must be idempotent (running twice for same week doesn't duplicate)\n- Check for existing assignments before creating\n- Toronto timezone for all date calculations\n- Service lives in src/lib/server/services/scheduling.ts","notes":"PR: https://github.com/orro3790/drive/pull/4","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:24:26.5939496+09:00","created_by":"Matt","updated_at":"2026-02-03T11:39:45.4639098+09:00","closed_at":"2026-02-03T11:39:45.4639098+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-4w6","depends_on_id":"DRV-5y4","type":"blocks","created_at":"2026-02-02T21:24:26.601433+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7","title":"Seed Data Script","description":"Source: docs/plans/seed-data-script.md\n\nCreate scripts/seed.ts that generates realistic test data for the Drive app with configurable scale (dev: 10 drivers, staging: 100 drivers).\n\n## Scale Configurations\n| Mode    | Drivers | Warehouses | Routes | Past Weeks | Future Weeks |\n|---------|---------|------------|--------|------------|--------------|\n| dev     | 10      | 2          | 10     | 2          | 2            |\n| staging | 100     | 4          | 40     | 3          | 2            |\n\n## Acceptance Criteria\n- `pnpm seed` creates 10 drivers with full data graph\n- `pnpm seed:staging` creates 100 drivers\n- Script is idempotent (re-run clears and recreates)\n- Seeded drivers can log in (account table populated)\n- Foreign key relationships all valid\n- Driver metrics reflect realistic distributions\n- Past assignments have completed shifts with parcel data\n- routeCompletions populated based on completed shifts\n- Cancelled assignments have resolved bid windows\n- Schedule page shows seeded assignments\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-03T14:35:03.1480857+09:00","created_by":"Matt","updated_at":"2026-02-03T22:33:10.7590717+09:00","closed_at":"2026-02-03T22:33:10.7590717+09:00"}
{"id":"DRV-4z7.1","title":"Add faker.js dependency and create seed config","description":"Source: docs/plans/seed-data-script.md (Step 1 + Files to Create)\n\n## Objective\nInstall faker.js and create the seed configuration module with scale settings.\n\n## Implementation Details\n\n### 1. Install dependency\n```bash\npnpm add -D @faker-js/faker\n```\n\n### 2. Create scripts/seed/config.ts\n```typescript\nexport interface SeedConfig {\n  drivers: number;\n  warehouses: number;\n  routes: number;\n  pastWeeks: number;\n  futureWeeks: number;\n}\n\nexport const DEV_CONFIG: SeedConfig = {\n  drivers: 10,\n  warehouses: 2,\n  routes: 10,\n  pastWeeks: 2,\n  futureWeeks: 2\n};\n\nexport const STAGING_CONFIG: SeedConfig = {\n  drivers: 100,\n  warehouses: 4,\n  routes: 40,\n  pastWeeks: 3,\n  futureWeeks: 2\n};\n\nexport function getConfig(isStaging: boolean): SeedConfig {\n  return isStaging ? STAGING_CONFIG : DEV_CONFIG;\n}\n```\n\n## Files to Create\n- scripts/seed/config.ts\n\n## Acceptance Criteria\n- [ ] @faker-js/faker appears in devDependencies\n- [ ] config.ts exports DEV_CONFIG and STAGING_CONFIG\n- [ ] getConfig() returns correct config based on boolean flag\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:35:15.2501716+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:45.934746+09:00","closed_at":"2026-02-03T22:32:45.934746+09:00","dependencies":[{"issue_id":"DRV-4z7.1","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:35:15.2536937+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.10","title":"Create bidding generator (windows + bids)","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/bidding.ts)\n\n## Objective\nCreate bid windows for cancelled/unfilled assignments and generate bids with appropriate status.\n\n## Implementation Details\n\n### Create scripts/seed/generators/bidding.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport type { GeneratedAssignment } from './assignments';\nimport type { GeneratedDriver } from './users';\nimport { db } from '../db';\nimport { bidWindows, bids, driverMetrics, routeCompletions } from '$lib/server/db/schema';\nimport { addHours, isBefore } from 'date-fns';\nimport { eq } from 'drizzle-orm';\n\nexport async function seedBidding(\n  assignments: GeneratedAssignment[],\n  drivers: GeneratedDriver[]\n): Promise\u003cvoid\u003e {\n  const now = new Date();\n  \n  // Get all metrics for bid scoring\n  const allMetrics = await db.select().from(driverMetrics);\n  const metricsByUser = new Map(allMetrics.map(m =\u003e [m.userId, m]));\n  \n  // Get all route completions for familiarity scoring\n  const allCompletions = await db.select().from(routeCompletions);\n  const completionsByUserRoute = new Map(\n    allCompletions.map(c =\u003e [`${c.userId}:${c.routeId}`, c.completionCount])\n  );\n  \n  // Filter to cancelled or unfilled assignments\n  const biddableAssignments = assignments.filter(\n    a =\u003e a.status === 'cancelled' || a.status === 'unfilled'\n  );\n  \n  let windowsCreated = 0;\n  let bidsCreated = 0;\n  \n  for (const assignment of biddableAssignments) {\n    // Calculate window timing\n    // Opens when assignment becomes available, closes 4 hours before shift\n    const assignmentDate = new Date(assignment.date);\n    const closesAt = addHours(assignmentDate, -4);\n    const opensAt = addHours(assignmentDate, -48);  // Opens 48 hours before\n    \n    // Determine window status based on current time\n    const isPastWindow = isBefore(closesAt, now);\n    const windowStatus = isPastWindow ? 'resolved' : 'open';\n    \n    // Generate 3-8 bids for this window\n    const numBids = faker.number.int({ min: 3, max: 8 });\n    const biddingDrivers = faker.helpers.shuffle([...drivers]).slice(0, numBids);\n    \n    // Calculate scores and determine winner\n    const scoredBids = biddingDrivers.map(driver =\u003e {\n      const metrics = metricsByUser.get(driver.id);\n      const familiarity = completionsByUserRoute.get(`${driver.id}:${assignment.routeId}`) || 0;\n      \n      // Calculate bid score per CLAUDE.md formula\n      const completionRate = metrics?.completionRate || 0;\n      const attendanceRate = metrics?.attendanceRate || 0;\n      const familiarityScore = Math.min(familiarity / 10, 1);  // Normalize to 0-1\n      const preferenceBonus = 0.5;  // Assume moderate preference match\n      \n      const score = \n        (completionRate * 0.4) +\n        (familiarityScore * 0.3) +\n        (attendanceRate * 0.2) +\n        (preferenceBonus * 0.1);\n      \n      return { driver, score };\n    }).sort((a, b) =\u003e b.score - a.score);\n    \n    const winner = isPastWindow ? scoredBids[0]?.driver : null;\n    \n    // Create bid window\n    await db.insert(bidWindows).values({\n      assignmentId: assignment.id,\n      opensAt,\n      closesAt,\n      status: windowStatus,\n      winnerId: winner?.id || null\n    });\n    windowsCreated++;\n    \n    // Create bids\n    for (let i = 0; i \u003c scoredBids.length; i++) {\n      const { driver, score } = scoredBids[i];\n      let bidStatus: 'pending' | 'won' | 'lost';\n      \n      if (!isPastWindow) {\n        bidStatus = 'pending';\n      } else {\n        bidStatus = driver.id === winner?.id ? 'won' : 'lost';\n      }\n      \n      await db.insert(bids).values({\n        assignmentId: assignment.id,\n        userId: driver.id,\n        score,\n        status: bidStatus,\n        bidAt: faker.date.between({ from: opensAt, to: closesAt }),\n        windowClosesAt: closesAt,\n        resolvedAt: isPastWindow ? closesAt : null\n      });\n      bidsCreated++;\n    }\n  }\n  \n  console.log(`Created ${windowsCreated} bid windows with ${bidsCreated} bids`);\n}\n```\n\n## Schema Reference\n\n### Bid Windows (src/lib/server/db/schema.ts:165-181)\n```typescript\nexport const bidWindows = pgTable('bid_windows', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  assignmentId: uuid('assignment_id').notNull().references(() =\u003e assignments.id).unique(),\n  opensAt: timestamp('opens_at', { withTimezone: true }).notNull().defaultNow(),\n  closesAt: timestamp('closes_at', { withTimezone: true }).notNull(),\n  status: bidWindowStatusEnum('status').notNull().default('open'),  // 'open', 'closed', 'resolved'\n  winnerId: text('winner_id').references(() =\u003e user.id)\n});\n```\n\n### Bids (src/lib/server/db/schema.ts:143-162)\n```typescript\nexport const bids = pgTable('bids', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  assignmentId: uuid('assignment_id').notNull().references(() =\u003e assignments.id),\n  userId: text('user_id').notNull().references(() =\u003e user.id),\n  score: real('score'),\n  status: bidStatusEnum('status').notNull().default('pending'),  // 'pending', 'won', 'lost'\n  bidAt: timestamp('bid_at', { withTimezone: true }).notNull().defaultNow(),\n  windowClosesAt: timestamp('window_closes_at', { withTimezone: true }).notNull(),\n  resolvedAt: timestamp('resolved_at', { withTimezone: true })\n});\n```\n\n## Files to Create\n- scripts/seed/generators/bidding.ts\n\n## Dependencies\n- Requires assignments, drivers, metrics, routeCompletions to be seeded first\n- Uses bid scoring formula from CLAUDE.md\n\n## Bid Scoring Formula (from CLAUDE.md)\n```\nscore = (completion_rate * 0.4) +\n        (route_familiarity * 0.3) +\n        (attendance_rate * 0.2) +\n        (preference_bonus * 0.1)\n```\n\n## Status Logic\n- Past closesAt → window status='resolved', bids are 'won' or 'lost'\n- Future closesAt → window status='open', bids are 'pending'\n- Winner = highest scored bid (only set on resolved windows)\n\n## Acceptance Criteria\n- [ ] Bid windows created for cancelled/unfilled assignments only\n- [ ] Each window has 3-8 bids\n- [ ] Scores calculated using the correct formula\n- [ ] Past windows: status='resolved', winnerId set, bids have won/lost status\n- [ ] Future windows: status='open', winnerId null, bids have pending status\n- [ ] Winner is the bid with highest score\n- [ ] Only one bid per window has status='won'\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:38:50.5572435+09:00","created_by":"Matt","updated_at":"2026-02-03T22:33:01.5845825+09:00","closed_at":"2026-02-03T22:33:01.5845825+09:00","dependencies":[{"issue_id":"DRV-4z7.10","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:38:50.5647956+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.10","depends_on_id":"DRV-4z7.8","type":"blocks","created_at":"2026-02-03T14:39:46.5360412+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.10","depends_on_id":"DRV-4z7.7","type":"blocks","created_at":"2026-02-03T14:39:47.2800519+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.10","depends_on_id":"DRV-4z7.9","type":"blocks","created_at":"2026-02-03T14:39:48.0689306+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.11","title":"Create main seed script with cleanup and orchestration","description":"Source: docs/plans/seed-data-script.md (Steps 4-6)\n\n## Objective\nCreate the main seed.ts entry point that orchestrates all generators with idempotent cleanup.\n\n## Implementation Details\n\n### Create scripts/seed.ts\n\n```typescript\n#!/usr/bin/env tsx\nimport { neon } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport { config } from 'dotenv';\nimport { eq, inArray } from 'drizzle-orm';\n\n// Load environment\nconfig();\n\nimport { getConfig, type SeedConfig } from './seed/config';\nimport { seedWarehouses } from './seed/generators/warehouses';\nimport { seedRoutes } from './seed/generators/routes';\nimport { seedDrivers } from './seed/generators/users';\nimport { seedPreferences } from './seed/generators/preferences';\nimport { seedMetrics } from './seed/generators/metrics';\nimport { seedAssignments } from './seed/generators/assignments';\nimport { seedRouteCompletions } from './seed/generators/route-completions';\nimport { seedBidding } from './seed/generators/bidding';\n\n// Import schema\nimport {\n  auditLogs,\n  notifications,\n  bids,\n  bidWindows,\n  routeCompletions,\n  shifts,\n  assignments,\n  driverMetrics,\n  driverPreferences,\n  routes,\n  warehouses\n} from '$lib/server/db/schema';\nimport { user, account } from '$lib/server/db/auth-schema';\n\n// Initialize database\nconst DATABASE_URL = process.env.DATABASE_URL;\nif (!DATABASE_URL) {\n  console.error('DATABASE_URL not set');\n  process.exit(1);\n}\n\nconst sql = neon(DATABASE_URL);\nexport const db = drizzle(sql);\n\nasync function clearData() {\n  console.log('Clearing existing data...');\n  \n  // Delete in reverse dependency order\n  await db.delete(auditLogs);\n  await db.delete(notifications);\n  await db.delete(bids);\n  await db.delete(bidWindows);\n  await db.delete(routeCompletions);\n  await db.delete(shifts);\n  await db.delete(assignments);\n  await db.delete(driverMetrics);\n  await db.delete(driverPreferences);\n  await db.delete(routes);\n  await db.delete(warehouses);\n  \n  // Delete driver accounts (keep managers)\n  const driverIds = await db.select({ id: user.id })\n    .from(user)\n    .where(eq(user.role, 'driver'));\n  \n  if (driverIds.length \u003e 0) {\n    const ids = driverIds.map(d =\u003e d.id);\n    await db.delete(account).where(inArray(account.userId, ids));\n    await db.delete(user).where(eq(user.role, 'driver'));\n  }\n  \n  console.log('Data cleared successfully');\n}\n\nasync function main() {\n  // Parse arguments\n  const args = process.argv.slice(2);\n  const isStaging = args.includes('--staging');\n  const isDryRun = args.includes('--dry-run');\n  \n  const config = getConfig(isStaging);\n  \n  console.log('='.repeat(50));\n  console.log(`Seed Script - ${isStaging ? 'STAGING' : 'DEV'} Mode`);\n  console.log('='.repeat(50));\n  console.log(`Drivers: ${config.drivers}`);\n  console.log(`Warehouses: ${config.warehouses}`);\n  console.log(`Routes: ${config.routes}`);\n  console.log(`Past Weeks: ${config.pastWeeks}`);\n  console.log(`Future Weeks: ${config.futureWeeks}`);\n  console.log('='.repeat(50));\n  \n  if (isDryRun) {\n    console.log('DRY RUN - No changes will be made');\n    return;\n  }\n  \n  // Clear existing data\n  await clearData();\n  \n  // Seed in dependency order\n  console.log('\\n1. Seeding warehouses...');\n  const warehouses = await seedWarehouses(config);\n  \n  console.log('\\n2. Seeding routes...');\n  const routes = await seedRoutes(config, warehouses);\n  \n  console.log('\\n3. Seeding drivers...');\n  const drivers = await seedDrivers(config);\n  \n  console.log('\\n4. Seeding preferences...');\n  await seedPreferences(config, drivers, routes);\n  \n  console.log('\\n5. Seeding metrics...');\n  await seedMetrics(drivers);\n  \n  console.log('\\n6. Seeding assignments and shifts...');\n  const assignments = await seedAssignments(config, drivers, routes);\n  \n  console.log('\\n7. Seeding route completions...');\n  await seedRouteCompletions(assignments);\n  \n  console.log('\\n8. Seeding bid windows and bids...');\n  await seedBidding(assignments, drivers);\n  \n  console.log('\\n' + '='.repeat(50));\n  console.log('SEED COMPLETE');\n  console.log('='.repeat(50));\n  console.log(`\\nLogin credentials: any seeded email / test1234`);\n  console.log(`\\nExample emails:`);\n  drivers.slice(0, 3).forEach(d =\u003e console.log(`  - ${d.email}`));\n}\n\nmain().catch(err =\u003e {\n  console.error('Seed failed:', err);\n  process.exit(1);\n});\n```\n\n### Create scripts/seed/db.ts (shared db export)\n\n```typescript\n// Re-export db from main script for use in generators\nexport { db } from '../seed';\n```\n\n### Update package.json scripts\n\nAdd to \"scripts\" section:\n```json\n{\n  \"seed\": \"tsx scripts/seed.ts\",\n  \"seed:staging\": \"tsx scripts/seed.ts --staging\"\n}\n```\n\n## Files to Create/Modify\n- scripts/seed.ts (main entry point)\n- scripts/seed/db.ts (shared db export for generators)\n- package.json (add seed scripts)\n\n## Cleanup Order (reverse dependency)\n1. auditLogs\n2. notifications\n3. bids\n4. bidWindows\n5. routeCompletions\n6. shifts\n7. assignments\n8. driverMetrics\n9. driverPreferences\n10. routes\n11. warehouses\n12. account (WHERE userId IN drivers)\n13. user (WHERE role = 'driver')\n\n## Seed Order (dependency order)\n1. warehouses (no dependencies)\n2. routes (depends on warehouses)\n3. drivers+accounts (no dependencies)\n4. preferences (depends on drivers, routes)\n5. metrics (depends on drivers)\n6. assignments+shifts (depends on drivers, routes, preferences)\n7. routeCompletions (depends on assignments)\n8. bidding (depends on assignments, drivers, metrics, routeCompletions)\n\n## Acceptance Criteria\n- [ ] `pnpm seed` runs without errors\n- [ ] `pnpm seed:staging` runs with larger dataset\n- [ ] `--dry-run` flag shows config but makes no changes\n- [ ] Script is idempotent (re-run clears and recreates)\n- [ ] Managers are preserved during cleanup\n- [ ] Progress logged for each step\n- [ ] Summary shows example login credentials\n- [ ] All foreign key constraints satisfied\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:39:26.6176845+09:00","created_by":"Matt","updated_at":"2026-02-03T22:33:02.28285+09:00","closed_at":"2026-02-03T22:33:02.28285+09:00","dependencies":[{"issue_id":"DRV-4z7.11","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:39:26.6225673+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.11","depends_on_id":"DRV-4z7.10","type":"blocks","created_at":"2026-02-03T14:39:55.7321724+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.2","title":"Create seed utility modules (password, dates)","description":"Source: docs/plans/seed-data-script.md (Step 2 - Create utility modules)\n\n## Objective\nCreate password hashing and date utilities for the seed script.\n\n## Implementation Details\n\n### 1. Create scripts/seed/utils/password.ts\nReference: scripts/reset-manager-v2.ts (lines 42-59) for exact scrypt config\n\n```typescript\nimport { scryptAsync } from '@noble/hashes/scrypt';\nimport { bytesToHex, randomBytes } from '@noble/hashes/utils';\n\nconst scryptConfig = {\n  N: 16384,\n  r: 16,\n  p: 1,\n  dkLen: 64\n};\n\nexport async function hashPassword(password: string): Promise\u003cstring\u003e {\n  const salt = bytesToHex(randomBytes(16));\n  const key = await scryptAsync(\n    password.normalize('NFKC'),  // Critical: NFKC normalization\n    salt,\n    {\n      N: scryptConfig.N,\n      r: scryptConfig.r,\n      p: scryptConfig.p,\n      dkLen: scryptConfig.dkLen,\n      maxmem: 128 * scryptConfig.N * scryptConfig.r * 2\n    }\n  );\n  return `${salt}:${bytesToHex(key)}`;\n}\n```\n\n### 2. Create scripts/seed/utils/dates.ts\nReference: src/lib/server/services/scheduling.ts (lines 22-48) for Toronto timezone helpers\n\n```typescript\nimport { toZonedTime, format } from 'date-fns-tz';\nimport { addDays, addWeeks, startOfDay } from 'date-fns';\n\nconst TORONTO_TZ = 'America/Toronto';\n\nexport function getWeekStart(date: Date): Date {\n  const zonedDate = toZonedTime(date, TORONTO_TZ);\n  const day = zonedDate.getDay();\n  const diff = day === 0 ? -6 : 1 - day;\n  const monday = addDays(zonedDate, diff);\n  return startOfDay(monday);\n}\n\nexport function toTorontoDateString(date: Date): string {\n  return format(toZonedTime(date, TORONTO_TZ), 'yyyy-MM-dd');\n}\n\nexport function getTorontoDayOfWeek(date: Date): number {\n  return toZonedTime(date, TORONTO_TZ).getDay();\n}\n\nexport function getDateRangeForWeeks(pastWeeks: number, futureWeeks: number) {\n  const now = new Date();\n  const currentWeekStart = getWeekStart(now);\n  const startDate = addWeeks(currentWeekStart, -pastWeeks);\n  const endDate = addWeeks(currentWeekStart, futureWeeks + 1);\n  return { startDate, endDate, currentWeekStart };\n}\n```\n\n## Files to Create\n- scripts/seed/utils/password.ts\n- scripts/seed/utils/dates.ts\n\n## Dependencies\n- @noble/hashes (already in project - used by Better Auth)\n- date-fns and date-fns-tz (already in project)\n\n## Acceptance Criteria\n- [ ] hashPassword() produces salt:hash format matching Better Auth\n- [ ] getWeekStart() returns Monday of the week in Toronto timezone\n- [ ] toTorontoDateString() returns 'yyyy-MM-dd' format\n- [ ] getDateRangeForWeeks() calculates correct date window\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:35:33.9968869+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:46.6253249+09:00","closed_at":"2026-02-03T22:32:46.6253249+09:00","dependencies":[{"issue_id":"DRV-4z7.2","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:35:34.0000907+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.2","depends_on_id":"DRV-4z7.1","type":"blocks","created_at":"2026-02-03T14:39:38.2126423+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.3","title":"Create warehouse generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/warehouses.ts)\n\n## Objective\nGenerate Toronto-area warehouse records with realistic names and addresses.\n\n## Implementation Details\n\n### Create scripts/seed/generators/warehouses.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport type { SeedConfig } from '../config';\nimport { db } from '../db';  // see main script bead for db setup\nimport { warehouses } from '$lib/server/db/schema';\n\n// Toronto-area warehouse location templates\nconst WAREHOUSE_TEMPLATES = [\n  { prefix: 'YTO', area: 'Mississauga' },\n  { prefix: 'YTO', area: 'Brampton' },\n  { prefix: 'YTO', area: 'Scarborough' },\n  { prefix: 'YTO', area: 'Etobicoke' },\n  { prefix: 'YTO', area: 'North York' },\n  { prefix: 'YTO', area: 'Markham' },\n  { prefix: 'YTO', area: 'Vaughan' },\n  { prefix: 'YTO', area: 'Richmond Hill' }\n];\n\nexport interface GeneratedWarehouse {\n  id: string;\n  name: string;\n}\n\nexport async function seedWarehouses(config: SeedConfig): Promise\u003cGeneratedWarehouse[]\u003e {\n  const toInsert = [];\n  \n  for (let i = 0; i \u003c config.warehouses; i++) {\n    const template = WAREHOUSE_TEMPLATES[i % WAREHOUSE_TEMPLATES.length];\n    const suffix = String(i + 1).padStart(2, '0');\n    \n    toInsert.push({\n      name: `${template.prefix}-${template.area.toUpperCase().substring(0, 3)}${suffix}`,\n      address: `${faker.location.streetAddress()}, ${template.area}, ON`\n    });\n  }\n  \n  const inserted = await db.insert(warehouses).values(toInsert).returning({ id: warehouses.id, name: warehouses.name });\n  return inserted;\n}\n```\n\n## Schema Reference (src/lib/server/db/schema.ts:64-71)\n```typescript\nexport const warehouses = pgTable('warehouses', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: text('name').notNull(),\n  address: text('address').notNull(),\n  createdBy: text('created_by').references(() =\u003e user.id),\n  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow()\n});\n```\n\n## Files to Create\n- scripts/seed/generators/warehouses.ts\n\n## Acceptance Criteria\n- [ ] Generates config.warehouses warehouses\n- [ ] Names follow pattern: YTO-XXX## (e.g., YTO-MIS01, YTO-BRA02)\n- [ ] Addresses include realistic Toronto-area locations\n- [ ] Returns array of { id, name } for use by routes generator\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:35:53.4990186+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:47.3489456+09:00","closed_at":"2026-02-03T22:32:47.3489456+09:00","dependencies":[{"issue_id":"DRV-4z7.3","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:35:53.509153+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.3","depends_on_id":"DRV-4z7.2","type":"blocks","created_at":"2026-02-03T14:39:39.0250139+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.4","title":"Create routes generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/routes.ts)\n\n## Objective\nGenerate routes with prefix codes linked to warehouses.\n\n## Implementation Details\n\n### Create scripts/seed/generators/routes.ts\n\n```typescript\nimport type { SeedConfig } from '../config';\nimport type { GeneratedWarehouse } from './warehouses';\nimport { db } from '../db';\nimport { routes } from '$lib/server/db/schema';\n\nexport interface GeneratedRoute {\n  id: string;\n  name: string;\n  warehouseId: string;\n}\n\nexport async function seedRoutes(\n  config: SeedConfig,\n  warehouses: GeneratedWarehouse[]\n): Promise\u003cGeneratedRoute[]\u003e {\n  const toInsert = [];\n  const routesPerWarehouse = Math.ceil(config.routes / warehouses.length);\n  \n  let routeIndex = 0;\n  for (const warehouse of warehouses) {\n    // Extract prefix from warehouse name (e.g., YTO-MIS01 -\u003e MIS)\n    const prefix = warehouse.name.split('-')[1]?.substring(0, 3) || 'RTE';\n    \n    for (let i = 0; i \u003c routesPerWarehouse \u0026\u0026 routeIndex \u003c config.routes; i++) {\n      const suffix = String(i + 1).padStart(3, '0');\n      toInsert.push({\n        name: `${prefix}-${suffix}`,\n        warehouseId: warehouse.id\n      });\n      routeIndex++;\n    }\n  }\n  \n  const inserted = await db.insert(routes)\n    .values(toInsert)\n    .returning({ \n      id: routes.id, \n      name: routes.name, \n      warehouseId: routes.warehouseId \n    });\n    \n  return inserted;\n}\n```\n\n## Schema Reference (src/lib/server/db/schema.ts:74-83)\n```typescript\nexport const routes = pgTable('routes', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  name: text('name').notNull(),\n  warehouseId: uuid('warehouse_id').notNull().references(() =\u003e warehouses.id),\n  createdBy: text('created_by').references(() =\u003e user.id),\n  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow()\n});\n```\n\n## Files to Create\n- scripts/seed/generators/routes.ts\n\n## Dependencies\n- Requires warehouses to be seeded first (needs warehouseId FK)\n\n## Acceptance Criteria\n- [ ] Generates config.routes routes\n- [ ] Routes distributed evenly across warehouses\n- [ ] Names follow pattern: XXX-### (e.g., MIS-001, BRA-002)\n- [ ] Each route has valid warehouseId FK\n- [ ] Returns array of { id, name, warehouseId } for use by other generators\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:36:10.6401164+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:48.5147486+09:00","closed_at":"2026-02-03T22:32:48.5147486+09:00","dependencies":[{"issue_id":"DRV-4z7.4","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:36:10.6461345+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.4","depends_on_id":"DRV-4z7.3","type":"blocks","created_at":"2026-02-03T14:39:39.7038822+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.5","title":"Create users generator (driver + account)","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/users.ts)\n\n## Objective\nGenerate drivers with BOTH user and account table entries so seeded drivers can log in.\n\n## Implementation Details\n\n### Create scripts/seed/generators/users.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport { nanoid } from 'nanoid';\nimport type { SeedConfig } from '../config';\nimport { hashPassword } from '../utils/password';\nimport { db } from '../db';\nimport { user, account } from '$lib/server/db/auth-schema';\n\nconst DEFAULT_PASSWORD = 'test1234';\n\nexport interface GeneratedDriver {\n  id: string;\n  name: string;\n  email: string;\n}\n\nexport async function seedDrivers(config: SeedConfig): Promise\u003cGeneratedDriver[]\u003e {\n  const hashedPassword = await hashPassword(DEFAULT_PASSWORD);\n  const drivers: GeneratedDriver[] = [];\n  \n  for (let i = 0; i \u003c config.drivers; i++) {\n    const firstName = faker.person.firstName();\n    const lastName = faker.person.lastName();\n    const id = nanoid(21);  // Match Better Auth ID format\n    \n    // Determine driver characteristics\n    // 70% high performers, 20% medium, 10% low\n    const performanceTier = Math.random();\n    let weeklyCap = 4;\n    let isFlagged = false;\n    \n    if (performanceTier \u003e 0.9) {\n      // Low performers - some flagged\n      isFlagged = Math.random() \u003e 0.5;\n      weeklyCap = 3;\n    } else if (performanceTier \u003e 0.7) {\n      // Medium performers\n      weeklyCap = 4;\n    } else {\n      // High performers - some with elevated cap\n      if (Math.random() \u003e 0.7) {\n        weeklyCap = 6;  // Earned elevated cap\n      }\n    }\n    \n    const driver = {\n      id,\n      name: `${firstName} ${lastName}`,\n      email: faker.internet.email({ firstName, lastName, provider: 'example.com' }).toLowerCase(),\n      phone: faker.phone.number({ style: 'national' }),\n      role: 'driver' as const,\n      weeklyCap,\n      isFlagged,\n      flagWarningDate: isFlagged ? faker.date.recent({ days: 7 }) : null,\n      createdAt: faker.date.past({ years: 1 })\n    };\n    \n    drivers.push({ id: driver.id, name: driver.name, email: driver.email });\n    \n    // Insert user\n    await db.insert(user).values(driver);\n    \n    // Insert account (CRITICAL for login)\n    await db.insert(account).values({\n      id: nanoid(21),\n      userId: driver.id,\n      accountId: driver.email,  // Better Auth uses email as accountId\n      providerId: 'credential',\n      password: hashedPassword,\n      createdAt: new Date()\n    });\n  }\n  \n  console.log(`Created ${drivers.length} drivers with password: ${DEFAULT_PASSWORD}`);\n  return drivers;\n}\n```\n\n## Schema Reference\n\n### User table (src/lib/server/db/auth-schema.ts:16-29)\n```typescript\nexport const user = pgTable('user', {\n  id: text('id').primaryKey(),\n  name: text('name').notNull(),\n  email: text('email').notNull().unique(),\n  emailVerified: boolean('email_verified').notNull().default(false),\n  image: text('image'),\n  role: text('role').notNull().default('driver'),\n  phone: text('phone'),\n  weeklyCap: integer('weekly_cap').notNull().default(4),\n  isFlagged: boolean('is_flagged').notNull().default(false),\n  flagWarningDate: timestamp('flag_warning_date', { withTimezone: true }),\n  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow()\n});\n```\n\n### Account table (src/lib/server/db/auth-schema.ts:51-67)\n```typescript\nexport const account = pgTable('account', {\n  id: text('id').primaryKey(),\n  userId: text('user_id').notNull().references(() =\u003e user.id, { onDelete: 'cascade' }),\n  accountId: text('account_id').notNull(),\n  providerId: text('provider_id').notNull(),\n  password: text('password'),\n  // ... other fields\n});\n```\n\n## Files to Create\n- scripts/seed/generators/users.ts\n\n## Dependencies\n- scripts/seed/utils/password.ts (for hashPassword)\n- nanoid (already in project via Better Auth)\n\n## Acceptance Criteria\n- [ ] Generates config.drivers drivers\n- [ ] Each driver has matching account with hashed password\n- [ ] ~70% high performers (cap 4-6, not flagged)\n- [ ] ~20% medium performers (cap 4, not flagged)\n- [ ] ~10% low performers (cap 3, some flagged)\n- [ ] Flagged drivers have flagWarningDate set\n- [ ] Seeded drivers can log in with email + 'test1234'\n- [ ] Returns array of { id, name, email } for use by other generators\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:36:35.3147592+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:49.3297346+09:00","closed_at":"2026-02-03T22:32:49.3297346+09:00","dependencies":[{"issue_id":"DRV-4z7.5","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:36:35.3192966+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.5","depends_on_id":"DRV-4z7.2","type":"blocks","created_at":"2026-02-03T14:39:40.4293013+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.6","title":"Create preferences generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/preferences.ts)\n\n## Objective\nGenerate driver preferences with 3-6 preferred days and 1-3 preferred routes.\n\n## Implementation Details\n\n### Create scripts/seed/generators/preferences.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport type { SeedConfig } from '../config';\nimport type { GeneratedDriver } from './users';\nimport type { GeneratedRoute } from './routes';\nimport { db } from '../db';\nimport { driverPreferences } from '$lib/server/db/schema';\n\nexport async function seedPreferences(\n  config: SeedConfig,\n  drivers: GeneratedDriver[],\n  routes: GeneratedRoute[]\n): Promise\u003cvoid\u003e {\n  const toInsert = [];\n  \n  for (const driver of drivers) {\n    // 3-6 preferred days (as integers 0=Sunday, 1=Monday, ..., 6=Saturday)\n    const numDays = faker.number.int({ min: 3, max: 6 });\n    const allDays = [0, 1, 2, 3, 4, 5, 6];\n    const preferredDays = faker.helpers.shuffle(allDays).slice(0, numDays).sort((a, b) =\u003e a - b);\n    \n    // 1-3 preferred routes (UUID array)\n    const numRoutes = faker.number.int({ min: 1, max: 3 });\n    const preferredRoutes = faker.helpers.shuffle([...routes])\n      .slice(0, numRoutes)\n      .map(r =\u003e r.id);\n    \n    toInsert.push({\n      userId: driver.id,\n      preferredDays,\n      preferredRoutes,\n      updatedAt: new Date(),\n      lockedAt: null  // Not locked - preferences can be edited\n    });\n  }\n  \n  await db.insert(driverPreferences).values(toInsert);\n  console.log(`Created preferences for ${drivers.length} drivers`);\n}\n```\n\n## Schema Reference (src/lib/server/db/schema.ts:86-96)\n```typescript\nexport const driverPreferences = pgTable('driver_preferences', {\n  id: uuid('id').primaryKey().defaultRandom(),\n  userId: text('user_id')\n    .notNull()\n    .references(() =\u003e user.id, { onDelete: 'cascade' })\n    .unique(),\n  preferredDays: integer('preferred_days').array().notNull().default([]),\n  preferredRoutes: uuid('preferred_routes').array().notNull().default([]),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),\n  lockedAt: timestamp('locked_at', { withTimezone: true })\n});\n```\n\n## Files to Create\n- scripts/seed/generators/preferences.ts\n\n## Dependencies\n- Requires drivers to be seeded first (needs userId FK)\n- Requires routes to be seeded first (for preferredRoutes UUIDs)\n\n## Acceptance Criteria\n- [ ] Each driver has exactly one preferences record\n- [ ] preferredDays contains 3-6 integers from 0-6\n- [ ] preferredDays are sorted ascending\n- [ ] preferredRoutes contains 1-3 valid route UUIDs\n- [ ] lockedAt is null (editable)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:36:53.3326662+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:58.583753+09:00","closed_at":"2026-02-03T22:32:58.583753+09:00","dependencies":[{"issue_id":"DRV-4z7.6","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:36:53.3378662+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.6","depends_on_id":"DRV-4z7.4","type":"blocks","created_at":"2026-02-03T14:39:41.1648769+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.6","depends_on_id":"DRV-4z7.5","type":"blocks","created_at":"2026-02-03T14:39:41.8534753+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.7","title":"Create metrics generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/metrics.ts)\n\n## Objective\nGenerate driver metrics with realistic performance distribution.\n\n## Implementation Details\n\n### Create scripts/seed/generators/metrics.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport type { GeneratedDriver } from './users';\nimport { db } from '../db';\nimport { driverMetrics, user } from '$lib/server/db/schema';\nimport { eq } from 'drizzle-orm';\n\nexport async function seedMetrics(drivers: GeneratedDriver[]): Promise\u003cvoid\u003e {\n  const toInsert = [];\n  \n  for (const driver of drivers) {\n    // Get driver's isFlagged status to correlate metrics\n    const [driverRecord] = await db.select({ isFlagged: user.isFlagged })\n      .from(user)\n      .where(eq(user.id, driver.id));\n    \n    let attendanceRate: number;\n    let completionRate: number;\n    let totalShifts: number;\n    \n    // Performance tier determines metrics\n    // Tier correlates with isFlagged status set in users generator\n    if (driverRecord?.isFlagged) {\n      // Low performers (\u003c70%)\n      attendanceRate = faker.number.float({ min: 0.55, max: 0.69, fractionDigits: 2 });\n      completionRate = faker.number.float({ min: 0.60, max: 0.70, fractionDigits: 2 });\n      totalShifts = faker.number.int({ min: 10, max: 30 });\n    } else {\n      // Determine if high or medium performer (random since not all high performers have elevated cap)\n      const isHighPerformer = Math.random() \u003e 0.22;  // ~78% of non-flagged are high performers\n      \n      if (isHighPerformer) {\n        // High performers (85-100%)\n        attendanceRate = faker.number.float({ min: 0.85, max: 1.0, fractionDigits: 2 });\n        completionRate = faker.number.float({ min: 0.88, max: 1.0, fractionDigits: 2 });\n        totalShifts = faker.number.int({ min: 20, max: 100 });\n      } else {\n        // Medium performers (70-85%)\n        attendanceRate = faker.number.float({ min: 0.70, max: 0.84, fractionDigits: 2 });\n        completionRate = faker.number.float({ min: 0.72, max: 0.87, fractionDigits: 2 });\n        totalShifts = faker.number.int({ min: 15, max: 50 });\n      }\n    }\n    \n    const completedShifts = Math.round(totalShifts * attendanceRate);\n    \n    toInsert.push({\n      userId: driver.id,\n      totalShifts,\n      completedShifts,\n      attendanceRate,\n      completionRate,\n      updatedAt: new Date()\n    });\n  }\n  \n  await db.insert(driverMetrics).values(toInsert);\n  console.log(`Created metrics for ${drivers.length} drivers`);\n}\n```\n\n## Schema Reference (src/lib/server/db/schema.ts:184-193)\n```typescript\nexport const driverMetrics = pgTable('driver_metrics', {\n  userId: text('user_id')\n    .primaryKey()\n    .references(() =\u003e user.id, { onDelete: 'cascade' }),\n  totalShifts: integer('total_shifts').notNull().default(0),\n  completedShifts: integer('completed_shifts').notNull().default(0),\n  attendanceRate: real('attendance_rate').notNull().default(0),\n  completionRate: real('completion_rate').notNull().default(0),\n  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow()\n});\n```\n\n## Files to Create\n- scripts/seed/generators/metrics.ts\n\n## Dependencies\n- Requires drivers to be seeded first (needs userId FK)\n- Queries user table to check isFlagged status\n\n## Performance Distribution\n- ~70% high performers: 85-100% rates, 20-100 total shifts\n- ~20% medium performers: 70-85% rates, 15-50 total shifts\n- ~10% low performers: \u003c70% rates, 10-30 total shifts\n\n## Acceptance Criteria\n- [ ] Each driver has exactly one metrics record\n- [ ] completedShifts \u003c= totalShifts\n- [ ] attendanceRate = completedShifts / totalShifts (approximately)\n- [ ] Flagged drivers have low metrics (\u003c70%)\n- [ ] Non-flagged drivers have medium-high metrics (70-100%)\n- [ ] Rates are between 0 and 1\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:37:16.4464359+09:00","created_by":"Matt","updated_at":"2026-02-03T22:32:59.3961838+09:00","closed_at":"2026-02-03T22:32:59.3961838+09:00","dependencies":[{"issue_id":"DRV-4z7.7","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:37:16.4507909+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.7","depends_on_id":"DRV-4z7.5","type":"blocks","created_at":"2026-02-03T14:39:42.5474101+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.8","title":"Create assignments and shifts generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/assignments.ts)\n\n## Objective\nGenerate assignments across past, current, and future weeks with appropriate status distribution. Create shifts for completed and cancelled assignments.\n\n## Implementation Details\n\n### Create scripts/seed/generators/assignments.ts\n\n```typescript\nimport { faker } from '@faker-js/faker';\nimport type { SeedConfig } from '../config';\nimport type { GeneratedDriver } from './users';\nimport type { GeneratedRoute } from './routes';\nimport { getDateRangeForWeeks, toTorontoDateString, getWeekStart, getTorontoDayOfWeek } from '../utils/dates';\nimport { db } from '../db';\nimport { assignments, shifts, driverPreferences } from '$lib/server/db/schema';\nimport { addDays, isBefore, isAfter, startOfDay } from 'date-fns';\nimport { toZonedTime } from 'date-fns-tz';\nimport { eq } from 'drizzle-orm';\n\nconst TORONTO_TZ = 'America/Toronto';\n\nexport interface GeneratedAssignment {\n  id: string;\n  routeId: string;\n  userId: string | null;\n  date: string;\n  status: 'scheduled' | 'active' | 'completed' | 'cancelled' | 'unfilled';\n  warehouseId: string;\n}\n\nexport async function seedAssignments(\n  config: SeedConfig,\n  drivers: GeneratedDriver[],\n  routes: GeneratedRoute[]\n): Promise\u003cGeneratedAssignment[]\u003e {\n  const { startDate, endDate, currentWeekStart } = getDateRangeForWeeks(\n    config.pastWeeks,\n    config.futureWeeks\n  );\n  \n  const now = new Date();\n  const today = startOfDay(toZonedTime(now, TORONTO_TZ));\n  const generatedAssignments: GeneratedAssignment[] = [];\n  \n  // Load preferences for matching drivers to routes\n  const allPrefs = await db.select().from(driverPreferences);\n  const prefsByUser = new Map(allPrefs.map(p =\u003e [p.userId, p]));\n  \n  // Track weekly assignment counts per driver\n  const weeklyAssignments = new Map\u003cstring, Map\u003cstring, number\u003e\u003e();\n  \n  let currentDate = startDate;\n  while (isBefore(currentDate, endDate)) {\n    const dateString = toTorontoDateString(currentDate);\n    const dayOfWeek = getTorontoDayOfWeek(currentDate);\n    const weekKey = toTorontoDateString(getWeekStart(currentDate));\n    const isPast = isBefore(currentDate, today);\n    const isToday = dateString === toTorontoDateString(today);\n    \n    for (const route of routes) {\n      // Find eligible driver for this route/day\n      const eligibleDrivers = drivers.filter(d =\u003e {\n        const prefs = prefsByUser.get(d.id);\n        if (!prefs) return false;\n        if (!prefs.preferredDays.includes(dayOfWeek)) return false;\n        if (!prefs.preferredRoutes.includes(route.id)) return false;\n        \n        // Check weekly cap (simplified - use 4 as default)\n        const driverWeekMap = weeklyAssignments.get(d.id) || new Map();\n        const weekCount = driverWeekMap.get(weekKey) || 0;\n        return weekCount \u003c 4;\n      });\n      \n      // Determine status based on timing\n      let status: 'scheduled' | 'completed' | 'cancelled' | 'unfilled';\n      let assignedDriver: GeneratedDriver | null = null;\n      \n      if (eligibleDrivers.length === 0) {\n        status = 'unfilled';\n      } else if (isPast) {\n        // Past: 85% completed, 10% cancelled, 5% unfilled\n        const roll = Math.random();\n        if (roll \u003c 0.85) {\n          status = 'completed';\n          assignedDriver = faker.helpers.arrayElement(eligibleDrivers);\n        } else if (roll \u003c 0.95) {\n          status = 'cancelled';\n          assignedDriver = faker.helpers.arrayElement(eligibleDrivers);\n        } else {\n          status = 'unfilled';\n        }\n      } else {\n        // Future (including today): scheduled or unfilled\n        status = 'scheduled';\n        assignedDriver = faker.helpers.arrayElement(eligibleDrivers);\n      }\n      \n      // Track assignment for weekly cap\n      if (assignedDriver) {\n        const driverWeekMap = weeklyAssignments.get(assignedDriver.id) || new Map();\n        const weekCount = driverWeekMap.get(weekKey) || 0;\n        driverWeekMap.set(weekKey, weekCount + 1);\n        weeklyAssignments.set(assignedDriver.id, driverWeekMap);\n      }\n      \n      const [inserted] = await db.insert(assignments).values({\n        routeId: route.id,\n        userId: assignedDriver?.id || null,\n        warehouseId: route.warehouseId,\n        date: dateString,\n        status,\n        assignedBy: status === 'unfilled' ? null : 'algorithm',\n        assignedAt: status === 'unfilled' ? null : faker.date.past({ years: 0.1 })\n      }).returning();\n      \n      // Create shift for completed or cancelled assignments\n      if (status === 'completed' || status === 'cancelled') {\n        const parcelsStart = faker.number.int({ min: 100, max: 200 });\n        const deliveryRate = faker.number.float({ min: 0.90, max: 1.0 });\n        \n        await db.insert(shifts).values({\n          assignmentId: inserted.id,\n          parcelsStart,\n          parcelsDelivered: status === 'completed' ? Math.round(parcelsStart * deliveryRate) : null,\n          parcelsReturned: status === 'completed' ? Math.round(parcelsStart * (1 - deliveryRate)) : null,\n          startedAt: faker.date.past({ years: 0.1 }),\n          completedAt: status === 'completed' ? faker.date.past({ years: 0.1 }) : null,\n          cancelledAt: status === 'cancelled' ? faker.date.past({ years: 0.1 }) : null,\n          cancelReason: status === 'cancelled' ? faker.helpers.arrayElement([\n            'vehicle_breakdown', 'medical_emergency', 'family_emergency', \n            'traffic_accident', 'weather_conditions', 'personal_emergency'\n          ]) : null\n        });\n      }\n      \n      generatedAssignments.push({\n        id: inserted.id,\n        routeId: route.id,\n        userId: assignedDriver?.id || null,\n        date: dateString,\n        status,\n        warehouseId: route.warehouseId\n      });\n    }\n    \n    currentDate = addDays(currentDate, 1);\n  }\n  \n  console.log(`Created ${generatedAssignments.length} assignments with shifts`);\n  return generatedAssignments;\n}\n```\n\n## Schema Reference\n\n### Assignments (src/lib/server/db/schema.ts:99-122)\nStatus enum: 'scheduled', 'active', 'completed', 'cancelled', 'unfilled'\nAssignedBy enum: 'algorithm', 'manager', 'bid'\n\n### Shifts (src/lib/server/db/schema.ts:125-140)\nCancelReason enum: vehicle_breakdown, medical_emergency, family_emergency, \ntraffic_accident, weather_conditions, personal_emergency, other\n\n## Files to Create\n- scripts/seed/generators/assignments.ts\n\n## Dependencies\n- Requires drivers, routes, preferences to be seeded first\n- Uses date utilities from utils/dates.ts\n\n## Status Distribution\n- Past weeks: 85% completed, 10% cancelled, 5% unfilled\n- Current week past days: same as past weeks\n- Current week future days: scheduled or unfilled\n- Future weeks: scheduled or unfilled\n\n## Parcel Data (for completed/cancelled)\n- parcelsStart: 100-200\n- parcelsDelivered: 90-100% of start (completed only)\n- parcelsReturned: remainder (completed only)\n\n## Acceptance Criteria\n- [ ] Assignments span pastWeeks + currentWeek + futureWeeks\n- [ ] Past assignments have appropriate status distribution\n- [ ] Future assignments are 'scheduled' or 'unfilled'\n- [ ] Completed/cancelled assignments have shift records\n- [ ] Shift parcel counts are realistic\n- [ ] Cancelled shifts have cancelReason set\n- [ ] Weekly cap respected per driver\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:37:54.3609598+09:00","created_by":"Matt","updated_at":"2026-02-03T22:33:00.1211766+09:00","closed_at":"2026-02-03T22:33:00.1211766+09:00","dependencies":[{"issue_id":"DRV-4z7.8","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:37:54.3691093+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.8","depends_on_id":"DRV-4z7.6","type":"blocks","created_at":"2026-02-03T14:39:43.2979469+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.8","depends_on_id":"DRV-4z7.4","type":"blocks","created_at":"2026-02-03T14:39:43.9771589+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.8","depends_on_id":"DRV-4z7.5","type":"blocks","created_at":"2026-02-03T14:39:45.0808203+09:00","created_by":"Matt"}]}
{"id":"DRV-4z7.9","title":"Create route completions generator","description":"Source: docs/plans/seed-data-script.md (Step 3 - generators/route-completions.ts)\n\n## Objective\nGenerate route completion records based on completed assignments to build route familiarity for bid scoring.\n\n## Implementation Details\n\n### Create scripts/seed/generators/route-completions.ts\n\n```typescript\nimport type { GeneratedAssignment } from './assignments';\nimport { db } from '../db';\nimport { routeCompletions } from '$lib/server/db/schema';\n\nexport async function seedRouteCompletions(\n  assignments: GeneratedAssignment[]\n): Promise\u003cvoid\u003e {\n  // Aggregate completion counts by user+route\n  const completionMap = new Map\u003cstring, { \n    userId: string; \n    routeId: string; \n    count: number; \n    lastDate: string;\n  }\u003e();\n  \n  for (const assignment of assignments) {\n    // Only count completed assignments\n    if (assignment.status !== 'completed' || !assignment.userId) continue;\n    \n    const key = `${assignment.userId}:${assignment.routeId}`;\n    const existing = completionMap.get(key);\n    \n    if (existing) {\n      existing.count++;\n      if (assignment.date \u003e existing.lastDate) {\n        existing.lastDate = assignment.date;\n      }\n    } else {\n      completionMap.set(key, {\n        userId: assignment.userId,\n        routeId: assignment.routeId,\n        count: 1,\n        lastDate: assignment.date\n      });\n    }\n  }\n  \n  if (completionMap.size === 0) {\n    console.log('No completed assignments to generate route completions from');\n    return;\n  }\n  \n  const toInsert = Array.from(completionMap.values()).map(c =\u003e ({\n    userId: c.userId,\n    routeId: c.routeId,\n    completionCount: c.count,\n    lastCompletedAt: new Date(c.lastDate)\n  }));\n  \n  await db.insert(routeCompletions).values(toInsert);\n  console.log(`Created ${toInsert.length} route completion records`);\n}\n```\n\n## Schema Reference (src/lib/server/db/schema.ts:196-212)\n```typescript\nexport const routeCompletions = pgTable(\n  'route_completions',\n  {\n    userId: text('user_id')\n      .notNull()\n      .references(() =\u003e user.id, { onDelete: 'cascade' }),\n    routeId: uuid('route_id')\n      .notNull()\n      .references(() =\u003e routes.id, { onDelete: 'cascade' }),\n    completionCount: integer('completion_count').notNull().default(0),\n    lastCompletedAt: timestamp('last_completed_at', { withTimezone: true })\n  },\n  (table) =\u003e ({\n    pk: primaryKey({ columns: [table.userId, table.routeId] }),\n    userIdx: index('idx_route_completions_user').on(table.userId)\n  })\n);\n```\n\n## Files to Create\n- scripts/seed/generators/route-completions.ts\n\n## Dependencies\n- Requires assignments to be seeded first\n- Only processes assignments with status='completed'\n\n## Purpose\nRoute familiarity (completionCount) is used in bid scoring:\n```\nscore = (completion_rate * 0.4) +\n        (route_familiarity * 0.3) +  \u003c-- This uses routeCompletions\n        (attendance_rate * 0.2) +\n        (preference_bonus * 0.1)\n```\n\n## Acceptance Criteria\n- [ ] One record per unique userId+routeId combination\n- [ ] completionCount reflects actual completed assignments for that route\n- [ ] lastCompletedAt is the most recent completion date\n- [ ] Only completed assignments contribute to counts\n- [ ] Composite primary key (userId, routeId) enforced\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T14:38:15.6548785+09:00","created_by":"Matt","updated_at":"2026-02-03T22:33:00.8520463+09:00","closed_at":"2026-02-03T22:33:00.8520463+09:00","dependencies":[{"issue_id":"DRV-4z7.9","depends_on_id":"DRV-4z7","type":"parent-child","created_at":"2026-02-03T14:38:15.6603432+09:00","created_by":"Matt"},{"issue_id":"DRV-4z7.9","depends_on_id":"DRV-4z7.8","type":"blocks","created_at":"2026-02-03T14:39:45.8361581+09:00","created_by":"Matt"}]}
{"id":"DRV-59t","title":"Audit for dead code and unused exports","description":"Systematic dead code detection across entire src/ directory. Review for: unused exports (functions, types, constants exported but never imported), orphaned files not imported anywhere, unreachable code (after early returns, impossible conditions, dead branches), unused store properties (set but never read), unused schema fields (defined but not used in API or components), commented-out code blocks to remove, unused dependencies in package.json (import scan), leftover dev artifacts (console.log, TODO comments, debug flags), unused CSS classes in component style blocks. Write findings to logs/nightly/2026-02-10/audit-dead-code.md with severity ratings and safe-to-remove recommendations.","notes":"PR: https://github.com/orro3790/drive/pull/76","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:31:17.6650623+09:00","created_by":"Matt","updated_at":"2026-02-10T03:02:40.8718421+09:00","closed_at":"2026-02-10T03:01:41.0203679+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-5eo","title":"Bid window closure cron job","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement cron job that runs every minute to close expired bid windows.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/close-bid-windows/+server.ts\n- Vercel Cron schedule: every minute (*/1 * * * *)\n- Job logic:\n  1. Find all bid windows where status='open' AND closesAt \u003c= now\n  2. For windows with bids: call resolveBidWindow()\n  3. For windows without bids: keep open (indefinite per spec)\n  4. Log each resolution\n\n## Spec References\n- docs/specs/SPEC.md: Line 294 (Cron job table entry)\n- docs/specs/SPEC.md: Line 119 (No bids = stays open indefinitely)\n- docs/specs/SPEC.md: Lines 131 (Resolution timing)\n\n## Acceptance Criteria\n- Cron runs every minute\n- Expired windows with bids are resolved\n- Expired windows without bids remain open (status stays 'open')\n- Multiple windows can be processed in single run\n- Job is idempotent\n- Errors on one window don't block others\n- Job execution logged with count of processed windows\n\n## Technical Constraints\n- Query: status='open' AND closesAt \u003c= NOW() AND has at least one bid\n- Process each window independently (try/catch)\n- Verify CRON_SECRET header\n- Keep execution under 60 seconds (Vercel limit)","notes":"PR: https://github.com/orro3790/drive/pull/16","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:26:43.4517426+09:00","created_by":"Matt","updated_at":"2026-02-04T10:15:22.7900483+09:00","closed_at":"2026-02-04T10:15:22.7900483+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-5eo","depends_on_id":"DRV-n6q","type":"blocks","created_at":"2026-02-02T21:26:43.4643155+09:00","created_by":"Matt"}]}
{"id":"DRV-5iz","title":"Manager manual assignment","description":"Source: docs/specs/SPEC.md § Bidding System \u003e Manager Override\n\n## Objective\nImplement ability for managers to manually assign drivers to routes, bypassing bidding.\n\n## Scope\n- API endpoint: POST /api/assignments/[id]/assign\n- Request body: { userId: string }\n- UI: button in assignment details panel → modal to select driver\n- Validation:\n  - Target driver not flagged\n  - Target driver under weekly cap\n  - Assignment currently unfilled or in bidding\n\n## Spec References\n- docs/specs/SPEC.md: Lines 155-157 (Manager override)\n- docs/specs/SPEC.md: Line 255 (Manually assign capability)\n- docs/specs/SPEC.md: Lines 19-20 (assignedByEnum includes 'manager')\n\n## Acceptance Criteria\n- Manager can assign any eligible driver to unfilled route\n- If bid window exists, it's closed and marked resolved\n- Assignment.assignedBy set to 'manager'\n- Assignment.assignedAt set to now\n- Driver receives notification of assignment\n- Audit log records manual assignment with manager as actor\n- Cannot assign flagged driver (validation error)\n- Cannot assign driver over weekly cap (validation error)\n\n## Technical Constraints\n- Close existing bid window if any (set status='resolved', no winner)\n- Mark any pending bids as 'lost'\n- Service in src/lib/server/services/assignments.ts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:30:14.5876283+09:00","created_by":"Matt","updated_at":"2026-02-06T10:09:54.1565041+09:00","closed_at":"2026-02-06T10:09:54.1565041+09:00","close_reason":"Implemented manual assignment API/service and manager routes detail-panel assignment modal with flagged/cap validation, bid-window resolution, notifications, and audit logging.","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-5iz","depends_on_id":"DRV-zxp","type":"blocks","created_at":"2026-02-02T21:30:14.6017067+09:00","created_by":"Matt"}]}
{"id":"DRV-5xw","title":"PUT /api/preferences lock enforcement non-atomic (TOCTOU)","description":"Handler does read-then-write sequence. If cron sets lockedAt between read and write, request can mutate preferences after lock. Source: logs/nightly/2026-02-18/drv-xnb.4 finding #3.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:02:06.7154779+09:00","created_by":"Matt","updated_at":"2026-02-18T20:08:07.4693113+09:00","closed_at":"2026-02-18T20:08:07.4693113+09:00","close_reason":"Closed","labels":["atomicity","lock","preferences"],"dependencies":[{"issue_id":"DRV-5xw","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:56.8401016+09:00","created_by":"unknown"}],"comments":[{"id":60,"issue_id":"DRV-5xw","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/166","created_at":"2026-02-18T11:08:35Z"}]}
{"id":"DRV-5y4","title":"Driver preferences UI","description":"Source: docs/specs/SPEC.md § Scheduling System, § User Interfaces \u003e Driver App\nSchema: docs/specs/data-model.md § driverPreferences table\n\n## Objective\nImplement driver preferences management: select preferred work days and top 3 routes.\n\n## Scope\n- API endpoints:\n  - GET /api/preferences - Get current user's preferences\n  - PUT /api/preferences - Update preferences (if not locked)\n- UI in src/routes/(app)/settings/+page.svelte\n- Preference fields:\n  - preferredDays: checkboxes for Mon-Sun (stored as int[] where Sunday=0)\n  - preferredRoutes: searchable route selector, max 3 routes\n- Display countdown to next lock deadline (Sunday 23:59)\n- Show lock status: can edit if Week N+2 preferences not yet locked\n\n## Spec References\n- docs/specs/SPEC.md: Line 238 (Settings route description)\n- docs/specs/SPEC.md: Lines 79-84 (Preference lock cycle)\n- docs/specs/SPEC.md: Lines 67-75 (Two-week lookahead model)\n- docs/specs/data-model.md: Lines 82-89 (driverPreferences table)\n\n## Acceptance Criteria\n- Driver can select which days they prefer to work (0-7 days)\n- Driver can select up to 3 preferred routes from searchable list\n- Preferences auto-saved on change (optimistic UI)\n- Lock deadline countdown displayed prominently\n- If preferences locked for current cycle, show read-only view with \"locked until\" message\n- New drivers start with empty preferences\n\n## Technical Constraints\n- preferredDays stored as integer array [0-6] where 0=Sunday\n- preferredRoutes stored as UUID array\n- lockedAt timestamp indicates when preferences were frozen\n- Check Week N+2 lock status before allowing edits","notes":"PR: https://github.com/orro3790/drive/pull/3","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:24:02.7971367+09:00","created_by":"Matt","updated_at":"2026-02-03T11:25:20.1607056+09:00","closed_at":"2026-02-03T11:25:20.1607056+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5y4","depends_on_id":"DRV-b9t","type":"blocks","created_at":"2026-02-02T21:24:02.8031778+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo","title":"Organization multi-tenant rollout (one user one org)","description":"Execute the organization-scoped multi-tenant roadmap from documentation/plans/organization-multi-tenant-one-user-one-org.md with phased delivery and strict tenant isolation.","acceptance_criteria":"All acceptance criteria in the source plan are satisfied, including org isolation across auth, APIs, services, realtime, cron, migration, and enforcement.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-12T15:53:39.1109542+09:00","created_by":"Matt","updated_at":"2026-02-19T19:55:12.678281+09:00","closed_at":"2026-02-19T19:55:12.678281+09:00","close_reason":"Closed"}
{"id":"DRV-5yo.1","title":"Track A: schema, migrations, backfill, and validation gates","description":"Implement additive schema changes, indexes, constraints, default organization seeding, data backfill, and readiness validation gates.","acceptance_criteria":"Backfill is idempotent and validation gates prove org IDs are populated and consistent before enforcement.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:39.8506871+09:00","created_by":"Matt","updated_at":"2026-02-12T16:16:41.7791717+09:00","closed_at":"2026-02-12T16:16:41.7791717+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.1","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:39.8565802+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.10","title":"Track J: cron org iteration and dedupe isolation","description":"Refactor cron handlers to iterate organizations, include org in log context, and encode org into dedupe keys.","acceptance_criteria":"Cron jobs execute safely org-by-org without cross-org side effects.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:47.4735177+09:00","created_by":"Matt","updated_at":"2026-02-12T23:23:43.0420452+09:00","closed_at":"2026-02-12T23:23:43.0420452+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.10","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:47.477747+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.10","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:47.4881344+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.10","depends_on_id":"DRV-5yo.8","type":"blocks","created_at":"2026-02-12T15:53:47.4965533+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.11","title":"Track K: test expansion and cross-org regression coverage","description":"Add unit, auth hook, integration, realtime, cron, and migration validation tests for same-org allow and cross-org deny cases.","acceptance_criteria":"Test suite demonstrates org isolation guarantees and migration readiness with stable CI outcomes.","notes":"PR: https://github.com/orro3790/drive/pull/117","status":"closed","priority":1,"issue_type":"task","assignee":"Matt","created_at":"2026-02-12T15:53:48.2618249+09:00","created_by":"Matt","updated_at":"2026-02-13T02:41:57.5683133+09:00","closed_at":"2026-02-13T02:41:22.6744917+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:48.2656848+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.3","type":"blocks","created_at":"2026-02-12T15:53:48.2718284+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.4","type":"blocks","created_at":"2026-02-12T15:53:48.2775377+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.5","type":"blocks","created_at":"2026-02-12T15:53:48.2862219+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.6","type":"blocks","created_at":"2026-02-12T15:53:48.2934127+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.7","type":"blocks","created_at":"2026-02-12T15:53:48.3009806+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.8","type":"blocks","created_at":"2026-02-12T15:53:48.3078337+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.9","type":"blocks","created_at":"2026-02-12T15:53:48.3164485+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.11","depends_on_id":"DRV-5yo.10","type":"blocks","created_at":"2026-02-12T15:53:48.3251628+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.12","title":"Track L: rollout flags strict guard cutover and NOT NULL enforcement","description":"Execute staged rollout flags, strict guard activation, legacy cleanup, and final NOT NULL enforcement migrations.","acceptance_criteria":"Strict org enforcement is active and database constraints are finalized without service disruption.","notes":"PR: https://github.com/orro3790/drive/pull/118","status":"closed","priority":0,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T15:53:49.0713317+09:00","created_by":"Matt","updated_at":"2026-02-13T03:15:01.1478999+09:00","closed_at":"2026-02-13T03:14:22.1201757+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.12","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:49.0745793+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.12","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:49.0820169+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.12","depends_on_id":"DRV-5yo.11","type":"blocks","created_at":"2026-02-12T15:53:49.090258+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.13","title":"Cutover contract: inventory user-creation entry points and hook context propagation","description":"Source: ralph/plans/user-org-not-null-cutover.md (Scope item 6, Design approach \u003e Hook data contract, Phase 1 items 2 and 6)\n\nObjective\nProduce a definitive inventory of every runtime path that can create users and define explicit organization-assignment behavior for each path before any NOT NULL migration is applied. Validate whether Better Auth request context reliably propagates from hooks.before to databaseHooks.user.create.before to hooks.after.\n\nImplementation details\n- Audit user creation entry points in src/lib/server/auth.ts and related auth providers, admin flows, scripts, and test helpers.\n- Add/extend request-scoped context helpers in src/lib/server/auth-abuse-hardening.ts to carry signup intent and reservation metadata.\n- Build a concrete contract document in repo docs (or plan appendix) listing for each path: create/join/other mode, org assignment source, expected role, fail-closed behavior.\n- Add instrumentation/probe logic needed to prove context propagation works across all three hook stages.\n- If propagation is unreliable for any path, specify and implement fallback design requirements for later beads: derive assignment in DB hook plus short-lived signup-intent persistence for after-hook consumption.\n\nDependencies\n- Parent epic DRV-5yo\n- Must complete before DB before-hook implementation, after-hook refactor, and migration enforcement work.\n\nAcceptance criteria\n- Inventory covers all known user-creation entry points and is committed in-repo.\n- Each entry point has explicit rule: deterministic org assignment OR explicit fail-closed error.\n- Context propagation proof includes an automated test or deterministic trace evidence and identifies unsupported paths.\n- No path remains implicit or TODO-only for org assignment behavior.\n\nTechnical constraints\n- Keep one-user-one-org invariant as target state for all supported signup paths.\n- Do not weaken existing abuse-hardening semantics while introducing context contract checks.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-13T09:00:14.1117042+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:30.7732791+09:00","closed_at":"2026-02-13T09:34:30.7732791+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.13","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:14.1204868+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.14","title":"Implement pre-insert organization assignment in databaseHooks.user.create.before","description":"Source: ralph/plans/user-org-not-null-cutover.md (Phase 1 items 1,3,4,5,7; Key principle)\n\nObjective\nEnsure every supported signup user row is inserted with a resolved organizationId (and role) by implementing databaseHooks.user.create.before in auth configuration; no user insert proceeds without org assignment.\n\nImplementation details\n- Update src/lib/server/auth.ts to add databaseHooks.user.create.before and map resolved context values into returned { data: { organizationId, role } }.\n- For join mode, consume reservation output produced in hooks.before without duplicating reservation calls.\n- For create mode, provision organization before user insert using helper(s) in src/lib/server/services/organizationSignup.ts while preserving current slug/join-code generation policy, conflict retries, and dispatch settings initialization behavior.\n- Extend src/lib/server/auth-abuse-hardening.ts helpers to provide typed accessors for resolved signup metadata to DB hook code.\n- Implement explicit fail-closed API errors when org metadata is missing, malformed, or unsupported for the current entry point.\n- Preserve behavior parity for non-org fields and existing auth provider workflows except where fail-closed is now required.\n\nDependencies\n- Depends on DRV-5yo.13 for complete entry-point contract and propagation decision.\n\nAcceptance criteria\n- Join signup inserts user with non-null organizationId on first insert attempt.\n- Create signup inserts user with non-null organizationId on first insert attempt.\n- Unsupported/non-signup paths either deterministically assign organizationId or fail closed with explicit error.\n- No duplicate reservation/provision side effects are triggered by DB hook execution.\n\nTechnical constraints\n- Must remain compatible with Stage A rollout where DB column may still be nullable during deploy window.\n- Failures must surface actionable error semantics and structured logging hooks for reconciliation.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-13T09:00:22.3006112+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:30.9851648+09:00","closed_at":"2026-02-13T09:34:30.9851648+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.14","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:22.3044656+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.14","depends_on_id":"DRV-5yo.13","type":"blocks","created_at":"2026-02-13T09:00:58.6004114+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.15","title":"Refactor signup after-hook to finalization-only side effects","description":"Source: ralph/plans/user-org-not-null-cutover.md (Phase 2 items 1-5; Hook data contract items 5 and 7)\n\nObjective\nAdjust hooks.after responsibilities so it finalizes bookkeeping and ownership metadata only, never core user organization assignment, while preserving idempotency and reconciliation signaling.\n\nImplementation details\n- Update src/lib/server/auth-abuse-hardening.ts after-hook flow to consume request-scoped reservation/provision context produced earlier in pipeline.\n- In join mode, consume reservationId exactly once and mark signup_onboarding consumed without mutating user.organizationId.\n- In create mode, finalize organizations.ownerUserId and any remaining ownership metadata in src/lib/server/services/organizationSignup.ts without relying on after-hook for user org assignment.\n- Add duplicate-consumption guardrails (single reservation consumed per successful signup attempt) and explicit no-op/idempotent handling for retried callbacks.\n- Emit reconciliation logs/events when finalization fails after user insert so cleanup jobs can recover safely.\n\nDependencies\n- Depends on DRV-5yo.14 (DB before-hook assignment must be in place).\n\nAcceptance criteria\n- After-hook contains no code path that sets user.organizationId.\n- Successful join flow consumes exactly one reservation and transitions onboarding record to consumed state.\n- Successful create flow sets owner metadata correctly and remains idempotent under retries.\n- Finalization failures emit structured reconciliation signal without cross-org data corruption.\n\nTechnical constraints\n- Preserve existing transactional/state-machine protections in reservation handling.\n- Maintain backward-compatible API behavior except for stricter integrity guarantees.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-13T09:00:29.6603119+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:31.2058284+09:00","closed_at":"2026-02-13T09:34:31.2058284+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.15","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:29.6644276+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.15","depends_on_id":"DRV-5yo.14","type":"blocks","created_at":"2026-02-13T09:00:59.4438408+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.16","title":"Harden failure compensation and reconciliation observability for signup side effects","description":"Source: ralph/plans/user-org-not-null-cutover.md (Phase 3 items 1-3; Risks and mitigations)\n\nObjective\nAdd deterministic cleanup and observability so side effects created before user insert or before finalization cannot leave long-lived inconsistent data.\n\nImplementation details\n- Extend cleanup logic in src/lib/server/services/organizationSignup.ts to handle stale join reservations and stale organizations created by failed create-signup attempts where ownership never finalized.\n- Add structured event names/fields in src/lib/server/logger.ts (or existing logger constants) for before-hook assignment failures, finalization failures, and cleanup actions.\n- Implement or update optional reconciliation script scripts/reconcile-signup-org-finalization.ts for manual/automated repair workflows with clear dry-run and execution modes.\n- Define retention/time-window rules for stale detection and ensure cleanup is safe against races with in-flight signups.\n\nDependencies\n- Depends on DRV-5yo.15 (after-hook finalization flow) and DRV-5yo.14 (pre-insert assignment behavior).\n\nAcceptance criteria\n- Stale reservations are released according to policy and verified by tests or repeatable validation steps.\n- Stale organizations from failed signup attempts are detected and cleaned/reconciled safely.\n- Structured logs/metrics exist for assignment failure, finalize failure, and cleanup outcomes with enough fields for incident triage.\n- Reconciliation tooling/runbook can recover known failure scenarios without manual SQL edits.\n\nTechnical constraints\n- Cleanup operations must be idempotent and race-safe.\n- Observability changes must avoid leaking sensitive signup metadata.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-13T09:00:37.5000389+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:31.4161269+09:00","closed_at":"2026-02-13T09:34:31.4161269+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.16","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:37.5043381+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.16","depends_on_id":"DRV-5yo.15","type":"blocks","created_at":"2026-02-13T09:01:00.2821427+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.17","title":"Enforce user.organization_id NOT NULL with remediation-gated migration","description":"Source: ralph/plans/user-org-not-null-cutover.md (Phase 4 items 1-3; Rollout strategy Stage B; Deliverables 2 and 3)\n\nObjective\nApply database-level NOT NULL enforcement for user.organization_id only after deterministic null-user remediation and integrity checks pass.\n\nImplementation details\n- Create drizzle/0017_user_org_not_null.sql with precheck, remediation/backfill hook points, blocking gate when null count \u003e 0, FK drop/recreate if required, NOT NULL alteration, and post-migration FK integrity verification query.\n- Update src/lib/server/db/auth-schema.ts so organizationId uses uuid(organization_id).notNull() and matches migration constraints (including ON DELETE RESTRICT semantics on FK).\n- Produce a runbook/checklist documenting null-user detection query, remediation steps, repeat validation loop, and go/no-go criteria before migration apply.\n- Ensure warehouse and signup_onboarding constraints from prior track remain unchanged.\n\nDependencies\n- Depends on DRV-5yo.14 and DRV-5yo.15 so runtime paths already insert org-assigned users before DB strictness.\n\nAcceptance criteria\n- Migration refuses to complete when null organization_id users exist.\n- After remediation and successful apply, schema enforces NOT NULL and FK integrity checks pass.\n- Drizzle schema typings reflect non-null organizationId and compile cleanly.\n- Runbook includes exact validation/remediation commands and rollback/abort guidance.\n\nTechnical constraints\n- Migration must be safe for production rollout ordering (Stage A compatibility deploy first, Stage B enforcement second).\n- Do not introduce destructive data operations without explicit deterministic remediation logic.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-13T09:00:45.4657594+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:31.7371196+09:00","closed_at":"2026-02-13T09:34:31.7371196+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.17","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:45.4695879+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.17","depends_on_id":"DRV-5yo.14","type":"blocks","created_at":"2026-02-13T09:01:01.2468894+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.17","depends_on_id":"DRV-5yo.15","type":"blocks","created_at":"2026-02-13T09:01:02.5312057+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.18","title":"Expand signup/org-assignment test coverage and cutover validation gates","description":"Source: ralph/plans/user-org-not-null-cutover.md (Phase 5 items 1-10; Rollout strategy Stage A-C; Acceptance criteria)\n\nObjective\nProve with automated coverage and rollout checks that pre-insert org assignment, finalization behavior, and guard semantics remain correct through cutover.\n\nImplementation details\n- Add/update tests in tests/server/authSignupOnboardingHook.test.ts, tests/server/authSignupReservationFlow.test.ts, tests/server/organizationSignupService.test.ts, and new tests/server/authDatabaseHooksOrgAssignment.test.ts as needed.\n- Cover create and join signup paths asserting organizationId is present before persistence and reservation/provision side effects happen exactly once.\n- Add contract test that validates hooks.before -\u003e databaseHooks.user.create.before -\u003e hooks.after context propagation (or fallback contract behavior if propagation is not guaranteed).\n- Add negative-path tests for missing/invalid metadata fail-closed semantics and explicit behavior for non-signup user creation paths.\n- Verify guard behavior remains correct in runtime edge cases and no cross-org corruption occurs on finalize failure scenarios.\n- Document Stage A monitoring queries/metrics and Stage B go/no-go checks in cutover checklist docs.\n\nDependencies\n- Depends on DRV-5yo.14, DRV-5yo.15, DRV-5yo.16, and DRV-5yo.17 for stable runtime and schema behavior.\n\nAcceptance criteria\n- All listed scenarios in plan Phase 5 are implemented with deterministic assertions.\n- Validation commands succeed: pnpm test, pnpm exec svelte-check --tsconfig ./tsconfig.json, pnpm validate.\n- Cutover checklist includes null-user baseline monitoring and pause/remediate rule when baseline increases.\n\nTechnical constraints\n- Follow Vitest discipline: treat failing tests as potential implementation defects first; avoid weakening assertions to force green.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-13T09:00:53.5023876+09:00","created_by":"Matt","updated_at":"2026-02-13T09:34:32.1155119+09:00","closed_at":"2026-02-13T09:34:32.1155119+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.18","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-13T09:00:53.5067245+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.18","depends_on_id":"DRV-5yo.14","type":"blocks","created_at":"2026-02-13T09:01:03.3927029+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.18","depends_on_id":"DRV-5yo.15","type":"blocks","created_at":"2026-02-13T09:01:04.2721225+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.18","depends_on_id":"DRV-5yo.16","type":"blocks","created_at":"2026-02-13T09:01:05.1318694+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.18","depends_on_id":"DRV-5yo.17","type":"blocks","created_at":"2026-02-13T09:01:05.9552697+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.2","title":"Track B: auth/session organization context and guard helpers","description":"Add organizationId to auth/session context and create shared org guard helpers for authenticated, manager, and driver flows.","acceptance_criteria":"locals.organizationId is reliably populated and guard helpers are used as the canonical org authorization entry points.","notes":"PR: https://github.com/orro3790/drive/pull/108","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:40.5857664+09:00","created_by":"Matt","updated_at":"2026-02-12T17:21:02.1709666+09:00","closed_at":"2026-02-12T17:14:38.2104802+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.2","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:40.5894351+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.2","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:40.5955845+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.3","title":"Track C: signup create/join organization flows and UI","description":"Redesign signup for create vs join organization, propagate org metadata, and finalize account role plus organization assignment transactionally.","acceptance_criteria":"Owner create-org and join-org flows succeed with reconciliation on failure and deny invalid org code or approval states.","notes":"Handoff: implementation pushed on DRV-5yo.3/implementation (commits eda27dd, 38975a7). Includes create/join org signup, org finalization service, and updated tests. Validation passed via pnpm validate (0 errors, 5 existing warnings).\\nPR: https://github.com/orro3790/drive/pull/109","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:41.3251214+09:00","created_by":"Matt","updated_at":"2026-02-12T18:17:04.0417879+09:00","closed_at":"2026-02-12T18:16:30.0036842+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.3","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:41.3289987+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.3","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:41.3347061+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.3","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:41.3416999+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.4","title":"Track D: onboarding service and API org scoping","description":"Scope onboarding data and APIs by organization, add targetRole support, and enforce manager visibility and mutation boundaries.","acceptance_criteria":"Managers can only list or mutate onboarding rows in their org and onboarding approvals are role-targeted.","notes":"PR: https://github.com/orro3790/drive/pull/113","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T15:53:42.2458068+09:00","created_by":"Matt","updated_at":"2026-02-13T00:44:35.949141+09:00","closed_at":"2026-02-13T00:43:56.5986389+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.4","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:42.2563696+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.4","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:42.2711602+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.4","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:42.2910206+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.5","title":"Track E: harden high-risk manager endpoints","description":"Apply org-bound checks to drivers and reset-password high-risk manager endpoints first.","acceptance_criteria":"Cross-org manager access is denied on all high-risk endpoints while same-org operations continue to work.","notes":"PR: https://github.com/orro3790/drive/pull/114","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T15:53:43.4021166+09:00","created_by":"Matt","updated_at":"2026-02-13T01:09:20.0734217+09:00","closed_at":"2026-02-13T01:08:49.495009+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.5","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:43.4067242+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.5","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:43.4131953+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.5","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:43.4204922+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.6","title":"Track F: harden manager warehouse route assignment and reports APIs","description":"Enforce org-aware warehouse and route checks across manager APIs for assignments, bid windows, reports, and dispatch settings endpoints.","acceptance_criteria":"Manager APIs enforce same-org access for every warehouse, route, assignment, bid-window, and reporting mutation or read.","notes":"PR: https://github.com/orro3790/drive/pull/115","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T15:53:44.2544679+09:00","created_by":"Matt","updated_at":"2026-02-13T01:31:43.1546609+09:00","closed_at":"2026-02-13T01:31:04.8702883+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.6","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:44.2609768+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.6","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:44.2672568+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.6","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:44.2738247+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.7","title":"Track G: harden driver endpoints for org boundaries","description":"Ensure driver-facing APIs only read and mutate resources owned by the driver's organization.","acceptance_criteria":"Cross-org driver reads and writes are denied across dashboard, assignments, bids, preferences, metrics, and shift endpoints.","notes":"PR: https://github.com/orro3790/drive/pull/116","status":"closed","priority":1,"issue_type":"task","assignee":"Matt","created_at":"2026-02-12T15:53:45.1098593+09:00","created_by":"Matt","updated_at":"2026-02-13T01:55:18.2481481+09:00","closed_at":"2026-02-13T01:54:41.7196251+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-5yo.7","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:45.1371124+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.7","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:45.1487551+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.7","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:45.1545586+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.8","title":"Track H: service-layer org scoping refactor","description":"Refactor manager access, scheduling, bidding, assignments, notifications, metrics, flagging, health, noshow, and dispatch settings services to be org-scoped.","acceptance_criteria":"All service-layer data access and fanout paths are org-local with no global cross-tenant scans.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:45.8883344+09:00","created_by":"Matt","updated_at":"2026-02-12T22:46:57.5720123+09:00","closed_at":"2026-02-12T22:46:57.5720123+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.8","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:45.8923134+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.8","depends_on_id":"DRV-5yo.1","type":"blocks","created_at":"2026-02-12T15:53:45.8982528+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.8","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:45.9041869+09:00","created_by":"Matt"}]}
{"id":"DRV-5yo.9","title":"Track I: realtime manager SSE organization isolation","description":"Bucket manager SSE streams by organization and require org context for all broadcast call sites.","acceptance_criteria":"Realtime events are only delivered to managers in the same organization.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-12T15:53:46.7126412+09:00","created_by":"Matt","updated_at":"2026-02-12T23:23:42.4395504+09:00","closed_at":"2026-02-12T23:23:42.4395504+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-5yo.9","depends_on_id":"DRV-5yo","type":"parent-child","created_at":"2026-02-12T15:53:46.7169046+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.9","depends_on_id":"DRV-5yo.2","type":"blocks","created_at":"2026-02-12T15:53:46.7240668+09:00","created_by":"Matt"},{"issue_id":"DRV-5yo.9","depends_on_id":"DRV-5yo.8","type":"blocks","created_at":"2026-02-12T15:53:46.7313903+09:00","created_by":"Matt"}]}
{"id":"DRV-5yr","title":"Audit scheduling, confirmations, and no-show services","description":"Production readiness audit of src/lib/server/services/scheduling.ts (375 lines), src/lib/server/services/confirmations.ts (204 lines), src/lib/server/services/noshow.ts (262 lines). Review for: schedule generation algorithm correctness (2-week lookahead, preference matching), timezone handling (Toronto/Eastern), DST transitions on confirmation deadlines and no-show detection, confirmation window boundaries (7 days to 48h), auto-drop at 48h triggering bid window, no-show detection at exactly 9:00:00, preference locking Sunday 23:59 Toronto, new driver scheduling wait. Write findings to logs/nightly/2026-02-10/audit-services-scheduling-pipeline.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:42.8022478+09:00","created_by":"Matt","updated_at":"2026-02-10T06:11:26.6571724+09:00","closed_at":"2026-02-10T06:11:26.6571724+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":30,"issue_id":"DRV-5yr","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/90","created_at":"2026-02-09T21:12:32Z"}]}
{"id":"DRV-5zym","title":"Nightly 2026-02-18: Late-Cancel Boundary Fix","description":"Parent epic for late-cancel boundary findings from nightly audit 2026-02-18. High: penalty threshold uses global 07:00 instead of per-route start time.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-18T12:45:05.4151119+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:20.0256895+09:00","closed_at":"2026-02-18T22:55:20.0256895+09:00","close_reason":"All late-cancel boundary child findings are now implemented and closed.","labels":["business-logic","nightly-audit","scheduling"]}
{"id":"DRV-65d","title":"Shift start and complete flow","description":"Source: docs/specs/SPEC.md § Core Concepts \u003e Entities (Shift)\nSchema: docs/specs/data-model.md § shifts table\n\n## Objective\nImplement the shift lifecycle: start shift with parcel count, complete shift with delivery metrics.\n\n## Scope\n- API endpoints:\n  - POST /api/shifts/start - Start shift (parcel count input)\n  - POST /api/shifts/complete - Complete shift (delivered/returned counts)\n- UI flow in driver dashboard:\n  - If today has assignment and shift not started: show \"Start Shift\" button\n  - Start: prompt for parcels_start count\n  - Active shift: show \"Complete Shift\" button\n  - Complete: prompt for parcels_delivered and parcels_returned\n- Update assignment status through lifecycle: scheduled → active → completed\n\n## Spec References\n- docs/specs/SPEC.md: Lines 51-52 (Shift entity description)\n- docs/specs/SPEC.md: Line 236 (Dashboard shows today's shift)\n- docs/specs/data-model.md: Lines 106-118 (shifts table)\n- docs/specs/data-model.md: Lines 19 (assignmentStatusEnum)\n\n## Acceptance Criteria\n- Driver can start shift only on assignment date\n- Start shift creates Shift record with parcels_start and startedAt\n- Assignment status changes to 'active' on start\n- Driver can complete active shift\n- Complete requires parcels_delivered (parcels_returned optional, default 0)\n- Assignment status changes to 'completed' on complete\n- Shift completedAt timestamp set\n- Cannot start already-started shift\n- Cannot complete already-completed shift\n\n## Technical Constraints\n- Shift has 1:1 relationship with Assignment\n- parcels_delivered + parcels_returned should not exceed parcels_start (warn but allow)\n- All timestamps in Toronto timezone\n- Completion triggers metrics update (separate bead)","notes":"PR: https://github.com/orro3790/drive/pull/7","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:27:08.4004607+09:00","created_by":"Matt","updated_at":"2026-02-03T19:54:17.8412119+09:00","closed_at":"2026-02-03T19:54:17.8412119+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-65d","depends_on_id":"DRV-xgp","type":"blocks","created_at":"2026-02-02T21:27:08.4095085+09:00","created_by":"Matt"}]}
{"id":"DRV-65e","title":"Audit health service","description":"Production readiness audit of src/lib/server/services/health.ts (942 lines). Review for: score calculation math correctness (attendance 50%, completion 30%, reliability 20%), hard-stop logic (no-shows and 2+ late cancellations cap at 49, reset stars), star progression qualifying week criteria, daily vs weekly evaluation timezone edge cases, pool eligibility removal on hard-stop, edge cases (new drivers, partial weeks, boundary scores 0/49/50/100), simulation preview correctness, data staleness during evaluation. Write findings to logs/nightly/2026-02-10/audit-services-health.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/77","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:30.8383202+09:00","created_by":"Matt","updated_at":"2026-02-10T03:17:47.0055978+09:00","closed_at":"2026-02-10T03:16:28.8276188+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-69a","title":"Push notification infrastructure","description":"Source: docs/specs/SPEC.md § Notifications \u003e Push Notifications\nConfig: CLAUDE.md § Firebase Configuration\n\n## Objective\nImplement Firebase Cloud Messaging integration for sending push notifications.\n\n## Scope\n- Server-side FCM service using Firebase Admin SDK\n- Service function: sendPushNotification(userId: string, type: NotificationType, data: object)\n- Store FCM tokens per user (add fcmToken column to users or separate table)\n- Notification types per spec:\n  - bid_open, bid_won, bid_lost\n  - shift_reminder, shift_cancelled\n  - warning, urgent_unfilled\n\n## Spec References\n- docs/specs/SPEC.md: Lines 266-278 (Push notification table)\n- docs/specs/SPEC.md: Lines 33 (FCM in tech stack)\n- CLAUDE.md: § Firebase Configuration (Admin SDK vs Web SDK)\n\n## Acceptance Criteria\n- FCM Admin SDK initialized with service account credentials\n- Users can register their FCM token (endpoint: POST /api/users/fcm-token)\n- sendPushNotification sends to user's registered token\n- Notification includes title and body per type\n- Failed sends logged but don't throw (user may have invalid token)\n- Notification also persisted to notifications table for in-app display\n\n## Technical Constraints\n- Use FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, FIREBASE_PRIVATE_KEY from env\n- Service in src/lib/server/services/notifications.ts\n- FCM tokens can change; client re-registers on app open\n- Handle users without FCM token (skip push, still create in-app notification)","notes":"PR: https://github.com/orro3790/drive/pull/8","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:28:34.4265895+09:00","created_by":"Matt","updated_at":"2026-02-03T20:28:51.0498529+09:00","closed_at":"2026-02-03T20:28:51.0498529+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-69a","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:28:34.4316178+09:00","created_by":"Matt"}]}
{"id":"DRV-69n","title":"Server: Resolve latest GitHub release APK","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Add a server-only helper that fetches GitHub Releases latest metadata, computes versionName/versionCode, and selects a deterministic APK download URL.\n\nFiles\n- Add: src/lib/server/githubRelease.ts\n\nImplementation Details\n- Export a function (example):\n  - async function getLatestAndroidApkRelease(): Promise\u003c{ versionName: string; versionCode: number; downloadUrl: string; tagName: string; assetName: string; source: 'github' | 'cache' }\u003e\n- Fetch URL:\n  - https://api.github.com/repos/orro3790/drive/releases/latest\n- Fetch options:\n  - Use AbortController timeout (5-10s).\n  - Headers:\n    - Accept: application/vnd.github+json\n    - User-Agent: drive-app-version-endpoint\n    - X-GitHub-Api-Version: 2022-11-28\n    - Authorization: Bearer \u003cGITHUB_TOKEN\u003e (only if env.GITHUB_TOKEN is present)\n- Parse/validate tag:\n  - Strip leading 'v'.\n  - Validate stable semver only: /^\\d+\\.\\d+\\.\\d+$/\n  - Reject anything else (including -alpha/-rc).\n- Compute versionCode:\n  - major*10000 + minor*100 + patch\n- Asset selection:\n  - Consider only assets with name ending in .apk\n  - Priority order:\n    1) name includes 'universal'\n    2) name starts with 'drive-v'\n    3) name === 'app-release.apk'\n    4) lexicographically smallest .apk name\n  - Use asset.browser_download_url\n- Caching (module-scoped):\n  - Keep lastKnownGood payload + fetchedAt timestamp.\n  - TTL should align with /api/app-version s-maxage (e.g. 10 minutes).\n  - Store and reuse ETag if present; send If-None-Match and handle 304.\n- Error handling:\n  - If fetch fails and lastKnownGood exists: return cached payload with source:'cache'.\n  - If no cached payload: throw a typed error that callers can map to 503.\n- Security:\n  - Never log or return the GitHub token.\n\nAcceptance Criteria\n- Helper returns a tag-scoped downloadUrl (contains /releases/download/vX.Y.Z/...).\n- Helper selects the same asset deterministically across runs.\n- Helper behaves correctly on 304 and transient errors.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-15T22:56:51.1762971+09:00","created_by":"Matt","updated_at":"2026-02-15T23:10:03.1537649+09:00","closed_at":"2026-02-15T23:10:03.1537649+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-69n","depends_on_id":"DRV-jwl","type":"blocks","created_at":"2026-02-15T22:58:00.6426359+09:00","created_by":"unknown"}]}
{"id":"DRV-6fs","title":"Route PATCH: add tests for cross-warehouse authorization boundary","description":"No direct route PATCH test asserting 403 on unauthorized target warehouse moves. Need tests for: (a) deny move to inaccessible target warehouse, (b) allow move to accessible target warehouse, (c) deny update when current warehouse is inaccessible. Source: logs/nightly/2026-02-18/drv-xnb.6-route-patch-cross-warehouse-authorization-audit.md Finding #5","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-18T12:07:30.1446033+09:00","created_by":"Matt","updated_at":"2026-02-18T12:07:30.1446033+09:00","labels":["authorization","routes","testing"]}
{"id":"DRV-6y8","title":"Driver Route History — Tabbed UI in /drivers","description":"Add a \"View Route History\" button in the Driver Details panel on /drivers. When clicked, open a new tab in the data table that displays the selected driver's full shift history (all completed routes with parcel data, exceptions, dates).\n\nRequirements:\n- Multiple simultaneous driver tabs supported\n- Each tab closable via an \"x\" button\n- Persist open tabs in localStorage (similar to existing column resize persistence)\n- Auto-select the new tab when opened\n\n**A plan must be created before implementation begins.**","notes":"PR: https://github.com/orro3790/drive/pull/100","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:27:38.7838589+09:00","created_by":"Matt","updated_at":"2026-02-11T12:43:14.5955922+09:00","closed_at":"2026-02-11T12:42:20.9426003+09:00","close_reason":"Closed","labels":["feature","frontend","ui"],"dependencies":[{"issue_id":"DRV-6y8","depends_on_id":"DRV-744","type":"blocks","created_at":"2026-02-11T01:27:46.3362671+09:00","created_by":"Matt"}]}
{"id":"DRV-71c","title":"Coverage docs Not Yet Proven section omits known High-risk gaps","description":"nightly-e2e-coverage.md Not Yet Proven section omits notification reliability gaps (drv-xnb.8: no transient/terminal taxonomy, no token cleanup, misleading fanout counters) and orchestrator report consistency gaps (drv-xnb.11). Source: logs/nightly/2026-02-18/drv-xnb.12-audit-checklist-docs-alignment-with-current-coverage.md Finding 4","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:06:45.796749+09:00","created_by":"Matt","updated_at":"2026-02-18T12:06:45.796749+09:00","labels":["accuracy","documentation","testing"],"dependencies":[{"issue_id":"DRV-71c","depends_on_id":"DRV-b0dc","type":"parent-child","created_at":"2026-02-18T12:48:43.1952047+09:00","created_by":"unknown"}]}
{"id":"DRV-71w","title":"ADV-* adversarial concurrency scenarios missing from integration suite","description":"Planned adversarial deliverables (ADV-001 through ADV-003) are documented but missing from integration suite. No tests/integration/adversarial/ directory exists. Bidding integration does not test near-simultaneous acceptance or conflict recovery. No-show integration lacks duplicate-invocation matrix. Source: logs/nightly/2026-02-18/drv-b1l.8-adversarial-concurrency-idempotency-scenario-pack-audit.md","notes":"Implemented ADV-001..003 integration adversarial scenarios, added IDEMP invariants, and updated coverage docs. pnpm validate passes. Integration test execution is blocked locally because DATABASE_URL is not set for integration harness.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:04:49.9044444+09:00","created_by":"Matt","updated_at":"2026-02-18T22:19:06.884849+09:00","closed_at":"2026-02-18T22:19:06.884849+09:00","close_reason":"Closed","labels":["concurrency","integration","testing"],"dependencies":[{"issue_id":"DRV-71w","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:55.4854544+09:00","created_by":"unknown"}],"comments":[{"id":65,"issue_id":"DRV-71w","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/173","created_at":"2026-02-18T13:19:05Z"}]}
{"id":"DRV-744","title":"Driver Route History — Data \u0026 API","description":"Surface every record of a driver's completed shifts/routes, including parcel counts (start, returned, delivered), exception details (exceptedReturns, exceptionNotes), and timestamps. This data is needed for auditing and future payroll (v2/v3 — no in-app payroll logic now, handled manually). Expose via an API endpoint that the manager dashboard can consume.\n\nSource: .claude/plans/fancy-crunching-shannon.md\n\n**A plan must be created before implementation begins.** ✅ Plan reviewed.","notes":"PR: https://github.com/orro3790/drive/pull/100","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:27:31.1444302+09:00","created_by":"Matt","updated_at":"2026-02-11T12:43:15.031192+09:00","closed_at":"2026-02-11T12:42:15.4219081+09:00","close_reason":"Closed","labels":["api","backend","feature"]}
{"id":"DRV-7cc","title":"Harden production log shipping to Axiom","description":"Finalize observability after the crash hotfix: make Axiom transport wiring production-reliable and explicit. Keep the current safe fallback, but add clear operator signal when fallback stdout logging is active so we can detect misconfiguration quickly.","acceptance_criteria":"1) Axiom transport is verified to initialize successfully in production when configured. 2) If transport is unavailable, app keeps running and emits an explicit warning signal once per cold start. 3) Required env vars/setup for Axiom are documented in project docs. 4) Verification steps confirm logs appear in Axiom and fallback path can be observed intentionally.","notes":"Finalized implementation and validation. Quality gates passed: pnpm lint, pnpm check, pnpm test (262 passed). Added follow-up DRV-bx1 for deferred latency monitor because free-tier cap allows only 3 active monitors. Active monitor set remains high error burst, traffic silent (no-data), and auth abuse burst.","status":"closed","priority":4,"issue_type":"chore","created_at":"2026-02-07T22:02:40.1373991+09:00","created_by":"Matt","updated_at":"2026-02-10T21:22:25.5746688+09:00","closed_at":"2026-02-10T21:22:25.5746688+09:00","close_reason":"Completed observability hardening and monitor baseline setup; remaining latency monitor tracked in DRV-bx1 due free-tier cap.","labels":["logging","observability"]}
{"id":"DRV-7u4","title":"Settings UX refactor for account and password flows","description":"Settings UX is currently confusing and error-prone.\\n\\nProblems to fix:\\n- Account fields (name/email/phone) are visually independent quick edits but currently rely on shared footer Save/Cancel.\\n- Password fields are shown as separated rows, which implies blur-save behavior, but they are a coupled form requiring current/new/confirm validation.\\n- Password visibility icon placement is inconsistent with InlineEditor slot expectations.\\n- Settings sidebar surface color differs from main content panel and breaks visual continuity.\\n\\nExpected behavior:\\n- Name/email/phone save inline on blur (per-field), no account footer Save/Cancel.\\n- Password section is a clearly grouped form unit with dedicated action controls.\\n- Password visibility toggles use InlineEditor icon slots cleanly (leading icon position preferred).\\n- Sidebar and content area share the same surface color token.","notes":"PR: https://github.com/orro3790/drive/pull/36","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-06T12:17:49.4122992+09:00","created_by":"Matt","updated_at":"2026-02-06T16:07:26.1552059+09:00","closed_at":"2026-02-06T16:06:13.1484002+09:00","close_reason":"Closed"}
{"id":"DRV-7x9","title":"Audit assignment, preference, route, and warehouse endpoints","description":"Production readiness audit of src/routes/api/assignments/ (confirm, cancel, assign, emergency-reopen), src/routes/api/preferences/ (get, patch, routes), src/routes/api/routes/ (CRUD), src/routes/api/warehouses/ (CRUD + managers), src/routes/api/onboarding/ (list, create, revoke). Review for: manager-only endpoint restriction, driver-scoped data access, confirm window enforcement (7d-48h), cancel late-cancellation detection, preference locked rejection after Sunday, route management scoped to manager warehouses, warehouse cascading on delete, onboarding invite lifecycle, input validation, consistent error format. Write findings to logs/nightly/2026-02-10/audit-api-management.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/89","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:21.0798966+09:00","created_by":"Matt","updated_at":"2026-02-10T05:57:43.2978929+09:00","closed_at":"2026-02-10T05:56:57.0081077+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-80g","title":"Missing test coverage for createBidWindow partial-failure scenarios","description":"Cron tests mock createBidWindow as pure boundary. No tests for 'assignment unfilled/audited then insert or fanout failure' behavior. Source: logs/nightly/2026-02-18/drv-xnb.3 finding #4.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:04:04.0757888+09:00","created_by":"Matt","updated_at":"2026-02-18T12:04:04.0757888+09:00","labels":["atomicity","bidding","testing"]}
{"id":"DRV-81d","title":"Onboarding allowlist TOCTOU: signup authorization race across phases","description":"Signup spans before/db/after hooks. Join assignment sourced from earlier reservation while finalize deferred to after hook. Revocation can occur during signup, finalize failure does not rollback user. Source: logs/nightly/2026-02-18/drv-xnb.1 finding #6.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:01:07.0045192+09:00","created_by":"Matt","updated_at":"2026-02-18T16:01:57.8047532+09:00","closed_at":"2026-02-18T16:01:57.8047532+09:00","close_reason":"Closed","labels":["auth","onboarding","security"],"dependencies":[{"issue_id":"DRV-81d","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:52.0095267+09:00","created_by":"unknown"}],"comments":[{"id":58,"issue_id":"DRV-81d","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/160","created_at":"2026-02-18T07:04:18Z"}]}
{"id":"DRV-84d","title":"Create reset-password page","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Create #4)\n\nCreate the password reset completion page.\n\nFILE TO CREATE: src/routes/(auth)/reset-password/+page.svelte\n\nPATTERN REFERENCE: src/routes/(auth)/sign-in/+page.svelte (password field pattern lines 101-132)\n\nCOMPONENT STRUCTURE:\n1. Script section with:\n   - Import goto from $app/navigation\n   - Import page from $app/stores\n   - Import authClient, InlineEditor, Button, Icon, NoticeBanner\n   - Import Eye, EyeOff, Key icons\n   - Import * as m from $lib/paraglide/messages.js\n   - Derived: token = $page.url.searchParams.get(token)\n   - Derived: errorParam = $page.url.searchParams.get(error)\n   - State: password, confirmPassword, showPassword, showConfirmPassword, errorMessage, isSubmitting, isSuccess\n\n2. Effect to check for INVALID_TOKEN error param on mount\n\n3. handleSubmit function:\n   - Guard: if (isSubmitting || !token) return\n   - Validate: password === confirmPassword (else show mismatch error)\n   - Validate: password.length \u003e= 8 (else show min length error)\n   - Call: authClient.resetPassword({ newPassword: password, token })\n   - On error: set errorMessage\n   - On success: set isSuccess = true, setTimeout(() =\u003e goto(/sign-in), 3000)\n\n4. Template:\n   - .auth-card container\n   - Header with title and subtitle\n   - If isSuccess: Show success banner and redirect notice\n   - If no token or INVALID_TOKEN: Show warning banner and link to /forgot-password\n   - Else: Show form with two password InlineEditors and submit Button\n\n5. Password fields:\n   - Both use inputType derived from showPassword state\n   - Both have visibility toggle button in leadingIcon snippet\n   - First: id=password, autocomplete=new-password\n   - Second: id=confirm-password, autocomplete=new-password\n\nACCEPTANCE CRITERIA:\n- Page renders at /reset-password\n- Reads token from ?token= query param\n- Shows invalid token error if ?error=INVALID_TOKEN\n- Shows invalid token error if no token present\n- Validates passwords match before submit\n- Validates password min 8 chars before submit\n- Calls authClient.resetPassword on valid submit\n- Redirects to /sign-in after 3 second delay on success\n- Password visibility toggles work independently\n- All text uses i18n messages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:14:49.834865+09:00","created_by":"Matt","updated_at":"2026-02-03T09:23:59.0473+09:00","closed_at":"2026-02-03T09:23:59.0473+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-84d","depends_on_id":"DRV-dma","type":"blocks","created_at":"2026-02-03T09:15:34.2198856+09:00","created_by":"Matt"}]}
{"id":"DRV-8bq","title":"Whitelist manager route and drivers filter toolbar","description":"Move whitelist management from settings page card-based UI to a dedicated /whitelist manager route with DataTable (matching warehouse/routes/drivers pattern). Also add missing filter and reset buttons to the drivers route toolbar.","notes":"PR: https://github.com/orro3790/drive/pull/101","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-11T15:04:55.7526399+09:00","created_by":"Matt","updated_at":"2026-02-11T15:41:55.434819+09:00","closed_at":"2026-02-11T15:41:13.1219694+09:00","close_reason":"Closed","labels":["backend","frontend","manager-ui"]}
{"id":"DRV-8bq.1","title":"Onboarding service — add user join for createdByName","description":"Modify listSignupOnboardingEntries() in src/lib/server/services/onboarding.ts to left-join with user table (from auth-schema.ts) and return createdByName: string | null. Add createdByName to SignupOnboardingEntry interface. Update toOnboardingEntry() to accept optional createdByName param with null default so existing callers are unaffected.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":30,"created_at":"2026-02-11T15:05:04.5527973+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:47.9232223+09:00","closed_at":"2026-02-11T19:48:47.9232223+09:00","close_reason":"Closed","labels":["api","backend"],"dependencies":[{"issue_id":"DRV-8bq.1","depends_on_id":"DRV-8bq","type":"parent-child","created_at":"2026-02-11T15:05:04.5565626+09:00","created_by":"Matt"}]}
{"id":"DRV-8bq.2","title":"Create whitelist store (whitelistStore.svelte.ts)","description":"Create src/lib/stores/whitelistStore.svelte.ts following warehouseStore.svelte.ts pattern. WhitelistEntry type with all SignupOnboardingEntry fields + createdByName. Methods: load() via GET /api/onboarding, create(email) via POST /api/onboarding with optimistic insert, revoke(id) via PATCH /api/onboarding/[id]/revoke with optimistic status update. Include mutation versioning, ensureOnlineForWrite() guard, toast feedback, rollback on failure.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":45,"created_at":"2026-02-11T15:05:13.7903912+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:49.0942378+09:00","closed_at":"2026-02-11T19:48:49.0942378+09:00","close_reason":"Closed","labels":["frontend","store"],"dependencies":[{"issue_id":"DRV-8bq.2","depends_on_id":"DRV-8bq","type":"parent-child","created_at":"2026-02-11T15:05:13.7934919+09:00","created_by":"Matt"},{"issue_id":"DRV-8bq.2","depends_on_id":"DRV-8bq.1","type":"blocks","created_at":"2026-02-11T15:05:13.802684+09:00","created_by":"Matt"}]}
{"id":"DRV-8bq.3","title":"Whitelist page, sidebar nav, i18n, settings cleanup","description":"Create src/routes/(manager)/whitelist/+page.svelte following warehouses/+page.svelte pattern with PageWithDetailPanel + DataTable. Columns: email (text, stickyLeft), resolvedStatus (custom Chip cell), createdByName (text), createdAt (date). Chrome: tabs, toolbar (filter + approve + reset), showColumnVisibility/showExport/showWideModeToggle. Filter drawer with email search + status select. Create modal for email approval. View-only detail panel with revoke button. Add ShieldPlus nav item to AppSidebar managerNavItems. Add all whitelist_* and nav_whitelist i18n messages to messages/en.json. Remove ManagerOnboardingSection from settings page.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-11T15:05:26.0574421+09:00","created_by":"Matt","updated_at":"2026-02-11T19:50:36.4383552+09:00","closed_at":"2026-02-11T19:50:36.4383552+09:00","close_reason":"Closed","labels":["frontend","i18n","manager-ui"],"dependencies":[{"issue_id":"DRV-8bq.3","depends_on_id":"DRV-8bq","type":"parent-child","created_at":"2026-02-11T15:05:26.0618334+09:00","created_by":"Matt"},{"issue_id":"DRV-8bq.3","depends_on_id":"DRV-8bq.2","type":"blocks","created_at":"2026-02-11T15:05:26.0717251+09:00","created_by":"Matt"}]}
{"id":"DRV-8bq.4","title":"Add filter toolbar and filter drawer to drivers page","description":"Add toolbar snippet to src/routes/(manager)/drivers/+page.svelte with filter button (opens Drawer) and reset button (clears filters, uses drivers_filter_reset i18n key). Add filter state: nameFilter, emailFilter, healthStateFilter, flaggedFilter, poolEligibleFilter. Create filteredDrivers derived that filters driverStore.drivers. Update createSvelteTable data source. Filter drawer with InlineEditor for name/email, Select for health state/flagged/pool eligible. Copy filter-form CSS from warehouse page. Add drivers_filter_* i18n messages and common_yes/common_no to messages/en.json.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2026-02-11T15:05:36.479842+09:00","created_by":"Matt","updated_at":"2026-02-11T19:50:37.5915305+09:00","closed_at":"2026-02-11T19:50:37.5915305+09:00","close_reason":"Closed","labels":["frontend","i18n","manager-ui"],"dependencies":[{"issue_id":"DRV-8bq.4","depends_on_id":"DRV-8bq","type":"parent-child","created_at":"2026-02-11T15:05:36.4844225+09:00","created_by":"Matt"}]}
{"id":"DRV-8cx","title":"Integration triage runbook has stale YYYY-MM-DD placeholder","description":"integration-triage-runbook.md still contains YYYY-MM-DD placeholder in Last validated field, so readers cannot tell if checklist guidance reflects current known behavior. Source: logs/nightly/2026-02-18/drv-xnb.12-audit-checklist-docs-alignment-with-current-coverage.md Finding 6","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-02-18T12:06:57.2513724+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:17.8290581+09:00","closed_at":"2026-02-19T19:54:17.8290581+09:00","close_reason":"Closed","labels":["documentation","maintenance"],"dependencies":[{"issue_id":"DRV-8cx","depends_on_id":"DRV-b0dc","type":"parent-child","created_at":"2026-02-18T12:48:45.1641487+09:00","created_by":"unknown"}]}
{"id":"DRV-8lao","title":"Nightly 2026-02-18: Atomicity and Transaction Safety","description":"Parent epic for atomicity/transaction safety findings from nightly audit 2026-02-18. Critical: non-atomic signup, bid-window creation, preference locking.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-18T12:44:58.3907133+09:00","created_by":"Matt","updated_at":"2026-02-18T20:11:26.6410167+09:00","closed_at":"2026-02-18T20:11:26.6410167+09:00","close_reason":"Closed","labels":["atomicity","nightly-audit","security","transactions"]}
{"id":"DRV-8rv","title":"UUID path validation missing in 6 dynamic API routes","description":"6 dynamic API routes use path params directly without UUID validation: assignments/[id]/confirm, assignments/[id]/cancel, shifts/[assignmentId]/edit, drivers/[id], drivers/[id]/health, drivers/[id]/shifts. Source: logs/nightly/2026-02-18/drv-xnb.9-api-input-and-error-contract-consistency-audit.md Finding 2","notes":"PR: https://github.com/orro3790/drive/pull/171","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:03:12.9464377+09:00","created_by":"Matt","updated_at":"2026-02-18T21:46:39.3431379+09:00","closed_at":"2026-02-18T21:46:22.5795023+09:00","close_reason":"Closed","labels":["api","input-validation","security"],"dependencies":[{"issue_id":"DRV-8rv","depends_on_id":"DRV-3ads","type":"parent-child","created_at":"2026-02-18T12:48:26.7366217+09:00","created_by":"unknown"}]}
{"id":"DRV-8ug","title":"Preference lock deadline uses mixed timezone logic, sensitive to host TZ","description":"getNextLockDeadline mixes Toronto weekday extraction with local-time Date mutation. Lock status is sensitive to host timezone and can be early/late from intended Sunday 23:59 Toronto boundary. Source: logs/nightly/2026-02-18/drv-xnb.2 finding #3.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:03:17.2863904+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:16.0695835+09:00","closed_at":"2026-02-19T19:54:16.0695835+09:00","close_reason":"Closed","labels":["lock","preferences","timezone"]}
{"id":"DRV-8v4","title":"Metrics calculation service","description":"Source: docs/specs/SPEC.md § Performance \u0026 Flagging \u003e Metrics Tracked\nSchema: docs/specs/data-model.md § driverMetrics, routeCompletions tables\n\n## Objective\nImplement service to recalculate driver metrics after shift completion.\n\n## Scope\n- Service function: updateDriverMetrics(userId: string)\n- Metrics to calculate:\n  - attendance_rate = completed_shifts / total_assigned_shifts\n  - completion_rate = avg(parcels_delivered / parcels_start) across all shifts\n  - totalShifts, completedShifts counts\n- Also update routeCompletions table:\n  - Increment completion_count for the route\n  - Update lastCompletedAt\n\n## Spec References\n- docs/specs/SPEC.md: Lines 187-193 (Metrics tracked table)\n- docs/specs/SPEC.md: Line 141 (Route familiarity normalization)\n- docs/specs/data-model.md: Lines 143-150 (driverMetrics table)\n- docs/specs/data-model.md: Lines 153-160 (routeCompletions table)\n\n## Acceptance Criteria\n- Metrics recalculated after each shift completion\n- attendance_rate: count assignments where shift exists and completedAt set / total assignments\n- completion_rate: average of (parcels_delivered / parcels_start) for all completed shifts\n- Route familiarity incremented for completed route\n- Handles edge cases: zero assignments (rate = 0), zero parcels_start (skip that shift)\n- driverMetrics.updatedAt reflects recalculation time\n\n## Technical Constraints\n- Service in src/lib/server/services/metrics.ts\n- Called automatically after shift completion\n- Must handle division by zero gracefully\n- Consider no-shows: assignment exists but no shift (counts against attendance)","notes":"PR: https://github.com/orro3790/drive/pull/12","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:27:30.5216768+09:00","created_by":"Matt","updated_at":"2026-02-04T02:09:36.3549769+09:00","closed_at":"2026-02-04T02:09:36.3549769+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-8v4","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:27:30.5281302+09:00","created_by":"Matt"}]}
{"id":"DRV-91a","title":"Week-start derivation runtime-timezone dependent in bidding/assignment","description":"getWeekStart(parseISO(...)) resolves date-only strings in host local timezone instead of Toronto. Monday assignment dates can map to previous Toronto day/week, shifting weekly-cap enforcement. Source: logs/nightly/2026-02-18/drv-xnb.2 finding #2.","notes":"PR: https://github.com/orro3790/drive/pull/164","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:01:42.9157774+09:00","created_by":"Matt","updated_at":"2026-02-18T19:44:19.232305+09:00","closed_at":"2026-02-18T19:42:59.8415979+09:00","close_reason":"Replaced runtime-TZ-sensitive getWeekStart(parseISO(date)) paths with Toronto date-only week-start helper across bidding/assignment flows; updated related tests.","labels":["assignments","bidding","timezone"],"dependencies":[{"issue_id":"DRV-91a","depends_on_id":"DRV-szo5","type":"parent-child","created_at":"2026-02-18T12:46:39.9540444+09:00","created_by":"unknown"}]}
{"id":"DRV-958m","title":"Bid-winner schedule assertion skipped but marked PASS","description":"Witness script skips schedule verification when assignment date is outside a real-time 2-week window. The skipped check is recorded as passed. Acceptance intent 'winner schedule reflects assigned shift' can be unverified while flow still passes. Should use artifact date/frozen clock or API-backed assertion. Source: logs/nightly/2026-02-18/drv-b1l.12-agent-browser-witness-audit.md","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:07:42.8324241+09:00","created_by":"Matt","updated_at":"2026-02-18T12:07:42.8324241+09:00","labels":["schedule","testing","witness"]}
{"id":"DRV-965","title":"Audit data table system","description":"Production readiness audit of all 17+ files in src/lib/components/data-table/ including cells/ subdirectory. Review for: TanStack Table integration (column definitions, sorting, filtering), pagination boundary conditions (first/last page, empty data, single page), filter panel UX (range/dropdown filters working together), cell renderers (date/number/badge formatting, null/undefined handling), export functionality correctness, performance with large datasets (100+ rows, unnecessary re-renders), empty state messaging, responsive design (horizontal scroll, column visibility at mobile), accessibility (table ARIA roles, sortable column announcements). Write findings to logs/nightly/2026-02-10/audit-components-data-table.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:31:00.1329521+09:00","created_by":"Matt","updated_at":"2026-02-10T02:33:26.0167965+09:00","closed_at":"2026-02-10T02:33:26.0167965+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":22,"issue_id":"DRV-965","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/74","created_at":"2026-02-09T17:35:01Z"}]}
{"id":"DRV-97h","title":"Notifications UI redesign","description":"Source: C:\\Users\\matto\\.claude\\plans\\reactive-percolating-eclipse.md\n\nRestyle the notifications page and items: remove borders/accent colors, simplify metadata, reduce header size, replace pagination with infinite scroll.\n\nFiles affected:\n- src/lib/components/notifications/NotificationItem.svelte\n- src/routes/(app)/notifications/+page.svelte\n- src/lib/stores/notificationsStore.svelte.ts\n\nNo changes to: API endpoint, schemas, Chip, design tokens.\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-06T10:04:58.1171846+09:00","created_by":"Matt","updated_at":"2026-02-06T10:15:14.8167715+09:00","closed_at":"2026-02-06T10:15:14.8167715+09:00","close_reason":"Completed notifications UI redesign subtasks: item restyle, infinite-scroll store support, and page-level sentinel-based loading."}
{"id":"DRV-97h.1","title":"Restyle NotificationItem: remove borders, add unread dot, drop date chip","description":"Source: C:\\Users\\matto\\.claude\\plans\\reactive-percolating-eclipse.md (## 1. NotificationItem Restyle)\n\nRestyle NotificationItem.svelte to remove all borders and accent-left indicators, replace with surface-contrast-only card styling, add an unread dot indicator, remove the date chip, and fix hover color.\n\nFile: src/lib/components/notifications/NotificationItem.svelte\n\n## Changes\n\n### CSS: Remove borders \u0026 accent-left\n- In `.notification-item`: delete `border: var(--item-border)`, `border-left-width: 3px`, `border-left-style: solid`, `border-left-color: transparent`\n- Delete the `--item-border` CSS custom property definition\n- In `.notification-item.unread`: delete the `--item-border` override and `border-left-color: var(--notification-accent)` rule\n- Change `border-radius` from `var(--radius-base)` to `var(--radius-lg)` (softer card shape)\n- Background stays `var(--surface-primary)` — contrast against page `var(--surface-inset)` provides card definition\n\n### CSS: Unread dot indicator\n- Add `position: relative` to `.icon-circle`\n- Add new rule:\n  ```css\n  .notification-item.unread .icon-circle::after {\n    content: '';\n    position: absolute;\n    top: -2px;\n    right: -2px;\n    width: 6px;\n    height: 6px;\n    border-radius: var(--radius-full);\n    background: var(--notification-accent);\n  }\n  ```\n- Keep existing bold title for unread (font-weight: var(--font-weight-bold)) — unchanged\n\n### CSS: Fix hover color\n- Delete `--item-hover-bg` CSS custom property\n- Change `.notification-item:hover` background from `var(--item-hover-bg)` to `var(--interactive-hover)` (#303030 — lighter on hover, correct for dark theme)\n\n### JS: Remove date chip\n- In `metadataChips` derived (lines 20-32), delete the `if (notification.data?.date)` block (lines 28-30)\n- Only route and warehouse chips remain\n\n### JS: Simplify timeLabel\n- In `timeLabel` derived (lines 33-41), remove the `hasDateChip` conditional and \"Notified\" prefix logic\n- Simplify to: `formatRelativeTime(notification.createdAt) || ''`\n- The `hasDateChip` variable, regex test, and \"Notified\" prefix are all removed\n\n### CSS: Read state\n- Keep `opacity: 0.65` for `.notification-item.read` — unchanged\n\n### CSS cleanup\n- Remove `--item-border` variable from `.notification-item`\n- Remove `--item-hover-bg` variable from `.notification-item`\n\n## Acceptance Criteria\n1. No borders or accent-left colors on any notification card\n2. Cards visually distinct via background contrast against `--surface-inset` page bg\n3. Unread notifications show bold title + small 6px colored dot at top-right of icon circle\n4. Read notifications dimmed at 0.65 opacity (unchanged)\n5. Date chip no longer appears — only route and warehouse chips remain\n6. Time string in top-right shows plain relative time (no \"Notified\" prefix)\n7. Hover lightens card to #303030\n8. border-radius is --radius-lg (7px)\n9. Mobile responsive: touch targets maintained (min-height 44px on coarse pointer)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T10:05:23.7556314+09:00","created_by":"Matt","updated_at":"2026-02-06T10:15:12.5606194+09:00","closed_at":"2026-02-06T10:15:12.5606194+09:00","close_reason":"NotificationItem restyled: removed borders/accent-left, added unread dot, dropped date chip, simplified relative time label, and updated hover/background styling.","dependencies":[{"issue_id":"DRV-97h.1","depends_on_id":"DRV-97h","type":"parent-child","created_at":"2026-02-06T10:05:23.762262+09:00","created_by":"Matt"}]}
{"id":"DRV-97h.2","title":"Add infinite scroll support to notificationsStore","description":"Source: C:\\Users\\matto\\.claude\\plans\\reactive-percolating-eclipse.md (## 3. Infinite Scroll — Store changes)\n\nAdd loadMore() append mode and hasMore tracking to the notifications store to support infinite scrolling.\n\nFile: src/lib/stores/notificationsStore.svelte.ts\n\n## State Changes\n\nAdd two new fields to the $state object (lines 23-42):\n```typescript\nhasMore: boolean;       // initialized to true\nisLoadingMore: boolean; // initialized to false\n```\n\nExpose via getters on the exported store object (after line 62):\n```typescript\nget hasMore() { return state.hasMore; },\nget isLoadingMore() { return state.isLoadingMore; },\n```\n\n## New Method: loadMore()\n\nAdd `async loadMore()` to the store object (after markAllRead):\n\n```typescript\nasync loadMore() {\n  if (state.isLoading || state.isLoadingMore || !state.hasMore) return;\n  state.isLoadingMore = true;\n\n  const nextPage = state.pagination.pageIndex + 2; // 0-indexed -\u003e 1-indexed + advance\n  const pageSize = state.pagination.pageSize;\n\n  try {\n    const res = await fetch(`/api/notifications?page=${nextPage}\u0026pageSize=${pageSize}`);\n    if (!res.ok) throw new Error('Failed to load notifications');\n\n    const data = await res.json();\n    const parsed = notificationListResponseSchema.safeParse(data);\n    if (!parsed.success) throw new Error('Invalid notifications response');\n\n    const { notifications: newNotifications, unreadCount, pagination } = parsed.data;\n    const newPageIndex = Math.min(\n      Math.max(0, pagination.page - 1),\n      Math.max(0, pagination.totalPages - 1)\n    );\n\n    state.notifications = [...state.notifications, ...newNotifications];\n    state.unreadCount = unreadCount;\n    state.pagination = {\n      pageIndex: newPageIndex,\n      pageSize: pagination.pageSize,\n      total: pagination.total,\n      pageCount: pagination.totalPages\n    };\n    state.hasMore = newPageIndex + 1 \u003c pagination.totalPages;\n  } catch (err) {\n    toastStore.error(m.notifications_load_error());\n  } finally {\n    state.isLoadingMore = false;\n  }\n}\n```\n\n## Modify Existing loadPage()\n\nAfter the successful parse block (around line 96), add:\n```typescript\nstate.hasMore = pageIndex + 1 \u003c pagination.totalPages;\n```\n\nThis ensures `hasMore` is set correctly after initial load.\n\n## No Changes To\n- markRead() — operates on in-memory list, works with accumulated items\n- markAllRead() — operates on in-memory list, works with accumulated items\n- API endpoint — existing page-based API supports this pattern\n\n## Acceptance Criteria\n1. `notificationsStore.hasMore` is `true` after initial load when totalPages \u003e 1\n2. `notificationsStore.hasMore` is `false` when on last page\n3. `loadMore()` appends new notifications to existing list (not replaces)\n4. `loadMore()` is a no-op when `hasMore` is false, `isLoading` is true, or `isLoadingMore` is true\n5. `isLoadingMore` is true during fetch, false after (success or error)\n6. On error: toast shown, existing list unchanged, isLoadingMore reset to false\n7. `markRead()` still works correctly on the accumulated list\n8. `markAllRead()` still works correctly on the accumulated list\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T10:05:38.2888638+09:00","created_by":"Matt","updated_at":"2026-02-06T10:15:13.321428+09:00","closed_at":"2026-02-06T10:15:13.321428+09:00","close_reason":"notificationsStore now supports infinite scroll with hasMore/isLoadingMore state, loadMore append mode, and hasMore updates on loadPage.","dependencies":[{"issue_id":"DRV-97h.2","depends_on_id":"DRV-97h","type":"parent-child","created_at":"2026-02-06T10:05:38.2938125+09:00","created_by":"Matt"}]}
{"id":"DRV-97h.3","title":"Restyle notifications page header and replace pagination with infinite scroll","description":"Source: C:\\Users\\matto\\.claude\\plans\\reactive-percolating-eclipse.md (## 2. Page Header + ## 3. Infinite Scroll — Page changes)\n\nReduce header typography, remove header border-bottom, replace DataTablePagination with IntersectionObserver-based infinite scroll.\n\nFile: src/routes/(app)/notifications/+page.svelte\n\n## Header Restyle\n\n### Typography\n- `.header-text h1` (line 189): change `font-size` from `var(--font-size-xl)` to `var(--font-size-lg)` (28px -\u003e 22px)\n- `@media (max-width: 480px)` `.header-text h1` (line 299-301): change from `var(--font-size-lg)` to `var(--font-size-base)` (22px -\u003e 14px)\n\n### Remove border-bottom\n- `.card-header` (line 178): delete `border-bottom: var(--border-width-thin) solid var(--border-primary)`\n\n## Replace Pagination with Infinite Scroll\n\n### Remove (imports, lines 11-15 area)\n- Delete `DataTablePagination` import (line 15)\n\n### Remove (script, lines 22-77 area)\n- Delete `canPreviousPage` derived (line 23)\n- Delete `canNextPage` derived (line 24)\n- Delete `goToFirstPage` function (lines 61-63)\n- Delete `goToPreviousPage` function (lines 65-68)\n- Delete `goToNextPage` function (lines 70-73)\n- Delete `goToLastPage` function (lines 75-77)\n\n### Add (script)\n```typescript\nlet sentinelEl: HTMLDivElement;\n```\n\n### Modify onMount (lines 79-81)\nReplace with:\n```typescript\nonMount(() =\u003e {\n  void notificationsStore.loadPage(0);\n\n  const observer = new IntersectionObserver(\n    (entries) =\u003e {\n      if (entries[0]?.isIntersecting) {\n        void notificationsStore.loadMore();\n      }\n    },\n    { rootMargin: '200px' }\n  );\n\n  $effect(() =\u003e {\n    if (sentinelEl) {\n      observer.observe(sentinelEl);\n      return () =\u003e observer.unobserve(sentinelEl);\n    }\n  });\n\n  return () =\u003e observer.disconnect();\n});\n```\n\n### Template: Replace pagination block (lines 137-150)\nDelete:\n```svelte\n{#if pagination.pageCount \u003e 1}\n  \u003cdiv class=\"notifications-pagination\"\u003e\n    \u003cDataTablePagination ... /\u003e\n  \u003c/div\u003e\n{/if}\n```\n\nReplace with scroll sentinel (place after the notifications-groups closing div, inside card-body):\n```svelte\n{#if notificationsStore.hasMore}\n  \u003cdiv class=\"scroll-sentinel\" bind:this={sentinelEl}\u003e\n    {#if notificationsStore.isLoadingMore}\n      \u003cSpinner size={20} label={m.common_loading()} /\u003e\n    {/if}\n  \u003c/div\u003e\n{/if}\n```\n\n### Remove derived `pagination` (line 22)\n- `const pagination = $derived(notificationsStore.pagination)` — no longer needed since pagination controls are removed\n\n### CSS: Remove\n- `.notifications-pagination` class (lines 275-277)\n\n### CSS: Add\n```css\n.scroll-sentinel {\n  display: flex;\n  justify-content: center;\n  padding: var(--spacing-3);\n  min-height: 1px;\n}\n```\n\n## Acceptance Criteria\n1. Header h1 is --font-size-lg (22px), drops to --font-size-base (14px) on mobile\n2. No border-bottom on card-header\n3. DataTablePagination component completely removed (import + template + functions)\n4. Scroll sentinel div appears below notification groups when hasMore is true\n5. IntersectionObserver triggers loadMore() when sentinel enters viewport (200px margin)\n6. Spinner visible in sentinel during isLoadingMore\n7. Sentinel disappears when all notifications loaded (hasMore = false)\n8. Observer properly cleaned up on unmount (no memory leaks)\n9. No console errors — $effect inside onMount handles sentinel binding reactively\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T10:05:55.9235896+09:00","created_by":"Matt","updated_at":"2026-02-06T10:15:14.1753419+09:00","closed_at":"2026-02-06T10:15:14.1753419+09:00","close_reason":"Notifications page updated: reduced header sizing, removed header border, removed pagination UI, and added IntersectionObserver sentinel with loading spinner.","dependencies":[{"issue_id":"DRV-97h.3","depends_on_id":"DRV-97h","type":"parent-child","created_at":"2026-02-06T10:05:55.9272505+09:00","created_by":"Matt"},{"issue_id":"DRV-97h.3","depends_on_id":"DRV-97h.2","type":"blocks","created_at":"2026-02-06T10:06:05.4013361+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj","title":"UX Standardization: Data Table Detail Panel Pattern","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md\n\nStandardize the data table + detail view pattern across all manager pages (drivers, routes, warehouses) based on the Snapgrade pattern.\n\n## Current Problems\n1. Inconsistent row click behavior: Routes opens drawer; Drivers/Warehouses don't respond\n2. Inconsistent detail views: Routes uses Drawer; Drivers uses mobile-only panel; Warehouses auto-generates\n3. Redundant actions column: Edit/delete buttons in table + in modals = confusing\n4. Unnecessary checkboxes: No batch operations, just wastes space\n5. Mobile column limiting: Only showing 1-2 columns when table could scroll horizontally\n\n## Target Pattern\n- Desktop Default: Side panel (520px) next to DataTable\n- Desktop Modal Mode: Toggle button in chrome switches to modal instead of side panel\n- Mobile: Bottom drawer (already implemented via mobileDetailContent)\n- Inline editing in detail panel (view mode → edit mode with Save/Cancel)\n\n## Acceptance Criteria\n- All 3 manager pages use consistent pattern\n- No actions column in tables\n- No checkboxes in tables\n- All columns visible on mobile (horizontal scroll)\n- Wide mode toggle persists preference to localStorage\n","notes":"PR: https://github.com/orro3790/drive/pull/23","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-04T16:21:07.2706213+09:00","created_by":"Matt","updated_at":"2026-02-04T17:56:29.7398591+09:00","closed_at":"2026-02-04T17:56:29.7398591+09:00","close_reason":"Closed"}
{"id":"DRV-9gj.1","title":"Remove mobile column auto-hiding from DataTable","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 1.1)\n\nRemove the automatic mobile column visibility switching from DataTable. Tables should scroll horizontally on mobile, showing all columns. Users can still manually toggle column visibility via the chrome button.\n\n## Files to Modify\n- `src/lib/components/data-table/DataTable.svelte`\n\n## Implementation Details\n\n1. **Remove mobile visibility effect** (lines ~345-375):\n   - Delete the `$effect` that saves desktop visibility and applies mobile filter\n   - Delete `savedDesktopVisibility` state variable\n   - Delete `wasMobile` tracking variable\n   - Delete `getMobileVisibleColumnIds()` function\n\n2. **Keep mobile detection** for other purposes:\n   - Keep `MOBILE_BREAKPOINT = 600`\n   - Keep `isMobile` derived (used by mobile detail panel)\n\n3. **Keep column visibility chrome button**:\n   - `showColumnVisibility` prop still works\n   - Users can manually hide/show columns on any viewport\n\n4. **Remove mobileVisible/mobilePriority from column meta**:\n   - These properties in columnHelpers.ts become unused\n   - Can leave them for backward compatibility or remove in follow-up\n\n## Acceptance Criteria\n- [ ] Mobile viewport shows all table columns\n- [ ] Table scrolls horizontally on mobile when columns exceed viewport\n- [ ] Column visibility toggle button still works\n- [ ] No automatic column hiding on resize\n- [ ] svelte-check passes with 0 errors\n\n## Testing\n1. Open any DataTable page (e.g., /drivers)\n2. Resize viewport to mobile (\u003c600px)\n3. All columns should remain visible\n4. Table should scroll horizontally\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:21:24.5277312+09:00","created_by":"Matt","updated_at":"2026-02-04T22:11:00.9879757+09:00","closed_at":"2026-02-04T22:11:00.9879757+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.1","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:21:24.5310026+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.1","depends_on_id":"DRV-9gj.5","type":"blocks","created_at":"2026-02-04T16:23:20.9957441+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.1","depends_on_id":"DRV-9gj.6","type":"blocks","created_at":"2026-02-04T16:23:52.2377069+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.1","depends_on_id":"DRV-9gj.7","type":"blocks","created_at":"2026-02-04T16:24:19.6329064+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.2","title":"Add wide mode toggle to DataTable chrome","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 1.2)\n\nAdd a wide mode toggle button to DataTable chrome that allows users to switch between side panel mode (default) and modal mode (table takes full width).\n\n## Files to Modify\n- `src/lib/components/data-table/DataTable.svelte`\n- `src/lib/components/data-table/types.ts`\n- `src/lib/components/icons/ViewportWide.svelte` (create new)\n- `messages/en.json`\n- `messages/zh.json`\n\n## Implementation Details\n\n### 1. Add Props to DataTable (types.ts and DataTable.svelte)\n\n```typescript\n/** Enable the wide mode toggle in chrome (for side panel vs modal switching) */\nshowWideModeToggle?: boolean;\n/** Current wide mode state (true = modal mode, false = side panel mode) */\nisWideMode?: boolean;\n/** Callback when wide mode is toggled */\nonWideModeChange?: (isWide: boolean) =\u003e void;\n```\n\n### 2. Add to Props Destructuring\n\n```typescript\nshowWideModeToggle = false,\nisWideMode = false,\nonWideModeChange,\n```\n\n### 3. Add Toggle Button to Chrome\n\nInsert after column visibility button, before export button:\n\n```svelte\n{#if showWideModeToggle \u0026\u0026 !isMobile}\n  \u003cIconButton\n    tooltip={isWideMode ? m.table_wide_mode_restore() : m.table_wide_mode_maximize()}\n    onclick={() =\u003e onWideModeChange?.(!isWideMode)}\n    isActive={isWideMode}\n  \u003e\n    \u003cIcon\u003e\u003cViewportWide /\u003e\u003c/Icon\u003e\n  \u003c/IconButton\u003e\n{/if}\n```\n\n### 4. Create ViewportWide Icon\n\n`src/lib/components/icons/ViewportWide.svelte`:\n- Use a \"maximize/expand\" style icon\n- Can use Lucide's \"Maximize2\" or similar SVG\n\n### 5. Add i18n Messages\n\n```json\n{\n  \"table_wide_mode_maximize\": \"Maximize table\",\n  \"table_wide_mode_restore\": \"Show side panel\"\n}\n```\n\n## Acceptance Criteria\n- [ ] Toggle button appears in chrome when `showWideModeToggle={true}`\n- [ ] Button hidden on mobile viewports\n- [ ] Button has active state when `isWideMode={true}`\n- [ ] Clicking button calls `onWideModeChange` with toggled value\n- [ ] Tooltip changes based on current mode\n- [ ] svelte-check passes with 0 errors\n\n## Testing\n1. Pass `showWideModeToggle={true}` to DataTable\n2. Verify button appears in chrome (desktop only)\n3. Click button, verify callback fires\n4. Verify tooltip text changes\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:21:41.2402858+09:00","created_by":"Matt","updated_at":"2026-02-04T22:11:01.1576823+09:00","closed_at":"2026-02-04T22:11:01.1576823+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.2","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:21:41.2456157+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.2","depends_on_id":"DRV-9gj.4","type":"blocks","created_at":"2026-02-04T16:22:46.2328377+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.3","title":"Create DetailPanel component with inline editing","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 2.1)\n\nCreate a reusable side panel component for displaying and editing item details. Supports view mode and inline edit mode with Save/Cancel footer.\n\n## Files to Create\n- `src/lib/components/DetailPanel.svelte`\n\n## Component Props\n\n```typescript\ntype Props\u003cT\u003e = {\n  /** Item to display (null = panel closed) */\n  item: T | null;\n  /** Panel title (displayed in sticky header) */\n  title: string;\n  /** Panel width in pixels (default: 420) */\n  width?: number;\n  /** Whether currently in edit mode */\n  isEditing?: boolean;\n  /** Whether there are unsaved changes (enables Save button) */\n  hasChanges?: boolean;\n  /** Whether save operation is in progress */\n  isSaving?: boolean;\n  /** Close handler */\n  onClose: () =\u003e void;\n  /** Edit mode toggle handler */\n  onEdit?: () =\u003e void;\n  /** Cancel edit handler (reverts changes) */\n  onCancel?: () =\u003e void;\n  /** Save handler */\n  onSave?: () =\u003e void;\n  /** Content snippet for view mode */\n  viewContent: Snippet\u003c[T]\u003e;\n  /** Content snippet for edit mode (inline form fields) */\n  editContent?: Snippet\u003c[T]\u003e;\n  /** Additional actions for view mode footer (e.g., \"Unflag\" button) */\n  extraActions?: Snippet\u003c[T]\u003e;\n};\n```\n\n## Component Structure\n\n```svelte\n\u003caside class=\"detail-panel\" class:open={!!item} style:width=\"{width}px\"\u003e\n  {#if item}\n    \u003c!-- Sticky Header --\u003e\n    \u003cheader class=\"panel-header\"\u003e\n      \u003ch2\u003e{title}\u003c/h2\u003e\n      \u003cIconButton onclick={onClose} tooltip={m.common_close()}\u003e\n        \u003cIcon\u003e\u003cXIcon /\u003e\u003c/Icon\u003e\n      \u003c/IconButton\u003e\n    \u003c/header\u003e\n\n    \u003c!-- Scrollable Body --\u003e\n    \u003cdiv class=\"panel-body\"\u003e\n      {#if isEditing \u0026\u0026 editContent}\n        {@render editContent(item)}\n      {:else}\n        {@render viewContent(item)}\n      {/if}\n    \u003c/div\u003e\n\n    \u003c!-- Sticky Footer --\u003e\n    \u003cfooter class=\"panel-footer\"\u003e\n      {#if isEditing}\n        \u003cButton variant=\"secondary\" onclick={onCancel} disabled={isSaving} fill\u003e\n          {m.common_cancel()}\n        \u003c/Button\u003e\n        \u003cButton onclick={onSave} disabled={!hasChanges || isSaving} fill\u003e\n          {isSaving ? m.common_saving() : m.common_save()}\n        \u003c/Button\u003e\n      {:else}\n        {#if extraActions}\n          {@render extraActions(item)}\n        {/if}\n        {#if onEdit}\n          \u003cButton onclick={onEdit} fill\u003e\n            {m.common_edit()}\n          \u003c/Button\u003e\n        {/if}\n      {/if}\n    \u003c/footer\u003e\n  {/if}\n\u003c/aside\u003e\n```\n\n## Styling Requirements\n\n```css\n.detail-panel {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  background: var(--surface-primary);\n  border-left: var(--border-width-thin) solid var(--border-primary);\n  overflow: hidden;\n}\n\n.detail-panel:not(.open) {\n  display: none;\n}\n\n.panel-header {\n  position: sticky;\n  top: 0;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: var(--spacing-3) var(--spacing-4);\n  border-bottom: var(--border-width-thin) solid var(--border-primary);\n  background: var(--surface-primary);\n  z-index: 1;\n}\n\n.panel-body {\n  flex: 1;\n  overflow-y: auto;\n  padding: var(--spacing-4);\n  -webkit-overflow-scrolling: touch;\n}\n\n.panel-footer {\n  position: sticky;\n  bottom: 0;\n  display: flex;\n  gap: var(--spacing-2);\n  padding: var(--spacing-3) var(--spacing-4);\n  border-top: var(--border-width-thin) solid var(--border-primary);\n  background: var(--surface-primary);\n}\n\n/* Edit mode: 50/50 button layout */\n.panel-footer \u003e :global(button) {\n  flex: 1;\n}\n```\n\n## Acceptance Criteria\n- [ ] Panel renders when item is provided\n- [ ] Panel hidden when item is null\n- [ ] Header shows title + close button\n- [ ] Body scrolls independently, header/footer stay sticky\n- [ ] View mode shows viewContent + Edit button (if onEdit provided)\n- [ ] Edit mode shows editContent + Cancel/Save buttons\n- [ ] Save button disabled when hasChanges=false or isSaving=true\n- [ ] Cancel button disabled when isSaving=true\n- [ ] Extra actions render in view mode footer\n- [ ] svelte-check passes with 0 errors\n\n## Dependencies\n- None (can be created independently)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:22:05.7083156+09:00","created_by":"Matt","updated_at":"2026-02-04T22:11:01.3348117+09:00","closed_at":"2026-02-04T22:11:01.3348117+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.3","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:22:05.7132487+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.3","depends_on_id":"DRV-9gj.4","type":"blocks","created_at":"2026-02-04T16:22:38.7313929+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.4","title":"Create PageWithDetailPanel layout component","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 2.2)\n\nCreate a layout wrapper component that handles the two-panel grid layout (table + detail) with wide mode toggle and localStorage persistence.\n\n## Files to Create\n- `src/lib/components/PageWithDetailPanel.svelte`\n\n## Component Props\n\n```typescript\ntype Props\u003cT\u003e = {\n  /** Storage key for wide mode preference (e.g., \"drive:drivers:wideMode\") */\n  storageKey: string;\n  /** Panel width when open (default: 420) */\n  panelWidth?: number;\n  /** Currently selected item (null = no selection) */\n  selectedItem: T | null;\n  /** Panel title */\n  panelTitle: string;\n  /** Whether in edit mode */\n  isEditing?: boolean;\n  /** Whether there are unsaved changes */\n  hasChanges?: boolean;\n  /** Whether save is in progress */\n  isSaving?: boolean;\n  /** Handlers */\n  onClose: () =\u003e void;\n  onEdit?: () =\u003e void;\n  onCancel?: () =\u003e void;\n  onSave?: () =\u003e void;\n  /** Main content (DataTable) */\n  children: Snippet;\n  /** Detail view content */\n  viewContent: Snippet\u003c[T]\u003e;\n  /** Detail edit content */\n  editContent?: Snippet\u003c[T]\u003e;\n  /** Extra footer actions */\n  extraActions?: Snippet\u003c[T]\u003e;\n};\n```\n\n## State Management\n\n```typescript\n// Wide mode from localStorage\nconst STORAGE_PREFIX = 'drive:';\nlet isWideMode = $state(false);\n\nonMount(() =\u003e {\n  const stored = localStorage.getItem(`${STORAGE_PREFIX}${storageKey}`);\n  isWideMode = stored === 'true';\n});\n\nfunction toggleWideMode() {\n  isWideMode = !isWideMode;\n  localStorage.setItem(`${STORAGE_PREFIX}${storageKey}`, String(isWideMode));\n  // If switching to wide mode while panel is open, could optionally close panel\n}\n\n// Expose for DataTable chrome\nexport { isWideMode, toggleWideMode };\n```\n\n## Component Structure\n\n```svelte\n\u003cdiv class=\"page-with-detail\" class:panel-open={!!selectedItem \u0026\u0026 !isWideMode}\u003e\n  \u003c!-- Main content area (DataTable) --\u003e\n  \u003cdiv class=\"main-content\"\u003e\n    {@render children()}\n  \u003c/div\u003e\n\n  \u003c!-- Side panel (when not wide mode) --\u003e\n  {#if !isWideMode}\n    \u003cDetailPanel\n      item={selectedItem}\n      title={panelTitle}\n      width={panelWidth}\n      {isEditing}\n      {hasChanges}\n      {isSaving}\n      {onClose}\n      {onEdit}\n      {onCancel}\n      {onSave}\n      {viewContent}\n      {editContent}\n      {extraActions}\n    /\u003e\n  {/if}\n\u003c/div\u003e\n\n\u003c!-- Modal (when wide mode and item selected) --\u003e\n{#if isWideMode \u0026\u0026 selectedItem}\n  \u003cModal title={panelTitle} onClose={onClose}\u003e\n    \u003cdiv class=\"modal-body\"\u003e\n      {#if isEditing \u0026\u0026 editContent}\n        {@render editContent(selectedItem)}\n      {:else}\n        {@render viewContent(selectedItem)}\n      {/if}\n    \u003c/div\u003e\n    \u003cdiv class=\"modal-footer\" slot=\"footer\"\u003e\n      {#if isEditing}\n        \u003cButton variant=\"secondary\" onclick={onCancel} disabled={isSaving}\u003e\n          {m.common_cancel()}\n        \u003c/Button\u003e\n        \u003cButton onclick={onSave} disabled={!hasChanges || isSaving}\u003e\n          {isSaving ? m.common_saving() : m.common_save()}\n        \u003c/Button\u003e\n      {:else}\n        {#if extraActions}\n          {@render extraActions(selectedItem)}\n        {/if}\n        {#if onEdit}\n          \u003cButton onclick={onEdit}\u003e\n            {m.common_edit()}\n          \u003c/Button\u003e\n        {/if}\n      {/if}\n    \u003c/div\u003e\n  \u003c/Modal\u003e\n{/if}\n```\n\n## Styling\n\n```css\n.page-with-detail {\n  display: grid;\n  grid-template-columns: 1fr;\n  height: 100%;\n  min-height: 0;\n  overflow: hidden;\n}\n\n.page-with-detail.panel-open {\n  grid-template-columns: minmax(0, 1fr) var(--panel-width, 420px);\n}\n\n.main-content {\n  min-width: 0;\n  overflow: hidden;\n}\n```\n\n## Context API (Alternative)\n\nCould use Svelte context to share isWideMode/toggleWideMode with child DataTable:\n\n```typescript\nconst WIDE_MODE_CTX = Symbol('wideMode');\nsetContext(WIDE_MODE_CTX, {\n  get isWideMode() { return isWideMode; },\n  toggle: toggleWideMode\n});\n```\n\nThen DataTable can `getContext(WIDE_MODE_CTX)` if available.\n\n## Acceptance Criteria\n- [ ] Two-panel layout when item selected and !isWideMode\n- [ ] Full-width table when isWideMode or no selection\n- [ ] Modal opens when isWideMode and item selected\n- [ ] Wide mode preference persists to localStorage\n- [ ] isWideMode and toggleWideMode accessible to DataTable\n- [ ] svelte-check passes with 0 errors\n\n## Dependencies\n- DRV-9gj.3 (DetailPanel component)\n- DRV-9gj.2 (Wide mode toggle - for the button in DataTable chrome)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:22:29.9418399+09:00","created_by":"Matt","updated_at":"2026-02-04T22:11:01.5351664+09:00","closed_at":"2026-02-04T22:11:01.5351664+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.4","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:22:29.9457172+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.4","depends_on_id":"DRV-9gj.5","type":"blocks","created_at":"2026-02-04T16:23:20.1256856+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.4","depends_on_id":"DRV-9gj.6","type":"blocks","created_at":"2026-02-04T16:23:51.4024145+09:00","created_by":"Matt"},{"issue_id":"DRV-9gj.4","depends_on_id":"DRV-9gj.7","type":"blocks","created_at":"2026-02-04T16:24:18.8412415+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.5","title":"Refactor Drivers page to use detail panel pattern","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 3.1)\n\nRefactor the drivers page to use the new PageWithDetailPanel layout and remove the actions column.\n\n## File to Modify\n- `src/routes/(manager)/drivers/+page.svelte`\n\n## Changes Required\n\n### 1. Remove Actions Column\n\nDelete from columns array:\n```typescript\nhelper.display({\n  id: 'actions',\n  header: m.common_actions(),\n  width: 100\n})\n```\n\nDelete the `actionsCell` snippet and its cellComponents entry.\n\n### 2. Remove Checkbox Selection (if present)\n\n- Remove `showSelection` prop from DataTable if set\n- No batch operations needed\n\n### 3. Add Row Click Handler\n\n```typescript\nfunction handleRowClick(driver: Driver) {\n  selectedDriver = driver;\n  // Reset edit state when selecting new driver\n  isEditing = false;\n}\n```\n\nPass to DataTable:\n```svelte\n\u003cDataTable\n  {table}\n  onRowClick={handleRowClick}\n  ...\n/\u003e\n```\n\n### 4. Wrap in PageWithDetailPanel\n\n```svelte\n\u003cPageWithDetailPanel\n  storageKey=\"drivers:wideMode\"\n  selectedItem={selectedDriver}\n  panelTitle={m.drivers_detail_title()}\n  {isEditing}\n  hasChanges={hasDriverChanges}\n  isSaving={isSaving}\n  onClose={() =\u003e { selectedDriver = null; isEditing = false; }}\n  onEdit={() =\u003e { isEditing = true; initEditForm(); }}\n  onCancel={() =\u003e { isEditing = false; resetEditForm(); }}\n  onSave={handleSave}\n  viewContent={driverViewContent}\n  editContent={driverEditContent}\n  extraActions={driverExtraActions}\n\u003e\n  \u003cDataTable ... /\u003e\n\u003c/PageWithDetailPanel\u003e\n```\n\n### 5. Create View Content Snippet\n\n```svelte\n{#snippet driverViewContent(driver: Driver)}\n  \u003cdl class=\"detail-list\"\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.common_name()}\u003c/dt\u003e\n      \u003cdd\u003e{driver.name}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.drivers_detail_email()}\u003c/dt\u003e\n      \u003cdd\u003e{driver.email}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003c!-- ... all fields ... --\u003e\n  \u003c/dl\u003e\n{/snippet}\n```\n\n### 6. Create Edit Content Snippet\n\n```svelte\n{#snippet driverEditContent(driver: Driver)}\n  \u003cform class=\"edit-form\"\u003e\n    \u003cdiv class=\"form-field\"\u003e\n      \u003clabel for=\"edit-cap\"\u003e{m.drivers_cap_label()}\u003c/label\u003e\n      \u003cSelect\n        id=\"edit-cap\"\n        options={weeklyCapOptions}\n        value={String(formWeeklyCap)}\n        onChange={(v) =\u003e (formWeeklyCap = Number(v))}\n      /\u003e\n      \u003cp class=\"field-hint\"\u003e{m.drivers_cap_description()}\u003c/p\u003e\n    \u003c/div\u003e\n    \u003c!-- Only weekly cap is editable for drivers --\u003e\n  \u003c/form\u003e\n{/snippet}\n```\n\n### 7. Create Extra Actions Snippet (for Unflag)\n\n```svelte\n{#snippet driverExtraActions(driver: Driver)}\n  {#if driver.isFlagged}\n    \u003cButton variant=\"secondary\" onclick={(e) =\u003e openUnflagConfirm(driver, e)} fill\u003e\n      {m.drivers_unflag_button()}\n    \u003c/Button\u003e\n  {/if}\n{/snippet}\n```\n\n### 8. Update State Management\n\n```typescript\nlet selectedDriver = $state\u003cDriver | null\u003e(null);\nlet isEditing = $state(false);\nlet isSaving = $state(false);\nlet formWeeklyCap = $state(4);\n\n// Track changes\nconst hasDriverChanges = $derived(\n  selectedDriver \u0026\u0026 formWeeklyCap !== selectedDriver.weeklyCap\n);\n\nfunction initEditForm() {\n  if (selectedDriver) {\n    formWeeklyCap = selectedDriver.weeklyCap;\n  }\n}\n\nfunction resetEditForm() {\n  initEditForm(); // Reset to original values\n}\n\nasync function handleSave() {\n  if (!selectedDriver) return;\n  isSaving = true;\n  await driverStore.updateCap(selectedDriver.id, formWeeklyCap);\n  isSaving = false;\n  isEditing = false;\n}\n```\n\n### 9. Pass Wide Mode to DataTable\n\n```svelte\n\u003cDataTable\n  {table}\n  showWideModeToggle\n  isWideMode={/* from PageWithDetailPanel context */}\n  onWideModeChange={/* from PageWithDetailPanel context */}\n  ...\n/\u003e\n```\n\n### 10. Keep mobileDetailContent for Mobile\n\nThe existing `mobileDetail` snippet stays for mobile bottom drawer.\n\n## Acceptance Criteria\n- [ ] No actions column in table\n- [ ] Click row → detail panel opens on right (desktop)\n- [ ] View mode shows all driver info\n- [ ] Edit button → edit mode with weekly cap selector\n- [ ] Save/Cancel work correctly\n- [ ] Unflag button appears in footer for flagged drivers\n- [ ] Wide mode toggle works (modal on click when enabled)\n- [ ] Mobile still uses bottom drawer\n- [ ] svelte-check passes with 0 errors\n\n## Dependencies\n- DRV-9gj.4 (PageWithDetailPanel)\n- DRV-9gj.1 (Remove mobile column limiting)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:23:12.6745359+09:00","created_by":"Matt","updated_at":"2026-02-04T20:11:17.3237621+09:00","closed_at":"2026-02-04T20:11:17.3237621+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-9gj.5","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:23:12.6778656+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.6","title":"Refactor Routes page to use detail panel pattern","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 3.2)\n\nRefactor the routes page to use PageWithDetailPanel layout, replacing the custom Drawer with the standardized pattern.\n\n## File to Modify\n- `src/routes/(manager)/routes/+page.svelte`\n\n## Changes Required\n\n### 1. Remove Actions Column\n\nDelete from columns array:\n```typescript\nhelper.display({\n  id: 'actions',\n  header: m.common_actions(),\n  width: 100\n})\n```\n\nDelete the `actionsCell` snippet.\n\n### 2. Remove Custom Drawer\n\nDelete the Drawer component usage and import.\n\n### 3. Remove disableMobileDetail\n\nCurrently routes has `disableMobileDetail` to prevent the built-in panel. Remove this and add proper `mobileDetailContent` instead.\n\n### 4. Update Row Click Handler\n\nAlready has `handleRowClick` - update to work with new pattern:\n\n```typescript\nfunction handleRowClick(route: RouteWithRelations) {\n  selectedRoute = route;\n  isEditing = false;\n}\n```\n\n### 5. Wrap in PageWithDetailPanel\n\n```svelte\n\u003cPageWithDetailPanel\n  storageKey=\"routes:wideMode\"\n  selectedItem={selectedRoute}\n  panelTitle={selectedRoute?.name ?? m.routes_detail_title()}\n  {isEditing}\n  hasChanges={hasRouteChanges}\n  isSaving={isSaving}\n  onClose={() =\u003e { selectedRoute = null; isEditing = false; }}\n  onEdit={() =\u003e { isEditing = true; initEditForm(); }}\n  onCancel={() =\u003e { isEditing = false; resetEditForm(); }}\n  onSave={handleSave}\n  viewContent={routeViewContent}\n  editContent={routeEditContent}\n  extraActions={routeExtraActions}\n\u003e\n  \u003cDataTable ... /\u003e\n\u003c/PageWithDetailPanel\u003e\n```\n\n### 6. Create View Content Snippet\n\n```svelte\n{#snippet routeViewContent(route: RouteWithRelations)}\n  \u003cdl class=\"detail-list\"\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.routes_detail_name()}\u003c/dt\u003e\n      \u003cdd\u003e{route.name}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.routes_detail_warehouse()}\u003c/dt\u003e\n      \u003cdd\u003e{route.warehouse?.name ?? m.common_unknown()}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.routes_detail_status()}\u003c/dt\u003e\n      \u003cdd\u003e\u003cStatusChip status={route.status} /\u003e\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.routes_detail_driver()}\u003c/dt\u003e\n      \u003cdd\u003e{route.driver?.name ?? m.routes_unassigned()}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003c!-- ... other fields ... --\u003e\n  \u003c/dl\u003e\n{/snippet}\n```\n\n### 7. Create Edit Content Snippet\n\n```svelte\n{#snippet routeEditContent(route: RouteWithRelations)}\n  \u003cform class=\"edit-form\"\u003e\n    \u003cdiv class=\"form-field\"\u003e\n      \u003clabel for=\"edit-name\"\u003e{m.routes_form_name()}\u003c/label\u003e\n      \u003cInlineEditor\n        id=\"edit-name\"\n        value={formName}\n        oncommit={(v) =\u003e (formName = v)}\n      /\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"form-field\"\u003e\n      \u003clabel for=\"edit-warehouse\"\u003e{m.routes_form_warehouse()}\u003c/label\u003e\n      \u003cSelect\n        id=\"edit-warehouse\"\n        options={warehouseOptions}\n        value={formWarehouseId}\n        onChange={(v) =\u003e (formWarehouseId = v)}\n      /\u003e\n    \u003c/div\u003e\n    \u003c!-- ... other editable fields ... --\u003e\n  \u003c/form\u003e\n{/snippet}\n```\n\n### 8. Create Extra Actions Snippet (for Delete)\n\n```svelte\n{#snippet routeExtraActions(route: RouteWithRelations)}\n  \u003cButton \n    variant=\"danger\" \n    onclick={(e) =\u003e openDeleteConfirm(route, e)}\n    fill\n  \u003e\n    {m.common_delete()}\n  \u003c/Button\u003e\n{/snippet}\n```\n\n### 9. Add mobileDetailContent\n\n```svelte\n{#snippet mobileDetail(route: RouteWithRelations)}\n  {@render routeViewContent(route)}\n  \u003cdiv class=\"mobile-actions\"\u003e\n    \u003cButton fill onclick={() =\u003e { isEditing = true; }}\u003e\n      {m.common_edit()}\n    \u003c/Button\u003e\n    \u003cButton variant=\"danger\" fill onclick={(e) =\u003e openDeleteConfirm(route, e)}\u003e\n      {m.common_delete()}\n    \u003c/Button\u003e\n  \u003c/div\u003e\n{/snippet}\n```\n\n### 10. State Management\n\n```typescript\nlet selectedRoute = $state\u003cRouteWithRelations | null\u003e(null);\nlet isEditing = $state(false);\nlet isSaving = $state(false);\nlet formName = $state('');\nlet formWarehouseId = $state('');\n// ... other form fields\n\nconst hasRouteChanges = $derived(\n  selectedRoute \u0026\u0026 (\n    formName !== selectedRoute.name ||\n    formWarehouseId !== selectedRoute.warehouseId\n    // ... other fields\n  )\n);\n```\n\n## Acceptance Criteria\n- [ ] No actions column in table\n- [ ] No custom Drawer component\n- [ ] Click row → detail panel opens on right (desktop)\n- [ ] View mode shows all route info\n- [ ] Edit mode allows editing route fields\n- [ ] Delete button in footer\n- [ ] Wide mode toggle works\n- [ ] Mobile uses bottom drawer with mobileDetailContent\n- [ ] svelte-check passes with 0 errors\n\n## Dependencies\n- DRV-9gj.4 (PageWithDetailPanel)\n- DRV-9gj.1 (Remove mobile column limiting)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:23:43.6748605+09:00","created_by":"Matt","updated_at":"2026-02-04T22:10:51.2798003+09:00","closed_at":"2026-02-04T22:10:51.2798003+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.6","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:23:43.6804829+09:00","created_by":"Matt"}]}
{"id":"DRV-9gj.7","title":"Refactor Warehouses page to use detail panel pattern","description":"Source: C:\\Users\\matto\\.claude\\plans\\humming-percolating-yao.md (Phase 3.3)\n\nRefactor the warehouses page to use PageWithDetailPanel layout and add proper detail views.\n\n## File to Modify\n- `src/routes/(manager)/warehouses/+page.svelte`\n\n## Changes Required\n\n### 1. Remove Actions Column\n\nDelete from columns array:\n```typescript\nhelper.display({\n  id: 'actions',\n  header: m.common_actions(),\n  width: 100\n})\n```\n\nDelete the `actionsCell` snippet.\n\n### 2. Add Row Click Handler\n\n```typescript\nfunction handleRowClick(warehouse: WarehouseWithCount) {\n  selectedWarehouse = warehouse;\n  isEditing = false;\n}\n```\n\n### 3. Wrap in PageWithDetailPanel\n\n```svelte\n\u003cPageWithDetailPanel\n  storageKey=\"warehouses:wideMode\"\n  selectedItem={selectedWarehouse}\n  panelTitle={selectedWarehouse?.name ?? m.warehouses_detail_title()}\n  {isEditing}\n  hasChanges={hasWarehouseChanges}\n  isSaving={isSaving}\n  onClose={() =\u003e { selectedWarehouse = null; isEditing = false; }}\n  onEdit={() =\u003e { isEditing = true; initEditForm(); }}\n  onCancel={() =\u003e { isEditing = false; resetEditForm(); }}\n  onSave={handleSave}\n  viewContent={warehouseViewContent}\n  editContent={warehouseEditContent}\n  extraActions={warehouseExtraActions}\n\u003e\n  \u003cDataTable ... /\u003e\n\u003c/PageWithDetailPanel\u003e\n```\n\n### 4. Create View Content Snippet\n\n```svelte\n{#snippet warehouseViewContent(warehouse: WarehouseWithCount)}\n  \u003cdl class=\"detail-list\"\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.warehouses_detail_name()}\u003c/dt\u003e\n      \u003cdd\u003e{warehouse.name}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.warehouses_detail_address()}\u003c/dt\u003e\n      \u003cdd\u003e{warehouse.address}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"detail-row\"\u003e\n      \u003cdt\u003e{m.warehouses_detail_route_count()}\u003c/dt\u003e\n      \u003cdd\u003e{warehouse.routeCount} {warehouse.routeCount === 1 ? 'route' : 'routes'}\u003c/dd\u003e\n    \u003c/div\u003e\n    \u003c!-- Could add: managers list, created date, etc. --\u003e\n  \u003c/dl\u003e\n{/snippet}\n```\n\n### 5. Create Edit Content Snippet\n\n```svelte\n{#snippet warehouseEditContent(warehouse: WarehouseWithCount)}\n  \u003cform class=\"edit-form\"\u003e\n    \u003cdiv class=\"form-field\"\u003e\n      \u003clabel for=\"edit-name\"\u003e{m.warehouses_form_name()}\u003c/label\u003e\n      \u003cInlineEditor\n        id=\"edit-name\"\n        value={formName}\n        oncommit={(v) =\u003e (formName = v)}\n      /\u003e\n    \u003c/div\u003e\n    \u003cdiv class=\"form-field\"\u003e\n      \u003clabel for=\"edit-address\"\u003e{m.warehouses_form_address()}\u003c/label\u003e\n      \u003cInlineEditor\n        id=\"edit-address\"\n        value={formAddress}\n        oncommit={(v) =\u003e (formAddress = v)}\n      /\u003e\n    \u003c/div\u003e\n  \u003c/form\u003e\n{/snippet}\n```\n\n### 6. Create Extra Actions Snippet (for Delete)\n\n```svelte\n{#snippet warehouseExtraActions(warehouse: WarehouseWithCount)}\n  \u003cButton \n    variant=\"danger\" \n    onclick={(e) =\u003e openDeleteConfirm(warehouse, e)}\n    disabled={warehouse.routeCount \u003e 0}\n    fill\n  \u003e\n    {m.common_delete()}\n  \u003c/Button\u003e\n  {#if warehouse.routeCount \u003e 0}\n    \u003cp class=\"delete-hint\"\u003e{m.warehouses_delete_has_routes()}\u003c/p\u003e\n  {/if}\n{/snippet}\n```\n\n### 7. Add mobileDetailContent\n\n```svelte\n{#snippet mobileDetail(warehouse: WarehouseWithCount)}\n  {@render warehouseViewContent(warehouse)}\n  \u003cdiv class=\"mobile-actions\"\u003e\n    \u003cButton fill onclick={() =\u003e { isEditing = true; }}\u003e\n      {m.common_edit()}\n    \u003c/Button\u003e\n    \u003cButton \n      variant=\"danger\" \n      fill \n      onclick={(e) =\u003e openDeleteConfirm(warehouse, e)}\n      disabled={warehouse.routeCount \u003e 0}\n    \u003e\n      {m.common_delete()}\n    \u003c/Button\u003e\n  \u003c/div\u003e\n{/snippet}\n```\n\n### 8. State Management\n\n```typescript\nlet selectedWarehouse = $state\u003cWarehouseWithCount | null\u003e(null);\nlet isEditing = $state(false);\nlet isSaving = $state(false);\nlet formName = $state('');\nlet formAddress = $state('');\n\nconst hasWarehouseChanges = $derived(\n  selectedWarehouse \u0026\u0026 (\n    formName !== selectedWarehouse.name ||\n    formAddress !== selectedWarehouse.address\n  )\n);\n\nfunction initEditForm() {\n  if (selectedWarehouse) {\n    formName = selectedWarehouse.name;\n    formAddress = selectedWarehouse.address;\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] No actions column in table\n- [ ] Click row → detail panel opens on right (desktop)\n- [ ] View mode shows warehouse info\n- [ ] Edit mode allows editing name and address\n- [ ] Delete button disabled when routeCount \u003e 0\n- [ ] Wide mode toggle works\n- [ ] Mobile uses bottom drawer with mobileDetailContent\n- [ ] svelte-check passes with 0 errors\n\n## Dependencies\n- DRV-9gj.4 (PageWithDetailPanel)\n- DRV-9gj.1 (Remove mobile column limiting)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T16:24:11.4161113+09:00","created_by":"Matt","updated_at":"2026-02-04T22:10:51.4758629+09:00","closed_at":"2026-02-04T22:10:51.4758629+09:00","close_reason":"Completed in PR #23","dependencies":[{"issue_id":"DRV-9gj.7","depends_on_id":"DRV-9gj","type":"parent-child","created_at":"2026-02-04T16:24:11.4219235+09:00","created_by":"Matt"}]}
{"id":"DRV-9gz","title":"Audit remaining services (assignments, lifecycle, flagging, metrics, managers, audit)","description":"Production readiness audit of src/lib/server/services/assignments.ts (200 lines), assignmentLifecycle.ts (120 lines), flagging.ts (207 lines), metrics.ts (111 lines), managers.ts (63 lines), audit.ts (85 lines). Review for: assignment lifecycle state machine (valid/invalid transitions), flagging thresholds (\u003c10 shifts → 80%, ≥10 → 70%), grace period (1 week) implementation, weekly cap reduction logic, metrics calculation edge cases (0 shifts, partial weeks), manager warehouse-level access control, audit logging of sensitive operations, query performance (N+1, missing indexes). Write findings to logs/nightly/2026-02-10/audit-services-remaining.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:49.1228816+09:00","created_by":"Matt","updated_at":"2026-02-10T02:46:37.7084962+09:00","closed_at":"2026-02-10T02:46:37.7084962+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":23,"issue_id":"DRV-9gz","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/75","created_at":"2026-02-09T17:47:27Z"}]}
{"id":"DRV-9k1","title":"Filter chips in routes table chrome","description":"Source: C:\\Users\\matto\\.claude\\plans\\swift-moseying-quail.md\n\nAdd filter chips to the DataTable chrome bar on the routes page so the manager\nalways sees what date/filters are active without reopening the filter drawer.\n\n- Date chip always visible (defaults to \"Today\")\n- Warehouse and status chips appear only when those filters are active\n- Each chip has an X to dismiss (date resets to today, others clear)\n- Chips are display-only (not clickable), filter drawer remains for setting filters\n\nFiles touched:\n- src/lib/components/primitives/Chip.svelte (onDismiss prop)\n- src/lib/components/data-table/DataTable.svelte (filters snippet slot)\n- src/routes/(manager)/routes/+page.svelte (filter chips rendering)\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-06T22:38:05.6285489+09:00","created_by":"Matt","updated_at":"2026-02-06T23:10:53.1245644+09:00","closed_at":"2026-02-06T23:10:53.1245644+09:00"}
{"id":"DRV-9k1.1","title":"Add onDismiss prop to Chip component","description":"Source: C:\\Users\\matto\\.claude\\plans\\swift-moseying-quail.md (Change 1)\n\nAdd an optional `onDismiss` callback prop to the Chip component that renders\na small X button after the label when provided.\n\n## File\n`src/lib/components/primitives/Chip.svelte`\n\n## Implementation\n\n1. Add prop: `onDismiss?: () =\u003e void`\n2. Import `XIcon` from `$lib/components/icons/XIcon.svelte`\n3. After the `.chip-label` span, conditionally render:\n   ```svelte\n   {#if onDismiss}\n     \u003cbutton\n       type=\"button\"\n       class=\"chip-dismiss\"\n       aria-label=\"Remove\"\n       onclick={(e) =\u003e { e.stopPropagation(); onDismiss(); }}\n     \u003e\n       \u003cXIcon /\u003e\n     \u003c/button\u003e\n   {/if}\n   ```\n4. Add CSS for `.chip-dismiss`:\n   - `display: inline-flex; align-items: center; justify-content: center;`\n   - `padding: 0; margin: 0; border: none; background: none;`\n   - `color: inherit; cursor: pointer;`\n   - `opacity: 0.6;` → `opacity: 1` on hover\n   - `transition: opacity var(--transition-fast);`\n   - Icon size: 12px via `.chip-dismiss :global(svg) { width: 12px; height: 12px; }`\n\n## Backward Compatibility\nWhen `onDismiss` is NOT provided, nothing renders — zero visual change to\nexisting Chip usages (status badges in routes table, bid windows, etc.).\n\n## Acceptance Criteria\n- Chip with `onDismiss` shows X button after label\n- Chip without `onDismiss` renders identically to before\n- X button click calls `onDismiss()` without triggering chip's `onClick`\n- X button has hover state (opacity transition)\n- X button is keyboard-accessible (focusable, activates on Enter/Space)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T22:38:19.8585551+09:00","created_by":"Matt","updated_at":"2026-02-06T23:10:50.346704+09:00","closed_at":"2026-02-06T23:10:50.346704+09:00","dependencies":[{"issue_id":"DRV-9k1.1","depends_on_id":"DRV-9k1","type":"parent-child","created_at":"2026-02-06T22:38:19.8625474+09:00","created_by":"Matt"}]}
{"id":"DRV-9k1.2","title":"Add filters snippet slot to DataTable chrome","description":"Source: C:\\Users\\matto\\.claude\\plans\\swift-moseying-quail.md (Change 2)\n\nAdd a `filters` snippet slot to DataTable that renders between the tabs and\naction buttons in the chrome bar.\n\n## File\n`src/lib/components/data-table/DataTable.svelte`\n\n## Implementation\n\n1. Add prop to `Props` type (after `tabs`, before `toolbar`):\n   ```typescript\n   /** Filter chips snippet (between tabs and actions in chrome) */\n   filters?: Snippet;\n   ```\n\n2. Destructure in props: `filters,`\n\n3. Update `hasChrome` derived (line ~287):\n   ```typescript\n   const hasChrome = $derived(\n     !!tabs || !!filters || !!toolbar || !!selection || showColumnVisibility || showExport || showWideToggle\n   );\n   ```\n\n4. Render between `.chrome-tabs` and `.chrome-actions` (after line ~360):\n   ```svelte\n   {#if filters}\n     \u003cdiv class=\"chrome-filters\"\u003e\n       {@render filters()}\n     \u003c/div\u003e\n   {/if}\n   ```\n\n5. Add CSS for `.chrome-filters`:\n   ```css\n   .chrome-filters {\n     display: flex;\n     flex-wrap: wrap;\n     gap: var(--spacing-1);\n     align-items: center;\n     flex: 1;\n     min-width: 0;\n     padding: var(--spacing-1) 0;\n   }\n\n   .data-table-chrome.is-stacked .chrome-filters {\n     width: 100%;\n     padding: var(--spacing-2) var(--spacing-3);\n   }\n   ```\n\n## Layout Behavior\n- Horizontal mode: chips sit between tabs and action buttons, flex-wrapping if needed\n- Stacked mode (narrow viewport): chips get their own full-width row between tabs and actions\n- `flex: 1` allows chips to fill available space; `min-width: 0` prevents overflow\n\n## Acceptance Criteria\n- DataTable without `filters` prop renders identically to before\n- DataTable with `filters` renders the snippet between tabs and actions\n- Chrome stacking logic still works correctly with filters present\n- Filters wrap gracefully when there are many chips\n- In stacked mode, filters appear as a distinct row\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T22:38:29.4913271+09:00","created_by":"Matt","updated_at":"2026-02-06T23:10:51.2780898+09:00","closed_at":"2026-02-06T23:10:51.2780898+09:00","dependencies":[{"issue_id":"DRV-9k1.2","depends_on_id":"DRV-9k1","type":"parent-child","created_at":"2026-02-06T22:38:29.4940336+09:00","created_by":"Matt"}]}
{"id":"DRV-9k1.3","title":"Render filter chips on routes page","description":"Source: C:\\Users\\matto\\.claude\\plans\\swift-moseying-quail.md (Change 3)\n\nImplement the filter chips snippet on the routes page that displays active\nfilter state as dismissable chips in the DataTable chrome.\n\n## File\n`src/routes/(manager)/routes/+page.svelte`\n\n## Implementation\n\n### A. Fix dateFilter initialization (prevent flash)\nChange `let dateFilter = $state('')` (line ~81) to:\n```typescript\nlet dateFilter = $state(toLocalYmd());\n```\nRemove the redundant `dateFilter = toLocalYmd()` from `onMount` (line ~564).\n\n### B. Add formatDateChipLabel helper\n```typescript\nfunction formatDateChipLabel(dateStr: string): string {\n  if (!dateStr) return 'Today';\n  const today = toLocalYmd();\n  if (dateStr === today) return 'Today';\n  // Parse YYYY-MM-DD without timezone shift\n  const [y, m, d] = dateStr.split('-').map(Number);\n  const date = new Date(y, m - 1, d);\n  const nowYear = new Date().getFullYear();\n  if (y !== nowYear) {\n    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });\n  }\n  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n}\n```\n\n### C. Add dismiss handlers\n```typescript\nfunction clearDateFilter() {\n  dateFilter = toLocalYmd();\n  applyFilters();\n}\nfunction clearWarehouseFilter() {\n  warehouseFilter = '';\n  applyFilters();\n}\nfunction clearStatusFilter() {\n  statusFilter = '';\n  applyFilters();\n}\n```\n\n### D. Add derived labels for chips\n```typescript\nconst warehouseChipLabel = $derived(\n  warehouseFilter\n    ? warehouseStore.warehouses.find(w =\u003e w.id === warehouseFilter)?.name ?? ''\n    : ''\n);\n```\n\n### E. Create filtersSnippet\n```svelte\n{#snippet filtersSnippet()}\n  \u003cChip\n    label={formatDateChipLabel(dateFilter)}\n    size=\"sm\"\n    onDismiss={dateFilter !== toLocalYmd() ? clearDateFilter : undefined}\n  /\u003e\n  {#if warehouseFilter \u0026\u0026 warehouseChipLabel}\n    \u003cChip\n      label={warehouseChipLabel}\n      size=\"sm\"\n      onDismiss={clearWarehouseFilter}\n    /\u003e\n  {/if}\n  {#if statusFilter}\n    \u003cChip\n      variant=\"status\"\n      status={statusFilter === 'assigned' ? 'success' : statusFilter === 'bidding' ? 'warning' : 'error'}\n      label={statusLabels[statusFilter]}\n      size=\"sm\"\n      onDismiss={clearStatusFilter}\n    /\u003e\n  {/if}\n{/snippet}\n```\n\n### F. Pass to DataTable\nAdd `filters={filtersSnippet}` to the routes `\u003cDataTable\u003e` (line ~934).\n\n## Dependencies\n- DRV-9k1.1 (Chip onDismiss prop)\n- DRV-9k1.2 (DataTable filters slot)\n\n## Existing code reused\n- `toLocalYmd()` — already defined in page (line ~163)\n- `applyFilters()` — already defined in page (line ~170)\n- `statusLabels` — already defined in page (line ~153)\n- `warehouseStore.warehouses` — already imported and loaded on mount\n- `Chip` — already imported (used in table cells)\n\n## Acceptance Criteria\n- Page load: date chip shows \"Today\", no other chips visible\n- Change date in drawer + apply: chip updates to formatted date, X appears\n- Click date X: resets to \"Today\", X disappears, table reloads\n- Apply warehouse filter: warehouse chip appears with warehouse name\n- Apply status filter: status chip appears with colored status label\n- Click X on warehouse/status: filter clears, chip gone, table reloads\n- \"Clear All\" in drawer: all conditional chips gone, date back to \"Today\"\n- Narrow viewport: chips wrap, stacked chrome shows chips in own row\n- Chips do not interfere with tab bar or action buttons\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T22:38:50.7184685+09:00","created_by":"Matt","updated_at":"2026-02-06T23:10:52.139286+09:00","closed_at":"2026-02-06T23:10:52.139286+09:00","dependencies":[{"issue_id":"DRV-9k1.3","depends_on_id":"DRV-9k1","type":"parent-child","created_at":"2026-02-06T22:38:50.7236532+09:00","created_by":"Matt"},{"issue_id":"DRV-9k1.3","depends_on_id":"DRV-9k1.1","type":"blocks","created_at":"2026-02-06T22:38:59.1578068+09:00","created_by":"Matt"},{"issue_id":"DRV-9k1.3","depends_on_id":"DRV-9k1.2","type":"blocks","created_at":"2026-02-06T22:38:59.9021439+09:00","created_by":"Matt"}]}
{"id":"DRV-9l2","title":"Driver settings page","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\n\n## Objective\nImplement driver settings page with account info and preferences.\n\n## Scope\n- UI page at src/routes/(app)/settings/+page.svelte\n- Sections:\n  1. Account info: name, email, phone (editable)\n  2. Password change\n  3. Preferences (embedded from preferences bead)\n- FCM token registration (for push notifications)\n\n## Spec References\n- docs/specs/SPEC.md: Line 238 (Driver settings route)\n\n## Acceptance Criteria\n- Driver can view and update account info\n- Driver can change password\n- Preferences section integrated (from DRV-5y4)\n- FCM token registered on page load (for push notifications)\n- Form validation and error handling\n\n## Technical Constraints\n- Combine account management with preferences UI\n- Call /api/users/fcm-token on load if token available\n- Use optimistic UI for updates","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:32:29.7662523+09:00","created_by":"Matt","updated_at":"2026-02-05T01:11:07.9284151+09:00","closed_at":"2026-02-05T01:11:07.9284151+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-9l2","depends_on_id":"DRV-5y4","type":"blocks","created_at":"2026-02-02T21:32:29.7707295+09:00","created_by":"Matt"},{"issue_id":"DRV-9l2","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:32:29.7780289+09:00","created_by":"Matt"}]}
{"id":"DRV-9pzp","title":"Add tests for FCM taxonomy, terminal cleanup, and fanout reliability metrics","description":"Notification service tests disable Firebase credentials and validate org scoping/in-app paths only. FCM failure taxonomy, terminal-token cleanup, retry behavior, and counter semantics remain unexercised. Source: logs/nightly/2026-02-18/drv-xnb.8-notification-reliability-and-fcm-error-taxonomy-audit.md Finding #4","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-18T12:11:47.5581756+09:00","created_by":"Matt","updated_at":"2026-02-19T19:53:59.9676951+09:00","closed_at":"2026-02-19T19:53:59.9676951+09:00","close_reason":"Closed","labels":["fcm","notifications","testing"]}
{"id":"DRV-9vlq","title":"Add API-002 and additional API-* real-DB scenarios for critical paths","description":"DRV-b1l.6 Audit Finding #1/#2/#3: The planned Milestone C scope requires multiple API critical-path scenarios, but only API-001 exists. Critical flows (driver bid acceptance, manager override, dispatch settings, driver history) are implemented but not exercised by real-DB API e2e journeys. Add API-002 and additional API-* real-DB scenarios covering: driver bid acceptance on org-scoped windows, manager override actions, dispatch settings updates, and driver history/timeline reads with explicit foreign-org denial cases. Source: logs/nightly/2026-02-18/drv-b1l.6-api-and-critical-ui-multi-tenant-journeys-audit.md","notes":"Implemented in PR #177: added API-002 smoke matrix with real-DB bid acceptance, manager override, dispatch settings, and history/timeline coverage plus explicit foreign-org denial checks and TENANT invariants.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:06.2887055+09:00","created_by":"Matt","updated_at":"2026-02-18T23:33:40.2505462+09:00","closed_at":"2026-02-18T23:33:40.2505462+09:00","close_reason":"Completed in merged PR #177","labels":["api","e2e-testing","testing-matrix"],"dependencies":[{"issue_id":"DRV-9vlq","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:49.6257917+09:00","created_by":"unknown"}]}
{"id":"DRV-9x8","title":"Signup finalize failure: log-only reconciliation is non-durable","description":"Default reconciliation handler is logging only. Authorization/consumption mismatches can persist without guaranteed remediation if logs are dropped or unmonitored. Source: logs/nightly/2026-02-18/drv-xnb.5-onboarding-allowlist-toctou-and-signup-atomicity-audit.md Finding #2","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:07:06.2654965+09:00","created_by":"Matt","updated_at":"2026-02-18T12:07:06.2654965+09:00","labels":["auth","observability","onboarding"]}
{"id":"DRV-9y0","title":"App shell and navigation","description":"Source: docs/specs/SPEC.md § User Interfaces\nPatterns: docs/agent-guidelines.md § Project Organization\n\n## Objective\nImplement the app shell with role-based navigation for drivers and managers.\n\n## Scope\n- Layout groups:\n  - src/routes/(auth)/ - Public auth pages (sign-in, sign-up)\n  - src/routes/(app)/ - Protected driver routes with driver sidebar\n  - src/routes/(manager)/ - Protected manager routes with manager sidebar\n- Sidebar navigation using AppSidebar component\n- Driver nav: Dashboard, Schedule, Settings, Notifications\n- Manager nav: Routes, Drivers, Warehouses, Notifications, Settings\n- Role-based redirect: drivers → /dashboard, managers → /routes\n\n## Spec References\n- docs/specs/SPEC.md: Lines 232-249 (User interfaces section)\n- docs/agent-guidelines.md: Lines 10-29 (Project organization)\n- CLAUDE.md: § UI Components (available components)\n\n## Acceptance Criteria\n- Auth pages accessible without login\n- Driver routes protected, redirect to sign-in if not authenticated\n- Manager routes protected, redirect if not authenticated or not manager role\n- Sidebar shows correct navigation items per role\n- Current route highlighted in sidebar\n- Mobile-responsive sidebar (hamburger menu)\n- Logo in sidebar header (placeholder for now)\n\n## Technical Constraints\n- Use existing AppSidebar, SidebarItem, PageHeader components\n- Layout files: +layout.svelte in each route group\n- Server-side role check in +layout.server.ts\n- Use hooks.server.ts for auth middleware","notes":"PR: https://github.com/orro3790/drive/pull/18","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-02T21:31:16.2025503+09:00","created_by":"Matt","updated_at":"2026-02-04T12:04:12.3189443+09:00","closed_at":"2026-02-04T12:04:12.3189443+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-9y0","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:31:16.2089262+09:00","created_by":"Matt"}]}
{"id":"DRV-a1e","title":"Warehouse CRUD (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § warehouses table\n\n## Objective\nImplement warehouse management for managers: list, create, edit, delete warehouses.\n\n## Scope\n- API endpoints:\n  - GET /api/warehouses - List all warehouses\n  - POST /api/warehouses - Create warehouse\n  - PATCH /api/warehouses/[id] - Update warehouse\n  - DELETE /api/warehouses/[id] - Delete warehouse (if no routes attached)\n- UI page at src/routes/(manager)/warehouses/+page.svelte\n- Use DataTable component for listing\n- Use Modal + InlineEditor for create/edit forms\n\n## Spec References\n- docs/specs/SPEC.md: Line 247 (Manager warehouse route)\n- docs/specs/SPEC.md: Line 260 (Edit routes and warehouses capability)\n- docs/specs/data-model.md: Lines 62-69 (warehouses table schema)\n- docs/agent-guidelines.md: § API Endpoint Pattern\n\n## Acceptance Criteria\n- Manager can view list of all warehouses\n- Manager can create new warehouse (name, address required)\n- Manager can edit existing warehouse\n- Manager can delete warehouse only if no routes reference it\n- createdBy field populated with current user ID\n- All changes logged to auditLogs table\n- Non-managers receive 403 on all endpoints\n\n## Technical Constraints\n- Role check: user.role === 'manager'\n- Audit logging for all mutations\n- Optimistic UI updates per agent-guidelines.md § Optimistic UI Pattern","notes":"PR: https://github.com/orro3790/drive/pull/1","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:22:56.2685927+09:00","created_by":"Matt","updated_at":"2026-02-03T02:26:08.0070797+09:00","closed_at":"2026-02-03T02:26:08.0070797+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-a1e","depends_on_id":"DRV-36d","type":"blocks","created_at":"2026-02-02T21:22:56.2790534+09:00","created_by":"Matt"}]}
{"id":"DRV-a47f","title":"Active-cycle preference locking bypassable via no-row and TOCTOU paths","description":"Lock check compares lockedAt against next deadline. Cron only updates existing driver_preferences rows, leaving no-row users unlockable. PUT path stays read-then-write non-atomic. High-risk no-row and TOCTOU (time-of-check-time-of-use) paths remain. Need atomic enforcement for both update and insert paths with cycle-aware Toronto logic. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.4 audit)","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:08:45.6507802+09:00","created_by":"Matt","updated_at":"2026-02-18T18:51:18.6800332+09:00","closed_at":"2026-02-18T18:51:18.6800332+09:00","close_reason":"Closed","labels":["critical","locking","preferences"],"dependencies":[{"issue_id":"DRV-a47f","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:53.6378048+09:00","created_by":"unknown"}],"comments":[{"id":59,"issue_id":"DRV-a47f","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/161","created_at":"2026-02-18T09:51:54Z"}]}
{"id":"DRV-a5s","title":"Audit test coverage and quality","description":"Audit all 37 test files in tests/ for production readiness — identify critical coverage gaps. Review for: which services/endpoints have NO tests, critical path coverage (shift lifecycle, bidding, confirmations, health — happy AND error paths), test quality (behavior vs implementation testing), mock correctness in tests/harness/, edge case coverage (boundary values, timezone, concurrency), cron job idempotency testing, auth abuse scenario testing, missing assertions (tests that pass without verifying outcomes), flaky test risks (time-dependent, random data, order-dependent). Produce a prioritized must-add-tests-before-production list. Write findings to logs/nightly/2026-02-10/audit-test-coverage.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/84","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:31:12.0046061+09:00","created_by":"Matt","updated_at":"2026-02-10T04:47:22.8937897+09:00","closed_at":"2026-02-10T04:45:00.52611+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-ai2","title":"Manager settings page","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\n\n## Objective\nImplement manager account settings page.\n\n## Scope\n- UI page at src/routes/(manager)/settings/+page.svelte\n- Account info: name, email, phone (editable)\n- Password change functionality\n- No manager-specific system settings for MVP\n\n## Spec References\n- docs/specs/SPEC.md: Line 249 (Manager settings route)\n\n## Acceptance Criteria\n- Manager can view their account info\n- Manager can update name, phone\n- Manager can change password (current password required)\n- Form validation for all fields\n- Success/error toasts on save\n\n## Technical Constraints\n- Reuse form patterns from driver settings if applicable\n- Use Better Auth password change flow","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-02T21:32:11.8754145+09:00","created_by":"Matt","updated_at":"2026-02-06T10:54:42.8863879+09:00","closed_at":"2026-02-06T10:54:42.8863879+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-ai2","depends_on_id":"DRV-9y0","type":"blocks","created_at":"2026-02-02T21:32:11.8803998+09:00","created_by":"Matt"}]}
{"id":"DRV-aij","title":"Drivers without preference row can bypass lock by creating one post-lock","description":"Lock cron updates existing rows only. Drivers without a row can submit preferences after lock without rejection. Source: logs/nightly/2026-02-18/drv-xnb.4 finding #2.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:01:54.2890439+09:00","created_by":"Matt","updated_at":"2026-02-18T20:18:25.6053324+09:00","closed_at":"2026-02-18T20:18:25.6053324+09:00","close_reason":"Closed","labels":["lock","preferences","scheduling"]}
{"id":"DRV-an5","title":"Manager bid window visibility","description":"Source: User request during DRV-5eo implementation\n\n## Objective\nAllow managers to see real-time status of bid windows and resolution results.\n\n## Scope\n- Add bid windows section to manager dashboard or routes overview\n- Show: open windows, recently resolved, winners, unfilled assignments\n- Real-time updates via SSE or polling\n\n## Acceptance Criteria\n- Managers can see all open bid windows\n- Managers can see recently resolved windows with winners\n- Managers can see unfilled assignments (no bids)\n- Status updates without manual refresh","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-04T10:31:54.6166077+09:00","created_by":"Matt","updated_at":"2026-02-05T00:22:13.8467619+09:00","closed_at":"2026-02-05T00:22:13.8467619+09:00","close_reason":"Closed"}
{"id":"DRV-asg","title":"Document no-show alert integration point","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nDocument the integration point for driver_no_show alerts. This depends on DRV-xtb (no-show detection cron) which is not yet implemented.\n\n## Integration Point\n\nWhen DRV-xtb (no-show detection cron) is implemented, add this alert:\n\n```typescript\nimport { sendManagerAlert } from \"$lib/server/services/notifications\";\n\n// In the no-show detection handler:\nawait sendManagerAlert(routeId, \"driver_no_show\", {\n  driverName: driver.name,\n  routeName: route.name,\n  date: assignment.date\n});\n```\n\n## Where to Add\n\nThe no-show detection cron will likely be at:\n- src/routes/api/cron/no-show-detection/+server.ts\n\nThe function should:\n1. Find assignments where status is \"active\" but shift has not started\n2. Check if current time \u003e shift start time + grace period\n3. Mark assignment as no-show\n4. Send manager alert\n\n## Placeholder\n\nFor now, this bead documents the expected integration. Actual implementation depends on DRV-xtb.\n\n## Files to Create (Future)\n- src/routes/api/cron/no-show-detection/+server.ts (DRV-xtb scope)\n\n## Dependencies\n- DRV-ldy (sendManagerAlert function must exist)\n- Blocked by: DRV-xtb (no-show detection cron, separate bead)\n\n## Acceptance Criteria\n- [ ] This bead is informational/documentation only\n- [ ] When DRV-xtb is implemented, sendManagerAlert call is added\n- [ ] driver_no_show notification type is available (from DRV-evm)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:25:40.1476776+09:00","created_by":"Matt","updated_at":"2026-02-04T14:28:57.2054612+09:00","closed_at":"2026-02-04T14:28:57.2054612+09:00","dependencies":[{"issue_id":"DRV-asg","depends_on_id":"DRV-ldy","type":"blocks","created_at":"2026-02-04T11:27:01.937308+09:00","created_by":"Matt"},{"issue_id":"DRV-asg","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:36.7831184+09:00","created_by":"Matt"}]}
{"id":"DRV-aus","title":"API: /api/app-version auto-tracks GitHub Releases","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Make GET /api/app-version resolve currentVersion + downloadUrl automatically from GitHub Releases (stable latest), while keeping minVersion manually controlled.\n\nFiles\n- Update: src/routes/api/app-version/+server.ts\n\nImplementation Details\n- minVersion:\n  - Read env.APP_MIN_VERSION (default '0').\n  - Parse int base-10.\n  - Clamp invalid/NaN/negative to 0.\n- currentVersion + downloadUrl:\n  - Call src/lib/server/githubRelease.ts helper.\n  - Use helper.versionCode for currentVersion.\n  - Use helper.downloadUrl for downloadUrl.\n- Caching headers (important for Vercel + GitHub rate limits):\n  - Cache-Control: public, max-age=0, s-maxage=600, stale-while-revalidate=3600\n- Failure mode:\n  - If helper provides cached lastKnownGood: return it.\n  - Else return 503 with:\n    - Retry-After: 60\n    - JSON body: { message: string }\n  - Do not return a broken URL like drive-v1.0.0.apk.\n- Optional debugging:\n  - Add a response header like X-Drive-AppVersion-Source: github|cache|error (do not add extra JSON fields).\n\nDependencies\n- Depends on: Server helper.\n\nAcceptance Criteria\n- Deployed endpoint returns valid tag-scoped APK URL and currentVersion matches tag-derived versionCode.\n- Endpoint response includes the Cache-Control header described above.\n- When GitHub is unavailable and no cached value exists, endpoint returns 503 with Retry-After.","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-15T22:56:12.7873021+09:00","created_by":"Matt","updated_at":"2026-02-19T19:13:32.4783955+09:00","closed_at":"2026-02-19T19:13:32.4783955+09:00","close_reason":"Closed"}
{"id":"DRV-axf","title":"Notifications page redesign","description":"Source: Plan from conversation (Notifications Page Redesign)\n\nRedesign the notifications page from a flat text list into a polished, type-aware notification inbox with visual differentiation, relative timestamps, time grouping, and actionable CTAs.\n\nNo backend changes required. All changes are frontend-only.\n\n## Scope\n- Type-to-icon/color config map for 12 notification types\n- Extracted NotificationItem component with type-aware styling\n- Relative timestamp utilities (formatRelativeTime, getTimeGroup)\n- i18n keys for time groups and CTAs\n- Full page rewrite with time-grouped sections\n\n## Acceptance Criteria\n- Each notification type renders with its unique icon and accent color\n- Unread notifications have tinted background, bold title, colored left border\n- Read notifications have reduced opacity\n- Timestamps show relative time (\"2m ago\", \"Yesterday\", \"Jan 15\")\n- Notifications grouped under \"Today\", \"Yesterday\", \"This Week\", \"Earlier\" headers\n- CTA buttons for bid_open (→ /bids) and shift_reminder (→ /dashboard)\n- CTA clicks do NOT trigger mark-as-read (stopPropagation)\n- Body clicks DO trigger mark-as-read\n- Mark-all-read and pagination still work\n- Mobile layout works at narrow viewports\n- Light and dark themes render correctly (all CSS variables)\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-05T10:37:50.8886806+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:21.1360057+09:00","closed_at":"2026-02-05T12:33:21.1360057+09:00","close_reason":"Closed"}
{"id":"DRV-axf.1","title":"Add relative time and grouping utilities to formatting.ts","description":"Source: Plan from conversation (Notifications Page Redesign — Step 1)\n\nAdd two date utility functions to `src/lib/utils/date/formatting.ts` using `date-fns` (already installed v4.1.0).\n\n## Functions to Add\n\n### `formatRelativeTime(date: Date | string | null | undefined): string`\nReturns a human-friendly relative timestamp:\n- \u003c 1 minute ago → `\"just now\"`\n- \u003c 60 minutes → `\"2m ago\"` (uses `differenceInMinutes`)\n- \u003c 24 hours → `\"1h ago\"` (uses `differenceInHours`)\n- Yesterday → `\"Yesterday\"` (uses `isYesterday`)\n- Otherwise → `\"Jan 15\"` (uses `format` with `'MMM d'`)\n\nInput handling: Accept `Date | string | null | undefined`, return `''` for falsy/invalid (match existing functions' pattern). Parse strings via `new Date()`.\n\n### `getTimeGroup(date: Date | string | null | undefined): 'today' | 'yesterday' | 'this_week' | 'earlier'`\nReturns a grouping key for section headers:\n- `isToday(d)` → `'today'`\n- `isYesterday(d)` → `'yesterday'`\n- `d \u003e= startOfWeek(now, { weekStartsOn: 0 })` → `'this_week'`\n- Otherwise → `'earlier'`\n\nInput handling: Same null/undefined/invalid guard as above. Return `'earlier'` for invalid dates.\n\n## date-fns Imports Needed\n```typescript\nimport { differenceInMinutes, differenceInHours, isToday, isYesterday, format, startOfWeek } from 'date-fns';\n```\n\n## File\n- Modify: `src/lib/utils/date/formatting.ts` (append after existing functions)\n\n## Dependencies\n- None (date-fns already installed)\n\n## Acceptance Criteria\n- `formatRelativeTime(new Date())` → `\"just now\"`\n- `formatRelativeTime(fiveMinutesAgo)` → `\"5m ago\"`\n- `formatRelativeTime(threeHoursAgo)` → `\"3h ago\"`\n- `formatRelativeTime(yesterday)` → `\"Yesterday\"`\n- `formatRelativeTime(lastWeek)` → formatted date like `\"Jan 28\"`\n- `formatRelativeTime(null)` → `\"\"`\n- `getTimeGroup(new Date())` → `\"today\"`\n- `getTimeGroup(yesterday)` → `\"yesterday\"`\n- `getTimeGroup(threeDaysAgo)` → `\"this_week\"` (if within current week)\n- `getTimeGroup(twoWeeksAgo)` → `\"earlier\"`\n- Both functions handle string ISO dates (e.g., `\"2026-01-15T10:00:00Z\"`)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T10:38:10.844709+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:18.2854691+09:00","closed_at":"2026-02-05T12:33:18.2854691+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-axf.1","depends_on_id":"DRV-axf","type":"parent-child","created_at":"2026-02-05T10:38:10.8491196+09:00","created_by":"Matt"}]}
{"id":"DRV-axf.2","title":"Create notification type-to-icon/color config map","description":"Source: Plan from conversation (Notifications Page Redesign — Step 2)\n\nCreate a new config file that maps each of the 12 notification types to an icon component and accent CSS variable.\n\n## File to Create\n`src/lib/config/notificationTypes.ts`\n\n## Implementation\n\n```typescript\nimport type { Component } from 'svelte';\nimport type { NotificationType } from '$lib/schemas/api/notifications';\n\nimport Gavel from '$lib/components/icons/Gavel.svelte';\nimport Crown from '$lib/components/icons/Crown.svelte';\nimport XCircle from '$lib/components/icons/XCircle.svelte';\nimport Clock from '$lib/components/icons/Clock.svelte';\nimport CalendarExclamation from '$lib/components/icons/CalendarExclamation.svelte';\nimport CheckCircleIcon from '$lib/components/icons/CheckCircleIcon.svelte';\nimport Lock from '$lib/components/icons/Lock.svelte';\nimport AlertTriangleIcon from '$lib/components/icons/AlertTriangleIcon.svelte';\nimport Announcement from '$lib/components/icons/Announcement.svelte';\nimport Route from '$lib/components/icons/Route.svelte';\nimport AlertCircleIcon from '$lib/components/icons/AlertCircleIcon.svelte';\n\ntype NotificationTypeConfig = {\n    icon: Component;\n    color: string; // CSS variable name (without var())\n};\n\nexport const notificationTypeConfig: Record\u003cNotificationType, NotificationTypeConfig\u003e = {\n    bid_open:               { icon: Gavel,               color: '--status-info' },\n    bid_won:                { icon: Crown,                color: '--status-success' },\n    bid_lost:               { icon: XCircle,              color: '--text-muted' },\n    shift_reminder:         { icon: Clock,                color: '--status-info' },\n    shift_cancelled:        { icon: CalendarExclamation,  color: '--status-error' },\n    assignment_confirmed:   { icon: CheckCircleIcon,      color: '--status-success' },\n    schedule_locked:        { icon: Lock,                 color: '--interactive-accent' },\n    warning:                { icon: AlertTriangleIcon,    color: '--status-warning' },\n    manual:                 { icon: Announcement,         color: '--text-muted' },\n    route_unfilled:         { icon: Route,                color: '--status-warning' },\n    route_cancelled:        { icon: CalendarExclamation,  color: '--status-error' },\n    driver_no_show:         { icon: AlertCircleIcon,      color: '--status-error' },\n};\n```\n\n## Key Design Decisions\n- Uses `Component` type from `svelte` for icon references (Svelte 5 pattern)\n- `color` stores the CSS variable NAME (e.g., `'--status-info'`) — consumer wraps with `var()` as needed\n- Config is typed as `Record\u003cNotificationType, NotificationTypeConfig\u003e` for exhaustiveness checking — TypeScript will error if a type is missing\n- All 12 icons confirmed to exist in `src/lib/components/icons/`\n\n## Dependencies\n- None (all icons already exist)\n\n## Acceptance Criteria\n- File compiles without TypeScript errors\n- All 12 notification types have entries\n- Adding/removing a type in `notificationTypeValues` causes a TS error in this file (exhaustiveness)\n- Icons can be rendered via `\u003csvelte:component this={config.icon} /\u003e`\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T10:38:24.9373017+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:18.87044+09:00","closed_at":"2026-02-05T12:33:18.87044+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-axf.2","depends_on_id":"DRV-axf","type":"parent-child","created_at":"2026-02-05T10:38:24.9435875+09:00","created_by":"Matt"}]}
{"id":"DRV-axf.3","title":"Create NotificationItem.svelte component","description":"Source: Plan from conversation (Notifications Page Redesign — Step 3)\n\nCreate an extracted notification item component with type-aware visual styling.\n\n## File to Create\n`src/lib/components/notifications/NotificationItem.svelte`\n\n## Props\n```typescript\ntype Props = {\n    notification: Notification;        // from '$lib/schemas/api/notifications'\n    onMarkRead: (id: string) =\u003e void;  // callback when body clicked\n};\n```\n\n## Visual Layout\n```\n[3px color bar] [32px icon circle] [Content area              ] [Relative time]\n                                     Title (bold if unread)      \"2m ago\"\n                                     Body text\n                                     Route A · Warehouse · Jan 15\n                                     Place Bid (if actionable)\n```\n\n## Rendering Details\n\n### Outer Element\n- Native `\u003cbutton\u003e` element (not Button primitive — need direct styling control for left border + icon layout)\n- `onclick` calls `onMarkRead(notification.id)` (only if not already read)\n- Full-width block button\n\n### Left Border\n- 3px left border colored by notification type (from `notificationTypeConfig[notification.type].color`)\n- Only for unread; transparent for read notifications\n\n### Icon Circle\n- 32×32px circle\n- Background: type color at 12% opacity via `color-mix(in srgb, var({color}) 12%, transparent)` (pattern already used in current page)\n- Icon rendered with `\u003csvelte:component this={config.icon} /\u003e` at 16px size, colored with type's accent color\n\n### Content Area\n- **Title**: Bold (`--font-weight-bold`) if unread, medium (`--font-weight-medium`) + muted color if read\n- **Body**: `--font-size-sm`, `--text-muted`, single line or wrapped\n- **Metadata line**: Defensive assembly from `data` field:\n  ```typescript\n  [notification.data?.routeName, notification.data?.warehouseName, notification.data?.date]\n      .filter(Boolean)\n      .join(' · ')\n  ```\n  Rendered in `--font-size-xs`, `--text-faint`. Only shown if non-empty string results.\n- **CTA link**: Only for specific types:\n  - `bid_open` → `\u003ca href=\"/bids\"\u003ePlace Bid\u003c/a\u003e` (i18n: `notifications_cta_place_bid`)\n  - `shift_reminder` → `\u003ca href=\"/dashboard\"\u003eView Dashboard\u003c/a\u003e` (i18n: `notifications_cta_view_dashboard`)\n  - Note: Route groups like `(driver)` are NOT part of URL in SvelteKit\n  - CTA uses `onclick|stopPropagation` to prevent triggering mark-as-read\n  - Style: small link-style text, interactive accent color\n\n### Relative Time\n- Top-right corner, using `formatRelativeTime(notification.createdAt)`\n- `--font-size-xs`, `--text-faint`\n\n### Read vs Unread States\n- **Unread**: Tinted background (`color-mix(in srgb, var(--interactive-accent) 6%, var(--surface-primary))`), bold title, colored left border\n- **Read**: `opacity: 0.65` on the entire item, medium-weight muted title, transparent left border\n\n### Hover\n- Subtle background change on hover (slightly darker tint)\n\n### Accessibility\n- `min-height: 44px` on `@media (pointer: coarse)` for WCAG touch targets\n- Screen reader text for unread state\n\n## Imports Needed\n```typescript\nimport type { Notification } from '$lib/schemas/api/notifications';\nimport { notificationTypeConfig } from '$lib/config/notificationTypes';\nimport { formatRelativeTime } from '$lib/utils/date/formatting';\nimport * as m from '$lib/paraglide/messages.js';\n```\n\n## Dependencies\n- Bead: \"Add relative time and grouping utilities\" (for `formatRelativeTime`)\n- Bead: \"Create notification type-to-icon/color config map\" (for `notificationTypeConfig`)\n\n## Acceptance Criteria\n- Renders different icons/colors for different notification types\n- Unread items have tinted bg, bold title, colored left border\n- Read items have reduced opacity, muted title, no left border\n- Metadata line renders from data field with null safety\n- CTA renders only for bid_open and shift_reminder types\n- CTA click does NOT trigger onMarkRead (stopPropagation)\n- Body/button click DOES trigger onMarkRead\n- Relative timestamp displays in top-right\n- Touch targets ≥ 44px on touch devices\n- Uses design tokens for all colors, spacing, typography\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T10:38:48.6793525+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:19.4576409+09:00","closed_at":"2026-02-05T12:33:19.4576409+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-axf.3","depends_on_id":"DRV-axf","type":"parent-child","created_at":"2026-02-05T10:38:48.6853781+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.3","depends_on_id":"DRV-axf.1","type":"blocks","created_at":"2026-02-05T10:39:28.9905773+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.3","depends_on_id":"DRV-axf.2","type":"blocks","created_at":"2026-02-05T10:39:29.984186+09:00","created_by":"Matt"}]}
{"id":"DRV-axf.4","title":"Add i18n keys for notification groups and CTAs","description":"Source: Plan from conversation (Notifications Page Redesign — Step 4)\n\nAdd internationalization keys for time group headers and CTA button labels.\n\n## File to Modify\n`messages/en.json`\n\n## Keys to Add\nInsert after the existing `notifications_unread_label` key (around line 95):\n\n```json\n\"notifications_group_today\": \"Today\",\n\"notifications_group_yesterday\": \"Yesterday\",\n\"notifications_group_this_week\": \"This Week\",\n\"notifications_group_earlier\": \"Earlier\",\n\"notifications_cta_place_bid\": \"Place Bid\",\n\"notifications_cta_view_dashboard\": \"View Dashboard\"\n```\n\n## Usage Context\n- `notifications_group_*` keys used in `+page.svelte` for time group section headers\n- `notifications_cta_place_bid` used in `NotificationItem.svelte` for bid_open CTA\n- `notifications_cta_view_dashboard` used in `NotificationItem.svelte` for shift_reminder CTA\n\n## Dependencies\n- None\n\n## Acceptance Criteria\n- All 6 keys added to `messages/en.json`\n- Keys follow existing naming convention (`notifications_` prefix)\n- JSON remains valid after edit\n- Paraglide generates corresponding message functions (verified by import in consuming components)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T10:38:54.6877555+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:20.0273862+09:00","closed_at":"2026-02-05T12:33:20.0273862+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-axf.4","depends_on_id":"DRV-axf","type":"parent-child","created_at":"2026-02-05T10:38:54.6939559+09:00","created_by":"Matt"}]}
{"id":"DRV-axf.5","title":"Rewrite notifications page with time grouping and NotificationItem","description":"Source: Plan from conversation (Notifications Page Redesign — Step 5)\n\nFull rewrite of the notifications page to use the new NotificationItem component with time-grouped sections.\n\n## File to Modify\n`src/routes/(app)/notifications/+page.svelte`\n\n## Key Changes from Current Implementation\n\n### Layout Structure\n- Uses `page-surface \u003e page-stage` scaffold (keep existing)\n- Content centered with `max-width: 680px` for focused feed feel\n- **Header moved INSIDE the `.page-card`**: Title + \"Mark All as Read\" button inside the card with a `border-bottom` separator (intentional layout change for contained inbox feel)\n\n### Time Grouping (new)\nAdd a `$derived` that groups `notificationsStore.notifications` by `getTimeGroup()`:\n\n```typescript\nconst groupedNotifications = $derived(() =\u003e {\n    const groups: { key: string; label: string; items: Notification[] }[] = [];\n    const groupMap = new Map\u003cstring, Notification[]\u003e();\n    const order = ['today', 'yesterday', 'this_week', 'earlier'];\n    const labels: Record\u003cstring, () =\u003e string\u003e = {\n        today: m.notifications_group_today,\n        yesterday: m.notifications_group_yesterday,\n        this_week: m.notifications_group_this_week,\n        earlier: m.notifications_group_earlier,\n    };\n\n    for (const n of notificationsStore.notifications) {\n        const key = getTimeGroup(n.createdAt);\n        if (!groupMap.has(key)) groupMap.set(key, []);\n        groupMap.get(key)!.push(n);\n    }\n\n    for (const key of order) {\n        const items = groupMap.get(key);\n        if (items?.length) {\n            groups.push({ key, label: labels[key](), items });\n        }\n    }\n    return groups;\n});\n```\n\n### Rendering\n```svelte\n{#each groupedNotifications as group (group.key)}\n    \u003cdiv class=\"notification-group\"\u003e\n        \u003ch3 class=\"group-header\"\u003e{group.label}\u003c/h3\u003e\n        {#each group.items as notification (notification.id)}\n            \u003cNotificationItem\n                {notification}\n                onMarkRead={handleMarkRead}\n            /\u003e\n        {/each}\n    \u003c/div\u003e\n{/each}\n```\n\n### Preserved Behaviors\n- Loading spinner state (Spinner component)\n- Error state (NoticeBanner)\n- Empty state (\"You're all caught up\")\n- DataTablePagination at bottom (same props/logic)\n- `onMount` → `notificationsStore.loadPage(0)`\n- `handleMarkAllRead`, `handleMarkRead`, pagination functions unchanged\n\n### Styles\n- Group header: `--font-size-xs`, `--text-faint`, uppercase, `letter-spacing: 0.05em`, padding\n- Card header (inside card): flex row with border-bottom separator\n- Mobile: Card goes full-width at `max-width: 767px` — audit existing `.page-card` styles to avoid conflicts\n- Remove old `.notification-item`, `.unread-dot`, `.notification-content`, etc. styles (moved to NotificationItem)\n\n### Removed Imports\n- Remove: `Button` (no longer used for notification items)\n- Remove: `formatUiDateTime` (replaced by formatRelativeTime in NotificationItem)\n\n### New Imports\n- Add: `NotificationItem` from `$lib/components/notifications/NotificationItem.svelte`\n- Add: `getTimeGroup` from `$lib/utils/date/formatting`\n\n## Dependencies\n- Bead: \"Add relative time and grouping utilities\" (for `getTimeGroup`)\n- Bead: \"Create notification type-to-icon/color config map\" (used by NotificationItem)\n- Bead: \"Create NotificationItem.svelte component\"\n- Bead: \"Add i18n keys\" (for group header labels)\n\n## Acceptance Criteria\n- Notifications grouped under \"Today\", \"Yesterday\", \"This Week\", \"Earlier\" headers\n- Each notification renders via NotificationItem with correct icon/color\n- Header + \"Mark All as Read\" inside the page-card\n- Loading, error, empty states still work\n- Pagination still works\n- Clicking notification body triggers mark-as-read\n- Clicking CTA link navigates without triggering mark-as-read\n- Mark-all-read button still works\n- Mobile layout renders correctly at narrow viewports\n- No leftover unused styles from old implementation\n- All colors use CSS variables (works in both light and dark themes)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T10:39:17.156576+09:00","created_by":"Matt","updated_at":"2026-02-05T12:33:20.5841934+09:00","closed_at":"2026-02-05T12:33:20.5841934+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-axf.5","depends_on_id":"DRV-axf","type":"parent-child","created_at":"2026-02-05T10:39:17.1635769+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.5","depends_on_id":"DRV-axf.1","type":"blocks","created_at":"2026-02-05T10:39:31.1486866+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.5","depends_on_id":"DRV-axf.2","type":"blocks","created_at":"2026-02-05T10:39:32.2888895+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.5","depends_on_id":"DRV-axf.3","type":"blocks","created_at":"2026-02-05T10:39:33.1811071+09:00","created_by":"Matt"},{"issue_id":"DRV-axf.5","depends_on_id":"DRV-axf.4","type":"blocks","created_at":"2026-02-05T10:39:34.1098164+09:00","created_by":"Matt"}]}
{"id":"DRV-b0dc","title":"Nightly 2026-02-18: Documentation Gaps","description":"Parent epic for documentation gap findings from nightly audit 2026-02-18. Medium: coverage docs overstate proven behavior, stale runbook placeholders.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-18T12:45:59.2687219+09:00","created_by":"Matt","updated_at":"2026-02-18T12:45:59.2687219+09:00","labels":["documentation","nightly-audit","testing"]}
{"id":"DRV-b1l","title":"Establish full multi-tenant end-to-end integration coverage for core dispatch algorithm","description":"We have repeatedly been burned by relying on mocked unit tests while core behavior drifts in production-like paths. The dispatch/scheduling algorithm is currently too black-box and needs deterministic end-to-end validation across real service boundaries and data persistence. Build a project-wide integration test program that exercises the backbone workflows across multiple organizations, validates tenant isolation invariants, and gives us confidence that critical planning/dispatch logic actually works as shipped.","design":"Technical plan: documentation/plans/DRV-b1l-multi-tenant-e2e-testing-program.md. Execution decomposition: DRV-b1l.1 (harness + initial smoke scenarios), DRV-b1l.2/.3/.4/.5 (core algorithm matrices), DRV-b1l.6 (API/UI critical journeys), DRV-b1l.8 (adversarial pack), DRV-b1l.7 (PR smoke CI gate), DRV-b1l.10 (nightly full CI + artifacts), DRV-b1l.9 (triage runbook and ownership).","acceptance_criteria":"1) A reusable integration harness creates deterministic multi-tenant fixtures (at least two orgs) and supports full workflow execution against real DB-backed service/API paths. 2) End-to-end suites cover the backbone flows: schedule generation, assignment eligibility/caps, bidding (competitive/instant/emergency), no-show detection, health scoring, manager overrides, dispatch settings, and notification fanout. 3) Every covered flow includes explicit cross-tenant assertions proving no reads, writes, assignments, or notifications leak across organizations. 4) The algorithm no longer behaves as an opaque black box: tests assert key decision points and expected outcomes for representative and adversarial scenarios. 5) Suites run in CI with at least a PR smoke subset plus broader scheduled run, and failures provide actionable diagnostics (scenario name, invariant violated, and relevant DB-state evidence).","notes":"PR: https://github.com/orro3790/drive/pull/188","status":"closed","priority":1,"issue_type":"epic","assignee":"drive","created_at":"2026-02-12T20:12:53.5888647+09:00","created_by":"Matt","updated_at":"2026-02-19T12:48:45.3165565+09:00","closed_at":"2026-02-19T12:46:58.510034+09:00","close_reason":"Closed","external_ref":"https://github.com/orro3790/drive/pull/188","labels":["algorithm","e2e","multi-tenant","nightly","quality","testing"]}
{"id":"DRV-b1l.1","title":"Build real-DB multi-tenant integration harness","description":"Create the core real-DB integration harness for deterministic multi-tenant testing. Includes a test-only DB client path, DB lifecycle/reset controls, fixture builders for at least two organizations, stable Toronto/DST time controls, and reusable invariant assertion utilities.","acceptance_criteria":"1) New harness under tests/integration/harness supports deterministic setup/reset for org-a and org-b using real DB state. 2) Integration runtime uses a test-only DB client path (without modifying production DB module behavior). 3) Shared helpers support actor-based scenario setup and invariant assertions for tenant isolation, cross-org notification leakage, and assignment integrity. 4) Milestone-A smoke scenarios BID-001, NOS-003, and API-001 run on the harness.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:16:26.4254735+09:00","created_by":"Matt","updated_at":"2026-02-14T04:17:03.8050866+09:00","closed_at":"2026-02-14T04:17:03.8050866+09:00","close_reason":"Closed","labels":["e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.1","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:16:26.4340009+09:00","created_by":"Matt"}],"comments":[{"id":44,"issue_id":"DRV-b1l.1","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/121","created_at":"2026-02-13T19:20:12Z"}]}
{"id":"DRV-b1l.10","title":"Wire nightly full integration runs and artifacts","description":"Add scheduled nightly execution for the full multi-tenant integration matrix with mandatory failure artifacts and deterministic environment setup.","acceptance_criteria":"1) Nightly workflow runs pnpm test:integration:full against deterministic DB setup. 2) Workflow uploads diagnostics artifacts for failures (scenario/invariant ids, evidence snapshots, logs). 3) Full run remains separate from PR smoke and does not slow merge-time gating. 4) Operational alerts are configured for nightly failures.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:34:12.1694323+09:00","created_by":"Matt","updated_at":"2026-02-18T01:58:30.0063273+09:00","closed_at":"2026-02-18T01:58:30.0063273+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.10-nightly-full-integration-runs-and-artifacts-audit.md","labels":["ci","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:34:12.1760124+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.2","type":"blocks","created_at":"2026-02-12T20:34:12.1926166+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.3","type":"blocks","created_at":"2026-02-12T20:34:12.2028446+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.4","type":"blocks","created_at":"2026-02-12T20:34:12.2141704+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.5","type":"blocks","created_at":"2026-02-12T20:34:12.2291802+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.6","type":"blocks","created_at":"2026-02-12T20:34:12.2453978+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.8","type":"blocks","created_at":"2026-02-12T20:34:12.2587606+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.10","depends_on_id":"DRV-b1l.7","type":"blocks","created_at":"2026-02-12T20:34:12.2692917+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.11","title":"Nightly: Cron/algorithm E2E drill + DB evidence report","description":"Source: documentation/plans/DRV-b1l-multi-tenant-e2e-testing-program.md\n\nObjective\nRun a true end-to-end automation drill (seed -\u003e cron endpoints -\u003e DB verification) against the CURRENT dev DB (no dedicated DB). Prove that our critical automated systems execute correctly and produce the expected algorithm outcomes + notifications.\n\nScope (must cover)\n- Deterministic reseed on the existing DATABASE_URL (safe: no real users/data)\n- Trigger cron endpoints in sequence using the real HTTP handlers (Authorization: Bearer CRON_SECRET)\n  - /api/cron/lock-preferences\n  - /api/cron/send-confirmation-reminders\n  - /api/cron/auto-drop-unconfirmed\n  - /api/cron/close-bid-windows\n  - /api/cron/no-show-detection\n  - /api/cron/health-daily\n  - /api/cron/health-weekly\n  - (optional but preferred) /api/cron/performance-check, /api/cron/shift-reminders, /api/cron/stale-shift-reminder\n- Idempotency: run each cron twice and assert no duplicate state transitions/duplicate notifications\n- DB verification (no need to login as every driver)\n  - Scheduling: assignments created for Week N+2 are org-scoped; weekly caps and flagged-driver rules enforced\n  - Confirmation reminders: correct drivers get confirmation_reminder and reruns dedupe properly\n  - Auto-drop: unconfirmed shifts past 48h convert into replacement flow (unfilled + bid window) and original driver gets shift_auto_dropped\n  - Bidding: expired windows resolve to 1 winner; losers get bid_lost; winner gets bid_won; assignment assigned_by='bid'\n  - No-show: after route start time, confirmed+not-arrived becomes emergency bid window; metrics/health updated; manager alert sent when route has manager\n\nImportant constraints\n- DO NOT create a separate database/environment. Use the current DB and reseed it.\n- Anchor date for deterministic seed MUST be after dispatchPolicy.confirmation.deploymentDate (currently 2026-03-01) so confirmation/auto-drop logic actually runs.\n\nDeliverables\n- A repeatable nightly runner command (script or tests) that produces artifacts in logs/nightly/YYYY-MM-DD/\n  - cron-e2e-report.md (human readable)\n  - cron-e2e-report.json (machine readable: scenarioId/invariantId/evidence)\n  - include the key entity IDs (org ids, driver ids, assignment ids, bid_window ids)\n- If any invariant fails, open follow-up defect beads with repro steps and evidence pointers.\n\nAcceptance criteria\n- One command executes the full drill from a clean reseed and ends with PASS/FAIL.\n- Each cron endpoint is exercised and verified by DB evidence (not just HTTP 200).\n- Rerunning the drill does not create duplicate notifications/windows/assignments (idempotency proven).\n","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-14T01:24:22.3294483+09:00","created_by":"Matt","updated_at":"2026-02-14T10:55:11.6121694+09:00","closed_at":"2026-02-14T10:55:11.6121694+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-b1l.11","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-14T01:24:22.3349743+09:00","created_by":"Matt"}],"comments":[{"id":53,"issue_id":"DRV-b1l.11","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/127","created_at":"2026-02-14T01:56:55Z"}]}
{"id":"DRV-b1l.12","title":"Nightly: Agent-browser witness verification for automations","description":"Source: documentation/plans/DRV-b1l-multi-tenant-e2e-testing-program.md\n\nObjective\nAdd a browser-level \"witness\" verification pass (mobile-first) that confirms the automated systems' outcomes are actually visible/consistent in the UI after the nightly cron/algorithm drill.\n\nScope\n- Use agent-browser (mobile viewport 390x844) as the browser runner.\n- After the cron/algorithm drill has executed, pick a small set of witness accounts and verify:\n  - Driver assigned by schedule generation: /schedule shows the new assignment; /notifications contains assignment_confirmed.\n  - Driver auto-dropped: /schedule no longer shows that assignment; /notifications contains shift_auto_dropped.\n  - Bid winner + bid loser: /notifications show bid_won / bid_lost respectively; winner's /schedule reflects assigned shift.\n  - Manager witness (seeded manager): /notifications shows driver_no_show (when no-show scenario executed) or other expected manager alerts.\n\nNotes\n- Do NOT log into every driver. Use DB queries from DRV-b1l.11 outputs to select the correct witness accounts (winner/loser ids, etc.).\n- If the seed data does not create a manager-assigned route, update seed/setup for the nightly suite to ensure at least one route has routes.managerId set so manager alerts can be verified.\n\nDeliverables\n- Screenshots under logs/nightly/YYYY-MM-DD/screenshots/ documenting each witness check.\n- Update the nightly report to include screenshot paths + PASS/FAIL per witness flow.\n\nAcceptance criteria\n- Agent-browser run produces a deterministic, repeatable witness pack with screenshots.\n- UI matches DB outcomes for the selected witnesses.\n- Any discrepancy is captured with screenshots and filed as a defect bead.\n","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-14T01:24:36.3513935+09:00","created_by":"Matt","updated_at":"2026-02-18T01:00:34.7998788+09:00","closed_at":"2026-02-18T01:00:34.7998788+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.12-agent-browser-witness-audit.md","labels":["nightly"],"dependencies":[{"issue_id":"DRV-b1l.12","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-14T01:24:36.3607361+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.12","depends_on_id":"DRV-b1l.11","type":"blocks","created_at":"2026-02-14T01:25:04.9077407+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.2","title":"Implement bidding lifecycle end-to-end matrix","description":"Create real-DB end-to-end coverage for competitive, instant, and emergency bidding, including tie-breaks, conflict retries, transitions to instant mode, and winner/loser side effects.","acceptance_criteria":"1) Scenarios cover open-\u003eresolve and competitive-\u003einstant transitions with deterministic expected winners. 2) Conflict retries and race-condition protections are validated with concurrent-style scenarios. 3) Notifications and bid window mutations are asserted as org-scoped with no cross-tenant leakage. 4) Scenario outputs include decision-point evidence for why winners were selected.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:16:43.3698916+09:00","created_by":"Matt","updated_at":"2026-02-19T11:57:51.0102974+09:00","closed_at":"2026-02-19T11:57:51.0102974+09:00","close_reason":"Closed","labels":["algorithm","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.2","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:16:43.3802857+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.2","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:16:56.2872243+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.3","title":"Implement scheduling and eligibility end-to-end matrix","description":"Create real-DB end-to-end scenarios for schedule generation and assignment eligibility. Cover week boundaries, flagged drivers, weekly caps, and org-specific route/driver pools with explicit no-leak assertions.","acceptance_criteria":"1) Integration scenarios verify schedule generation only uses in-org routes and in-org eligible drivers. 2) Weekly cap and flagged-driver behavior is validated through real assignment writes and reads. 3) DST/week boundary scenarios prove stable behavior under Toronto timezone transitions. 4) Every scenario asserts tenant isolation invariants for assignment rows and related reads.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:16:43.4012751+09:00","created_by":"Matt","updated_at":"2026-02-18T02:24:37.7978297+09:00","closed_at":"2026-02-18T02:24:37.7978297+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.3-scheduling-and-eligibility-e2e-matrix-audit.md","labels":["algorithm","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.3","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:16:43.4107724+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.3","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:16:43.4376555+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.4","title":"Implement health scoring and intervention end-to-end matrix","description":"Create real-DB end-to-end coverage for daily and weekly health evaluation, hard-stop events, streak progression/reset, and manager intervention-triggered behavior under multi-tenant conditions.","acceptance_criteria":"1) Daily and weekly evaluation jobs run against seeded multi-tenant data and produce expected score/streak transitions. 2) Hard-stop and reset scenarios are validated using persisted events and follow-up state checks. 3) Notification/flag side effects are asserted to remain within organization boundaries. 4) Scenario failures emit actionable state snapshots for debugging policy drift.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:16:43.4961334+09:00","created_by":"Matt","updated_at":"2026-02-18T02:16:24.8811211+09:00","closed_at":"2026-02-18T02:16:24.8811211+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.4-health-scoring-and-intervention-e2e-matrix-audit.md","labels":["algorithm","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.4","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:16:43.5015519+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.4","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:16:43.5173922+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.5","title":"Implement no-show and emergency reassignment end-to-end matrix","description":"Create real-DB end-to-end scenarios for no-show detection, route-specific cutoffs, emergency bonus policy resolution, manager alerts, and emergency bid window fanout.","acceptance_criteria":"1) Scenarios validate per-route cutoff behavior including DST edges with deterministic clocks. 2) Emergency bonus resolution is verified from org dispatch settings in real DB state. 3) Idempotency is validated for repeated/noisy cron execution. 4) All generated windows/alerts/notifications are proven org-scoped with explicit cross-tenant non-interference assertions.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:16:43.528654+09:00","created_by":"Matt","updated_at":"2026-02-18T02:10:31.4506182+09:00","closed_at":"2026-02-18T02:10:31.4506182+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.5-no-show-and-emergency-reassignment-e2e-matrix-audit.md","labels":["algorithm","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.5","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:16:43.538253+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.5","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:16:43.5577951+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.6","title":"Implement API and critical UI end-to-end multi-tenant journeys","description":"Add API-level and selective Playwright end-to-end journeys that exercise manager and driver critical paths across organizations, including bid acceptance, manager override, dispatch settings updates, and timeline views.","acceptance_criteria":"1) API e2e suites validate auth context and org-bound authorization for manager and driver critical endpoints. 2) Select UI e2e scenarios cover highest-risk flows where orchestration bugs are likely to hide. 3) Every journey includes explicit cross-tenant non-interference assertions. 4) Suites are deterministic and runnable in CI.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:17:05.9109458+09:00","created_by":"Matt","updated_at":"2026-02-18T02:06:02.4451414+09:00","closed_at":"2026-02-18T02:06:02.4451414+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.6-api-and-critical-ui-multi-tenant-journeys-audit.md","labels":["api","e2e","multi-tenant","nightly","testing","ui"],"dependencies":[{"issue_id":"DRV-b1l.6","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:17:05.9154322+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.6","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:17:05.929495+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.7","title":"Wire integration smoke suite into PR CI","description":"Wire the minimum required multi-tenant integration smoke suite into pull request CI with deterministic DB setup and actionable failure artifacts.","acceptance_criteria":"1) PR CI starts a Postgres service, applies schema, seeds deterministic baseline fixtures, and runs pnpm test:integration:smoke. 2) Smoke failures are merge-blocking and include diagnostics artifacts (scenario id, invariant id, evidence rows/logs). 3) Smoke selection is explicit and stable (only *.smoke.test.ts). 4) Runtime budget remains stable and tracked over time.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:17:11.5336791+09:00","created_by":"Matt","updated_at":"2026-02-14T05:58:32.2439958+09:00","closed_at":"2026-02-14T05:58:32.2439958+09:00","close_reason":"Closed","labels":["ci","e2e","multi-tenant","nightly","testing"],"dependencies":[{"issue_id":"DRV-b1l.7","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:17:11.5386929+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.7","depends_on_id":"DRV-b1l.1","type":"blocks","created_at":"2026-02-12T20:34:05.5549537+09:00","created_by":"Matt"}],"comments":[{"id":47,"issue_id":"DRV-b1l.7","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/123","created_at":"2026-02-13T21:00:07Z"}]}
{"id":"DRV-b1l.8","title":"Add adversarial concurrency and idempotency scenario pack","description":"Create adversarial end-to-end scenarios for race conditions, duplicate cron invocations, near-simultaneous bids, and conflicting manager actions to validate deterministic and safe algorithm behavior under stress.","acceptance_criteria":"1) Bidding and no-show flows include concurrency/idempotency scenarios with reproducible outcomes. 2) Assertions verify safety invariants (no duplicate assignment, no duplicate open window, no cross-org writes). 3) Flaky timing dependencies are removed via deterministic controls or explicit synchronization. 4) Scenario outputs clearly state expected recovery behavior when conflicts occur.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:17:17.6437361+09:00","created_by":"Matt","updated_at":"2026-02-18T02:01:44.9585066+09:00","closed_at":"2026-02-18T02:01:44.9585066+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-b1l.8-adversarial-concurrency-idempotency-scenario-pack-audit.md","labels":["algorithm","e2e","multi-tenant","nightly","resilience","testing"],"dependencies":[{"issue_id":"DRV-b1l.8","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:17:17.6500581+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.8","depends_on_id":"DRV-b1l.2","type":"blocks","created_at":"2026-02-12T20:17:17.6800695+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.8","depends_on_id":"DRV-b1l.5","type":"blocks","created_at":"2026-02-12T20:17:17.6963887+09:00","created_by":"Matt"}]}
{"id":"DRV-b1l.9","title":"Publish integration failure triage runbook and ownership model","description":"Document how to triage and fix integration failures quickly, including scenario taxonomy, invariant meanings, expected artifacts, and ownership/escalation rules for algorithm regressions.","acceptance_criteria":"1) Runbook explains failure classes, required diagnostics, and first-response workflow. 2) Ownership is defined for core algorithm regressions vs harness failures. 3) Docs include commands for local reproduction of smoke and full suites. 4) Team can execute runbook from a fresh session without tribal context.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-12T20:17:23.0527232+09:00","created_by":"Matt","updated_at":"2026-02-14T08:00:40.1519833+09:00","closed_at":"2026-02-14T08:00:40.1519833+09:00","close_reason":"Closed","labels":["e2e","nightly","ops","quality","testing"],"dependencies":[{"issue_id":"DRV-b1l.9","depends_on_id":"DRV-b1l","type":"parent-child","created_at":"2026-02-12T20:17:23.0559858+09:00","created_by":"Matt"},{"issue_id":"DRV-b1l.9","depends_on_id":"DRV-b1l.10","type":"blocks","created_at":"2026-02-12T20:34:18.8530379+09:00","created_by":"Matt"}],"comments":[{"id":43,"issue_id":"DRV-b1l.9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/120","created_at":"2026-02-13T16:57:27Z"},{"id":45,"issue_id":"DRV-b1l.9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/122","created_at":"2026-02-13T20:18:02Z"},{"id":46,"issue_id":"DRV-b1l.9","author":"Matt","text":"Merged PR #122: refreshed integration triage runbook now that Milestone A harness is in develop; validated locally with dockerized Postgres + pnpm test:integration:smoke and pnpm validate.","created_at":"2026-02-13T20:24:02Z"},{"id":48,"issue_id":"DRV-b1l.9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/124","created_at":"2026-02-13T21:24:31Z"},{"id":49,"issue_id":"DRV-b1l.9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/125","created_at":"2026-02-13T22:29:38Z"},{"id":50,"issue_id":"DRV-b1l.9","author":"Matt","text":"Merged PR #125: strengthened integration triage runbook (scope + evidence matrix + Windows bd.exe/PowerShell defect template + fresh-session validation checklist).","created_at":"2026-02-13T22:38:34Z"},{"id":51,"issue_id":"DRV-b1l.9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/126","created_at":"2026-02-13T23:04:07Z"},{"id":52,"issue_id":"DRV-b1l.9","author":"Matt","text":"Merged PR #126: force-closed DRV-b1l.9 (dependency DRV-b1l.10) and tightened execution plan.","created_at":"2026-02-13T23:07:53Z"}]}
{"id":"DRV-b6o","title":"Create password reset email template","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Create #1)\n\nCreate HTML email template for password reset emails.\n\nFILE TO CREATE: src/lib/server/emails/resetPassword.ts\n\nIMPLEMENTATION:\nExport a const resetPasswordHtml containing an HTML email template string.\nBase structure on Snapgrade pattern: C:\\Users\\matto\\projects\\Snapgrade\\src\\lib\\server\\emails\\resetPassword.ts\n\nTemplate must include these placeholders (use {{ placeholder }} syntax):\n- {{ handlerUrl }} - The password reset URL\n- {{ year }} - Current year for footer  \n- {{ appOrigin }} - App origin URL for footer\n\nKEY CHANGES FROM SNAPGRADE:\n- Replace Snapgrade with Drive in all text\n- Keep same HTML structure and inline styles\n- Keep same placeholder syntax for consistency\n\nACCEPTANCE CRITERIA:\n- File exports resetPasswordHtml const\n- All three placeholders present (handlerUrl, year, appOrigin)\n- HTML is valid and renders correctly in email clients\n- Branding says Drive not Snapgrade","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:13:30.9335971+09:00","created_by":"Matt","updated_at":"2026-02-03T09:20:06.2075404+09:00","closed_at":"2026-02-03T09:20:06.2075404+09:00","close_reason":"Closed"}
{"id":"DRV-b9t","title":"Route CRUD (Manager)","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\nSchema: docs/specs/data-model.md § routes table\n\n## Objective\nImplement route management for managers: list, create, edit, delete routes.\n\n## Scope\n- API endpoints:\n  - GET /api/routes - List routes (with warehouse info)\n  - POST /api/routes - Create route\n  - PATCH /api/routes/[id] - Update route\n  - DELETE /api/routes/[id] - Delete route (if no future assignments)\n- UI page at src/routes/(manager)/routes/+page.svelte (this is the manager dashboard home)\n- Filter by warehouse, status (assigned/unfilled), date\n- DataTable with route name, warehouse, current assignment status\n\n## Spec References\n- docs/specs/SPEC.md: Line 245 (Manager routes overview)\n- docs/specs/SPEC.md: Lines 253-260 (Manager capabilities)\n- docs/specs/data-model.md: Lines 72-79 (routes table schema)\n- docs/specs/SPEC.md: Line 49 (Route entity description)\n\n## Acceptance Criteria\n- Manager can view all routes with warehouse association\n- Manager can filter routes by warehouse\n- Manager can create route (name required, warehouse required)\n- Manager can edit route name or reassign to different warehouse\n- Manager can delete route only if no future assignments exist\n- Routes display current day's assignment status (assigned/unfilled/bidding)\n- All changes logged to auditLogs\n\n## Technical Constraints\n- Routes have many-to-one relationship with warehouses\n- Route names should be unique within a warehouse\n- Include warehouse name in route listings via join","notes":"PR: https://github.com/orro3790/drive/pull/2; Manager credentials fixed - Better Auth admin plugin with roles configured, password reset verified working. Ready for /verify.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:23:15.7964204+09:00","created_by":"Matt","updated_at":"2026-02-03T10:38:22.4861187+09:00","closed_at":"2026-02-03T10:38:22.4861187+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-b9t","depends_on_id":"DRV-a1e","type":"blocks","created_at":"2026-02-02T21:23:15.8025154+09:00","created_by":"Matt"}]}
{"id":"DRV-beb","title":"academyMapStore skips runtime response validation before state commit","description":"academyMapStore imports only BoundsResponse type and assigns response.json() directly before committing to state. Runtime schema exists (src/lib/schemas/academy-bounds.ts:76) but is not used. Malformed payloads can enter store state undetected. Source: logs/nightly/2026-02-18/drv-xnb.10-store-mutation-safety-and-offline-guard-parity-audit.md Finding 2","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:04:35.1954242+09:00","created_by":"Matt","updated_at":"2026-02-18T12:04:35.1954242+09:00","labels":["data-integrity","stores","validation"]}
{"id":"DRV-bf8","title":"Update specs and ADRs for confirmation system","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Context \u003e Spec changes required)\n\nUpdate project specifications and ADRs to reflect the new confirmation-based system.\n\n## Files to update:\n\n### docs/specs/SPEC.md — Section §166-179\n- Change from \"Assumed confirmed unless cancelled\" to \"Mandatory confirmation required\"\n- Document confirmation window: 7 days to 48 hours before shift\n- Document auto-drop at 48h deadline\n- Document 9 AM arrival deadline\n- Document 1-hour post-shift edit window\n\n### docs/adr/002-replacement-bidding-system.md\n- Update bid window duration from 30 minutes to 24-hour competitive + instant fallback\n- Document competitive → instant transition at 24h mark\n- Document emergency mode (first-come-first-served + 20% bonus)\n- Update decision rationale\n\n### docs/specs/data-model.md\n- Add confirmedAt to assignments table\n- Add mode, trigger, payBonusPercent to bidWindows table\n- Add arrivedAt, editableUntil to shifts table\n- Add new driverMetrics columns\n- Add new notification types\n- Note removal of UNIQUE constraint on bidWindows.assignmentId\n\n### CLAUDE.md\n- Update Key Business Rules section with confirmation rules\n- Add 9 AM arrival deadline\n- Add emergency route concept\n\n## Acceptance criteria\n- All spec documents reflect the new system accurately\n- No contradictions between documents\n- ADR includes decision context and rationale\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-06T17:15:07.8531263+09:00","created_by":"Matt","updated_at":"2026-02-06T23:23:12.3909787+09:00","closed_at":"2026-02-06T23:23:12.3909787+09:00"}
{"id":"DRV-bjh","title":"Driver health gamification v1","description":"Source: docs/plans/driver-health-gamification.md\\n\\nImplement the v1 driver-facing health system with persisted score and streak state, simulation-only incentives, dashboard UX, and milestone/reset notifications. Keep payroll and cap changes manual and out of scope.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-08T00:01:58.2855336+09:00","created_by":"Matt","updated_at":"2026-02-11T20:32:56.4281626+09:00","closed_at":"2026-02-11T20:32:56.4281626+09:00","close_reason":"Closed","labels":["driver-health","gamification"]}
{"id":"DRV-bjh.1","title":"Add persistent driver health schema and state synchronization","description":"Source: docs/plans/driver-health-gamification.md (Technical Design -\u003e Data Model Additions, Edge Cases, Security \u0026 Governance)\n\nObjective\nCreate durable storage for daily health snapshots and current health state so score and stars survive reloads and can be audited.\n\nImplementation details\n- Update `src/lib/server/db/schema.ts` with `driver_health_snapshot` and `driver_health_state` tables (or project-conventional equivalents).\n- Include fields from spec: score inputs, hard-stop flag/reasons, streak/stars, eligibility/intervention flags, next milestone metadata, timestamps.\n- Add migration files in the project migration location to create new tables, indexes on `userId` plus date or week keys, and constraints for 0-100 score and 0-4 stars where supported.\n- Ensure manager unflag or reinstate flow synchronizes `assignmentPoolEligible` and `requiresManagerIntervention` in health state.\n- Add append-only audit log write points for pool removal and reinstatement transitions using existing audit infrastructure.\n\nDependencies\n- Align with existing metrics and flagging tables in `src/lib/server/db/schema.ts`.\n\nAcceptance criteria\n- New tables exist with all required fields and are queryable by API and evaluator code.\n- Score and streak state persist across process restart and device reload.\n- Manual reinstatement updates health-state eligibility fields deterministically.\n- Migration is idempotent and safe in existing environments.\n\nTechnical constraints\n- Server-side writes only; no client mutation path.\n- Preserve backward compatibility with existing manager health-state behavior.\n","notes":"PR: https://github.com/orro3790/drive/pull/53","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T00:02:07.4950211+09:00","created_by":"Matt","updated_at":"2026-02-08T10:56:44.7872353+09:00","closed_at":"2026-02-08T10:55:50.5812967+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-bjh.1","depends_on_id":"DRV-bjh","type":"parent-child","created_at":"2026-02-08T00:02:07.4990334+09:00","created_by":"Matt"}]}
{"id":"DRV-bjh.2","title":"Implement daily score and weekly star evaluation services","description":"Source: docs/plans/driver-health-gamification.md (Proposed Health Model, Evaluation Jobs, Acceptance Criteria)\n\nObjective\nImplement reliability-first health computation pipeline: daily 0-100 scoring plus weekly 0-4 star progression with immediate hard-stop resets.\n\nImplementation details\n- Extend `src/lib/server/services/metrics.ts` and adjacent services with score computation: attendance(50) + completion(30) + reliability(20).\n- Encode hard-stop policy: any no-show or 2 late cancellations in rolling 30 days caps score to 49 for impacted period and triggers reset path.\n- Enforce completion below 80 percent corrective-state signaling and one-week recovery window marker (simulation guidance only in v1; no automatic cap or pay mutation).\n- Add weekly close evaluator to increment streak on qualifying week (100 percent attendance, completion \u003e= 95 percent, no no-shows, no late cancellations), max 4 stars.\n- Treat zero-assignment weeks as neutral (no increment and no reset).\n- Persist daily snapshots and current state after each run; keep recomputation idempotent for backfilled metric changes.\n\nDependencies\n- Depends on health schema task for persistence targets.\n\nAcceptance criteria\n- Daily run persists score and reasons and applies hard-stop cap correctly.\n- Weekly run updates streak and stars exactly per qualifying, hard-stop, and neutral rules.\n- Duplicate or concurrent event processing does not double-penalize a single shift event.\n- Re-running evaluators over the same period yields stable results.\n\nTechnical constraints\n- Server-side authoritative calculations only.\n- Keep `src/lib/config/dispatchPolicy.ts` as source of truth for policy constants where applicable.\n","notes":"PR: https://github.com/orro3790/drive/pull/54","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-08T00:02:15.9764909+09:00","created_by":"Matt","updated_at":"2026-02-08T11:38:21.4444428+09:00","closed_at":"2026-02-08T11:38:21.4444428+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-bjh.2","depends_on_id":"DRV-bjh","type":"parent-child","created_at":"2026-02-08T00:02:15.9803316+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.2","depends_on_id":"DRV-bjh.1","type":"blocks","created_at":"2026-02-08T00:02:40.5293248+09:00","created_by":"Matt"}]}
{"id":"DRV-bjh.3","title":"Expose driver health endpoint and milestone/reset notifications","description":"Source: docs/plans/driver-health-gamification.md (API Surface, Notifications, Security \u0026 Governance, Product Decisions #17)\n\nObjective\nProvide authenticated read-only health payload for driver UI and emit user-facing notifications for progression and corrective states.\n\nImplementation details\n- Add `GET /api/driver-health` route handler in API routes (`src/routes/api/...`) returning current score, stars and streak, elite-threshold marker, hard-stop reasons, next milestone, and simulation rewards.\n- Keep `/api/dashboard` lightweight; either fetch health via dedicated endpoint or minimal expansion based on existing patterns.\n- Integrate evaluator outcomes with notification pipeline for: streak advanced, streak reset with reason, 4-star simulation bonus eligibility, corrective-state warning (completion \u003c 80 percent).\n- Ensure response language and notification copy clearly label rewards and cap impacts as simulation-only in v1.\n- Enforce auth and driver scoping so a user can read only personal health state.\n\nDependencies\n- Depends on scoring and persisted state outputs.\n\nAcceptance criteria\n- Authenticated driver receives complete health payload with no write operations exposed.\n- Required notification events emit once per qualifying state transition.\n- Messaging does not imply automatic payroll or cap mutation.\n\nTechnical constraints\n- No new privilege-escalation paths; preserve existing API auth model.\n- Read path tolerates missing historical snapshots for new drivers by returning neutral onboarding state.\n","notes":"PR: https://github.com/orro3790/drive/pull/55","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T00:02:22.7848056+09:00","created_by":"Matt","updated_at":"2026-02-08T11:56:02.408221+09:00","closed_at":"2026-02-08T11:55:15.4782315+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-bjh.3","depends_on_id":"DRV-bjh","type":"parent-child","created_at":"2026-02-08T00:02:22.7877571+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.3","depends_on_id":"DRV-bjh.2","type":"blocks","created_at":"2026-02-08T00:02:41.0327484+09:00","created_by":"Matt"}]}
{"id":"DRV-bjh.4","title":"Replace dashboard metric emphasis with health card UX","description":"Source: docs/plans/driver-health-gamification.md (UI Surface, In Scope, Product Decisions #3-4 #15-16)\n\nObjective\nShip a driver dashboard health card that makes reliability incentives obvious while keeping raw metrics as secondary detail.\n\nImplementation details\n- Update driver dashboard UI components (likely under `src/routes/.../dashboard` and shared components) to prioritize a health card over the current high-emphasis raw metrics block.\n- Render score bar (0-100) with elite threshold marker, 0-4 star row, concise status summary, factor breakdown, and next-milestone guidance.\n- Include terminology updates: `Open Shifts` and `Place Bid` where health incentives reference shift access.\n- Display simulation previews: 4 stars =\u003e +10 percent bonus and higher assignment access projection; visibly mark as simulation.\n- Keep raw attendance and completion counts accessible via compact or collapsible secondary section.\n- Ensure responsive behavior for desktop and mobile plus loading, empty, and error states from `/api/driver-health`.\n\nDependencies\n- Depends on health API contract and notification copy keys.\n\nAcceptance criteria\n- Dashboard shows score and stars with required marker, breakdown, and guidance content.\n- Raw metrics remain available but visually de-emphasized.\n- Simulation language appears wherever incentive values are shown.\n- UI remains functional for neutral, no-assignment, and new-driver states.\n\nTechnical constraints\n- No client-side authority over health calculations; display server values only.\n- Preserve existing design-system patterns and accessibility semantics.\n","notes":"PR: https://github.com/orro3790/drive/pull/56","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T00:02:29.6613134+09:00","created_by":"Matt","updated_at":"2026-02-08T12:27:32.9341874+09:00","closed_at":"2026-02-08T12:26:54.4878992+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-bjh.4","depends_on_id":"DRV-bjh","type":"parent-child","created_at":"2026-02-08T00:02:29.6657521+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.4","depends_on_id":"DRV-bjh.3","type":"blocks","created_at":"2026-02-08T00:02:41.5371609+09:00","created_by":"Matt"}]}
{"id":"DRV-bjh.5","title":"Add regression and edge-case tests for health policy","description":"Source: docs/plans/driver-health-gamification.md (Acceptance Criteria, Edge Cases, Suggested Decomposition #5)\n\nObjective\nPrevent policy regressions by covering scoring, weekly progression, hard-stop rules, API outputs, and UI-state rendering with automated tests.\n\nImplementation details\n- Add backend unit and integration tests for daily score weighting, hard-stop cap to 49, weekly qualifying criteria, neutral zero-assignment weeks, and immediate reset behavior.\n- Add tests for late-cancel rolling-30-day threshold and no-show pool-removal trigger semantics.\n- Add idempotency tests for backfill or recompute and concurrent event handling to avoid double penalties.\n- Add API contract tests for `GET /api/driver-health` (auth, payload fields, and simulation wording).\n- Add UI or component tests for health card rendering across healthy, corrective, hard-stop, neutral onboarding, and 4-star milestone states.\n\nDependencies\n- Depends on schema, evaluator, API, and dashboard implementation beads.\n\nAcceptance criteria\n- Test suite enforces all eight v1 acceptance criteria from spec.\n- Critical edge cases in spec are covered with deterministic fixtures.\n- CI fails when policy behavior deviates from locked product decisions.\n\nTechnical constraints\n- Reuse existing test stack and conventions; keep fixtures maintainable and explicit.\n","notes":"Added deterministic regression coverage for health policy and UI state: new service tests for daily hard-stop cap (\u003c=49), weekly qualifying criteria, neutral zero-assignment weeks, and immediate reset semantics; API contract tests for GET /api/driver-health auth/onboarding/payload/simulation wording; UI-state mapping tests for onboarding, hard-stop, corrective, healthy charging, and 4-star milestone cases. Also stabilized existing long-running cron/service test hooks with explicit beforeEach hook timeouts to avoid flaky timeout failures under full-suite load. Validation: pnpm test and pnpm validate both pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-08T00:02:35.9780905+09:00","created_by":"Matt","updated_at":"2026-02-09T19:51:54.9197682+09:00","closed_at":"2026-02-09T19:51:54.9197682+09:00","close_reason":"Completed health policy regression and edge-case test coverage","dependencies":[{"issue_id":"DRV-bjh.5","depends_on_id":"DRV-bjh","type":"parent-child","created_at":"2026-02-08T00:02:35.9862218+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.5","depends_on_id":"DRV-bjh.1","type":"blocks","created_at":"2026-02-08T00:02:42.0554739+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.5","depends_on_id":"DRV-bjh.2","type":"blocks","created_at":"2026-02-08T00:02:42.6119109+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.5","depends_on_id":"DRV-bjh.3","type":"blocks","created_at":"2026-02-08T00:02:43.1587774+09:00","created_by":"Matt"},{"issue_id":"DRV-bjh.5","depends_on_id":"DRV-bjh.4","type":"blocks","created_at":"2026-02-08T00:02:43.6603118+09:00","created_by":"Matt"}]}
{"id":"DRV-bjka","title":"Nightly 2026-02-18: Orchestrator and Witness Reliability","description":"Parent epic for nightly orchestrator/witness findings from nightly audit 2026-02-18. High: pass/fail semantics gaps, witness determinism, gating mismatches.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-18T12:45:36.9496264+09:00","created_by":"Matt","updated_at":"2026-02-18T23:06:50.5439241+09:00","closed_at":"2026-02-18T23:06:50.5439241+09:00","close_reason":"All child reliability fixes merged","labels":["nightly","nightly-audit","orchestrator","witness"],"comments":[{"id":70,"issue_id":"DRV-bjka","author":"DESKTOP-V2O36N0\\matto","text":"All child beads are now closed and merged via PR #174 and PR #175. PR #175: https://github.com/orro3790/drive/pull/175","created_at":"2026-02-18T14:06:49Z"}]}
{"id":"DRV-bo0","title":"Create warehouse managers CRUD API","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nCreate src/routes/api/warehouses/[id]/managers/+server.ts for managing warehouse manager assignments.\n\n## File: src/routes/api/warehouses/[id]/managers/+server.ts\n\n```typescript\n/**\n * Warehouse Managers API\n *\n * GET    /api/warehouses/[id]/managers - List managers for warehouse\n * POST   /api/warehouses/[id]/managers - Add manager to warehouse\n * DELETE /api/warehouses/[id]/managers - Remove manager from warehouse\n */\n\nimport { json, error } from \"@sveltejs/kit\";\nimport type { RequestHandler } from \"./$types\";\nimport { db } from \"$lib/server/db\";\nimport { warehouseManagers, warehouses, user } from \"$lib/server/db/schema\";\nimport { canManagerAccessWarehouse } from \"$lib/server/services/managers\";\nimport { and, eq } from \"drizzle-orm\";\nimport { z } from \"zod\";\n\nconst addManagerSchema = z.object({\n  userId: z.string().min(1)\n});\n\nconst removeManagerSchema = z.object({\n  userId: z.string().min(1)\n});\n\nexport const GET: RequestHandler = async ({ locals, params }) =\u003e {\n  if (!locals.user) throw error(401, \"Unauthorized\");\n  if (locals.user.role !== \"manager\") throw error(403, \"Forbidden\");\n\n  const { id: warehouseId } = params;\n\n  // Verify caller has access to this warehouse\n  const canAccess = await canManagerAccessWarehouse(locals.user.id, warehouseId);\n  if (!canAccess) throw error(403, \"No access to this warehouse\");\n\n  const managers = await db\n    .select({\n      id: warehouseManagers.id,\n      userId: warehouseManagers.userId,\n      userName: user.name,\n      userEmail: user.email,\n      createdAt: warehouseManagers.createdAt\n    })\n    .from(warehouseManagers)\n    .innerJoin(user, eq(user.id, warehouseManagers.userId))\n    .where(eq(warehouseManagers.warehouseId, warehouseId));\n\n  return json({ managers });\n};\n\nexport const POST: RequestHandler = async ({ locals, params, request }) =\u003e {\n  if (!locals.user) throw error(401, \"Unauthorized\");\n  if (locals.user.role !== \"manager\") throw error(403, \"Forbidden\");\n\n  const { id: warehouseId } = params;\n\n  // Verify caller has access\n  const canAccess = await canManagerAccessWarehouse(locals.user.id, warehouseId);\n  if (!canAccess) throw error(403, \"No access to this warehouse\");\n\n  // Verify warehouse exists\n  const [warehouse] = await db\n    .select({ id: warehouses.id })\n    .from(warehouses)\n    .where(eq(warehouses.id, warehouseId));\n  if (!warehouse) throw error(404, \"Warehouse not found\");\n\n  const body = await request.json();\n  const result = addManagerSchema.safeParse(body);\n  if (!result.success) throw error(400, \"Validation failed\");\n\n  const { userId } = result.data;\n\n  // Verify target user exists and is a manager\n  const [targetUser] = await db\n    .select({ id: user.id, role: user.role })\n    .from(user)\n    .where(eq(user.id, userId));\n  \n  if (!targetUser) throw error(404, \"User not found\");\n  if (targetUser.role !== \"manager\") throw error(400, \"User must be a manager\");\n\n  // Check if already assigned\n  const [existing] = await db\n    .select({ id: warehouseManagers.id })\n    .from(warehouseManagers)\n    .where(and(\n      eq(warehouseManagers.warehouseId, warehouseId),\n      eq(warehouseManagers.userId, userId)\n    ));\n  \n  if (existing) throw error(409, \"Manager already assigned to warehouse\");\n\n  const [created] = await db\n    .insert(warehouseManagers)\n    .values({ warehouseId, userId })\n    .returning();\n\n  return json({ warehouseManager: created }, { status: 201 });\n};\n\nexport const DELETE: RequestHandler = async ({ locals, params, request }) =\u003e {\n  if (!locals.user) throw error(401, \"Unauthorized\");\n  if (locals.user.role !== \"manager\") throw error(403, \"Forbidden\");\n\n  const { id: warehouseId } = params;\n\n  // Verify caller has access\n  const canAccess = await canManagerAccessWarehouse(locals.user.id, warehouseId);\n  if (!canAccess) throw error(403, \"No access to this warehouse\");\n\n  const body = await request.json();\n  const result = removeManagerSchema.safeParse(body);\n  if (!result.success) throw error(400, \"Validation failed\");\n\n  const { userId } = result.data;\n\n  // Prevent removing self if only manager\n  const [countResult] = await db\n    .select({ count: count() })\n    .from(warehouseManagers)\n    .where(eq(warehouseManagers.warehouseId, warehouseId));\n  \n  if (countResult.count \u003c= 1 \u0026\u0026 userId === locals.user.id) {\n    throw error(400, \"Cannot remove last manager from warehouse\");\n  }\n\n  const deleted = await db\n    .delete(warehouseManagers)\n    .where(and(\n      eq(warehouseManagers.warehouseId, warehouseId),\n      eq(warehouseManagers.userId, userId)\n    ))\n    .returning();\n\n  if (deleted.length === 0) throw error(404, \"Manager assignment not found\");\n\n  return json({ success: true });\n};\n```\n\n## Additional imports needed\n```typescript\nimport { count } from \"drizzle-orm\";\n```\n\n## Files to Create\n- src/routes/api/warehouses/[id]/managers/+server.ts\n\n## Dependencies\n- DRV-4jy (manager access service)\n- DRV-sww (warehouse_managers table)\n\n## Acceptance Criteria\n- [ ] GET lists all managers for a warehouse\n- [ ] POST adds a manager (validates is manager role)\n- [ ] DELETE removes a manager\n- [ ] DELETE prevents removing last manager\n- [ ] All endpoints validate warehouse access\n- [ ] 409 returned for duplicate assignment","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:24:59.3559906+09:00","created_by":"Matt","updated_at":"2026-02-04T14:28:28.324582+09:00","closed_at":"2026-02-04T14:28:28.324582+09:00","dependencies":[{"issue_id":"DRV-bo0","depends_on_id":"DRV-4jy","type":"blocks","created_at":"2026-02-04T11:26:45.808137+09:00","created_by":"Matt"},{"issue_id":"DRV-bo0","depends_on_id":"DRV-sww","type":"blocks","created_at":"2026-02-04T11:26:52.0537895+09:00","created_by":"Matt"},{"issue_id":"DRV-bo0","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:35.0214407+09:00","created_by":"Matt"}]}
{"id":"DRV-brh","title":"Late-cancel threshold uses global startHourLocal, not route start time","description":"Late-cancel derives from confirmation window built on global startHourLocal instead of route-specific start time. Cancel endpoint does not join route start time. Source: logs/nightly/2026-02-18/drv-xnb.1 finding #5.","notes":"PR: https://github.com/orro3790/drive/pull/167","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:02:22.8578258+09:00","created_by":"Matt","updated_at":"2026-02-18T20:37:13.5533537+09:00","closed_at":"2026-02-18T20:36:45.5433377+09:00","close_reason":"Closed","labels":["cancellation","routes","scheduling"],"dependencies":[{"issue_id":"DRV-brh","depends_on_id":"DRV-5zym","type":"parent-child","created_at":"2026-02-18T12:47:11.1117686+09:00","created_by":"unknown"}]}
{"id":"DRV-bx1","title":"Add latency degradation monitor when monitor slot available","description":"Axiom free-tier monitor capacity is currently limited to 3 active monitors. Add the latency p95 threshold monitor once a monitor slot is available (by deleting/merging an existing monitor or upgrading plan).","acceptance_criteria":"1) Create threshold monitor 'driver-ops latency degradation p95'. 2) Query uses event=http.request.completed and percentile(durationMs, 95) over 15m window. 3) Threshold is \u003e=5000 with 15m frequency/range and existing alert notifier attached.","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-02-10T21:21:59.5265183+09:00","created_by":"Matt","updated_at":"2026-02-11T20:36:10.1237835+09:00","closed_at":"2026-02-11T20:36:10.1237835+09:00","close_reason":"Closed","labels":["logging","observability"]}
{"id":"DRV-c0m","title":"Audit bidding API endpoints","description":"Production readiness audit of src/routes/api/bids/ (submit, available, mine) and src/routes/api/bid-windows/ (list, create, close, assign). Review for: auth and authorization (drivers bid, managers manage windows), race conditions (simultaneous bids, window closing during submission), input validation, duplicate bid prevention, bidding on closed/assigned windows, manager instant-assign bypass for emergency mode, available bids filtering (closed/resolved excluded, eligibility check), response pagination, error handling. Write findings to logs/nightly/2026-02-10/audit-api-bidding.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/81","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:01.2896413+09:00","created_by":"Matt","updated_at":"2026-02-10T04:09:10.3138394+09:00","closed_at":"2026-02-10T04:07:58.8958816+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-cxc","title":"Audit cron job endpoints","description":"Production readiness audit of all 10 cron endpoints in src/routes/api/cron/ (lock-preferences, close-bid-windows, no-show-detection, send-confirmation-reminders, auto-drop-unconfirmed, shift-reminders, performance-check, health-daily, health-weekly, plus any rate-limit cron). Review for: authorization (Vercel cron secret or equivalent), idempotency (safe to run twice), batch processing for timeout avoidance, error isolation (one failure doesn't block rest), timezone correctness (Toronto/Eastern), logging with start/end timestamps and counts, edge cases (no items, all fail, partial batch), Vercel function timeout limits, ordering dependencies between jobs. Write findings to logs/nightly/2026-02-10/audit-api-cron.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:06.9358928+09:00","created_by":"Matt","updated_at":"2026-02-10T05:13:33.2841925+09:00","closed_at":"2026-02-10T05:13:33.2841925+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":27,"issue_id":"DRV-cxc","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/86","created_at":"2026-02-09T20:14:26Z"}]}
{"id":"DRV-cy3","title":"Preference lock check uses next-Sunday deadline, allowing post-lock edits","description":"Lock check compares lockedAt against next Sunday deadline instead of current cycle boundary. Active-cycle locks evaluate as unlocked for entire week after lock. Source: logs/nightly/2026-02-18/drv-xnb.4 finding #1, drv-xnb.1 finding #4.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:00:55.8514168+09:00","created_by":"Matt","updated_at":"2026-02-18T15:15:21.771991+09:00","closed_at":"2026-02-18T15:15:21.771991+09:00","close_reason":"Closed","labels":["lock","preferences","scheduling"],"dependencies":[{"issue_id":"DRV-cy3","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:55.2603201+09:00","created_by":"unknown"}],"comments":[{"id":55,"issue_id":"DRV-cy3","author":"DESKTOP-V2O36N0\\matto","text":"Implemented current-cycle Toronto lock boundary for preference checks and cron lock timestamp sourcing. Added regression tests: tests/server/preferenceLockTime.test.ts; cron lock API contract remains green. Verification run: pnpm exec vitest run tests/server/preferenceLockTime.test.ts tests/server/cronLockPreferencesApi.test.ts, pnpm validate, and mobile settings smoke on /settings.","created_at":"2026-02-18T06:15:44Z"},{"id":56,"issue_id":"DRV-cy3","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/159","created_at":"2026-02-18T06:16:19Z"},{"id":57,"issue_id":"DRV-cy3","author":"DESKTOP-V2O36N0\\matto","text":"Merged: https://github.com/orro3790/drive/pull/159","created_at":"2026-02-18T06:18:19Z"}]}
{"id":"DRV-dbd","title":"Driver reachability and unified scroll contract","description":"Fix clipped and unreachable content by enforcing one vertical scroll owner across shell and route surfaces for dashboard, schedule, bids, notifications, and settings.","acceptance_criteria":"Mobile and desktop reachability is verified for all five routes, deep links and role redirects work, and notifications infinite scroll still loads reliably.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-07T17:05:03.7948707+09:00","created_by":"Matt","updated_at":"2026-02-07T17:42:52.0924053+09:00","closed_at":"2026-02-07T17:42:52.0924053+09:00","close_reason":"All children completed"}
{"id":"DRV-dbd.1","title":"Implement shell-level scroll-owner contract","description":"Update driver, app, and manager layouts plus shared page scaffolding so one primary container owns vertical scrolling and shell wrappers stop clipping content.","acceptance_criteria":"Shell layouts no longer conflict on overflow behavior and sidebar and header interactions remain stable on mobile and desktop.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T17:05:16.9671038+09:00","created_by":"Matt","updated_at":"2026-02-07T17:18:39.1330328+09:00","closed_at":"2026-02-07T17:18:39.1330328+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-dbd.1","depends_on_id":"DRV-dbd","type":"parent-child","created_at":"2026-02-07T17:05:16.9703063+09:00","created_by":"Matt"}]}
{"id":"DRV-dbd.2","title":"Make driver and shared route surfaces contract-compliant","description":"Refactor dashboard, schedule, bids, notifications, and settings surfaces to remove viewport-height conflicts and align with the single scroll-owner contract.","acceptance_criteria":"Target pages have no clipping and only intentional nested scroll regions remain.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T17:05:17.4887424+09:00","created_by":"Matt","updated_at":"2026-02-07T17:18:39.2951697+09:00","closed_at":"2026-02-07T17:18:39.2951697+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-dbd.2","depends_on_id":"DRV-dbd","type":"parent-child","created_at":"2026-02-07T17:05:17.4924986+09:00","created_by":"Matt"},{"issue_id":"DRV-dbd.2","depends_on_id":"DRV-dbd.1","type":"blocks","created_at":"2026-02-07T17:06:35.861248+09:00","created_by":"Matt"}]}
{"id":"DRV-dbd.3","title":"Repair notifications sentinel behavior under new scroll root","description":"Adjust notifications IntersectionObserver setup so pagination still triggers correctly when scroll ownership changes.","acceptance_criteria":"Notifications loadMore behavior is reliable near the sentinel without duplicate or missed loads.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:18.0358469+09:00","created_by":"Matt","updated_at":"2026-02-07T17:18:39.4687501+09:00","closed_at":"2026-02-07T17:18:39.4687501+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-dbd.3","depends_on_id":"DRV-dbd","type":"parent-child","created_at":"2026-02-07T17:05:18.0385289+09:00","created_by":"Matt"},{"issue_id":"DRV-dbd.3","depends_on_id":"DRV-dbd.1","type":"blocks","created_at":"2026-02-07T17:06:36.4950955+09:00","created_by":"Matt"},{"issue_id":"DRV-dbd.3","depends_on_id":"DRV-dbd.2","type":"blocks","created_at":"2026-02-07T17:06:37.1704087+09:00","created_by":"Matt"}]}
{"id":"DRV-dbd.4","title":"Record reachability and deep-link verification evidence","description":"Execute and document route, role, and reachability checks for driver, manager, and unauthenticated scenarios across target pages.","acceptance_criteria":"Verification artifact includes pass and fail evidence for mobile and desktop and identifies any remaining defects.","notes":"Browser verification completed with agent-browser on localhost:5173 for desktop and iPhone 14 emulation. Notifications pagination path was fully exercised after seeding additional notifications (20 -\u003e 54 items); sentinel rendered then retired, and loadMore requests for page=2 and page=3 were captured on both viewports.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:18.605593+09:00","created_by":"Matt","updated_at":"2026-02-07T17:42:51.6444976+09:00","closed_at":"2026-02-07T17:42:51.6444976+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-dbd.4","depends_on_id":"DRV-dbd","type":"parent-child","created_at":"2026-02-07T17:05:18.609475+09:00","created_by":"Matt"},{"issue_id":"DRV-dbd.4","depends_on_id":"DRV-dbd.2","type":"blocks","created_at":"2026-02-07T17:06:37.8463725+09:00","created_by":"Matt"},{"issue_id":"DRV-dbd.4","depends_on_id":"DRV-dbd.3","type":"blocks","created_at":"2026-02-07T17:06:38.5053451+09:00","created_by":"Matt"}]}
{"id":"DRV-dc2","title":"Add scheduling integration test files under tests/integration/scheduling","description":"DRV-b1l.3 Audit Finding #5: Integration-suite composition has no dedicated scheduling SCH-* test files. Present smoke scenarios are API-001, BID-001, and NOS-003; there is no tests/integration/scheduling/* counterpart. Add a scheduling-focused integration test file set so vitest.integration.config.ts includes first-class SCH-* scenarios, not only cron-script invariants. Source: logs/nightly/2026-02-18/drv-b1l.3-scheduling-and-eligibility-e2e-matrix-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:06:29.7310589+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:07.8038226+09:00","closed_at":"2026-02-19T19:54:07.8038226+09:00","close_reason":"Closed","labels":["e2e-testing","scheduling","testing-matrix"]}
{"id":"DRV-ddq","title":"Manager-to-route assignment and alert scoping","description":"Source: User requirement during DRV-5eo session\n\n## Problem\nCurrent model has no manager scoping - all managers see all routes and get all alerts. At scale this creates notification hell.\n\n## Requirements\n\n### Data Model Changes\n1. Add `warehouseManagers` junction table - assigns managers to warehouses\n2. Add `managerId` to `routes` - assigns primary manager to each route\n\n### Access Rules\n| Scope | Can View | Can Override | Gets Alerts |\n|-------|----------|--------------|-------------|\n| Own routes | ✅ | ✅ | ✅ |\n| Other managers' routes at same warehouse | ✅ (health/status) | ✅ | ❌ |\n| Routes at other warehouses | ❌ | ❌ | ❌ |\n\n### Alert Scoping\n- `urgent_unfilled`, `driver_cancelled`, `no_show` → Only route's assigned manager\n- Managers should NOT get alerts for colleagues' routes (even at same warehouse)\n\n### Visibility\n- Manager dashboard shows all routes at their warehouse(s)\n- Can see status/health of colleagues' routes (to help if needed)\n- Can override any assignment at their warehouse\n\n## Schema Changes\n```sql\n-- New junction table\nCREATE TABLE warehouse_managers (\n  id UUID PRIMARY KEY,\n  warehouse_id UUID REFERENCES warehouses(id),\n  user_id UUID REFERENCES users(id),\n  created_at TIMESTAMPTZ\n);\n\n-- Add to routes\nALTER TABLE routes ADD COLUMN manager_id UUID REFERENCES users(id);\n```\n\n## Acceptance Criteria\n- Managers assigned to specific warehouses\n- Routes assigned to specific managers within warehouse\n- Alerts only go to route's assigned manager\n- Managers can view all routes at their warehouse(s)\n- Managers can override any assignment at their warehouse(s)\n- Manager dashboard scoped to their warehouses","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-04T10:49:20.0290109+09:00","created_by":"Matt","updated_at":"2026-02-04T15:36:11.3279932+09:00","closed_at":"2026-02-04T15:36:11.3279932+09:00","close_reason":"Closed"}
{"id":"DRV-dma","title":"Add password reset i18n strings","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Modify #3)\n\nAdd internationalization strings for password reset pages.\n\nFILES TO MODIFY:\n- messages/en.json\n- messages/zh.json\n\nENGLISH STRINGS TO ADD (messages/en.json):\nAdd after existing auth_* keys (around line 42):\n\nauth_forgot_password_title: Forgot password?\nauth_forgot_password_subtitle: Enter your email and we will send you a reset link.\nauth_forgot_password_button: Send Reset Link\nauth_forgot_password_success: If an account exists with this email, you will receive a password reset link shortly.\nauth_forgot_password_error: Unable to send reset email. Please try again.\nauth_back_to_sign_in: Back to sign in\nauth_reset_password_title: Set new password\nauth_reset_password_subtitle: Enter your new password below.\nauth_reset_password_button: Reset Password\nauth_reset_password_success: Your password has been reset successfully!\nauth_reset_password_error: Unable to reset password. Please try again.\nauth_reset_password_invalid_token: This reset link is invalid or has expired.\nauth_reset_password_request_new: Request a new reset link\nauth_reset_password_redirecting: Redirecting to sign in...\nauth_reset_password_min_length: Password must be at least 8 characters.\nauth_password_new_placeholder: Enter your new password\n\nCHINESE STRINGS TO ADD (messages/zh.json):\nSame keys with Chinese translations - check existing zh.json for tone/style consistency.\n\nACCEPTANCE CRITERIA:\n- All 16 keys added to en.json\n- All 16 keys added to zh.json with proper translations\n- Keys follow existing naming convention (auth_*)\n- JSON remains valid after edits","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:14:13.3215088+09:00","created_by":"Matt","updated_at":"2026-02-03T09:20:07.4135402+09:00","closed_at":"2026-02-03T09:20:07.4135402+09:00","close_reason":"Closed"}
{"id":"DRV-dpm","title":"Audit notifications and onboarding services","description":"Production readiness audit of src/lib/server/services/notifications.ts (536 lines) and src/lib/server/services/onboarding.ts (427 lines). Review for: FCM error handling (token expiry, invalid tokens, quota limits, network failures), bulk notification batching (Firebase limits), notification template completeness, onboarding invite lifecycle (creation, acceptance, revocation, expiry), signup policy enforcement (allowlist vs open), email validation, error states (duplicate invites, revoked acceptance, expired invites), sensitive data in logs. Write findings to logs/nightly/2026-02-10/audit-services-notifications-onboarding.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:36.793415+09:00","created_by":"Matt","updated_at":"2026-02-10T05:43:13.26194+09:00","closed_at":"2026-02-10T05:43:13.26194+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":29,"issue_id":"DRV-dpm","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/88","created_at":"2026-02-09T20:43:50Z"}]}
{"id":"DRV-drp","title":"Route: /download links to latest release APK","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Ensure the /download page always offers the latest release APK automatically, without relying on Vercel env vars for currentVersion/downloadUrl.\n\nFiles\n- Update: src/routes/download/+page.server.ts\n- Optional: src/routes/download/+page.svelte (display versionName vs code)\n\nImplementation Details\n- Replace load() to call src/lib/server/githubRelease.ts helper.\n- Return:\n  - downloadUrl = helper.downloadUrl (tag-scoped)\n  - currentVersion = helper.versionName (preferred for UI)\n- If you decide to implement /download as a redirect to the APK:\n  - Use 302/307 to helper.downloadUrl\n  - Set Cache-Control: no-store\n\nAcceptance Criteria\n- /download renders (or redirects to) a link that points to /releases/download/vX.Y.Z/...apk.\n- No per-release Vercel env updates are required.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-15T22:57:11.6738284+09:00","created_by":"Matt","updated_at":"2026-02-15T23:14:31.6602203+09:00","closed_at":"2026-02-15T23:14:31.6602203+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-drp","depends_on_id":"DRV-69n","type":"blocks","created_at":"2026-02-15T22:58:03.6599212+09:00","created_by":"unknown"}]}
{"id":"DRV-dvq","title":"Add real-DB SCH-003/SCH-004 scenarios for DST and week-boundary stability","description":"DRV-b1l.3 Audit Finding #1/#4: The scheduling matrix requires SCH-003 and SCH-004 scenarios (DST week-boundary stability, weekly-cap without cross-org counting), but these are not implemented as executable real-DB scenarios. Current DST coverage is mocked unit-level only. Add explicit real-DB SCH-003 and SCH-004 scenarios with stable IDs and deterministic evidence including Toronto DST spring/fall and week-boundary inputs. Source: logs/nightly/2026-02-18/drv-b1l.3-scheduling-and-eligibility-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:05:42.7887+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:22.1801381+09:00","closed_at":"2026-02-18T23:17:22.1801381+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","scheduling","testing-matrix"],"dependencies":[{"issue_id":"DRV-dvq","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:35.6024521+09:00","created_by":"unknown"}]}
{"id":"DRV-dyx","title":"Add manager alert to assignment cancellation","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nUpdate src/routes/api/assignments/[id]/cancel/+server.ts to send manager alert when driver cancels.\n\n## Changes\n\n### Import sendManagerAlert\n```typescript\nimport { sendManagerAlert } from \"$lib/server/services/notifications\";\n```\n\n### Send alert after cancellation\nAfter the assignment is cancelled and audit logged, send the manager alert:\n\n```typescript\n// After: await db.insert(auditLogs).values({...});\n\n// Send alert to route manager\nawait sendManagerAlert(existing.routeId, \"route_cancelled\", {\n  driverName: locals.user.name ?? \"A driver\",\n  date: existing.date,\n  routeName: routeInfo?.name  // Need to fetch route name\n});\n```\n\n### Fetch route info for alert context\nAdd to the existing query or make separate query:\n```typescript\n// Add to existing select or query separately\nconst [routeInfo] = await db\n  .select({ name: routes.name })\n  .from(routes)\n  .where(eq(routes.id, existing.routeId));\n```\n\n## Import requirements\n```typescript\nimport { assignments, auditLogs, bidWindows, routes } from \"$lib/server/db/schema\";\n```\n\n## Files to Modify\n- src/routes/api/assignments/[id]/cancel/+server.ts\n\n## Dependencies\n- DRV-ldy (sendManagerAlert function)\n\n## Acceptance Criteria\n- [ ] Alert sent when driver cancels assignment\n- [ ] Alert includes driver name, date, route name\n- [ ] Alert only goes to primary route manager\n- [ ] No error if route has no manager (graceful skip)\n- [ ] Cancellation still works if alert fails","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:25:12.0778912+09:00","created_by":"Matt","updated_at":"2026-02-04T14:25:39.7287929+09:00","closed_at":"2026-02-04T14:25:39.7287929+09:00","dependencies":[{"issue_id":"DRV-dyx","depends_on_id":"DRV-ldy","type":"blocks","created_at":"2026-02-04T11:26:55.6009743+09:00","created_by":"Matt"},{"issue_id":"DRV-dyx","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:35.6219743+09:00","created_by":"Matt"}]}
{"id":"DRV-dyz","title":"Create email sending utility with Resend","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Create #2)\n\nCreate email sending utility using Resend API.\n\nFILE TO CREATE: src/lib/server/email.ts\n\nIMPLEMENTATION:\nBased on Snapgrade pattern: C:\\Users\\matto\\projects\\Snapgrade\\src\\lib\\server\\services\\organizations\\sendInvitationEmail.ts\n\nKey function signature:\nexport async function sendPasswordResetEmail(to: string, resetUrl: string): Promise\u003cvoid\u003e\n\nREQUIRED CODE STRUCTURE:\n1. Import resetPasswordHtml from ./emails/resetPassword\n2. Import logger from ./logger\n3. Read RESEND_API_KEY from process.env\n4. If no key, log error and return (dont throw - prevents timing attacks)\n5. Replace placeholders in template:\n   - {{ handlerUrl }} -\u003e resetUrl\n   - {{ year }} -\u003e new Date().getFullYear()\n   - {{ appOrigin }} -\u003e derive from resetUrl or use env\n6. POST to https://api.resend.com/emails with:\n   - Authorization: Bearer RESEND_API_KEY\n   - Content-Type: application/json\n   - Body: { from, to, subject, html }\n7. Log success/failure with Pino logger\n\nENV VARS USED:\n- RESEND_API_KEY (required)\n- EMAIL_FROM (optional, default: Drive \u003cnoreply@yourdomain.com\u003e)\n\nACCEPTANCE CRITERIA:\n- Function doesnt throw on missing API key (logs instead)\n- Function doesnt throw on Resend failure (logs instead)\n- Placeholder replacement works correctly\n- Successful send logged with email ID\n- Failed send logged with error details","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:13:45.3741064+09:00","created_by":"Matt","updated_at":"2026-02-03T09:21:05.3489373+09:00","closed_at":"2026-02-03T09:21:05.3489373+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-dyz","depends_on_id":"DRV-b6o","type":"blocks","created_at":"2026-02-03T09:15:22.063993+09:00","created_by":"Matt"}]}
{"id":"DRV-dzxr","title":"Audit all routes for hardcoded strings / missing paraglide messages","description":"Deep audit every driver-facing and manager-facing route for hardcoded strings and missing paraglide messages, then fix them all.\n\n## Scope\n- All routes under (driver)/, (manager)/, and (app)/\n- All components imported by those routes\n- Check for any user-visible text rendered without m.xxx() calls\n\n## Deliverable\n- Replace all hardcoded strings with paraglide m.xxx() calls\n- Add missing message keys to en.json, zh.json, zh-Hant.json\n- Recompile paraglide after changes","notes":"PR: https://github.com/orro3790/drive/pull/194","status":"closed","priority":2,"issue_type":"chore","assignee":"drive","created_at":"2026-02-19T22:27:21.0867146+09:00","created_by":"Matt","updated_at":"2026-02-19T23:38:38.8945903+09:00","closed_at":"2026-02-19T23:37:24.9301987+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-dzxr.1","title":"Audit (driver) routes/components for hardcoded UI strings","status":"open","priority":2,"issue_type":"chore","created_at":"2026-02-19T23:07:24.491109+09:00","created_by":"Matt","updated_at":"2026-02-19T23:07:24.491109+09:00","labels":["nightly"],"dependencies":[{"issue_id":"DRV-dzxr.1","depends_on_id":"DRV-dzxr","type":"parent-child","created_at":"2026-02-19T23:07:24.4983931+09:00","created_by":"unknown"}]}
{"id":"DRV-dzxr.2","title":"Audit (manager) routes/components for hardcoded UI strings","status":"in_progress","priority":2,"issue_type":"chore","assignee":"drive","created_at":"2026-02-19T23:07:26.2037436+09:00","created_by":"Matt","updated_at":"2026-02-20T00:17:07.2088696+09:00","labels":["nightly"],"dependencies":[{"issue_id":"DRV-dzxr.2","depends_on_id":"DRV-dzxr","type":"parent-child","created_at":"2026-02-19T23:07:26.2081265+09:00","created_by":"unknown"}]}
{"id":"DRV-dzxr.3","title":"Audit (app) routes/components for hardcoded UI strings","notes":"PR: https://github.com/orro3790/drive/pull/194","status":"closed","priority":2,"issue_type":"chore","assignee":"drive","created_at":"2026-02-19T23:07:28.1318872+09:00","created_by":"Matt","updated_at":"2026-02-19T23:59:46.0381175+09:00","closed_at":"2026-02-19T23:59:37.9343507+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-dzxr.3","depends_on_id":"DRV-dzxr","type":"parent-child","created_at":"2026-02-19T23:07:28.1376486+09:00","created_by":"unknown"}]}
{"id":"DRV-dzxr.4","title":"Add missing Paraglide message keys and translations","notes":"PR: https://github.com/orro3790/drive/pull/195","status":"closed","priority":2,"issue_type":"chore","assignee":"drive","created_at":"2026-02-19T23:07:30.0599845+09:00","created_by":"Matt","updated_at":"2026-02-20T00:15:08.3306134+09:00","closed_at":"2026-02-20T00:14:33.2840357+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-dzxr.4","depends_on_id":"DRV-dzxr","type":"parent-child","created_at":"2026-02-19T23:07:30.0684258+09:00","created_by":"unknown"}]}
{"id":"DRV-dzxr.5","title":"Regenerate Paraglide artifacts and verify i18n coverage","notes":"Verified on branch for PR #194: Paraglide compile, pnpm check, and pnpm test passed; touched locale keys parity validated across en/zh/zh-Hant/ko.","status":"closed","priority":2,"issue_type":"chore","assignee":"drive","created_at":"2026-02-19T23:07:32.434738+09:00","created_by":"Matt","updated_at":"2026-02-19T23:47:21.9073895+09:00","closed_at":"2026-02-19T23:47:15.4721355+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-dzxr.5","depends_on_id":"DRV-dzxr","type":"parent-child","created_at":"2026-02-19T23:07:32.4445775+09:00","created_by":"unknown"}]}
{"id":"DRV-e2u","title":"Missing idempotency invariant module for integration tests","description":"tests/integration/invariants/idempotency.ts is documented in plan but not implemented. Current integration invariants only include tenant and assignment checks. Adversarial/IDEMP-* test plumbing incomplete. withScenarioEvidence exists but is unused by current integration scenarios. Source: logs/nightly/2026-02-18/drv-b1l.8-adversarial-concurrency-idempotency-scenario-pack-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:05:07.7315866+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:13.1697988+09:00","closed_at":"2026-02-19T19:54:13.1697988+09:00","close_reason":"Closed","labels":["idempotency","integration","testing"]}
{"id":"DRV-e30","title":"Preference lock cron job","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nADR: docs/adr/003-scheduling-model.md\n\n## Objective\nImplement the weekly cron job that locks preferences and triggers schedule generation.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/lock-preferences/+server.ts\n- Vercel Cron schedule: Sunday 23:59 Toronto time\n- Job sequence:\n  1. Set lockedAt timestamp on all driverPreferences for Week N+2\n  2. Call schedule generation algorithm for Week N+2\n  3. Create notifications for all drivers with new assignments\n  4. Log job completion\n\n## Spec References\n- docs/specs/SPEC.md: Lines 79-84 (Preference lock cycle)\n- docs/specs/SPEC.md: Line 293 (Cron job table entry)\n- docs/specs/SPEC.md: Lines 280-285 (In-app notifications)\n\n## Acceptance Criteria\n- Cron runs every Sunday at 23:59 Toronto time\n- All driver preferences have lockedAt set for the target week\n- Schedule generation runs automatically after lock\n- Each driver receives notification about their new assignments\n- Job is idempotent (re-running doesn't duplicate work)\n- Job execution logged for debugging\n\n## Technical Constraints\n- Use Vercel Cron syntax in vercel.json\n- Toronto timezone = America/Toronto\n- Cron endpoint must verify CRON_SECRET header (Vercel provides this)\n- Calculate Week N+2 start date from current time","notes":"PR: https://github.com/orro3790/drive/pull/15","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:24:46.2827285+09:00","created_by":"Matt","updated_at":"2026-02-04T10:01:01.6830993+09:00","closed_at":"2026-02-04T10:01:01.6830993+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-e30","depends_on_id":"DRV-4w6","type":"blocks","created_at":"2026-02-02T21:24:46.288817+09:00","created_by":"Matt"}]}
{"id":"DRV-e5g","title":"dashboardStore.completeShift optimistic rollback not race-safe","description":"dashboardStore.completeShift uses optimistic rollback without mutation-version tracking. Unlike other optimistic stores (route, warehouse, driver), there is no re-entry guard before setting isCompletingShift, allowing overlapping invocations to restore stale snapshot data over newer state. Source: logs/nightly/2026-02-18/drv-xnb.10-store-mutation-safety-and-offline-guard-parity-audit.md Finding 1","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:04:04.6934636+09:00","created_by":"Matt","updated_at":"2026-02-18T21:58:02.2252615+09:00","closed_at":"2026-02-18T21:58:02.2252615+09:00","close_reason":"Closed","labels":["concurrency","data-integrity","stores"],"dependencies":[{"issue_id":"DRV-e5g","depends_on_id":"DRV-3ads","type":"parent-child","created_at":"2026-02-18T12:48:23.2239361+09:00","created_by":"unknown"}],"comments":[{"id":64,"issue_id":"DRV-e5g","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/172","created_at":"2026-02-18T13:02:04Z"}]}
{"id":"DRV-e5n","title":"Dashboard optimistic rollback lacks mutation-version guard","description":"Dashboard optimistic complete-shift snapshot rollback has no mutation-version guard and can restore stale state if overlapping requests interleave. Source: logs/nightly/2026-02-18/drv-xnb.1 finding #8.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:02:52.6253176+09:00","created_by":"Matt","updated_at":"2026-02-18T21:06:45.227052+09:00","closed_at":"2026-02-18T21:06:45.227052+09:00","close_reason":"Closed","labels":["race-condition","rollback","stores"],"dependencies":[{"issue_id":"DRV-e5n","depends_on_id":"DRV-3ads","type":"parent-child","created_at":"2026-02-18T12:48:21.5911109+09:00","created_by":"unknown"}],"comments":[{"id":61,"issue_id":"DRV-e5n","author":"DESKTOP-V2O36N0\\matto","text":"Implemented mutation-version guard for dashboard completeShift optimistic rollback (commit fb34183). pnpm validate passes with 0 errors (warnings only). Pending browser /verify and PR submission.","created_at":"2026-02-18T12:04:21Z"},{"id":62,"issue_id":"DRV-e5n","author":"DESKTOP-V2O36N0\\matto","text":"PR opened: https://github.com/orro3790/drive/pull/169","created_at":"2026-02-18T12:04:49Z"}]}
{"id":"DRV-e6p","title":"No operational alerting for nightly integration failures","description":"No explicit Slack/PagerDuty/on-call alert step is defined in existing workflows for nightly failures. Need operational alerting with documented owner and escalation path in the runbook. Source: logs/nightly/2026-02-18/drv-b1l.10-nightly-full-integration-runs-and-artifacts-audit.md","notes":"PR: https://github.com/orro3790/drive/pull/184","status":"closed","priority":2,"issue_type":"bug","assignee":"drive","created_at":"2026-02-18T12:06:24.6410361+09:00","created_by":"Matt","updated_at":"2026-02-19T11:28:09.3006105+09:00","closed_at":"2026-02-19T11:27:34.6007739+09:00","close_reason":"Added nightly failure alert dispatch + runbook owner/escalation contract with tests","labels":["alerting","ci","nightly"]}
{"id":"DRV-ehh","title":"Audit schemas, types, and configuration","description":"Production readiness audit of all 25 files in src/lib/schemas/ and 4 files in src/lib/config/. Review for: Zod schema completeness (all fields validated with proper constraints), schema-database alignment (Zod vs Drizzle table definitions), type export consistency, dispatch policy values matching CLAUDE.md business rules, notification template completeness with proper placeholders, driver lifecycle state machine coverage, lifecycle labels for all states, missing validations (string lengths, number ranges, enums), redundant or conflicting type definitions. Write findings to logs/nightly/2026-02-10/audit-schemas-config.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:42.1440758+09:00","created_by":"Matt","updated_at":"2026-02-10T02:06:47.4056212+09:00","closed_at":"2026-02-10T02:06:47.4056212+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":21,"issue_id":"DRV-ehh","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/73","created_at":"2026-02-09T17:07:43Z"}]}
{"id":"DRV-evm","title":"Add manager alert notification types to enum","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nExtend the notificationTypeEnum to include manager alert types for route events.\n\n## Schema Change (src/lib/server/db/schema.ts)\n\n### Add to notificationTypeEnum:\nThe existing enum is:\n```typescript\nexport const notificationTypeEnum = pgEnum('notification_type', [\n  'shift_reminder',\n  'bid_open',\n  'bid_won',\n  'bid_lost',\n  'shift_cancelled',\n  'warning',\n  'manual',\n  'schedule_locked',\n  'assignment_confirmed'\n]);\n```\n\nAdd these three new values (past tense to match existing style):\n- 'route_unfilled'\n- 'route_cancelled'  \n- 'driver_no_show'\n\n### Database Migration Note\nPostgreSQL enum extension requires:\n```sql\nALTER TYPE notification_type ADD VALUE 'route_unfilled';\nALTER TYPE notification_type ADD VALUE 'route_cancelled';\nALTER TYPE notification_type ADD VALUE 'driver_no_show';\n```\n\nDrizzle's db:push should handle this, but if not, run the SQL manually.\n\n## Files to Modify\n- src/lib/server/db/schema.ts\n\n## Dependencies\n- DRV-4w0 (schema foundation must be in place)\n\n## Acceptance Criteria\n- [ ] notificationTypeEnum includes 'route_unfilled'\n- [ ] notificationTypeEnum includes 'route_cancelled'\n- [ ] notificationTypeEnum includes 'driver_no_show'\n- [ ] pnpm db:push succeeds\n- [ ] TypeScript compilation passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:23:10.7367627+09:00","created_by":"Matt","updated_at":"2026-02-04T12:34:03.1736784+09:00","closed_at":"2026-02-04T12:34:03.1736784+09:00","close_reason":"Added route_unfilled, route_cancelled, driver_no_show to notificationTypeEnum","dependencies":[{"issue_id":"DRV-evm","depends_on_id":"DRV-4w0","type":"blocks","created_at":"2026-02-04T11:25:58.3374764+09:00","created_by":"Matt"},{"issue_id":"DRV-evm","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:18.1956572+09:00","created_by":"Matt"}]}
{"id":"DRV-ext","title":"Ops: Vercel env vars for automated updater","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Perform one-time Vercel configuration so the updater can call GitHub reliably without per-release maintenance.\n\nSteps\n- In Vercel project env vars:\n  - Keep: APP_MIN_VERSION (manual knob)\n  - Add: GITHUB_TOKEN (recommended; read-only is sufficient for public repos)\n  - Remove/ignore: APP_CURRENT_VERSION, APP_DOWNLOAD_URL (no longer used)\n- Redeploy after env changes.\n\nAcceptance Criteria\n- /api/app-version continues to return the latest release values without manual updates per release.\n- GitHub rate limiting does not break /api/app-version for normal traffic.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-15T22:57:39.6890277+09:00","created_by":"Matt","updated_at":"2026-02-16T00:30:02.1684193+09:00","closed_at":"2026-02-16T00:30:02.1684193+09:00","close_reason":"Configured Vercel env vars for updater","dependencies":[{"issue_id":"DRV-ext","depends_on_id":"DRV-04g","type":"blocks","created_at":"2026-02-15T22:58:08.1423498+09:00","created_by":"unknown"},{"issue_id":"DRV-ext","depends_on_id":"DRV-drp","type":"blocks","created_at":"2026-02-15T22:58:09.5788805+09:00","created_by":"unknown"}]}
{"id":"DRV-f56","title":"Set up Vitest test runner","notes":"PR: https://github.com/orro3790/drive/pull/34","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-05T20:30:13.4613855+09:00","created_by":"Matt","updated_at":"2026-02-06T09:49:08.8870902+09:00","closed_at":"2026-02-06T09:47:23.470004+09:00","close_reason":"Closed"}
{"id":"DRV-ff4","title":"Audit driver and settings components","description":"Production readiness audit of src/lib/components/driver/HealthCard.svelte, driver/CancelShiftModal.svelte, all 6 components in settings/, and notifications/NotificationItem.svelte. Review for: HealthCard score/star/streak display accuracy and simulation preview, CancelShiftModal confirmation flow and late cancellation warning, settings form validation and save/cancel flow, NotificationItem timestamp formatting and read/unread styling, mobile UX (touch targets min 44px, scrolling, viewport fit), error states for missing/loading/failed data, reactive updates from store changes, edge cases (new driver no health data, 0 stars, long notification text). Write findings to logs/nightly/2026-02-10/audit-components-driver-settings.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:54.3815903+09:00","created_by":"Matt","updated_at":"2026-02-10T03:39:14.0718572+09:00","closed_at":"2026-02-10T03:39:14.0718572+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":24,"issue_id":"DRV-ff4","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/79","created_at":"2026-02-09T18:41:00Z"}]}
{"id":"DRV-ffj","title":"Nightly coverage docs overstate lock/auto-drop correctness","description":"nightly-e2e-coverage.md describes preference locking and 48-hour auto-drop as proven coverage, but audits report Critical defects: drv-xnb.4 shows post-lock edits still accepted, drv-xnb.2 shows DST mismatch between confirmation deadline and auto-drop cutoff. Source: logs/nightly/2026-02-18/drv-xnb.12-audit-checklist-docs-alignment-with-current-coverage.md Finding 1","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:06:03.5825171+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:37.7768829+09:00","closed_at":"2026-02-19T19:54:37.7768829+09:00","close_reason":"Closed","labels":["accuracy","documentation","testing"],"dependencies":[{"issue_id":"DRV-ffj","depends_on_id":"DRV-b0dc","type":"parent-child","created_at":"2026-02-18T12:48:38.7453647+09:00","created_by":"unknown"}]}
{"id":"DRV-gru","title":"DST drift between confirmation deadline and auto-drop cutoff","description":"Confirmation deadline uses calendar-day subtraction at 07:00 Toronto while auto-drop uses hoursUntilShift\u003c=48. Diverges by 1 hour on DST transition weeks (spring forward/fall back). Source: logs/nightly/2026-02-18/drv-xnb.2 finding #1, drv-xnb.1 finding #2.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:00:41.4338417+09:00","created_by":"Matt","updated_at":"2026-02-18T12:56:04.337658+09:00","closed_at":"2026-02-18T12:56:04.337658+09:00","close_reason":"Closed","labels":["auto-drop","confirmations","dst","scheduling"],"dependencies":[{"issue_id":"DRV-gru","depends_on_id":"DRV-szo5","type":"parent-child","created_at":"2026-02-18T12:46:38.5068648+09:00","created_by":"unknown"}]}
{"id":"DRV-hao","title":"Audit shift lifecycle API endpoints","description":"Production readiness audit of src/routes/api/shifts/ — arrive, start, complete, and [assignmentId]/edit endpoints. Review for: auth (authenticated + correct driver), Zod input validation, arrive 9 AM deadline enforcement and duplicate prevention, start parcelsStart validation (positive integer, must be after arrival), complete parcelsReturned validation and 1-hour edit window calculation, edit window enforcement and parcel count validation, HTTP status code correctness (400/401/403/404/409), consistent error/success response shapes. Write findings to logs/nightly/2026-02-10/audit-api-shifts.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/78","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:29:55.368266+09:00","created_by":"Matt","updated_at":"2026-02-10T03:28:14.1788049+09:00","closed_at":"2026-02-10T03:27:09.408956+09:00","close_reason":"Closed","labels":["nightly"]}
{"id":"DRV-heg","title":"Verify Android push notifications end-to-end (native APK)","description":"Objective: validate push notifications work on a real Android device using the signed APK + production backend.\n\nChecklist:\n- Install latest APK via /download.\n- Ensure notification permission prompt is user-initiated (Android 13+).\n- Confirm device obtains FCM token and POSTs it to /api/users/fcm-token (200).\n- Send a test push to the device token (Firebase Console or server path) and confirm it is received.\n- Confirm tapping a notification opens the app (and navigates reasonably).\n\nAcceptance:\n- Token registration succeeds and can be repeated on app reopen.\n- Test push is received on device.\n- No UI overlap with system status/nav bars during test.\n","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-16T11:13:48.2105419+09:00","created_by":"Matt","updated_at":"2026-02-16T11:13:55.9917648+09:00","labels":["mobile","notifications","verification"],"dependencies":[{"issue_id":"DRV-heg","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-16T11:13:48.2316762+09:00","created_by":"unknown"},{"issue_id":"DRV-heg","depends_on_id":"DRV-mzp","type":"blocks","created_at":"2026-02-16T11:13:48.2460547+09:00","created_by":"unknown"}]}
{"id":"DRV-heg.1","title":"Push E2E smoke run (single device)","description":"Source: documentation/testing/push-notification-checklist.md (Single-Device Execution Mode, One-Device Smoke Run)\n\nObjective\n- Execute the four-case smoke run with one physical Android device and desktop actor sessions to prove end-to-end trigger -\u003e in-app record -\u003e push delivery -\u003e tap behavior.\n\nImplementation Details\n- Use one phone and two desktop sessions (manager + driver).\n- Keep phone logged into expected recipient account for each case.\n- Run smoke cases in order:\n  1) shift_reminder (recipient=driver, trigger=cron)\n  2) bid_won (recipient=driver, trigger=bid resolution)\n  3) driver_no_show (recipient=manager, trigger=no-show detection)\n  4) return_exception (recipient=manager, trigger=shift completion with excepted returns \u003e 0)\n- For each case capture evidence:\n  - Android tray screenshot\n  - In-app notifications screen screenshot\n  - Tap result screenshot/notes\n\nDependencies\n- Requires DRV-69a and DRV-mzp (already linked through DRV-heg parent).\n\nAcceptance Criteria\n- All four smoke cases pass with evidence artifacts captured.\n- Each case confirms all three surfaces: push tray, in-app record, tap behavior.\n- Non-recipient account does not receive notification in each case.\n\nTechnical Constraints\n- No mocked push events. Use real domain triggers and real FCM delivery.\n- Cron calls must use Authorization: Bearer \u003cCRON_SECRET\u003e.\n- Keep test data isolated to one organization.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-16T11:59:44.4677999+09:00","created_by":"Matt","updated_at":"2026-02-16T12:00:16.3843774+09:00","labels":["mobile","notifications","verification"],"dependencies":[{"issue_id":"DRV-heg.1","depends_on_id":"DRV-heg","type":"parent-child","created_at":"2026-02-16T11:59:44.4732708+09:00","created_by":"unknown"}]}
{"id":"DRV-heg.2","title":"Push E2E full matrix pass (single device actor model)","description":"Source: documentation/testing/push-notification-checklist.md (Full Test Suite, Summary Table - Single-Device Actor Matrix)\n\nObjective\n- Execute the complete notification matrix using one-device recipient switching and desktop trigger actors, validating recipient correctness for all implemented notification types.\n\nImplementation Details\n- Use the matrix in the checklist and run every implemented type end-to-end.\n- For each type validate:\n  - expected recipient(s) receive push + in-app record\n  - non-recipient(s) do not receive\n  - notification copy/title/body match event context\n  - tapping notification opens expected destination\n- Group runs to reduce setup churn:\n  - Driver-recipient block (phone logged in as driver)\n  - Manager-recipient block (phone logged in as manager)\n  - Cron-driven block (authorized cron invocation with CRON_SECRET)\n\nDependencies\n- Depends on DRV-heg.1 smoke run completion.\n\nAcceptance Criteria\n- Full checklist executed for all currently implemented notification dispatch paths.\n- Pass/fail report recorded with per-type evidence and defect notes.\n- Any failed cases include reproducible steps and owner assignment suggestions.\n\nTechnical Constraints\n- Do not count Firebase Console raw test send as feature coverage (infra sanity only).\n- No mocks; only real triggers from routes/services/cron.\n- Keep verification in production-safe test data scope.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-16T11:59:59.0892267+09:00","created_by":"Matt","updated_at":"2026-02-16T11:59:59.0892267+09:00","labels":["mobile","notifications","verification"],"dependencies":[{"issue_id":"DRV-heg.2","depends_on_id":"DRV-heg","type":"parent-child","created_at":"2026-02-16T11:59:59.0941218+09:00","created_by":"unknown"},{"issue_id":"DRV-heg.2","depends_on_id":"DRV-heg.1","type":"blocks","created_at":"2026-02-16T11:59:59.1113364+09:00","created_by":"unknown"}]}
{"id":"DRV-heg.3","title":"Notification dispatch gap audit + follow-up beads","description":"Source: documentation/testing/push-notification-checklist.md (Summary Table rows marked TBD, troubleshooting outcomes)\n\nObjective\n- Identify notification types present in schema/templates that are not currently dispatched by any runtime trigger, and convert each confirmed gap into actionable implementation beads.\n\nImplementation Details\n- Build dispatch map: notification type -\u003e trigger path -\u003e source file -\u003e actor -\u003e recipient.\n- Confirm current TBD candidates (e.g., shift_cancelled, manual) and any additional gaps discovered during DRV-heg.2 execution.\n- For each gap, create a new implementation bead with:\n  - explicit trigger source\n  - recipient contract\n  - payload/title/body requirements\n  - acceptance tests (push + in-app + tap)\n\nDependencies\n- Depends on DRV-heg.2 to incorporate real execution findings.\n\nAcceptance Criteria\n- Dispatch map is complete and stored in checklist/docs notes.\n- Every confirmed gap has a dedicated implementation bead with source traceability.\n- No notification type remains in ambiguous \"TBD\" state without owner/action.\n\nTechnical Constraints\n- Audit must be code-backed (routes/services/cron), not assumption-based.\n- Follow-up beads must be P0 if blocking E2E sign-off; otherwise justify lower priority explicitly.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-16T12:00:09.1614531+09:00","created_by":"Matt","updated_at":"2026-02-16T12:00:09.1614531+09:00","labels":["notifications","triage","verification"],"dependencies":[{"issue_id":"DRV-heg.3","depends_on_id":"DRV-heg","type":"parent-child","created_at":"2026-02-16T12:00:09.168124+09:00","created_by":"unknown"},{"issue_id":"DRV-heg.3","depends_on_id":"DRV-heg.2","type":"blocks","created_at":"2026-02-16T12:00:09.1855719+09:00","created_by":"unknown"}]}
{"id":"DRV-hfh","title":"nightly: display shift start time in UI + notifications","description":"We currently show shift *date* in schedule/dashboard/bids and show notification createdAt as relative time, but we do not display the shift's scheduled start time (route start time) consistently.\n\nGoal: surface route start time (e.g. \"9:00 AM\") alongside shift date in shift cards and include shift date/time context in shift-related notifications (in-app + push templates).","acceptance_criteria":"Drivers can see shift start time on their schedule/dashboard/bids; shift-related notifications include shift date/time context; formatting is consistent (12h w/ minutes).","notes":"Push notifications are being verified live; nightly epic remains for shift start-time content improvements.","status":"closed","priority":2,"issue_type":"epic","assignee":"drive","created_at":"2026-02-15T01:27:04.8382921+09:00","created_by":"Matt","updated_at":"2026-02-19T12:22:31.001476+09:00","closed_at":"2026-02-19T12:20:31.2373936+09:00","close_reason":"Closed","external_ref":"https://github.com/orro3790/drive/pull/186","labels":["nightly"]}
{"id":"DRV-hfh.1","title":"UI: show route start time on schedule + dashboard shift cards","description":"Add shift start time to driver-facing shift cards.\n\nContext:\n- Schedule currently renders date via formatAssignmentDate(date) only.\n- Dashboard (today shift + lists) also renders date only.\n- Both stores already include routeStartTime.\n\nImplementation sketch:\n- Add a small helper in src/lib/utils/date/formatting.ts to format a \"HH:mm\" time string to a user-friendly \"h:mm a\" label.\n- Render the time next to the date (e.g., \"Mon, Feb 10 • 9:00 AM\") in:\n  - src/routes/(driver)/schedule/+page.svelte\n  - src/routes/(driver)/dashboard/+page.svelte","acceptance_criteria":"Schedule items show date + start time; Dashboard today shift shows date + start time; no visual regressions; works for 09:00 and 09:30 values.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","estimated_minutes":90,"created_at":"2026-02-15T01:27:06.0789172+09:00","created_by":"Matt","updated_at":"2026-02-19T10:01:42.5712152+09:00","closed_at":"2026-02-19T10:01:42.5712152+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-hfh.1","depends_on_id":"DRV-hfh","type":"parent-child","created_at":"2026-02-15T01:27:06.0849978+09:00","created_by":"unknown"}],"comments":[{"id":71,"issue_id":"DRV-hfh.1","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/181","created_at":"2026-02-19T01:02:17Z"}]}
{"id":"DRV-hfh.2","title":"API+UI: include route start time in bids lists","description":"Available bids and my bids currently show assignment date only.\n\nAdd routeStartTime to bid window/bid payloads and render it in the bids UI.\n\nLikely touchpoints:\n- src/routes/api/bids/available/+server.ts (select routes.startTime)\n- src/lib/stores/bidsStore.svelte.ts schema/types (add routeStartTime)\n- src/routes/(driver)/bids/+page.svelte (render time next to assignmentDate)","acceptance_criteria":"Bids UI shows shift date + start time for each window/bid; API response includes routeStartTime; zod schemas updated.","notes":"PR: https://github.com/orro3790/drive/pull/180","status":"closed","priority":3,"issue_type":"task","assignee":"drive","estimated_minutes":60,"created_at":"2026-02-15T01:27:07.5182238+09:00","created_by":"Matt","updated_at":"2026-02-19T09:45:17.7180995+09:00","closed_at":"2026-02-19T09:44:45.2192424+09:00","close_reason":"Closed","labels":["nightly"],"dependencies":[{"issue_id":"DRV-hfh.2","depends_on_id":"DRV-hfh","type":"parent-child","created_at":"2026-02-15T01:27:07.5241975+09:00","created_by":"unknown"}]}
{"id":"DRV-hfh.3","title":"Notifications: include shift date/time context (in-app + push)","description":"Shift-related notifications currently have generic title/body and the in-app inbox only shows relative createdAt. Add shift date/time context.\n\nImplementation sketch:\n- For shift-related notification types (at least: assignment_confirmed, shift_reminder, bid_won, shift_auto_dropped; maybe bid_open/emergency_route_available):\n  - include assignmentDate + routeStartTime in notifications.data (strings)\n  - update title/body templates in src/lib/server/services/notifications.ts to include something like \"Mon, Feb 10 at 9:00 AM\".\n- In UI (src/lib/components/notifications/NotificationItem.svelte): if notification.data has assignmentDate/routeStartTime, render a small chip/label under the title (or in metadata chips).\n- Add/update server unit tests in tests/server/notificationsService.test.ts to assert inserted notification includes the new data fields when sending shift-related notifications.","acceptance_criteria":"In-app notifications show shift date/time when present; push payload title/body includes shift date/time; tests cover at least one shift-related type producing the correct inserted data.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","estimated_minutes":120,"created_at":"2026-02-15T01:27:08.9544131+09:00","created_by":"Matt","updated_at":"2026-02-19T10:56:06.8470657+09:00","closed_at":"2026-02-19T10:55:32.9692552+09:00","close_reason":"Closed","external_ref":"https://github.com/orro3790/drive/pull/182","labels":["nightly"],"dependencies":[{"issue_id":"DRV-hfh.3","depends_on_id":"DRV-hfh","type":"parent-child","created_at":"2026-02-15T01:27:08.9594198+09:00","created_by":"unknown"}]}
{"id":"DRV-hvl","title":"data-loaded can report ready before first fetch completes (determinism risk)","description":"Stores initialize loading state to false. Pages expose data-loaded directly from isLoading. Witness runner treats data-loaded=true as readiness and immediately asserts row existence. On first render, data-loaded may transiently be true before onMount kicks off fetch, causing race-prone PASS/FAIL outcomes. Affects notifications and schedule pages. Source: logs/nightly/2026-02-18/drv-b1l.12-agent-browser-witness-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:06:59.5993985+09:00","created_by":"Matt","updated_at":"2026-02-18T23:06:36.6155402+09:00","closed_at":"2026-02-18T23:06:36.6155402+09:00","close_reason":"Fixed and merged in PR #175","labels":["determinism","ui","witness"],"dependencies":[{"issue_id":"DRV-hvl","depends_on_id":"DRV-bjka","type":"parent-child","created_at":"2026-02-18T12:48:08.0141122+09:00","created_by":"unknown"}],"comments":[{"id":68,"issue_id":"DRV-hvl","author":"DESKTOP-V2O36N0\\matto","text":"Merged in PR #175: https://github.com/orro3790/drive/pull/175. Schedule/notifications now expose data-loaded only after first load completes via hasLoaded state, with store regression tests.","created_at":"2026-02-18T14:06:35Z"}]}
{"id":"DRV-hzd3","title":"Auto-drop side-effect coupling non-atomic under partial failures","description":"createBidWindow can unfill assignment and write audit before bid-window insert. Insert failure path returns unsuccessful after earlier mutations. Post-insert fanout is on main path. Need durable-core transaction (window + assignment/audit consistency) plus best-effort fanout that cannot invalidate durable success. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.1 and drv-xnb.3 audits)","notes":"PR: https://github.com/orro3790/drive/pull/163","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:10:05.9563696+09:00","created_by":"Matt","updated_at":"2026-02-18T19:31:19.0133976+09:00","closed_at":"2026-02-18T19:30:49.1917892+09:00","close_reason":"Closed","labels":["auto-drop","bidding","critical"],"dependencies":[{"issue_id":"DRV-hzd3","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:47.6049982+09:00","created_by":"unknown"}]}
{"id":"DRV-i29","title":"Nightly full integration artifacts not uploaded to GitHub Actions","description":"PR smoke uploads artifacts on failure, but there is no GitHub Actions workflow that uploads nightly full diagnostics artifacts (vitest logs, scenario/invariant report JSON, tests/integration/.evidence/** bundles). Local drill scripts write to logs/nightly/\u003cdate\u003e but these are not captured in CI. Source: logs/nightly/2026-02-18/drv-b1l.10-nightly-full-integration-runs-and-artifacts-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:05:57.3226562+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:11.3353135+09:00","closed_at":"2026-02-19T19:54:11.3353135+09:00","close_reason":"Closed","labels":["artifacts","ci","integration"]}
{"id":"DRV-ircv","title":"Add cross-tenant non-interference assertions for no-show artifacts","description":"DRV-b1l.5 Audit Finding #5: Cross-tenant assertions exist, but not yet as complete non-interference proofs for all no-show artifacts. NOS-003 asserts expected notification recipients and runs a notification leakage invariant, but nightly no-show checks are mostly org-A-scoped counters without explicit org-B non-interference assertions for windows/alerts/fanout. Add explicit cross-tenant non-interference invariants in the no-show section (org-B unaffected counts for bid_windows and notifications). Expand no-show fanout assertions to prove org-scoped recipient sets including negative assertions for org-B users. Source: logs/nightly/2026-02-18/drv-b1l.5-no-show-and-emergency-reassignment-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:10:10.6838348+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:23.3620263+09:00","closed_at":"2026-02-18T23:17:23.3620263+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","multi-tenant","no-show"],"dependencies":[{"issue_id":"DRV-ircv","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:47.9142779+09:00","created_by":"unknown"}]}
{"id":"DRV-iwbn","title":"Bulk notification observability overcounts success, hides delivery quality","description":"sendBulkNotifications emits no aggregate telemetry. Callers treat Map.size as success count but it only reflects attempted recipients. Cron counters increment 'sent' when sendNotification resolves even when push fails. pushError is not consumed for aggregation/alerting. Source: logs/nightly/2026-02-18/drv-xnb.8-notification-reliability-and-fcm-error-taxonomy-audit.md Finding #3","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:15.2351495+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:18.257249+09:00","closed_at":"2026-02-18T22:55:18.257249+09:00","close_reason":"Covered by DRV-vii implementation (PR #168): FCM taxonomy, terminal token cleanup, and aggregate reliability counters added.","labels":["metrics","notifications","observability"],"dependencies":[{"issue_id":"DRV-iwbn","depends_on_id":"DRV-1sft","type":"parent-child","created_at":"2026-02-18T12:47:21.9158887+09:00","created_by":"unknown"}]}
{"id":"DRV-jfw","title":"Route: /download links to latest release APK","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Ensure the /download page always offers the latest release APK automatically, without relying on Vercel env vars for currentVersion/downloadUrl.\n\nFiles\n- Update: src/routes/download/+page.server.ts\n- (Optional) Update: src/routes/download/+page.svelte to display versionName instead of numeric versionCode.\n\nImplementation Details\n- Replace load() to call src/lib/server/githubRelease.ts helper.\n- Set:\n  - downloadUrl = helper.downloadUrl (tag-scoped)\n  - currentVersion = helper.versionName (preferred for UI) OR helper.versionCode if the message expects a number.\n- If you decide to implement /download as a redirect to the APK:\n  - Use 302/307 to helper.downloadUrl\n  - Set Cache-Control: no-store\n\nDependencies\n- Depends on: Server helper.\n\nAcceptance Criteria\n- /download renders a download link that points to /releases/download/vX.Y.Z/...apk.\n- No per-release Vercel env updates are required.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-15T22:56:15.2717078+09:00","created_by":"Matt","updated_at":"2026-02-19T19:44:22.8296719+09:00","closed_at":"2026-02-19T19:44:22.8296719+09:00","close_reason":"Closed"}
{"id":"DRV-jnk","title":"Driver dashboard","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\n\n## Objective\nImplement the driver's main dashboard showing today's shift, schedule overview, metrics, and pending bids.\n\n## Scope\n- UI page at src/routes/(app)/+page.svelte\n- Sections:\n  1. Today's shift card (if any): route, warehouse, start/complete buttons\n  2. This week schedule summary\n  3. Next week schedule summary\n  4. Personal metrics: attendance rate, completion rate\n  5. Pending bids: list of open bids with countdown\n- New driver banner: \"Your first scheduled shifts will appear in ~2 weeks\"\n\n## Spec References\n- docs/specs/SPEC.md: Line 236 (Dashboard route description)\n- docs/specs/SPEC.md: Lines 94-98 (New driver handling)\n- docs/specs/SPEC.md: Lines 187-193 (Metrics display)\n\n## Acceptance Criteria\n- Dashboard loads user's assignments, metrics, pending bids\n- Today's shift prominently displayed with action buttons\n- Week summaries show assigned days\n- Metrics displayed as percentages\n- Pending bids show route and time until window closes\n- New drivers (no scheduled shifts) see explanation banner\n- Mobile-first responsive design\n\n## Technical Constraints\n- Aggregate data from assignments, driverMetrics, bids tables\n- Toronto timezone for \"today\" calculation\n- Consider data loading strategy (parallel fetches)\n- Use existing primitives (Chip for status, Card patterns from design system)","notes":"PR: https://github.com/orro3790/drive/pull/10","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:29:34.8954746+09:00","created_by":"Matt","updated_at":"2026-02-03T21:35:14.4298026+09:00","closed_at":"2026-02-03T21:35:14.4298026+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-jnk","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:29:34.9005988+09:00","created_by":"Matt"},{"issue_id":"DRV-jnk","depends_on_id":"DRV-vth","type":"blocks","created_at":"2026-02-02T21:29:34.9061025+09:00","created_by":"Matt"}]}
{"id":"DRV-jwl","title":"Spec: Android update pipeline contract","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Treat ralph/plans/MOB-android-update-pipeline.md as the canonical contract for Android update discovery.\n- Ensure the policy choices are explicit and stable (no prereleases, versionCode scheme, asset selection, caching, fallback).\n\nImplementation Details\n- Review/update ralph/plans/MOB-android-update-pipeline.md to ensure it includes:\n  - Prerelease policy: stable releases only via GitHub /releases/latest.\n  - Tag parsing rules: accept vX.Y.Z or X.Y.Z only.\n  - versionCode formula: major*10000 + minor*100 + patch; constraints documented.\n  - Deterministic asset selection priority.\n  - /api/app-version contract: JSON shape + caching headers.\n  - /download contract: must point to tag-scoped URL; if redirect, no-store.\n  - GitHub request headers + timeout + optional GITHUB_TOKEN.\n  - Fallback rules: last-known-good cache, else 503 with Retry-After.\n  - CI requirement: verify APK embedded versionName/versionCode matches tag.\n\nAcceptance Criteria\n- ralph/plans/MOB-android-update-pipeline.md exists and is accurate.\n- All implementation beads reference this doc as Source.","notes":"PR: https://github.com/orro3790/drive/pull/179","status":"closed","priority":1,"issue_type":"chore","assignee":"drive","created_at":"2026-02-15T22:56:33.221314+09:00","created_by":"Matt","updated_at":"2026-02-19T00:11:00.802461+09:00","closed_at":"2026-02-19T00:10:36.568631+09:00","close_reason":"Closed"}
{"id":"DRV-kcu","title":"Comprehensive automated tests for services, stores, and APIs","description":"Build deterministic, high-value automated coverage for core domain services, stores, and route API contracts.","acceptance_criteria":"Critical service, API, and store behavior is covered by deterministic tests with enforced coverage gates.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-07T17:05:06.1663432+09:00","created_by":"Matt","updated_at":"2026-02-09T21:31:52.0090643+09:00","closed_at":"2026-02-09T21:31:52.0090643+09:00","close_reason":"All child tasks DRV-kcu.1 through DRV-kcu.4 are completed and acceptance criteria for deterministic services, API, and store coverage with enforced gates are met.","dependencies":[{"issue_id":"DRV-kcu","depends_on_id":"DRV-uoh","type":"blocks","created_at":"2026-02-07T17:06:33.7875848+09:00","created_by":"Matt"}]}
{"id":"DRV-kcu.1","title":"Build shared Vitest harness for deterministic domain tests","description":"Add reusable helpers for fake time, request event builders, and service boundary mocks.","acceptance_criteria":"New tests share deterministic harness utilities and avoid timing and random flakiness.","notes":"Verified shared Vitest harness is in place: tests/harness/time.ts (fake time control), tests/harness/requestEvent.ts (request event builders), and tests/harness/serviceMocks.ts (service boundary mocks). Confirmed downstream adoption across server API/service tests and re-ran pnpm test + pnpm validate successfully.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:02.6486201+09:00","created_by":"Matt","updated_at":"2026-02-09T19:32:22.5279128+09:00","closed_at":"2026-02-09T19:32:22.5279128+09:00","close_reason":"Completed deterministic harness utilities and validation","dependencies":[{"issue_id":"DRV-kcu.1","depends_on_id":"DRV-kcu","type":"parent-child","created_at":"2026-02-07T17:06:02.6526025+09:00","created_by":"Matt"}]}
{"id":"DRV-kcu.2","title":"Add service-level tests for lifecycle and bidding core","description":"Cover high-risk service logic for bidding, confirmations, no-show, assignments, and scheduling boundaries.","acceptance_criteria":"Boundary and failure-mode service tests protect critical lifecycle and bidding decisions.","notes":"Implemented deterministic service-level regression coverage across core lifecycle/bidding boundaries: added bidding service failure-path tests (missing assignment, duplicate open window, past-shift guard, scoped expired-window queries, instant-assign conflict fallback), confirmation service tests (window math, missing assignment, deadline guard, success writes + audit, unconfirmed filtering), scheduling service tests (Toronto week-start normalization, count fallback, cap/flag gating), and assignment service tests for manual assignment decisions (not found, forbidden warehouse scope, non-unfilled rejection, weekly-cap rejection, successful assignment with bid-resolution notifications). Validation: pnpm test (99 passing) and pnpm validate pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:03.2589626+09:00","created_by":"Matt","updated_at":"2026-02-09T20:08:15.8035202+09:00","closed_at":"2026-02-09T20:08:15.8035202+09:00","close_reason":"Completed service-level lifecycle and bidding boundary test coverage","dependencies":[{"issue_id":"DRV-kcu.2","depends_on_id":"DRV-kcu","type":"parent-child","created_at":"2026-02-07T17:06:03.2622455+09:00","created_by":"Matt"},{"issue_id":"DRV-kcu.2","depends_on_id":"DRV-kcu.1","type":"blocks","created_at":"2026-02-07T17:06:46.0939447+09:00","created_by":"Matt"}]}
{"id":"DRV-kcu.3","title":"Add API contract tests for driver and cron endpoints","description":"Add auth, validation, status code, and payload contract tests for driver lifecycle and cron APIs.","acceptance_criteria":"API contract tests verify expected success and failure responses and prevent handler regressions.","notes":"Source: ralph/plans/DRV-kcu.3.md. Implemented 10 API contract suites for driver lifecycle and cron endpoints. Validation passed: targeted vitest, pnpm test, pnpm validate.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:03.9100518+09:00","created_by":"Matt","updated_at":"2026-02-09T21:08:23.9022632+09:00","closed_at":"2026-02-09T21:08:23.9022632+09:00","close_reason":"Implemented full API contract suite coverage for driver lifecycle and cron endpoints; all tests and validate pass","dependencies":[{"issue_id":"DRV-kcu.3","depends_on_id":"DRV-kcu","type":"parent-child","created_at":"2026-02-07T17:06:03.9146362+09:00","created_by":"Matt"},{"issue_id":"DRV-kcu.3","depends_on_id":"DRV-kcu.1","type":"blocks","created_at":"2026-02-07T17:06:46.7509794+09:00","created_by":"Matt"}]}
{"id":"DRV-kcu.4","title":"Add store behavior suites and enforce coverage gates","description":"Add deterministic store behavior tests and enforce coverage thresholds for target domains in quality gates.","acceptance_criteria":"Store tests cover optimistic and error paths and coverage thresholds are enforced in CI.","notes":"Implemented deterministic store behavior coverage for routeStore and warehouseStore with 16 optimistic/error-path tests. Added Vitest coverage gating for those store files (per-file thresholds), introduced test:coverage script + @vitest/coverage-v8, and added CI workflow to run validate + coverage on pull requests and main pushes. Validation: pnpm validate and pnpm test:coverage both pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:04.5488389+09:00","created_by":"Matt","updated_at":"2026-02-09T21:31:39.7689561+09:00","closed_at":"2026-02-09T21:31:39.7689561+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-kcu.4","depends_on_id":"DRV-kcu","type":"parent-child","created_at":"2026-02-07T17:06:04.5611011+09:00","created_by":"Matt"},{"issue_id":"DRV-kcu.4","depends_on_id":"DRV-kcu.2","type":"blocks","created_at":"2026-02-07T17:06:47.3972032+09:00","created_by":"Matt"},{"issue_id":"DRV-kcu.4","depends_on_id":"DRV-kcu.3","type":"blocks","created_at":"2026-02-07T17:06:48.0578791+09:00","created_by":"Matt"}]}
{"id":"DRV-l46","title":"Missing DST transition tests for auto-drop cron","description":"Auto-drop tests do not cover DST edge dates. Need tests for spring-forward and fall-back shift dates at deadline -1s, deadline, and deadline +1s. Source: logs/nightly/2026-02-18/drv-xnb.2 finding #1.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:04:27.4710564+09:00","created_by":"Matt","updated_at":"2026-02-18T12:04:27.4710564+09:00","labels":["auto-drop","dst","testing"]}
{"id":"DRV-ldy","title":"Add sendManagerAlert to notification service","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nExtend src/lib/server/services/notifications.ts with manager alert functionality.\n\n## Changes to src/lib/server/services/notifications.ts\n\n### 1. Update NotificationType\nAdd to the type union:\n- route_unfilled\n- route_cancelled\n- driver_no_show\n\n### 2. Update NOTIFICATION_TEMPLATES\nAdd templates for new types:\n```typescript\nroute_unfilled: {\n  title: \"Route Unfilled\",\n  body: \"A route at your warehouse has no driver assigned.\"\n},\nroute_cancelled: {\n  title: \"Driver Cancelled\",\n  body: \"A driver has cancelled their assignment.\"\n},\ndriver_no_show: {\n  title: \"Driver No-Show\",\n  body: \"A driver did not show up for their assigned shift.\"\n}\n```\n\n### 3. Add sendManagerAlert function\n```typescript\nimport { getRouteManager } from \"./managers\";\n\nexport type ManagerAlertType = \"route_unfilled\" | \"route_cancelled\" | \"driver_no_show\";\n\ninterface AlertDetails {\n  routeName?: string;\n  driverName?: string;\n  date?: string;\n  warehouseName?: string;\n}\n\n/**\n * Send alert notification to the primary manager of a route.\n * \n * @param routeId - The route UUID to look up manager\n * @param alertType - Type of alert to send\n * @param details - Additional context for the notification body\n * @returns true if notification sent, false if no manager assigned\n */\nexport async function sendManagerAlert(\n  routeId: string,\n  alertType: ManagerAlertType,\n  details: AlertDetails = {}\n): Promise\u003cboolean\u003e {\n  const log = logger.child({ operation: \"sendManagerAlert\", routeId, alertType });\n  \n  const managerId = await getRouteManager(routeId);\n  if (\\!managerId) {\n    log.warn(\"No manager assigned to route, skipping alert\");\n    return false;\n  }\n  \n  const template = NOTIFICATION_TEMPLATES[alertType];\n  \n  // Customize body with details\n  let body = template.body;\n  if (details.routeName) {\n    body = body.replace(\"A route\", `Route ${details.routeName}`);\n  }\n  if (details.driverName) {\n    body = body.replace(\"A driver\", details.driverName);\n  }\n  if (details.date) {\n    body += ` (${details.date})`;\n  }\n  \n  await sendNotification(managerId, alertType, {\n    title: template.title,\n    body,\n    data: { routeId, ...details }\n  });\n  \n  log.info({ managerId }, \"Manager alert sent\");\n  return true;\n}\n```\n\n## Dependencies\n- DRV-evm (notification enum types)\n- DRV-4jy (manager access service for getRouteManager)\n\n## Acceptance Criteria\n- [ ] sendManagerAlert function exported\n- [ ] Function looks up manager from route\n- [ ] Returns false if no manager assigned (no crash)\n- [ ] Notification created in database\n- [ ] Push notification sent if manager has FCM token\n- [ ] Logger captures operation details","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:23:55.5797731+09:00","created_by":"Matt","updated_at":"2026-02-04T14:12:18.4608326+09:00","closed_at":"2026-02-04T14:12:18.4608326+09:00","dependencies":[{"issue_id":"DRV-ldy","depends_on_id":"DRV-evm","type":"blocks","created_at":"2026-02-04T11:26:18.2210544+09:00","created_by":"Matt"},{"issue_id":"DRV-ldy","depends_on_id":"DRV-4jy","type":"blocks","created_at":"2026-02-04T11:26:21.5170111+09:00","created_by":"Matt"},{"issue_id":"DRV-ldy","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:26.4856371+09:00","created_by":"Matt"}]}
{"id":"DRV-lne2","title":"Add TENANT-* assertions to API-001 and all API/UI scenarios","description":"DRV-b1l.6 Audit Finding #5: Explicit cross-tenant non-interference assertions are not present for API/UI journeys as currently implemented. Reusable tenant invariants exist and are used in bidding smoke, but API-001 does not invoke tenant invariant helpers. Require explicit TENANT-*/non-interference assertions in every API-* and UI-* scenario (positive in-org behavior plus negative cross-org proof). Source: logs/nightly/2026-02-18/drv-b1l.6-api-and-critical-ui-multi-tenant-journeys-audit.md","notes":"Implemented in PR #177: added TENANT non-interference assertions across API-001/API-002 and new Playwright UI journeys with explicit tenant leakage checks.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:51.7723649+09:00","created_by":"Matt","updated_at":"2026-02-18T23:33:40.0233597+09:00","closed_at":"2026-02-18T23:33:40.0233597+09:00","close_reason":"Completed in merged PR #177","labels":["api","e2e-testing","multi-tenant","ui"],"dependencies":[{"issue_id":"DRV-lne2","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:52.8713358+09:00","created_by":"unknown"}]}
{"id":"DRV-lvao","title":"Nightly 2026-02-18: E2E Testing Matrix Gaps","description":"Parent epic for E2E testing matrix gap findings from nightly audit 2026-02-18. High: missing real-DB scenarios for scheduling, health, no-show, API, UI journeys.","notes":"All 11 children completed; final API/UI matrix work landed in merged PR #177.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-18T12:45:20.5377363+09:00","created_by":"Matt","updated_at":"2026-02-18T23:33:57.2535928+09:00","closed_at":"2026-02-18T23:33:57.2535928+09:00","close_reason":"All child beads complete; epic delivered via merged PR #177","labels":["e2e-testing","nightly-audit","testing-matrix"]}
{"id":"DRV-lwg","title":"Hardening, quality gates, and release readiness","description":"Finalize security, reliability, observability, and release process gates so the driver initiative is ready for handoff and production.","acceptance_criteria":"All quality gates pass, hardening checks are complete, and rollout and rollback playbooks are documented.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-07T17:05:06.7202636+09:00","created_by":"Matt","updated_at":"2026-02-07T17:05:06.7202636+09:00","dependencies":[{"issue_id":"DRV-lwg","depends_on_id":"DRV-v83","type":"blocks","created_at":"2026-02-07T17:06:34.4350513+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg","depends_on_id":"DRV-kcu","type":"blocks","created_at":"2026-02-07T17:06:35.1848322+09:00","created_by":"Matt"}]}
{"id":"DRV-lwg.1","title":"Security and privacy hardening pass","description":"Audit auth and validation boundaries and remove sensitive identifier logging from server paths.","acceptance_criteria":"Sensitive data is no longer logged in plaintext and auth and role checks are consistently enforced.","notes":"Completed DRV-lwg.1 hardening pass: added strict param/body/query validation for warehouse, emergency-reopen, bids, and bid-window endpoints (including malformed JSON handling); enforced manager warehouse scoping for /api/bid-windows event-driven resolution; fixed manager-only role gate for emergency reopen; removed plaintext identifier logging and replaced raw error object logging with safe categories/types; added global Pino redaction for sensitive identifiers/tokens/IP/email fields. Verification: pnpm lint, pnpm check, pnpm test, pnpm build all pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:11.9723522+09:00","created_by":"Matt","updated_at":"2026-02-09T18:08:43.3687115+09:00","closed_at":"2026-02-09T18:08:43.3687115+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-lwg.1","depends_on_id":"DRV-lwg","type":"parent-child","created_at":"2026-02-07T17:06:11.9772087+09:00","created_by":"Matt"}]}
{"id":"DRV-lwg.2","title":"Reliability hardening for cron and mutation paths","description":"Improve idempotency, failure handling, and observability around cron jobs and critical mutation endpoints.","acceptance_criteria":"Cron and mutation flows handle failures predictably with actionable telemetry and safe retries.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:12.5963797+09:00","created_by":"Matt","updated_at":"2026-02-18T15:39:15.9408429+09:00","closed_at":"2026-02-18T15:39:15.9408429+09:00","close_reason":"Completed: hardened cron failure isolation and cancellation replacement-window reliability","dependencies":[{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-lwg","type":"parent-child","created_at":"2026-02-07T17:06:12.6026587+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-lwg.1","type":"blocks","created_at":"2026-02-07T17:06:48.7016653+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-17l.9","type":"blocks","created_at":"2026-02-10T09:44:05.5793575+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-17l.10","type":"blocks","created_at":"2026-02-10T09:44:06.2563223+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-17l.11","type":"blocks","created_at":"2026-02-10T09:44:06.9392296+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-17l.12","type":"blocks","created_at":"2026-02-10T09:44:07.6228678+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.2","depends_on_id":"DRV-17l.13","type":"blocks","created_at":"2026-02-10T09:44:08.3328116+09:00","created_by":"Matt"}]}
{"id":"DRV-lwg.3","title":"Enforce CI quality-gate matrix for final landing","description":"Add or update CI workflows to gate lint, typecheck, unit tests, E2E, and build before merge.","acceptance_criteria":"PR validation blocks merges on gate failures and quality checks run reliably in CI.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-07T17:06:13.2442753+09:00","created_by":"Matt","updated_at":"2026-02-18T23:46:08.3614695+09:00","closed_at":"2026-02-18T23:46:08.3614695+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-lwg.3","depends_on_id":"DRV-lwg","type":"parent-child","created_at":"2026-02-07T17:06:13.2476001+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.3","depends_on_id":"DRV-lwg.2","type":"blocks","created_at":"2026-02-07T17:06:49.3533063+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.3","depends_on_id":"DRV-17l.14","type":"blocks","created_at":"2026-02-10T09:44:08.9851639+09:00","created_by":"Matt"}]}
{"id":"DRV-lwg.4","title":"Publish release verification and rollback playbook","description":"Document pre-release checks, post-deploy verification, monitoring, and rollback actions for the driver rollout.","acceptance_criteria":"Playbook is complete, executable, and ready for handoff with clear ownership and triggers.","notes":"PR: https://github.com/orro3790/drive/pull/189","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:06:13.8979694+09:00","created_by":"Matt","updated_at":"2026-02-19T21:06:25.6205822+09:00","closed_at":"2026-02-19T21:03:53.332794+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-lwg.4","depends_on_id":"DRV-lwg","type":"parent-child","created_at":"2026-02-07T17:06:13.9014171+09:00","created_by":"Matt"},{"issue_id":"DRV-lwg.4","depends_on_id":"DRV-lwg.3","type":"blocks","created_at":"2026-02-07T17:06:50.0303204+09:00","created_by":"Matt"}]}
{"id":"DRV-mhl","title":"Service worker for offline caching","description":"Source: docs/specs/SPEC.md § Offline Strategy\n\n## Objective\nImplement service worker for caching schedule and metrics data.\n\n## Scope\n- Service worker registration\n- Cache strategy: stale-while-revalidate for:\n  - GET /api/assignments/mine\n  - GET /api/preferences\n  - GET /api/metrics (driver metrics)\n- Offline detection banner\n- Cache invalidation on connectivity return\n\n## Spec References\n- docs/specs/SPEC.md: Lines 300-315 (Offline strategy section)\n\n## Acceptance Criteria\n- Service worker registered on app load\n- Cached endpoints available offline\n- \"You're offline\" banner when navigator.onLine is false\n- Stale data served immediately, background refresh when online\n- Cache refreshed when connectivity returns\n- Write operations show \"requires connectivity\" message when offline\n\n## Technical Constraints\n- Use SvelteKit service worker patterns (if available) or manual registration\n- Capacitor may provide its own offline handling\n- Consider Workbox for cache management\n- Test on mobile with airplane mode","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-02T21:33:10.7844524+09:00","created_by":"Matt","updated_at":"2026-02-06T11:41:39.3727837+09:00","closed_at":"2026-02-06T11:41:39.3727837+09:00","close_reason":"Closed","labels":["checkpoint"],"dependencies":[{"issue_id":"DRV-mhl","depends_on_id":"DRV-jnk","type":"blocks","created_at":"2026-02-02T21:33:10.7923981+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2","title":"Manager override flows and global urgent bonus","description":"Implement explicit manager assignment override actions (reassign/open bidding/open urgent bidding) and a manager-editable global urgent bonus setting, based on documentation/plans/manager-override-and-global-urgent-bonus.md.","acceptance_criteria":"Manager route detail uses explicit override actions with correct state gating; global urgent bonus is editable in settings and used at runtime by urgent/no-show flows; no-show penalties are not applied by manual manager overrides; tests cover transition and response contracts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-11T01:22:15.8140513+09:00","created_by":"Matt","updated_at":"2026-02-11T19:49:45.8677993+09:00","closed_at":"2026-02-11T19:49:45.8677993+09:00","close_reason":"Closed","labels":["bidding","dispatch","manager"]}
{"id":"DRV-mo2.1","title":"Add dispatch_settings table and dispatch settings schema","description":"Create dispatch_settings singleton table (id='global') with emergencyBonusPercent, updatedBy, updatedAt; add Drizzle migration; enforce upsert-on-read/write initialization; add src/lib/schemas/dispatch-settings.ts with emergencyBonusPercent integer 0..100 validation.","acceptance_criteria":"Migration creates dispatch_settings and supports singleton row semantics; default global row is created when missing with emergencyBonusPercent=20; dispatch settings schema validates integer range 0..100.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:22:21.9411925+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:43.2660025+09:00","closed_at":"2026-02-11T19:48:43.2660025+09:00","close_reason":"Closed","labels":["db","migration","schema"],"dependencies":[{"issue_id":"DRV-mo2.1","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:22:21.9465744+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.2","title":"Implement dispatch settings service and manager settings API","description":"Add src/lib/server/services/dispatchSettings.ts with getDispatchSettings, updateDispatchSettings, and getEmergencyBonusPercent. Add manager-only GET/PATCH endpoint at src/routes/api/settings/dispatch/+server.ts using the new schema and service. Include fallback to dispatchPolicy emergency bonus if DB read fails.","acceptance_criteria":"Managers can GET/PATCH dispatch settings via /api/settings/dispatch; service lazily initializes missing global row; runtime emergency bonus reads from service with safe fallback behavior.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:22:29.1713507+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:44.4217178+09:00","closed_at":"2026-02-11T19:48:44.4217178+09:00","close_reason":"Closed","labels":["api","service","settings"],"dependencies":[{"issue_id":"DRV-mo2.2","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:22:29.1765972+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.2","depends_on_id":"DRV-mo2.1","type":"blocks","created_at":"2026-02-11T01:22:29.1899608+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.3","title":"Add assignment override API with explicit actions and state gating","description":"Create /api/assignments/[id]/override supporting actions reassign/open_bidding/open_urgent_bidding with required assignment-state matrix, warehouse access checks, idempotency, and normalized response/error contracts. Reuse assignment and bidding services, enforce single-open-window behavior for emergency escalation, and define pending-bid outcome/audit updates. Extend manager routes API payloads with assignmentStatus and isShiftStarted for deterministic UI gating.","acceptance_criteria":"Override endpoint enforces allowed states and returns required response shape; invalid states and conflicts return specified error codes; urgent escalation can replace non-emergency open windows while preserving single-open-window invariant; routes APIs include assignmentStatus and isShiftStarted.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:22:35.63552+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:45.5820452+09:00","closed_at":"2026-02-11T19:48:45.5820452+09:00","close_reason":"Closed","labels":["api","assignments","bidding"],"dependencies":[{"issue_id":"DRV-mo2.3","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:22:35.6415613+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.3","depends_on_id":"DRV-mo2.1","type":"blocks","created_at":"2026-02-11T01:22:35.6576124+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.3","depends_on_id":"DRV-mo2.2","type":"blocks","created_at":"2026-02-11T01:22:35.6690725+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.4","title":"Migrate emergency reopen and no-show flows to runtime bonus provider","description":"Update legacy emergency reopen endpoint to delegate to override action (compatibility wrapper) and replace direct dispatchPolicy bonus reads with getEmergencyBonusPercent. Update noshow service to use runtime bonus and guarantee exactly one emergency notification fanout path.","acceptance_criteria":"Legacy /emergency-reopen remains compatible but delegates to override behavior; no-show and emergency flows consume runtime dispatch settings bonus; no-show path emits a single emergency notification fanout with no duplicate sends.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:22:46.0561127+09:00","created_by":"Matt","updated_at":"2026-02-11T19:49:41.9940979+09:00","closed_at":"2026-02-11T19:49:41.9940979+09:00","close_reason":"Closed","labels":["bidding","compatibility","noshow"],"dependencies":[{"issue_id":"DRV-mo2.4","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:22:46.0604906+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.4","depends_on_id":"DRV-mo2.2","type":"blocks","created_at":"2026-02-11T01:22:46.072711+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.4","depends_on_id":"DRV-mo2.3","type":"blocks","created_at":"2026-02-11T01:22:46.0836088+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.5","title":"Update manager routes UI/store to explicit override actions","description":"In src/routes/(manager)/routes/+page.svelte and src/lib/stores/routeStore.svelte.ts, replace ambiguous reopen flows with explicit action buttons by assignment lifecycle state: Open Bidding, Open Urgent Bidding, and Assign/Reassign Driver. Migrate store calls to /api/assignments/[id]/override and align optimistic updates to normalized API responses. Update i18n keys/copy in messages/en.json, messages/zh.json, and messages/zh-Hant.json for labels and confirmations.","acceptance_criteria":"Routes detail panel shows correct action set for scheduled/unfilled/bidding states and hides overrides for active/completed/cancelled; assign button placement remains right-aligned; UI no longer uses ambiguous reopen wording; localized copy exists for new action labels and confirmations.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:22:54.1647081+09:00","created_by":"Matt","updated_at":"2026-02-11T19:49:43.1567491+09:00","closed_at":"2026-02-11T19:49:43.1567491+09:00","close_reason":"Closed","labels":["i18n","store","ui"],"dependencies":[{"issue_id":"DRV-mo2.5","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:22:54.1709634+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.5","depends_on_id":"DRV-mo2.2","type":"blocks","created_at":"2026-02-11T01:22:54.1856521+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.5","depends_on_id":"DRV-mo2.3","type":"blocks","created_at":"2026-02-11T01:22:54.1950265+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.6","title":"Add manager dispatch settings UI for global urgent bonus","description":"Create src/lib/components/settings/ManagerDispatchSection.svelte and mount it in src/routes/(app)/settings/+page.svelte for manager role. Add numeric Urgent bonus (%) input with inline validation and save feedback backed by /api/settings/dispatch.","acceptance_criteria":"Managers can view and update global emergency bonus percent from settings with validation; successful save updates runtime value consumed by urgent/no-show flows without code changes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:23:00.5884257+09:00","created_by":"Matt","updated_at":"2026-02-11T19:49:44.5015518+09:00","closed_at":"2026-02-11T19:49:44.5015518+09:00","close_reason":"Closed","labels":["settings","ui"],"dependencies":[{"issue_id":"DRV-mo2.6","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:23:00.5943402+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.6","depends_on_id":"DRV-mo2.2","type":"blocks","created_at":"2026-02-11T01:23:00.6080229+09:00","created_by":"Matt"}]}
{"id":"DRV-mo2.7","title":"Add server/store coverage for override transitions and runtime bonus","description":"Add/extend tests for assignment override behavior, dispatch settings API, no-show runtime bonus fanout guarantees, bidding escalation replacement behavior, and routeStore override response mapping. Include response-shape and error-code assertions for override/settings APIs and run full checks.","acceptance_criteria":"Test suite covers scheduled reassignment, urgent override without no-show penalties, unfilled open bidding, invalid-state rejections, runtime bonus reads, single no-show fanout, bidding escalation replacement semantics, and route store mapping to override responses.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T01:23:07.2309302+09:00","created_by":"Matt","updated_at":"2026-02-19T19:30:44.5346319+09:00","closed_at":"2026-02-19T19:30:44.5346319+09:00","close_reason":"Closed","labels":["api","store","test"],"dependencies":[{"issue_id":"DRV-mo2.7","depends_on_id":"DRV-mo2","type":"parent-child","created_at":"2026-02-11T01:23:07.2359109+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.7","depends_on_id":"DRV-mo2.3","type":"blocks","created_at":"2026-02-11T01:23:07.2500894+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.7","depends_on_id":"DRV-mo2.4","type":"blocks","created_at":"2026-02-11T01:23:07.2620407+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.7","depends_on_id":"DRV-mo2.5","type":"blocks","created_at":"2026-02-11T01:23:07.2760805+09:00","created_by":"Matt"},{"issue_id":"DRV-mo2.7","depends_on_id":"DRV-mo2.6","type":"blocks","created_at":"2026-02-11T01:23:07.2886027+09:00","created_by":"Matt"}]}
{"id":"DRV-mzp","title":"In-app notification inbox","description":"Source: docs/specs/SPEC.md § Notifications \u003e In-App Notifications\nSchema: docs/specs/data-model.md § notifications table\n\n## Objective\nImplement the notification inbox for viewing and managing in-app notifications.\n\n## Scope\n- API endpoints:\n  - GET /api/notifications - List user's notifications (paginated)\n  - PATCH /api/notifications/[id]/read - Mark as read\n  - POST /api/notifications/mark-all-read - Mark all as read\n- UI pages:\n  - Driver: src/routes/(app)/notifications/+page.svelte\n  - Manager: src/routes/(manager)/notifications/+page.svelte\n- Display: title, body, timestamp, read status\n- Unread count badge in sidebar navigation\n\n## Spec References\n- docs/specs/SPEC.md: Lines 280-285 (In-app notifications)\n- docs/specs/SPEC.md: Lines 239, 248 (Notification routes for driver/manager)\n- docs/specs/data-model.md: Lines 163-172 (notifications table)\n\n## Acceptance Criteria\n- User sees list of their notifications, newest first\n- Unread notifications visually distinct\n- Clicking notification marks it as read\n- \"Mark all as read\" button clears all unread\n- Sidebar shows unread count badge\n- Pagination for users with many notifications\n- Both drivers and managers have notification inbox\n\n## Technical Constraints\n- Query: userId = current user, ORDER BY createdAt DESC\n- Use index idx_notifications_user_read for performance\n- Unread count query for badge: count where read=false\n- Consider SSE for real-time badge updates (separate bead)","notes":"Progress: notifications API/store/UI done; sidebar unread badge wired; docs updated. pnpm validate passed. pnpm build failed on Windows (Vercel symlink EPERM). /verify not run (manual mobile empty-state check only). Remaining: /verify on /notifications with data, address findings, PR/merge.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:28:55.3165707+09:00","created_by":"Matt","updated_at":"2026-02-05T09:57:03.4101527+09:00","closed_at":"2026-02-05T09:57:03.4101527+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-mzp","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:28:55.3259423+09:00","created_by":"Matt"}]}
{"id":"DRV-n1y","title":"Daily shift reminder cron","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\n\n## Objective\nImplement daily cron job that sends shift reminders to drivers with assignments today.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/shift-reminders/+server.ts\n- Vercel Cron schedule: daily morning (suggest 06:00 Toronto time)\n- Job logic:\n  1. Get all assignments for today where status='scheduled' and userId is not null\n  2. For each: send push notification (type: shift_reminder)\n  3. Log count of reminders sent\n\n## Spec References\n- docs/specs/SPEC.md: Line 296 (Cron job table entry)\n- docs/specs/SPEC.md: Line 275 (shift_reminder notification type)\n\n## Acceptance Criteria\n- Cron runs daily in morning\n- All drivers with assignments today receive reminder\n- Reminder includes route name and warehouse\n- Only scheduled (not cancelled) assignments get reminders\n- Already-started shifts don't get reminders\n- Job execution logged\n\n## Technical Constraints\n- Toronto timezone for \"today\" calculation\n- Keep under 60 seconds\n- Verify CRON_SECRET header\n- Batch notifications if many drivers","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:29:12.3881497+09:00","created_by":"Matt","updated_at":"2026-02-04T14:20:47.7719588+09:00","closed_at":"2026-02-04T14:20:47.7719588+09:00","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-n1y","depends_on_id":"DRV-69a","type":"blocks","created_at":"2026-02-02T21:29:12.3931617+09:00","created_by":"Matt"}]}
{"id":"DRV-n6q","title":"Bid scoring and resolution","description":"Source: docs/specs/SPEC.md § Bidding System \u003e Scoring Algorithm\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement the bid scoring algorithm and winner selection when bid windows close.\n\n## Scope\n- Service function: resolveBidWindow(bidWindowId: string)\n- Scoring formula per SPEC.md:\n  score = (completion_rate × 0.4) +\n          (route_familiarity_normalized × 0.3) +\n          (attendance_rate × 0.2) +\n          (route_preference_bonus × 0.1)\n- Resolution logic:\n  1. Get all pending bids for window\n  2. Calculate score for each bidder\n  3. Sort by score desc, then bidAt asc (tie-breaker)\n  4. Winner: update bid status='won', assignment.userId, assignment.assignedBy='bid'\n  5. Losers: update bid status='lost'\n  6. Send notifications to winner and losers\n\n## Spec References\n- docs/specs/SPEC.md: Lines 129-146 (Scoring algorithm with formula)\n- docs/specs/SPEC.md: Lines 148-153 (Resolution steps)\n- docs/specs/SPEC.md: Lines 272-274 (bid_won, bid_lost notifications)\n- docs/adr/002-replacement-bidding-system.md: Scoring weights rationale\n- docs/specs/data-model.md: Lines 278-314 (calculateBidScore query)\n\n## Acceptance Criteria\n- Scores calculated correctly per formula\n- Highest score wins\n- Ties broken by earliest bid timestamp\n- Winner's bid marked 'won', others marked 'lost'\n- Assignment updated with winner's userId\n- Assignment.assignedBy set to 'bid'\n- Winner receives push notification \"You won [Route] for [Date]\"\n- Losers receive push notification \"[Route] assigned to another driver\"\n- BidWindow status set to 'resolved', winnerId set\n\n## Technical Constraints\n- route_familiarity_normalized = min(completions / 20, 1)\n- route_preference_bonus = 1.0 if route in preferredRoutes, else 0\n- All rates are 0-1 scale\n- Handle edge case: no bids when window closes (window stays open per spec)","notes":"PR: https://github.com/orro3790/drive/pull/13","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:26:21.6920733+09:00","created_by":"Matt","updated_at":"2026-02-04T02:30:52.7795371+09:00","closed_at":"2026-02-04T02:30:52.7795371+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-n6q","depends_on_id":"DRV-vth","type":"blocks","created_at":"2026-02-02T21:26:21.6979426+09:00","created_by":"Matt"}]}
{"id":"DRV-nb4j","title":"Cancel endpoint missing route start time for lifecycle evaluation","description":"Assignment fetch for cancellation does not join routes or select routes.startTime. Even if lifecycle math is fixed to be route-time-aware, cancel endpoint lacks required data plumbing. Source: logs/nightly/2026-02-18/drv-xnb.7-late-cancellation-threshold-audit.md Finding #2","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:09:00.2970679+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:04.8918511+09:00","closed_at":"2026-02-19T19:54:04.8918511+09:00","close_reason":"Closed","labels":["api","data-plumbing","scheduling"]}
{"id":"DRV-nnw","title":"No scheduled nightly workflow for full integration suite","description":"No scheduled GitHub workflow runs pnpm test:integration:full. CI only runs smoke tests on PR/push to main. The full command exists in package.json but is not wired to any scheduled workflow. Cron-jobs.yml schedules endpoint calls, not vitest integration runs. Source: logs/nightly/2026-02-18/drv-b1l.10-nightly-full-integration-runs-and-artifacts-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:05:34.006689+09:00","created_by":"Matt","updated_at":"2026-02-18T23:06:39.2543524+09:00","closed_at":"2026-02-18T23:06:39.2543524+09:00","close_reason":"Fixed and merged in PR #175","labels":["ci","integration","nightly"],"dependencies":[{"issue_id":"DRV-nnw","depends_on_id":"DRV-bjka","type":"parent-child","created_at":"2026-02-18T12:48:11.1606749+09:00","created_by":"unknown"}],"comments":[{"id":69,"issue_id":"DRV-nnw","author":"DESKTOP-V2O36N0\\matto","text":"Merged in PR #175: https://github.com/orro3790/drive/pull/175. Added scheduled workflow .github/workflows/integration-full-nightly.yml to run pnpm test:integration:full nightly with artifacts.","created_at":"2026-02-18T14:06:37Z"}]}
{"id":"DRV-o4e","title":"Server: Resolve latest GitHub release APK","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Add a server-only helper that fetches GitHub Releases latest metadata, computes versionName/versionCode, and selects a deterministic APK download URL.\n\nFiles\n- Add: src/lib/server/githubRelease.ts\n\nImplementation Details\n- Export a function (example):\n  - async function getLatestAndroidApkRelease(): Promise\u003c{ versionName: string; versionCode: number; downloadUrl: string; tagName: string; assetName: string; source: 'github' | 'cache' }\u003e\n- Fetch URL:\n  - https://api.github.com/repos/orro3790/drive/releases/latest\n- Fetch options:\n  - Use AbortController timeout (5-10s).\n  - Headers:\n    - Accept: application/vnd.github+json\n    - User-Agent: drive-app-version-endpoint\n    - X-GitHub-Api-Version: 2022-11-28\n    - Authorization: Bearer ${process.env.GITHUB_TOKEN} (only if env var present)\n- Parse/validate tag:\n  - Strip leading 'v'.\n  - Validate stable semver only: /^\\d+\\.\\d+\\.\\d+$/\n  - Reject anything else (including -alpha/-rc).\n- Compute versionCode:\n  - major*10000 + minor*100 + patch\n- Asset selection:\n  - Consider only assets with name ending in .apk\n  - Priority order:\n    1) name includes 'universal'\n    2) name starts with 'drive-v'\n    3) name === 'app-release.apk'\n    4) lexicographically smallest .apk name\n  - Use asset.browser_download_url\n- Caching (module-scoped):\n  - Keep lastKnownGood payload + fetchedAt timestamp.\n  - TTL should align with /api/app-version s-maxage (e.g. 10 minutes).\n  - Store and reuse ETag if present; send If-None-Match and handle 304.\n- Error handling:\n  - If fetch fails and lastKnownGood exists: return cached payload with source:'cache'.\n  - If no cached payload: throw a typed error that callers can map to 503.\n- Security:\n  - Never log or return the GitHub token.\n\nDependencies\n- Blocks/depends on: spec doc (created above).\n\nAcceptance Criteria\n- Helper returns a tag-scoped downloadUrl (contains /releases/download/vX.Y.Z/...).\n- Helper selects the same asset deterministically across runs.\n- Helper behaves correctly on 304 and transient errors.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-15T22:56:10.6145247+09:00","created_by":"Matt","updated_at":"2026-02-19T19:44:21.286162+09:00","closed_at":"2026-02-19T19:44:21.286162+09:00","close_reason":"Closed"}
{"id":"DRV-obx","title":"Bid window creation service","description":"Source: docs/specs/SPEC.md § Bidding System\nADR: docs/adr/002-replacement-bidding-system.md\n\n## Objective\nImplement service to create bid windows when assignments become unfilled.\n\n## Scope\n- Service function: createBidWindow(assignmentId: string)\n- Triggers:\n  - Driver cancels assignment\n  - No-show detected\n  - Schedule generation creates unfilled assignment\n- Window duration logic:\n  - If shift \u003e 30 min away: closesAt = now + 30 minutes\n  - If shift ≤ 30 min away: closesAt = shift date start time\n  - If shift already passed: no window created\n- Send push notification to eligible drivers\n\n## Spec References\n- docs/specs/SPEC.md: Lines 106-111 (Bid window triggers)\n- docs/specs/SPEC.md: Lines 113-119 (Bid window duration table)\n- docs/specs/SPEC.md: Lines 121-127 (Notification rules)\n- docs/adr/002-replacement-bidding-system.md: Window mechanics rationale\n- docs/specs/data-model.md: Lines 133-140 (bidWindows table)\n\n## Acceptance Criteria\n- Bid window created with correct closesAt based on time until shift\n- Assignment status updated to 'unfilled' if not already\n- BidWindow record created with status='open'\n- Push notification sent to all eligible drivers (under cap, not flagged)\n- Notification includes route name, date, window close time\n- No duplicate windows for same assignment\n\n## Technical Constraints\n- Service in src/lib/server/services/bidding.ts\n- Calculate time difference in Toronto timezone\n- \"30 minutes away\" means assignment.date as datetime vs now\n- Eligible drivers query: role='driver' AND isFlagged=false AND under weekly cap","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:25:33.8924132+09:00","created_by":"Matt","updated_at":"2026-02-03T17:03:56.9251896+09:00","closed_at":"2026-02-03T17:03:56.9251896+09:00","close_reason":"Implementation complete in src/lib/server/services/bidding.ts. Service includes: createBidWindow(), window duration logic, eligible driver filtering, notification creation, duplicate prevention.","dependencies":[{"issue_id":"DRV-obx","depends_on_id":"DRV-xgp","type":"blocks","created_at":"2026-02-02T21:25:33.8980793+09:00","created_by":"Matt"}]}
{"id":"DRV-odx","title":"Phase 2: Enhanced Shift Lifecycle","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 2)\n\nEnhance the on-shift workflow with multi-step driver operations.\n\nNew flow: On-site arrival signal (before 9 AM) → parcel inventory → deliveries → returns entry → summary → finish shift. 1-hour edit window for parcel corrections.\n\nKey outcomes:\n- Timestamped audit trail for every shift step\n- Auto-calculated delivery counts (parcelsStart - parcelsReturned)\n- 9 AM arrival deadline enables automated no-show detection\n- 1-hour post-shift edit window for correcting parcel counts\n","notes":"PR: https://github.com/orro3790/drive/pull/37","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-06T17:09:22.8856163+09:00","created_by":"Matt","updated_at":"2026-02-06T18:54:26.2828574+09:00","closed_at":"2026-02-06T18:53:30.739065+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-odx","depends_on_id":"DRV-34m","type":"blocks","created_at":"2026-02-06T17:15:42.0327367+09:00","created_by":"Matt"}]}
{"id":"DRV-odx.1","title":"Schema migration: enhanced shift lifecycle","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 2 \u003e Schema Changes)\n\nDatabase schema migration for the enhanced shift lifecycle.\n\n## Changes\n\n### shifts table — add columns:\n- `arrivedAt` timestamp(tz) nullable — when driver signaled on-site arrival\n- `editableUntil` timestamp(tz) nullable — completedAt + 1 hour, after which parcel edits are locked\n\n### shifts table — behavioral change:\n- `parcelsDelivered` becomes server-calculated (parcelsStart - parcelsReturned)\n- Keep UNIQUE constraint on assignmentId (cancel does not create shift records; see design notes)\n- If a partial shift record exists from a no-show driver, it gets deleted during bid resolution (handled in bidding service)\n\n## Files to modify\n- `src/lib/server/db/schema.ts` — add arrivedAt and editableUntil columns to shifts table\n\n## Implementation\n1. Add columns to shifts table definition\n2. Run `pnpm drizzle-kit generate` to create migration SQL\n3. Run `pnpm drizzle-kit migrate` to apply\n4. Verify existing shifts data is preserved (new columns are nullable)\n\n## Acceptance criteria\n- Migration applies cleanly\n- Existing shift records unaffected (new columns are null)\n- TypeScript types updated, app compiles\n- UNIQUE constraint on assignmentId preserved\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:12:34.3386474+09:00","created_by":"Matt","updated_at":"2026-02-06T18:21:59.8395994+09:00","closed_at":"2026-02-06T18:21:59.8395994+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-odx.1","depends_on_id":"DRV-odx","type":"parent-child","created_at":"2026-02-06T17:12:34.3447757+09:00","created_by":"Matt"}]}
{"id":"DRV-odx.2","title":"Shift arrive endpoint + service","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 2 \u003e API Endpoints)\n\nNew endpoint for drivers to signal on-site arrival.\n\n## New endpoint: POST /api/shifts/arrive\n\nFile: src/routes/api/shifts/arrive/+server.ts\n\n### Request: { assignmentId: string }\n\n### Logic:\n1. Auth: driver only\n2. Get assignment, verify:\n   - Assignment belongs to locals.user.id\n   - Assignment date = today (Toronto time, use getTorontoDateString pattern from noshow.ts)\n   - Assignment status = 'scheduled'\n   - Assignment confirmedAt IS NOT NULL (must be confirmed first)\n3. Check time: current Toronto time \u003c 9:00 AM (ARRIVAL_DEADLINE_HOUR = 9)\n   - If past 9 AM: return 400 \"Must arrive before 9:00 AM\"\n4. Check for existing shift: query shifts where assignmentId matches\n   - If shift already exists (arrivedAt already set): return 400 \"Already arrived\"\n5. Create shift record:\n   ```typescript\n   await db.insert(shifts).values({\n     assignmentId,\n     arrivedAt: new Date()\n   });\n   ```\n6. Update assignment status to 'active'\n7. Create audit log\n8. Return json({ success: true, arrivedAt: timestamp })\n\n### Service function (optional, can be in endpoint):\nIf extracted to a service file, put in src/lib/server/services/shifts.ts or similar.\n\n## Dependencies\n- Phase 2 schema migration (arrivedAt column)\n- Phase 1 confirmation system (confirmedAt must exist)\n\n## Acceptance criteria\n- Arriving before 9 AM on shift day succeeds\n- Arriving after 9 AM returns 400\n- Arriving on wrong day returns 400\n- Arriving without confirmation returns 400\n- Double arrival returns 400\n- Assignment transitions to 'active'\n- Shift record created with arrivedAt timestamp\n- Audit log created\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:12:44.7845765+09:00","created_by":"Matt","updated_at":"2026-02-06T18:23:15.560858+09:00","closed_at":"2026-02-06T18:23:15.560858+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-odx.2","depends_on_id":"DRV-odx","type":"parent-child","created_at":"2026-02-06T17:12:44.7924699+09:00","created_by":"Matt"},{"issue_id":"DRV-odx.2","depends_on_id":"DRV-odx.1","type":"blocks","created_at":"2026-02-06T17:15:30.7742097+09:00","created_by":"Matt"}]}
{"id":"DRV-odx.3","title":"Modify start/complete/edit shift endpoints","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 2 \u003e API Endpoints)\n\nModify existing shift endpoints for the new multi-step lifecycle.\n\n## File: src/routes/api/shifts/start/+server.ts\n\n### Changes:\n- Currently creates shift record AND records parcelsStart\n- New: shift record already exists (from /arrive), this only records parcelsStart\n- Validate: shift exists for this assignment with arrivedAt set\n- Validate: parcelsStart not already set (prevent double entry)\n- Set parcelsStart and startedAt = now()\n- Do NOT update assignment status (already 'active' from /arrive)\n\n## File: src/routes/api/shifts/complete/+server.ts\n\n### Changes:\n- Current input: { assignmentId, parcelsDelivered, parcelsReturned }\n- New input: { assignmentId, parcelsReturned } (parcelsDelivered is calculated)\n- Validate: parcelsReturned \u003c= parcelsStart (cannot return more than started with)\n- Calculate: parcelsDelivered = parcelsStart - parcelsReturned\n- Set completedAt = now(), editableUntil = addHours(now, 1) (use date-fns addHours)\n- Rest of logic unchanged (update assignment status, record route completion, update metrics)\n\n## New endpoint: PATCH /api/shifts/[assignmentId]/edit\n\nFile: src/routes/api/shifts/[assignmentId]/edit/+server.ts\n\n### Request: { parcelsStart?: number, parcelsReturned?: number }\n\n### Logic:\n1. Auth: driver, owns assignment\n2. Get shift for this assignmentId\n3. Validate: shift.completedAt IS NOT NULL (must be completed)\n4. Validate: shift.editableUntil \u003e now() (within 1-hour window)\n5. If parcelsStart provided: validate \u003e 0\n6. If parcelsReturned provided: validate \u003c= parcelsStart (use new value if both provided)\n7. Recalculate parcelsDelivered = (newParcelsStart ?? existingParcelsStart) - (newParcelsReturned ?? existingParcelsReturned)\n8. Update shift record\n9. Recalculate driver metrics (call updateDriverMetrics)\n10. Create audit log with before/after values\n11. Return json({ success: true, shift: updated })\n\n### Error responses:\n- 400 \"Edit window has expired\" if past editableUntil\n- 400 \"Shift not yet completed\" if completedAt is null\n- 400 \"Returns cannot exceed starting parcels\"\n\n## Dependencies\n- Phase 2 schema migration (arrivedAt, editableUntil columns)\n- Arrive endpoint (shift record must exist)\n\n## Acceptance criteria\n- Start: only sets parcelsStart on existing shift (does not create shift)\n- Start: fails if no shift exists (must arrive first)\n- Complete: calculates parcelsDelivered automatically\n- Complete: rejects parcelsReturned \u003e parcelsStart\n- Complete: sets editableUntil = completedAt + 1 hour\n- Edit: succeeds within 1 hour of completion\n- Edit: fails after 1 hour with clear error message\n- Edit: recalculates parcelsDelivered and updates metrics\n- Edit: creates audit log with before/after values\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:12:59.5219315+09:00","created_by":"Matt","updated_at":"2026-02-06T18:24:45.5895066+09:00","closed_at":"2026-02-06T18:24:45.5895066+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-odx.3","depends_on_id":"DRV-odx","type":"parent-child","created_at":"2026-02-06T17:12:59.5273744+09:00","created_by":"Matt"},{"issue_id":"DRV-odx.3","depends_on_id":"DRV-odx.1","type":"blocks","created_at":"2026-02-06T17:15:31.9078495+09:00","created_by":"Matt"},{"issue_id":"DRV-odx.3","depends_on_id":"DRV-odx.2","type":"blocks","created_at":"2026-02-06T17:15:32.7875055+09:00","created_by":"Matt"}]}
{"id":"DRV-odx.4","title":"Dashboard UI: multi-step shift workflow","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 2 \u003e UI Changes)\n\nReplace the current Today's Shift card with a multi-step workflow.\n\n## File: src/routes/(driver)/dashboard/+page.svelte\n\n### Replace existing Today's Shift section with step-based UI:\n\n**Step 1 — Not Yet On Site** (assignment.status='scheduled', no shift record):\n- Large \"I'm On Site\" button (Button fill variant=\"primary\")\n- Show route name, warehouse name, shift date\n- Disabled state with message if past 9 AM: \"Arrival deadline passed\"\n\n**Step 2 — Arrived, Needs Inventory** (shift.arrivedAt set, parcelsStart null):\n- \"Enter Parcel Count\" — number input (InlineEditor type=\"number\")\n- \"Submit\" Button\n- Show arrivedAt timestamp: \"Arrived at {time}\"\n\n**Step 3 — In Progress** (parcelsStart set, completedAt null):\n- Status display: \"Delivering...\" with route details\n- Show parcel count: \"Started with {parcelsStart} parcels\"\n- \"Complete Shift\" Button to proceed to step 4\n\n**Step 4 — Completing** (user clicks Complete):\n- \"How many returns?\" — number input, max = parcelsStart\n- Live summary below input:\n  - Started with: {parcelsStart} parcels\n  - Returning: {parcelsReturned} parcels\n  - Delivered: {parcelsStart - parcelsReturned} parcels\n- \"Finish Shift\" Button (Button fill variant=\"primary\")\n\n**Step 5 — Completed (Editable)** (completedAt set, editableUntil \u003e now):\n- Delivery summary (same as step 4 but read-only)\n- \"Edit\" button (Button variant=\"secondary\")\n- Countdown: \"Editable for {minutes} more minutes\"\n- Edit mode: shows input fields for parcelsStart and parcelsReturned\n\n**Step 6 — Completed (Locked)** (editableUntil \u003c= now):\n- Delivery summary (read-only)\n- \"Contact manager to edit\" text (muted)\n\n### Step determination logic:\n```typescript\nconst step = $derived(() =\u003e {\n  if (!todayShift) return null;\n  if (!todayShift.shift?.arrivedAt) return 'arrive';\n  if (!todayShift.shift?.parcelsStart) return 'inventory';\n  if (!todayShift.shift?.completedAt) return 'delivering';\n  if (todayShift.shift?.editableUntil \u0026\u0026 new Date() \u003c new Date(todayShift.shift.editableUntil)) return 'completed-editable';\n  return 'completed-locked';\n});\n```\n\n## File: src/lib/stores/dashboardStore.svelte.ts\n\n### Add methods:\n- arrive(assignmentId) → POST /api/shifts/arrive, update todayShift state\n- Modify startShift(assignmentId, parcelsStart) → POST /api/shifts/start (parcelsStart only)\n- Modify completeShift(assignmentId, parcelsReturned) → POST /api/shifts/complete (parcelsReturned only, server calculates delivered)\n- editShift(assignmentId, parcelsStart?, parcelsReturned?) → PATCH /api/shifts/{assignmentId}/edit\n- Add editTimeRemaining derived state using todayShift.shift.editableUntil\n\n### UI components to use:\n- Button from src/lib/components/primitives/Button.svelte\n- InlineEditor from src/lib/components/primitives/InlineEditor.svelte (for number inputs)\n- Chip for status badges\n- Existing card layout patterns\n\n## Dependencies\n- Arrive endpoint\n- Start/complete/edit endpoints\n- Phase 2 schema migration\n\n## Acceptance criteria\n- Correct step shown based on shift state\n- \"I'm On Site\" button calls arrive endpoint, transitions to inventory step\n- Parcel count input validates (positive integer)\n- Returns input validates (0 to parcelsStart)\n- Delivery summary calculates correctly\n- Edit button appears only within 1-hour window\n- Countdown timer updates in real-time\n- All steps work on mobile (large inputs, clear buttons)\n- Offline guard on all write actions\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:13:30.0843703+09:00","created_by":"Matt","updated_at":"2026-02-06T18:53:23.3723113+09:00","closed_at":"2026-02-06T18:53:23.3723113+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-odx.4","depends_on_id":"DRV-odx","type":"parent-child","created_at":"2026-02-06T17:13:30.0898109+09:00","created_by":"Matt"},{"issue_id":"DRV-odx.4","depends_on_id":"DRV-odx.3","type":"blocks","created_at":"2026-02-06T17:15:33.5436347+09:00","created_by":"Matt"},{"issue_id":"DRV-odx.4","depends_on_id":"DRV-odx.2","type":"blocks","created_at":"2026-02-06T17:15:34.6682473+09:00","created_by":"Matt"}]}
{"id":"DRV-ov43","title":"Nightly pass/fail semantics allow report-consistency blind spots","description":"Orchestrator derives pass/fail from process results only. Witness can be marked skipped-but-passed. Witness flow can proceed even if cron report says fail. Need to reconcile orchestrator status against artifact verdict fields and treat witness-skipped as distinct from pass in strict audit mode. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.11 audit)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:36.1424449+09:00","created_by":"Matt","updated_at":"2026-02-18T23:06:31.2663658+09:00","closed_at":"2026-02-18T23:06:31.2663658+09:00","close_reason":"Fixed and merged in PR #175","labels":["nightly","orchestrator","testing"],"dependencies":[{"issue_id":"DRV-ov43","depends_on_id":"DRV-bjka","type":"parent-child","created_at":"2026-02-18T12:48:06.3325962+09:00","created_by":"unknown"}],"comments":[{"id":66,"issue_id":"DRV-ov43","author":"DESKTOP-V2O36N0\\matto","text":"Merged in PR #175: https://github.com/orro3790/drive/pull/175. Orchestrator now enforces upstream witness gating and strict-audit skipped-witness semantics.","created_at":"2026-02-18T14:06:29Z"}]}
{"id":"DRV-q471","title":"Add end-to-end hard-stop provenance scenario with manager reinstatement","description":"DRV-b1l.4 Audit Finding #3: Hard-stop/reset plus manager intervention flow is only partially proven end-to-end. Lifecycle S11 seeds intervention state with direct SQL rather than deriving from a persisted hard-stop event path. Add an end-to-end hard-stop provenance scenario that starts from persisted no-show/late-cancel events, validates health reset state, performs manager reinstatement, and verifies behavior when no new hard-stop events occur post-reinstatement. Source: logs/nightly/2026-02-18/drv-b1l.4-health-scoring-and-intervention-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:07:38.2608059+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:22.5918336+09:00","closed_at":"2026-02-18T23:17:22.5918336+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","health","intervention"],"dependencies":[{"issue_id":"DRV-q471","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:39.3422278+09:00","created_by":"unknown"}]}
{"id":"DRV-q8c","title":"Fix: svelte-check errors (NotificationPermissionCard)","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Unblock CI by fixing the TypeScript errors in NotificationPermissionCard.\n\nFiles\n- Update: src/lib/components/driver/NotificationPermissionCard.svelte\n\nImplementation Details\n- Fix Svelte 5 $state inference:\n  - Change to: let permissionStatus = $state\u003cPushPermissionStatus\u003e('unknown');\n  - Avoid literal-only inference that makes comparisons like permissionStatus === 'prompt' impossible.\n- Fix Button size typing:\n  - Replace size=\\\"sm\\\" with size=\\\"small\\\" (allowed values: compact|xs|small|standard|large).\n\nAcceptance Criteria\n- pnpm check (svelte-check) reports 0 errors.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-15T22:56:18.3636574+09:00","created_by":"Matt","updated_at":"2026-02-19T19:11:06.5760074+09:00","closed_at":"2026-02-19T19:11:06.5760074+09:00","close_reason":"Closed"}
{"id":"DRV-qen","title":"Daily performance check cron","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\nDependencies: Metrics service, Flagging service\n\n## Objective\nImplement daily cron job that recalculates metrics and applies flagging logic.\n\n## Scope\n- Cron endpoint at src/routes/api/cron/performance-check/+server.ts\n- Vercel Cron schedule: daily (suggest 02:00 Toronto time, after day's shifts complete)\n- Job logic:\n  1. Get all drivers (role='driver')\n  2. For each driver: call updateDriverMetrics()\n  3. For each driver: call checkAndApplyFlag()\n  4. Log summary: drivers checked, newly flagged, caps reduced, rewards granted\n\n## Spec References\n- docs/specs/SPEC.md: Line 295 (Cron job table entry)\n- docs/specs/SPEC.md: Lines 185-215 (Performance \u0026 Flagging section)\n\n## Acceptance Criteria\n- Cron runs daily at configured time\n- All driver metrics recalculated\n- Flag logic applied to all drivers\n- Reward logic applied (20+ shifts, 95%+ attendance → cap = 6)\n- Job execution logged with statistics\n- Errors on one driver don't block others\n\n## Technical Constraints\n- Process drivers in batches to avoid timeout\n- Keep under 60 seconds (Vercel Cron limit)\n- Verify CRON_SECRET header\n- Consider running after midnight Toronto time","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:28:13.1944573+09:00","created_by":"Matt","updated_at":"2026-02-04T14:18:54.3806332+09:00","closed_at":"2026-02-04T14:18:54.3806332+09:00","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-qen","depends_on_id":"DRV-102","type":"blocks","created_at":"2026-02-02T21:28:13.1989474+09:00","created_by":"Matt"}]}
{"id":"DRV-qk8","title":"Coverage docs claim route-time late-cancel behavior that is not implemented","description":"nightly-e2e-coverage.md frames early/late cancellation handling as covered, but drv-xnb.7 shows late-cancel classification still uses global 07:00 instead of per-route start time, and cancel endpoint lacks route start time plumbing. Source: logs/nightly/2026-02-18/drv-xnb.12-audit-checklist-docs-alignment-with-current-coverage.md Finding 2","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:06:26.9188707+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:36.2301616+09:00","closed_at":"2026-02-19T19:54:36.2301616+09:00","close_reason":"Closed","labels":["accuracy","documentation","testing"],"dependencies":[{"issue_id":"DRV-qk8","depends_on_id":"DRV-b0dc","type":"parent-child","created_at":"2026-02-18T12:48:41.2937486+09:00","created_by":"unknown"}]}
{"id":"DRV-qlr","title":"API JSON parsing unguarded in 7 write endpoints","description":"7 write endpoints use await request.json() without try/catch guard, allowing malformed JSON to bubble into unhandled errors: shifts/complete, shifts/arrive, shifts/start, shifts/[assignmentId]/edit, assignments/[id]/cancel, preferences, drivers/[id]. Source: logs/nightly/2026-02-18/drv-xnb.9-api-input-and-error-contract-consistency-audit.md Finding 1","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:02:53.1208672+09:00","created_by":"Matt","updated_at":"2026-02-18T21:28:50.6656248+09:00","closed_at":"2026-02-18T21:28:50.6656248+09:00","close_reason":"Closed","labels":["api","input-validation","security"],"dependencies":[{"issue_id":"DRV-qlr","depends_on_id":"DRV-3ads","type":"parent-child","created_at":"2026-02-18T12:48:24.729193+09:00","created_by":"unknown"}],"comments":[{"id":63,"issue_id":"DRV-qlr","author":"DESKTOP-V2O36N0\\matto","text":"PR: https://github.com/orro3790/drive/pull/170","created_at":"2026-02-18T12:29:28Z"}]}
{"id":"DRV-qqk3","title":"FCM failures not classified: transient vs terminal errors collapsed","description":"sendNotification catches all FCM send failures and normalizes to pushError='push_failed' with no code-based branch for retryable vs terminal classes. Logged failure detail drops provider-specific code/message context needed for taxonomy. Source: logs/nightly/2026-02-18/drv-xnb.8-notification-reliability-and-fcm-error-taxonomy-audit.md Finding #1","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:10:22.9927083+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:17.3528111+09:00","closed_at":"2026-02-18T22:55:17.3528111+09:00","close_reason":"Covered by DRV-vii implementation (PR #168): FCM taxonomy, terminal token cleanup, and aggregate reliability counters added.","labels":["fcm","notifications","observability"],"dependencies":[{"issue_id":"DRV-qqk3","depends_on_id":"DRV-1sft","type":"parent-child","created_at":"2026-02-18T12:47:25.4614894+09:00","created_by":"unknown"}]}
{"id":"DRV-qvg","title":"Witness skip counted as PASS allows missing verdict artifacts","description":"When witness script is absent or dev server unreachable, orchestrator records witness as {passed: true, skipped: true}. Overall PASS can be emitted while witness-ui-report.json is never produced. Source: logs/nightly/2026-02-18/drv-xnb.11-nightly-orchestrator-result-report-consistency-audit.md Finding 2","status":"closed","priority":2,"issue_type":"bug","assignee":"drive","created_at":"2026-02-18T12:05:13.5608578+09:00","created_by":"Matt","updated_at":"2026-02-19T12:37:59.5484784+09:00","closed_at":"2026-02-19T12:35:32.9738923+09:00","close_reason":"Skipped witness now fails orchestrator and requires witness artifact evidence","external_ref":"https://github.com/orro3790/drive/pull/187","labels":["nightly","observability","testing"]}
{"id":"DRV-qz8","title":"Update .env.example with Resend config","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Modify #4)\n\nDocument the Resend email configuration in .env.example.\n\nFILE TO MODIFY: .env.example\n\nADD NEW SECTION after Firebase section:\n\n# -------------------------------------------\n# Email (Resend)\n# -------------------------------------------\n# Get API key from: Resend Dashboard \u003e API Keys\n# Required for password reset emails\nRESEND_API_KEY=re_xxxxxxxxxxxx\n\n# From address for transactional emails\n# Must match a verified domain in Resend\nEMAIL_FROM=Drive \u003cnoreply@yourdomain.com\u003e\n\nACCEPTANCE CRITERIA:\n- New Email section added to .env.example\n- RESEND_API_KEY documented with example format\n- EMAIL_FROM documented with example value\n- Comments explain where to get the API key","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:15:12.2176567+09:00","created_by":"Matt","updated_at":"2026-02-03T09:20:08.4254326+09:00","closed_at":"2026-02-03T09:20:08.4254326+09:00","close_reason":"Closed"}
{"id":"DRV-r8g","title":"Derived Metrics, Health Seeding \u0026 Tier Label","description":"Overhaul seed system to derive metrics from actual assignment/shift data (not random), create health seed generator for driverHealthSnapshots + driverHealthState, and add Tier I/II label to HealthCard. See plan: .claude/plans/lazy-sniffing-hanrahan.md","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-08T20:45:23.736312+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:39.7012806+09:00","closed_at":"2026-02-08T21:12:39.7012806+09:00","close_reason":"Closed","labels":["dashboard","health","seed"]}
{"id":"DRV-r8g.1","title":"Add confirmedAt to assignment seed generator","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Part A2)\n\n## Objective\nAdd `confirmedAt: Date | null` field to `GeneratedAssignment` interface and populate it based on assignment status during generation.\n\n## File\n`scripts/seed/generators/assignments.ts`\n\n## Implementation\n\n1. Add `confirmedAt: Date | null` to `GeneratedAssignment` interface (line 26-34)\n\n2. In `createShiftForStatus` / assignment creation logic, set `confirmedAt` based on status:\n   - **completed/active**: `confirmedAt` = random timestamp 3-5 days before assignment date (timely confirmation)\n   - **cancelled**: 30% get `confirmedAt` (these become late cancellations in metrics), 70% null (pre-confirmation drops)\n   - **scheduled (future)**: 60% get `confirmedAt`, 40% null (haven't confirmed yet)\n   - **unfilled**: null (no driver assigned)\n\n3. Use `randomTimeOnDate()` or similar utility from `../utils/dates` to generate realistic confirmation timestamps. The confirmation date should be `assignmentDate - randomInt(3, 5)` days.\n\n4. Also update `seed.ts` `db.insert(assignments).values()` (lines 283-294) to include `confirmedAt: a.confirmedAt` in the mapped values.\n\n## Dependencies\nNone — this is the first step.\n\n## Acceptance Criteria\n- `GeneratedAssignment` interface has `confirmedAt` field\n- All generated assignments have `confirmedAt` set according to the rules above\n- `confirmedAt` is included in the `db.insert(assignments)` call in `seed.ts`\n- Existing assignment generation logic unchanged (status distribution, daily cap, etc.)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:45:44.8821271+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:32.4937143+09:00","closed_at":"2026-02-08T21:12:32.4937143+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.1","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:45:44.8981266+09:00","created_by":"Matt"}]}
{"id":"DRV-r8g.2","title":"Rewrite metrics generator to derive from real shift data","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Part A3)\n\n## Objective\nReplace the random metrics generator with one that computes all driverMetrics columns from actual assignment and shift data.\n\n## File\n`scripts/seed/generators/metrics.ts`\n\n## Implementation\n\n1. Change function signature:\n   ```typescript\n   export function generateMetrics(\n     drivers: GeneratedUser[],\n     assignments: GeneratedAssignment[],\n     shifts: GeneratedShift[]\n   ): GeneratedMetric[]\n   ```\n\n2. Expand `GeneratedMetric` interface to include ALL driverMetrics schema columns:\n   ```typescript\n   export interface GeneratedMetric {\n     userId: string;\n     totalShifts: number;\n     completedShifts: number;\n     attendanceRate: number;\n     completionRate: number;\n     avgParcelsDelivered: number;\n     totalAssigned: number;\n     confirmedShifts: number;\n     autoDroppedShifts: number;\n     lateCancellations: number;\n     noShows: number;\n     bidPickups: number;\n   }\n   ```\n\n3. For each driver, compute from assignments/shifts:\n   - `totalAssigned`: count assignments where `userId === driver.id` and status !== 'unfilled'\n   - `completedShifts`: count assignments where status === 'completed'\n   - `totalShifts`: same as `completedShifts`\n   - `attendanceRate`: `completedShifts / totalAssigned` (guard div/0, default 0)\n   - `completionRate`: for completed shifts, `sum(parcelsDelivered) / sum(parcelsStart)` — resolve shifts via `assignments[shift.assignmentIndex].userId`\n   - `avgParcelsDelivered`: `sum(parcelsDelivered) / completedShifts` (guard div/0)\n   - `confirmedShifts`: count assignments where `confirmedAt !== null`\n   - `lateCancellations`: count where `status === 'cancelled' \u0026\u0026 confirmedAt !== null`\n   - `noShows`: 0 (seed doesn't generate no-show bid windows)\n   - `autoDroppedShifts`: 0 (not modeled in seed)\n   - `bidPickups`: count where `assignedBy === 'bid'`\n\n4. Delete all random generation functions: `selectPerformanceTier`, `generateRatesForTier`, `randomInRange`.\n\n## Dependencies\n- DRV-r8g.1 (confirmedAt must exist on assignments for lateCancellations count)\n\n## Acceptance Criteria\n- All 11 metric columns are computed from real data\n- No random generation remains\n- Drivers with 0 assignments get sensible defaults (0 rates, 0 counts)\n- `completionRate` uses parcel delivery ratio (parcelsDelivered/parcelsStart), NOT shift completion count\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:46:07.7223886+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:33.6804673+09:00","closed_at":"2026-02-08T21:12:33.6804673+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.2","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:46:07.7311981+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.2","depends_on_id":"DRV-r8g.1","type":"blocks","created_at":"2026-02-08T20:48:28.2342353+09:00","created_by":"Matt"}]}
{"id":"DRV-r8g.3","title":"Create health seed generator","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Part B1)\n\n## Objective\nCreate a new generator that produces `driverHealthSnapshots` (daily scores) and `driverHealthState` (current state) records derived from actual assignment/shift/metrics data using the real health score formula.\n\n## File\n`scripts/seed/generators/health.ts` (NEW)\n\n## Types\n\n```typescript\nexport interface GeneratedHealthSnapshot {\n  userId: string;\n  evaluatedAt: string; // YYYY-MM-DD\n  score: number;\n  attendanceRate: number;\n  completionRate: number;\n  lateCancellationCount30d: number;\n  noShowCount30d: number;\n  hardStopTriggered: boolean;\n  reasons: string[];\n}\n\nexport interface GeneratedHealthState {\n  userId: string;\n  currentScore: number;\n  streakWeeks: number;\n  stars: number;\n  lastQualifiedWeekStart: string | null;\n  assignmentPoolEligible: boolean;\n  requiresManagerIntervention: boolean;\n  nextMilestoneStars: number;\n}\n\nexport interface GeneratedHealthResult {\n  snapshots: GeneratedHealthSnapshot[];\n  states: GeneratedHealthState[];\n}\n```\n\n## Function Signature\n\n```typescript\nexport function generateHealth(\n  drivers: GeneratedUser[],\n  assignments: GeneratedAssignment[],\n  shifts: GeneratedShift[],\n  metrics: GeneratedMetric[]\n): GeneratedHealthResult\n```\n\n## Algorithm\n\n### Step 1: Build lookup structures\n- Map assignments by userId → sorted by date\n- Map shifts by assignmentIndex\n- Map metrics by userId\n\n### Step 2: Daily snapshots\nFor each driver, for each unique past date where they had an assignment:\n- Get all-time `attendanceRate` and `completionRate` from their metrics record\n- Scan assignments in [date-30d, date] window to count:\n  - `lateCancelCount30d`: status === 'cancelled' \u0026\u0026 confirmedAt !== null\n  - `noShowCount30d`: 0 (seed doesn't generate no-show triggers)\n- Apply score formula (from `src/lib/server/services/health.ts` lines 134-153):\n  ```\n  attendance_component = attendanceRate × 50\n  completion_component = completionRate × 30\n  totalEvents = noShowCount30d + lateCancelCount30d\n  reliability_component = max(0, 20 - (totalEvents × 5))\n  baseScore = clamp(round(sum), 0, 100)\n  ```\n- Hard-stop: if `noShowCount30d \u003e 0 || lateCancelCount30d \u003e= 2` → cap at 49\n\n### Step 3: Weekly star evaluation\nFor each **fully completed** past week (Mon-Sun ending before today):\n- Skip partial current week\n- Count driver's assignments that week\n- Zero-assignment weeks → neutral (no change to stars/streak)\n- Weekly qualification criteria (from `dispatchPolicy.health.qualifyingWeek`):\n  - Attendance: all non-cancelled assignments completed → 100%\n  - Completion rate: parcelsDelivered/parcelsStart for completed shifts ≥ 95%\n  - 0 no-shows in week\n  - 0 late cancellations in week (cancelled + confirmedAt)\n- If hard-stop in 30d window at week end → stars = 0, streak = 0\n- If qualified → streak++, stars = min(stars + 1, maxStars=4)\n- If not qualified (no hard-stop) → no change\n\n### Step 4: Build health state per driver\n- `currentScore`: most recent daily snapshot score\n- `streakWeeks`, `stars`: accumulated from weekly evaluations\n- `lastQualifiedWeekStart`: most recent qualifying week start date (YYYY-MM-DD)\n- `assignmentPoolEligible`: false if any hard-stop triggered\n- `requiresManagerIntervention`: mirrors hard-stop\n- `nextMilestoneStars`: min(stars + 1, 4)\n\n## Config References\n- `dispatchPolicy.health.scoreWeights` — {attendance: 50, completion: 30, reliability: 20}\n- `dispatchPolicy.health.hardStopScoreCap` — 49\n- `dispatchPolicy.health.lateCancelRollingDays` — 30\n- `dispatchPolicy.health.lateCancelThreshold` — 2\n- `dispatchPolicy.health.qualifyingWeek` — {minAttendanceRate: 1.0, minCompletionRate: 0.95, maxNoShows: 0, maxLateCancellations: 0}\n- `dispatchPolicy.health.maxStars` — 4\n\nImport from `src/lib/config/dispatchPolicy.ts` (accessible from seed scripts).\n\n## Dependencies\n- DRV-r8g.1 (confirmedAt on assignments needed for late cancellation detection)\n- DRV-r8g.2 (metrics data needed for attendance/completion rates)\n\n## Acceptance Criteria\n- One snapshot per past date per driver where they had an assignment\n- Score formula matches `src/lib/server/services/health.ts` exactly\n- Weekly star evaluation uses only fully completed past weeks\n- Health state reflects accumulated weekly evaluations\n- Drivers with 0 past assignments get no snapshots and no health state (onboarding)\n- Hard-stop drivers get score capped at 49, stars reset to 0\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:46:43.192483+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:34.7923202+09:00","closed_at":"2026-02-08T21:12:34.7923202+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.3","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:46:43.2004537+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.3","depends_on_id":"DRV-r8g.1","type":"blocks","created_at":"2026-02-08T20:48:29.6560666+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.3","depends_on_id":"DRV-r8g.2","type":"blocks","created_at":"2026-02-08T20:48:31.1149729+09:00","created_by":"Matt"}]}
{"id":"DRV-r8g.4","title":"Reorder seed pipeline and wire health generator","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Parts A1, B2, B3)\n\n## Objective\nReorder the seed pipeline in `scripts/seed.ts` so metrics are computed after assignments/shifts, wire in the new health generator, and fix clearData() to include health tables.\n\n## File\n`scripts/seed.ts`\n\n## Implementation\n\n### 1. Fix clearData() (lines 60-98)\nAdd health table deletes after auditLogs, before notifications:\n```typescript\nawait db.delete(auditLogs);\nawait db.delete(driverHealthSnapshots);  // NEW\nawait db.delete(driverHealthState);      // NEW\nawait db.delete(notifications);\n// ... rest unchanged\n```\n\n### 2. Add schema imports (lines 20-34)\nAdd `driverHealthSnapshots` and `driverHealthState` to the schema import block.\nAdd `generateHealth` to the seed module imports.\n\n### 3. Reorder seed() function\n\nCurrent step order:\n1. warehouses, 2. routes, 3. users, 4. preferences, 5. metrics, 6. assignments/shifts, 7. route-completions, 8. bidding, 9. notifications\n\nNew step order:\n1. warehouses, 2. routes, 3. users, 4. preferences, 5. assignments/shifts, 6. route-completions, 7. metrics, 8. health, 9. bidding, 10. notifications\n\nSpecifically:\n- Move the assignments/shifts block (old step 6, lines 271-329) to step 5 (before metrics)\n- Move route-completions (old step 7, lines 331-344) to step 6\n- Update metrics call (old step 5) to step 7, change from `generateMetrics(drivers)` to `generateMetrics(drivers, assignmentData.assignments, assignmentData.shifts)`\n- Update `db.insert(driverMetrics).values()` to include ALL 11 columns:\n  ```typescript\n  avgParcelsDelivered: m.avgParcelsDelivered,\n  totalAssigned: m.totalAssigned,\n  confirmedShifts: m.confirmedShifts,\n  autoDroppedShifts: m.autoDroppedShifts,\n  lateCancellations: m.lateCancellations,\n  noShows: m.noShows,\n  bidPickups: m.bidPickups,\n  ```\n- Add `confirmedAt: a.confirmedAt` to `db.insert(assignments).values()` map (line 284-293)\n\n### 4. Add health step (new step 8)\nAfter metrics insert, add:\n```typescript\nconsole.log('\\n8. Creating health snapshots and state...');\nconst healthData = generateHealth(drivers, assignmentData.assignments, assignmentData.shifts, metricsData);\n\nif (healthData.snapshots.length \u003e 0) {\n    await db.insert(driverHealthSnapshots).values(\n        healthData.snapshots.map((s) =\u003e ({\n            userId: s.userId,\n            evaluatedAt: s.evaluatedAt,\n            score: s.score,\n            attendanceRate: s.attendanceRate,\n            completionRate: s.completionRate,\n            lateCancellationCount30d: s.lateCancellationCount30d,\n            noShowCount30d: s.noShowCount30d,\n            hardStopTriggered: s.hardStopTriggered,\n            reasons: s.reasons\n        }))\n    );\n}\n\nif (healthData.states.length \u003e 0) {\n    await db.insert(driverHealthState).values(\n        healthData.states.map((s) =\u003e ({\n            userId: s.userId,\n            currentScore: s.currentScore,\n            streakWeeks: s.streakWeeks,\n            stars: s.stars,\n            lastQualifiedWeekStart: s.lastQualifiedWeekStart,\n            assignmentPoolEligible: s.assignmentPoolEligible,\n            requiresManagerIntervention: s.requiresManagerIntervention,\n            nextMilestoneStars: s.nextMilestoneStars,\n            updatedAt: getSeedNow()\n        }))\n    );\n}\n\nconsole.log(`   Created ${healthData.snapshots.length} health snapshots`);\nconsole.log(`   Created ${healthData.states.length} health state records`);\n```\n\n### 5. Renumber subsequent steps\nBidding becomes step 9, notifications becomes step 10. Update console.log messages.\n\n## Dependencies\n- DRV-r8g.1 (confirmedAt field exists on GeneratedAssignment)\n- DRV-r8g.2 (rewritten metrics generator with new signature)\n- DRV-r8g.3 (health generator exists)\n\n## Acceptance Criteria\n- `pnpm seed` runs without errors\n- clearData() deletes health tables (no FK constraint errors on re-seed)\n- Metrics are computed after assignments (not before)\n- Health snapshots and states are inserted\n- Console output shows correct step numbers and counts\n- All 11 driverMetrics columns populated in insert\n- `confirmedAt` included in assignments insert\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:47:17.2854574+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:35.882309+09:00","closed_at":"2026-02-08T21:12:35.882309+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.4","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:47:17.2948556+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.4","depends_on_id":"DRV-r8g.1","type":"blocks","created_at":"2026-02-08T20:48:32.6540311+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.4","depends_on_id":"DRV-r8g.2","type":"blocks","created_at":"2026-02-08T20:48:34.4090725+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.4","depends_on_id":"DRV-r8g.3","type":"blocks","created_at":"2026-02-08T20:48:36.3082982+09:00","created_by":"Matt"}]}
{"id":"DRV-r8g.5","title":"Add tier label to HealthCard","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Part C)\n\n## Objective\nAdd a \"Tier I\" or \"Tier II\" label to the HealthCard, displayed above the score value in the section-header row, aligned to flex-end. Tier is derived from stars: stars \u003e= 2 = Tier I, else Tier II.\n\n## Files\n- `src/lib/schemas/health.ts` — add tier to HealthResponse type\n- `src/routes/api/driver-health/+server.ts` — compute tier from stars\n- `src/lib/components/driver/HealthCard.svelte` — display tier label\n- `messages/en.json` — add message key\n\n## Implementation\n\n### 1. HealthResponse type (`src/lib/schemas/health.ts`)\nAdd `tier: 'I' | 'II'` to the HealthResponse type (before `score`):\n```typescript\nexport type HealthResponse = {\n    tier: 'I' | 'II';\n    score: number | null;\n    // ... rest unchanged\n};\n```\n\n### 2. API endpoint (`src/routes/api/driver-health/+server.ts`)\n\nOnboarding response (line 57-80): add `tier: 'II'`\n\nNormal response (line 91-120): add `tier: state.stars \u003e= 2 ? 'I' as const : 'II' as const`\n\nDesign rationale: Tier I (2+ stars) = sustained qualifying-week performance (driver access level). Distinct from bonusEligible (4 stars) which is pay incentive eligibility.\n\n### 3. HealthCard component (`src/lib/components/driver/HealthCard.svelte`)\n\nIn the template, wrap the existing `.score-value` span (lines 123-126) in a new `.score-label-group` div:\n\n```svelte\n\u003cdiv class=\"score-label-group\"\u003e\n    \u003cspan class=\"tier-label\"\u003e{m.dashboard_health_tier_label({ tier: health.tier })}\u003c/span\u003e\n    \u003cspan class=\"score-value\" style:color={scoreColor}\u003e\n        \u003cHealthLine stroke={scoreColor} /\u003e\n        {health.score ?? 0}\n    \u003c/span\u003e\n\u003c/div\u003e\n```\n\nAdd CSS:\n```css\n.score-label-group {\n    display: flex;\n    flex-direction: column;\n    align-items: flex-end;\n    gap: 2px;\n}\n\n.tier-label {\n    font-size: var(--font-size-xs);\n    font-weight: var(--font-weight-medium);\n    color: var(--text-muted);\n    text-transform: uppercase;\n    letter-spacing: var(--letter-spacing-sm);\n}\n```\n\n### 4. Message key (`messages/en.json`)\nAdd:\n```json\n\"dashboard_health_tier_label\": \"Tier {tier}\"\n```\n\n## Dependencies\nNone — this is independent of the seed work (but logically part of the same epic).\n\n## Acceptance Criteria\n- HealthResponse type includes `tier` field\n- API returns `tier: 'I'` for drivers with 2+ stars, `tier: 'II'` otherwise\n- Onboarding state returns `tier: 'II'`\n- HealthCard displays \"TIER I\" or \"TIER II\" above the score value, right-aligned\n- Tier label uses xs/medium/muted/uppercase styling consistent with other section labels\n- TypeScript compiles with no errors (run `pnpm check`)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:47:47.8759759+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:37.0059535+09:00","closed_at":"2026-02-08T21:12:37.0059535+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.5","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:47:47.8854763+09:00","created_by":"Matt"}]}
{"id":"DRV-r8g.6","title":"Reseed and verify via agent-browser","description":"Source: C:\\Users\\matto\\.claude\\plans\\lazy-sniffing-hanrahan.md (Verification)\n\n## Objective\nRun the seed, log in as a seeded driver, and verify via agent-browser that the dashboard shows real health data and tier label.\n\n## Steps\n\n1. Run `pnpm seed` — confirm no errors, check console output for:\n   - Health snapshot count (should be ~80 for dev mode: 10 drivers × ~8 past dates)\n   - Health state count (should equal number of drivers with past assignments)\n   - Metrics show real derived values (not random)\n\n2. Log in as a seeded driver via agent-browser (use /dev-login skill with a @driver.test email)\n\n3. Navigate to `/dashboard` at 390×844 mobile viewport\n\n4. Verify HealthCard:\n   - Shows real score (not \"onboarding\" / null state)\n   - Shows star progression (0-4 stars based on qualifying weeks)\n   - Shows \"Tier I\" or \"Tier II\" label above score\n   - Streak badge shows if applicable\n\n5. Verify metrics section shows real derived values:\n   - Attendance rate matches what's computed from actual assignments\n   - Completion rate matches parcel delivery ratio\n\n6. Screenshot for visual verification\n\n## Dependencies\n- DRV-r8g.4 (pipeline wired and working)\n- DRV-r8g.5 (tier label in HealthCard)\n\n## Acceptance Criteria\n- Seed runs cleanly with no errors\n- Dashboard HealthCard shows populated health data for seeded drivers\n- Tier label visible and correctly styled\n- No onboarding/empty state for drivers with past assignments\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-08T20:48:14.0287713+09:00","created_by":"Matt","updated_at":"2026-02-08T21:12:38.1128329+09:00","closed_at":"2026-02-08T21:12:38.1128329+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-r8g.6","depends_on_id":"DRV-r8g","type":"parent-child","created_at":"2026-02-08T20:48:14.0434877+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.6","depends_on_id":"DRV-r8g.4","type":"blocks","created_at":"2026-02-08T20:48:37.7734336+09:00","created_by":"Matt"},{"issue_id":"DRV-r8g.6","depends_on_id":"DRV-r8g.5","type":"blocks","created_at":"2026-02-08T20:48:40.3216727+09:00","created_by":"Matt"}]}
{"id":"DRV-rjzl","title":"Notification reliability signals too coarse for operational recovery","description":"Push failures collapsed to single push_failed status. Invalid-token remediation deferred by comment rather than enforced. Fanout counters risk overstating success via Map.size usage. Need FCM failure taxonomy, terminal token cleanup, and aggregate counters (attempted, pushSent, pushFailedTransient, pushFailedTerminal, tokensInvalidated). Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.8 audit)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:11:01.9829981+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:17.9392884+09:00","closed_at":"2026-02-18T22:55:17.9392884+09:00","close_reason":"Covered by DRV-vii implementation (PR #168): FCM taxonomy, terminal token cleanup, and aggregate reliability counters added.","labels":["fcm","notifications","observability"],"dependencies":[{"issue_id":"DRV-rjzl","depends_on_id":"DRV-1sft","type":"parent-child","created_at":"2026-02-18T12:47:20.0192065+09:00","created_by":"unknown"}]}
{"id":"DRV-ryjo","title":"Add real-DB NOS-001/NOS-002 scenarios for cutoff and DST boundaries","description":"DRV-b1l.5 Audit Finding #1/#2: The no-show matrix requires NOS-001 through NOS-004 but only NOS-003 exists. Route-specific cutoff and DST boundaries are not fully validated in real-DB end-to-end scenarios. NOS-003 freezes to one post-deadline timestamp and verifies no-show creation, but does not exercise pre/post cutoff transitions. DST/cutoff boundary checks currently exist only in mocked service tests. Add real-DB NOS-001 and NOS-002 scenarios that explicitly assert pre/deadline/post behavior for multiple route start times and both DST spring/fall boundaries with deterministic frozen clocks. Source: logs/nightly/2026-02-18/drv-b1l.5-no-show-and-emergency-reassignment-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:09:10.7097662+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:22.9784903+09:00","closed_at":"2026-02-18T23:17:22.9784903+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","no-show","testing-matrix"],"dependencies":[{"issue_id":"DRV-ryjo","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:43.7529439+09:00","created_by":"unknown"}]}
{"id":"DRV-sea","title":"Audit page routes and layouts","description":"Production readiness audit of all page routes: src/routes/(driver)/ (dashboard, schedule, bids), src/routes/(manager)/ (drivers, routes, warehouses), src/routes/(app)/ (settings, notifications), and all layout files. Review for: loading/error/empty state handling, role-based access (driver vs manager page isolation), layout nesting (auth→app→role-specific guard flow), navigation (sidebar items match routes, active state), mobile layout at 390px without horizontal scroll, offline behavior (OfflineBanner, connectivity handling), store initialization on mount, page transition smoothness, appropriate page titles. Write findings to logs/nightly/2026-02-10/audit-page-routes.md with severity ratings.","notes":"PR: https://github.com/orro3790/drive/pull/85","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:31:06.2658738+09:00","created_by":"Matt","updated_at":"2026-02-10T05:01:21.0328787+09:00","closed_at":"2026-02-10T05:00:35.253747+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":26,"issue_id":"DRV-sea","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/85","created_at":"2026-02-09T20:01:27Z"}]}
{"id":"DRV-si47","title":"DST enforcement mismatch can shift drop timing by +/-1 hour","description":"Confirmation deadlines computed from date arithmetic plus fixed local shift hour. Auto-drop enforcement uses hoursUntilShift threshold logic. DST boundaries (spring forward/fall back) can cause +/-1 hour timing drift for auto-drop and confirmation deadlines. Need unified Toronto-instant deadline model. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.2 audit)","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:08:22.261551+09:00","created_by":"Matt","updated_at":"2026-02-18T16:28:42.4272948+09:00","closed_at":"2026-02-18T16:28:42.4272948+09:00","close_reason":"Unified confirmation and auto-drop deadline calculation to Toronto instant math with DST-safe 48h/7d offsets; added DST boundary tests for lifecycle, confirmation service, and auto-drop cron.","labels":["critical","dst","scheduling"],"dependencies":[{"issue_id":"DRV-si47","depends_on_id":"DRV-szo5","type":"parent-child","created_at":"2026-02-18T12:46:37.1133233+09:00","created_by":"unknown"}]}
{"id":"DRV-sww","title":"Run db:push and create backfill migration","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nApply schema changes to database and backfill existing data for manager assignments.\n\n## Steps\n\n### 1. Run Drizzle push\n```bash\npnpm db:push\n```\n\n### 2. Create and run backfill SQL\n\n#### Backfill routes.managerId\nSet managerId to createdBy ONLY if createdBy is a manager:\n```sql\nUPDATE routes r\nSET manager_id = r.created_by\nWHERE r.manager_id IS NULL\n  AND EXISTS (\n    SELECT 1 FROM \"user\" u \n    WHERE u.id = r.created_by \n    AND u.role = 'manager'\n  );\n```\n\n#### Backfill warehouse_managers\nAuto-assign managers to warehouses they created:\n```sql\nINSERT INTO warehouse_managers (warehouse_id, user_id)\nSELECT w.id, w.created_by\nFROM warehouses w\nINNER JOIN \"user\" u ON u.id = w.created_by AND u.role = 'manager'\nWHERE w.created_by IS NOT NULL\nON CONFLICT (warehouse_id, user_id) DO NOTHING;\n```\n\n### 3. Verify migration\n```sql\n-- Check routes have managers\nSELECT COUNT(*) FROM routes WHERE manager_id IS NOT NULL;\n\n-- Check warehouse_managers populated\nSELECT COUNT(*) FROM warehouse_managers;\n```\n\n## Files to Create (Optional)\nIf using migration files:\n- drizzle/migrations/XXX_manager_scoping_backfill.sql\n\n## Dependencies\n- DRV-4w0 (schema changes)\n- DRV-evm (enum extension)\n\n## Acceptance Criteria\n- [ ] Schema applied successfully\n- [ ] Existing routes have managerId populated where createdBy is manager\n- [ ] warehouse_managers table populated with existing manager-warehouse relationships\n- [ ] No orphaned data or constraint violations","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:23:23.4974353+09:00","created_by":"Matt","updated_at":"2026-02-04T12:34:06.3197683+09:00","closed_at":"2026-02-04T12:34:06.3197683+09:00","close_reason":"Schema pushed successfully. Backfill script ran - no existing data required migration.","dependencies":[{"issue_id":"DRV-sww","depends_on_id":"DRV-4w0","type":"blocks","created_at":"2026-02-04T11:26:01.6772962+09:00","created_by":"Matt"},{"issue_id":"DRV-sww","depends_on_id":"DRV-evm","type":"blocks","created_at":"2026-02-04T11:26:05.9301582+09:00","created_by":"Matt"},{"issue_id":"DRV-sww","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:18.8176766+09:00","created_by":"Matt"}]}
{"id":"DRV-szo5","title":"Nightly 2026-02-18: DST and Timezone Enforcement","description":"Parent epic for DST/timezone enforcement findings from nightly audit 2026-02-18. Critical: confirmation vs auto-drop timing drift during DST transitions.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-18T12:44:45.4930974+09:00","created_by":"Matt","updated_at":"2026-02-18T19:43:07.4853357+09:00","closed_at":"2026-02-18T19:43:07.4853357+09:00","close_reason":"All DST/timezone enforcement child bugs completed, including week-start Toronto date-only fix for bidding and assignment eligibility paths.","labels":["dst","nightly-audit","scheduling","timezone"]}
{"id":"DRV-t19","title":"Update sign-in page forgot password link","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Modify #2)\n\nChange the forgot password button to a link.\n\nFILE TO MODIFY: src/routes/(auth)/sign-in/+page.svelte\n\nCHANGE REQUIRED:\nLines 146-148, change:\n\nFROM:\n\u003cbutton type=\"button\" class=\"forgot-password\"\u003e\n  {m.auth_forgot_password()}\n\u003c/button\u003e\n\nTO:\n\u003ca href=\"/forgot-password\" class=\"forgot-password\"\u003e\n  {m.auth_forgot_password()}\n\u003c/a\u003e\n\nNOTE: The existing .forgot-password CSS class (lines 196-214) already works for both button and anchor elements - no style changes needed.\n\nACCEPTANCE CRITERIA:\n- Button element replaced with anchor element\n- href points to /forgot-password\n- Text and class remain unchanged\n- Styles continue to work (hover underline, accent color)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:15:01.1043007+09:00","created_by":"Matt","updated_at":"2026-02-03T09:25:18.5421606+09:00","closed_at":"2026-02-03T09:25:18.5421606+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-t19","depends_on_id":"DRV-37q","type":"blocks","created_at":"2026-02-03T09:15:38.7377759+09:00","created_by":"Matt"}]}
{"id":"DRV-t3r","title":"Implement shift lifecycle scenarios S1-S6","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Scenarios S1-S6)\n\n## Objective\nImplement the core driver shift lifecycle: confirm, arrive, start, complete, edit (success + expired).\n\n## File to Modify\nscripts/nightly/lifecycle-e2e.test.ts — replace .todo tests with implementations\n\n## Scenarios\n\n### S1: Confirm shift\n- Find scheduled assignment for anchor date where confirmedAt IS NULL\n- If none: prime one (update a future assignment's date to anchor date)\n- Freeze time to 5 days before shift (within 7-day confirmation window)\n- Import src/routes/api/assignments/[id]/confirm/+server.ts\n- Call POST with invokeEndpoint, params: { id: assignmentId }\n- Assert: status 200, response.confirmedAt exists\n- Assert DB: assignments.confirmedAt IS NOT NULL\n- Store assignmentId for subsequent scenarios\n- advanceTimeByMs(1000)\n\n### S2: Arrive\n- Reset freeze to {anchorDate}T13:00:00.000Z (08:00 EST, before 09:00 route start)\n- Import src/routes/api/shifts/arrive/+server.ts\n- Capture driverMetrics.arrivedOnTimeCount before\n- Call POST with body: { assignmentId }\n- Assert: status 200, response.arrivedAt exists\n- Assert DB: shifts row exists with arrivedAt IS NOT NULL\n- Assert DB: assignments.status = 'active'\n- Assert DB: driverMetrics.arrivedOnTimeCount incremented by 1\n- advanceTimeByMs(1000)\n\n### S3: Start (record parcels)\n- Import src/routes/api/shifts/start/+server.ts\n- Call POST with body: { assignmentId, parcelsStart: 150 }\n- Assert: status 200, response.shift.parcelsStart = 150, startedAt exists\n- Assert DB: shifts.parcelsStart = 150, shifts.startedAt IS NOT NULL\n- advanceTimeByMs(1000)\n\n### S4: Complete\n- Import src/routes/api/shifts/complete/+server.ts\n- Capture driverMetrics.highDeliveryCount before\n- Call POST with body: { assignmentId, parcelsReturned: 5, exceptedReturns: 2, exceptionNotes: \"Holiday closures\" }\n- Assert: status 200, parcelsDelivered = 145, editableUntil exists\n- Assert DB: assignments.status = 'completed'\n- Assert DB: shifts.completedAt IS NOT NULL, shifts.editableUntil IS NOT NULL\n- Assert DB: driverMetrics.highDeliveryCount incremented (adjusted rate = (145+2)/150 = 98% \u003e= 95%)\n- advanceTimeByMs(1000)\n\n### S5: Edit (within window)\n- Import src/routes/api/shifts/[assignmentId]/edit/+server.ts\n- Call PATCH with params: { assignmentId }, body: { parcelsReturned: 8, exceptedReturns: 3, exceptionNotes: \"Updated closures\" }\n- Assert: status 200, parcelsDelivered = 142\n- Assert DB: shifts.parcelsReturned = 8, shifts.exceptedReturns = 3\n\n### S6: Edit (expired window)\n- advanceTimeByMs(2 * 60 * 60 * 1000) — 2 hours past editableUntil\n- Call PATCH edit endpoint again with same body\n- Assert: status 400 (edit window expired)\n- Do NOT fail test — this is expected behavior\n\n## Invariants to Record\nEach scenario logs: scenarioId, endpoint, status, assertions passed/failed.\nAdd to report.results array.\n\n## Dependencies\n- DRV-43w (test scaffolding)\n\n## Acceptance Criteria\n- [ ] All 6 scenarios implemented and passing\n- [ ] Each scenario uses advanceTimeByMs(1000) to avoid timestamp collisions\n- [ ] S6 correctly expects 400 status (not a failure)\n- [ ] DB assertions verify actual state changes\n- [ ] Metrics increments verified (arrivedOnTimeCount, highDeliveryCount)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:43:06.7691735+09:00","created_by":"Matt","updated_at":"2026-02-14T20:10:26.4897393+09:00","closed_at":"2026-02-14T20:10:26.4897393+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-t3r","depends_on_id":"DRV-43w","type":"blocks","created_at":"2026-02-14T19:45:19.7865274+09:00","created_by":"Matt"}]}
{"id":"DRV-tko","title":"Add manager alert to bid window escalation","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nUpdate src/lib/server/services/bidding.ts to send route_unfilled alert when bid window closes without winner.\n\n## Changes\n\n### Import sendManagerAlert\n```typescript\nimport { sendManagerAlert } from \"./notifications\";\n```\n\n### Find the bid window resolution function\nLook for resolveBidWindow or closeBidWindow function that handles when a bid window closes.\n\n### Add alert on escalation (no bids or no winner)\nWhen bid window closes and assignment remains unfilled:\n\n```typescript\n// In resolveBidWindow or similar function:\nif (bidCount === 0 || \\!winnerId) {\n  // Assignment remains unfilled - alert manager\n  const [assignment] = await db\n    .select({ \n      routeId: assignments.routeId,\n      date: assignments.date \n    })\n    .from(assignments)\n    .where(eq(assignments.id, assignmentId));\n\n  if (assignment) {\n    const [routeInfo] = await db\n      .select({ name: routes.name })\n      .from(routes)\n      .where(eq(routes.id, assignment.routeId));\n\n    await sendManagerAlert(assignment.routeId, \"route_unfilled\", {\n      routeName: routeInfo?.name,\n      date: assignment.date\n    });\n  }\n  \n  log.info({ assignmentId }, \"Bid window closed unfilled, manager alerted\");\n}\n```\n\n### Handle case where bid window already closed (cron job)\nIn src/routes/api/cron/close-bid-windows/+server.ts, after closing expired windows:\n\n```typescript\n// For each window that closed unfilled\nfor (const window of closedUnfilled) {\n  await sendManagerAlert(routeId, \"route_unfilled\", {\n    routeName: routeInfo?.name,\n    date: assignment.date\n  });\n}\n```\n\n## Files to Modify\n- src/lib/server/services/bidding.ts\n- src/routes/api/cron/close-bid-windows/+server.ts (if separate escalation logic)\n\n## Dependencies\n- DRV-ldy (sendManagerAlert function)\n\n## Acceptance Criteria\n- [ ] Alert sent when bid window closes with no winner\n- [ ] Alert includes route name and date\n- [ ] Alert only sent once per window close\n- [ ] No duplicate alerts on repeated cron runs\n- [ ] Service gracefully handles missing manager","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:25:27.1443988+09:00","created_by":"Matt","updated_at":"2026-02-04T14:27:13.3078405+09:00","closed_at":"2026-02-04T14:27:13.3078405+09:00","dependencies":[{"issue_id":"DRV-tko","depends_on_id":"DRV-ldy","type":"blocks","created_at":"2026-02-04T11:26:58.7700225+09:00","created_by":"Matt"},{"issue_id":"DRV-tko","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:36.2013022+09:00","created_by":"Matt"}]}
{"id":"DRV-tpzr","title":"Add lifecycle tests for non-07:00 route start time boundaries","description":"Tests currently reinforce fixed-hour behavior. Need boundary tests for non-07:00 routes (e.g., 11:00) at deadline - 1s, deadline, and deadline + 1s for both lifecycle service and cancel endpoint. Source: logs/nightly/2026-02-18/drv-xnb.7-late-cancellation-threshold-audit.md Finding #3","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-18T12:09:40.0500371+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:03.1716753+09:00","closed_at":"2026-02-19T19:54:03.1716753+09:00","close_reason":"Closed","labels":["lifecycle","scheduling","testing"]}
{"id":"DRV-uj9","title":"Audit primitive and app-shell components","description":"Production readiness audit of all 12 components in src/lib/components/primitives/ and 4 in src/lib/components/app-shell/. Review for: accessibility (ARIA labels, keyboard navigation, focus management, screen reader), prop typing completeness, design token usage (CSS custom properties from app.css), hardcoded values (magic numbers, inline styles, hardcoded colors), mobile responsiveness at 390px viewport, dark/light theme support, event handling (click, keyboard), edge cases (empty content, long text, disabled/loading states), consistency across similar components. Write findings to logs/nightly/2026-02-10/audit-components-primitives.md with severity ratings.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-10T01:30:48.3726864+09:00","created_by":"Matt","updated_at":"2026-02-10T03:52:35.4493333+09:00","closed_at":"2026-02-10T03:52:35.4493333+09:00","close_reason":"Closed","labels":["nightly"],"comments":[{"id":25,"issue_id":"DRV-uj9","author":"Matt","text":"PR: https://github.com/orro3790/drive/pull/80","created_at":"2026-02-09T18:54:06Z"}]}
{"id":"DRV-uoh","title":"Canonical lifecycle contract and deterministic seed foundation","description":"Centralize assignment lifecycle derivation, remove duplicate API logic, and make seed outputs deterministic for repeatable validation and E2E.","acceptance_criteria":"Lifecycle flags come from one shared contract and deterministic seeded scenarios can be reproduced from fixed inputs.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-07T17:05:04.3379847+09:00","created_by":"Matt","updated_at":"2026-02-07T19:20:31.3671243+09:00","closed_at":"2026-02-07T19:20:31.3671243+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-uoh","depends_on_id":"DRV-dbd","type":"blocks","created_at":"2026-02-07T17:06:30.312687+09:00","created_by":"Matt"}]}
{"id":"DRV-uoh.1","title":"Create shared assignment lifecycle contract module","description":"Add a canonical server lifecycle derivation module with typed input and output and timezone-aware context.","acceptance_criteria":"Contract computes cancelability, confirmability, arrive, start, complete, and confirmation-window fields with boundary tests.","notes":"PR: https://github.com/orro3790/drive/pull/43","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T17:05:27.8491159+09:00","created_by":"Matt","updated_at":"2026-02-07T18:20:02.9065333+09:00","closed_at":"2026-02-07T18:18:47.2477848+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-uoh.1","depends_on_id":"DRV-uoh","type":"parent-child","created_at":"2026-02-07T17:05:27.8514312+09:00","created_by":"Matt"}]}
{"id":"DRV-uoh.2","title":"Migrate dashboard and mine assignments APIs to shared lifecycle contract","description":"Refactor dashboard and assignments mine endpoints to remove duplicate lifecycle logic and use shared contract output.","acceptance_criteria":"Both endpoints emit lifecycle fields from the shared contract without breaking existing store payload shape.","notes":"PR: https://github.com/orro3790/drive/pull/44","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T17:05:28.365545+09:00","created_by":"Matt","updated_at":"2026-02-07T18:52:24.4687023+09:00","closed_at":"2026-02-07T18:51:35.4443091+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-uoh.2","depends_on_id":"DRV-uoh","type":"parent-child","created_at":"2026-02-07T17:05:28.3695427+09:00","created_by":"Matt"},{"issue_id":"DRV-uoh.2","depends_on_id":"DRV-uoh.1","type":"blocks","created_at":"2026-02-07T17:06:39.2868878+09:00","created_by":"Matt"}]}
{"id":"DRV-uoh.3","title":"Align mutation endpoint guards with lifecycle contract rules","description":"Reconcile arrive, start, complete, and cancel endpoint guard logic with canonical lifecycle semantics to prevent read and write drift.","acceptance_criteria":"Mutation endpoints enforce the same lifecycle boundaries represented by read APIs for edge cases and transitions.","notes":"PR: https://github.com/orro3790/drive/pull/46 | Validation: pnpm validate, svelte-check, assignmentLifecycle tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:28.9963838+09:00","created_by":"Matt","updated_at":"2026-02-07T19:21:09.5409463+09:00","closed_at":"2026-02-07T19:20:28.0079669+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-uoh.3","depends_on_id":"DRV-uoh","type":"parent-child","created_at":"2026-02-07T17:05:29.0504531+09:00","created_by":"Matt"},{"issue_id":"DRV-uoh.3","depends_on_id":"DRV-uoh.2","type":"blocks","created_at":"2026-02-07T17:06:40.0517867+09:00","created_by":"Matt"}]}
{"id":"DRV-uoh.4","title":"Add deterministic seed mode with fixed personas and anchor time","description":"Extend seed scripts with fixed seed and anchor-date support plus stable driver personas and scenarios for repeatable E2E.","acceptance_criteria":"Repeated seed runs with the same inputs produce identical personas and scenario states for test flows.","notes":"PR: https://github.com/orro3790/drive/pull/45","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T17:05:29.747412+09:00","created_by":"Matt","updated_at":"2026-02-07T19:02:46.8831556+09:00","closed_at":"2026-02-07T19:02:14.9297967+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-uoh.4","depends_on_id":"DRV-uoh","type":"parent-child","created_at":"2026-02-07T17:05:29.7511967+09:00","created_by":"Matt"}]}
{"id":"DRV-v83","title":"Mobile-first driver verification and defect burn-down","description":"Use agent-browser to systematically verify all driver routes and lifecycle flows on mobile viewport (390x844), discover and fix defects, and document results. Covers: seed data validation, auth preflight, route smoke matrix, shift lifecycle E2E journeys, exploratory testing, and defect triage/fixes.","acceptance_criteria":"All driver routes pass mobile smoke verification. Shift lifecycle happy paths (confirm, arrive, start, complete, edit, cancel, bid) verified E2E. All critical/high defects fixed or tracked as new beads.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-07T17:05:05.5127634+09:00","created_by":"Matt","updated_at":"2026-02-19T19:45:27.1740006+09:00","closed_at":"2026-02-19T19:45:27.1740006+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-v83","depends_on_id":"DRV-dbd","type":"blocks","created_at":"2026-02-07T17:06:31.7733984+09:00","created_by":"Matt"},{"issue_id":"DRV-v83","depends_on_id":"DRV-uoh","type":"blocks","created_at":"2026-02-07T17:06:32.4331367+09:00","created_by":"Matt"},{"issue_id":"DRV-v83","depends_on_id":"DRV-49o","type":"blocks","created_at":"2026-02-07T17:06:33.1170889+09:00","created_by":"Matt"}]}
{"id":"DRV-v83.1","title":"Seed data validation and agent-browser auth preflight","description":"Validate that deterministic seeding produces the shift states needed for downstream verification beads. Confirm driver authentication works via /dev-login with *@driver.test / test1234 credentials. Confirm manager role-guard rejects driver routes (redirects to /?error=access_denied). Verify mobile viewport (390x844) renders /dashboard without errors. Document specific driver emails and assignment IDs for use in v83.2 and v83.3.","acceptance_criteria":"pnpm seed -- --deterministic --seed=42 --anchor-date=\u003ctoday\u003e runs successfully. Driver auth via /dev-login persists across navigation. Manager login correctly redirects away from driver routes. Mobile viewport renders /dashboard without console errors or layout breakage. Specific driver emails and assignment IDs documented for downstream beads.","notes":"Preflight passed. Seed data reference saved in scripts/query-seed-data.cjs. See DRV-v83.1 body for driver/assignment IDs.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:52.8398005+09:00","created_by":"Matt","updated_at":"2026-02-11T19:48:46.749976+09:00","closed_at":"2026-02-11T19:48:46.749976+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-v83.1","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-07T17:05:52.8455661+09:00","created_by":"Matt"}]}
{"id":"DRV-v83.2","title":"Driver route smoke matrix via agent-browser","description":"Run /verify with explicit checklists on every driver-accessible route at mobile viewport (390x844). Routes: /dashboard (shift card, health card, metrics render), /schedule (assignment list renders), /bids (bid windows or empty state), /notifications (inbox renders), /settings (settings page renders), /sign-in (form renders, no auth required), /dashboard as manager (redirects to /?error=access_denied), /dashboard unauthenticated (redirects to /sign-in). Each route checked for: no JS errors, no horizontal scroll, 44px+ touch targets, 16px+ body text, design-token color consistency.","acceptance_criteria":"All driver routes PASS smoke checks or issues are tracked as defects for v83.4. Each route has a documented PASS/FAIL result with screenshot evidence. Auth guard and role guard verified.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:53.497447+09:00","created_by":"Matt","updated_at":"2026-02-13T22:11:01.2939584+09:00","closed_at":"2026-02-13T22:11:01.2939584+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-v83.2","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-07T17:05:53.5038269+09:00","created_by":"Matt"},{"issue_id":"DRV-v83.2","depends_on_id":"DRV-v83.1","type":"blocks","created_at":"2026-02-07T17:06:43.411331+09:00","created_by":"Matt"}],"comments":[{"id":40,"issue_id":"DRV-v83.2","author":"Matt","text":"Mobile smoke matrix complete (390x844). Report: documentation/verification/DRV-v83.2-route-smoke.md with screenshots under documentation/verification/screenshots/DRV-v83.2. Functional route and guard checks pass; logged defects for touch targets (\u003c44px), body text size (~14.224px), and manager redirect expectation drift.","created_at":"2026-02-13T13:10:55Z"}]}
{"id":"DRV-v83.3","title":"Shift lifecycle journey verification via agent-browser","description":"Walk through complete driver flows on mobile viewport (390x844) using agent-browser. Journeys: (1) Confirm — find future unconfirmed assignment, tap Confirm, verify status change. (2) Arrive/Start/Complete/Edit — today's assignment, tap I'm On Site, enter parcels start, tap Delivering, Complete Shift, enter returns, Finish, then Edit within window and modify counts. (3) Cancel — future confirmed assignment, cancel with reason via modal. (4) Bid — navigate to /bids, place bid, verify feedback. (5) Notifications — read notification, mark all read, verify badge update. Edge cases to check: 9 AM arrival deadline, edit window expiry, offline guard messaging.","acceptance_criteria":"All 5 lifecycle journeys verified on mobile viewport. Each journey has documented PASS/FAIL with screenshots. Failures documented as defects for v83.4 with severity and reproduction steps.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:54.2285828+09:00","created_by":"Matt","updated_at":"2026-02-13T23:40:07.166192+09:00","closed_at":"2026-02-13T23:40:07.166192+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-v83.3","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-07T17:05:54.2320996+09:00","created_by":"Matt"},{"issue_id":"DRV-v83.3","depends_on_id":"DRV-v83.1","type":"blocks","created_at":"2026-02-07T17:06:44.1126202+09:00","created_by":"Matt"}],"comments":[{"id":42,"issue_id":"DRV-v83.3","author":"Matt","text":"Lifecycle journeys verified on mobile (390x844). Report: documentation/verification/DRV-v83.3-lifecycle-journeys.md with screenshots in documentation/verification/screenshots/DRV-v83.3. Journeys: confirm, arrive/start/complete/edit, cancel, bid, notifications. Edge cases: 9AM arrival cutoff + edit-window expiry + offline guard.","created_at":"2026-02-13T14:39:46Z"}]}
{"id":"DRV-v83.4","title":"Exploratory pass, defect triage, and fixes","description":"Collect all defects from v83.2 and v83.3. Run exploratory pass covering: theme toggle (dark/light), empty states (no shifts, no bids, no notifications), deep-scroll behavior on long lists, form validation error display, deep-link navigation (direct URL entry), additional viewports (320px and 768px width), and loading/skeleton states. Fix all CRITICAL and HIGH severity defects on branch and re-verify each fix. Track MEDIUM and LOW defects as new beads for future work.","acceptance_criteria":"No BLOCK-severity defects remaining. All CRITICAL and HIGH defects fixed and re-verified, or justified with documented rationale. MEDIUM and LOW defects tracked as new beads. Exploratory pass completed with documented results.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T17:05:54.9298837+09:00","created_by":"Matt","updated_at":"2026-02-19T18:52:38.331026+09:00","closed_at":"2026-02-19T18:52:38.331026+09:00","close_reason":"Touch target fix (44px coarse-pointer on auth toggles, checkbox), font-size comment correction, i18n verified OK, exploratory pass passed at 390x844/320x568/768x1024. Font promotions dropped per owner decision. LOW defects tracked as DRV-v83.5 and DRV-v83.6. Commit 3edf61c.","dependencies":[{"issue_id":"DRV-v83.4","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-07T17:05:54.9419498+09:00","created_by":"Matt"},{"issue_id":"DRV-v83.4","depends_on_id":"DRV-v83.2","type":"blocks","created_at":"2026-02-07T17:06:44.7688958+09:00","created_by":"Matt"},{"issue_id":"DRV-v83.4","depends_on_id":"DRV-v83.3","type":"blocks","created_at":"2026-02-07T17:06:45.4131087+09:00","created_by":"Matt"}],"comments":[{"id":39,"issue_id":"DRV-v83.4","author":"Matt","text":"Defects from DRV-v83.2 smoke pass are ready for triage/fix: HIGH touch targets under 44px, MEDIUM body copy under 16px, LOW manager redirect expectation drift (/routes vs /?error=access_denied). Evidence: documentation/verification/DRV-v83.2-route-smoke.md and screenshots.","created_at":"2026-02-13T13:10:55Z"},{"id":41,"issue_id":"DRV-v83.4","author":"Matt","text":"Additional defects from DRV-v83.3: MEDIUM i18n token renders literally after edit (\"shift_complete_summary_excepted\") — evidence in documentation/verification/screenshots/DRV-v83.3/journey2-after-edit.png. LOW cancellation modal has delayed state settlement (confirm disables then UI updates after noticeable delay).","created_at":"2026-02-13T14:39:44Z"}]}
{"id":"DRV-v83.5","title":"Manager redirect drift: /dashboard as manager redirects to /routes instead of /?error=access_denied","description":"When a manager navigates to /dashboard, the server redirect sends them to /routes. Expected behavior: redirect to /?error=access_denied. Low severity — managers rarely hit this path manually.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-19T18:38:34.6321237+09:00","created_by":"Matt","updated_at":"2026-02-19T18:38:34.6321237+09:00","dependencies":[{"issue_id":"DRV-v83.5","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-19T18:38:34.6389201+09:00","created_by":"unknown"}]}
{"id":"DRV-v83.6","title":"Cancellation modal delayed state: confirm button disables before UI updates","description":"When cancelling a shift, the confirm button disables immediately but the modal takes a noticeable delay before the UI reflects the cancellation result. Low severity — functional but feels sluggish on real devices.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-19T18:38:52.8541851+09:00","created_by":"Matt","updated_at":"2026-02-19T18:38:52.8541851+09:00","dependencies":[{"issue_id":"DRV-v83.6","depends_on_id":"DRV-v83","type":"parent-child","created_at":"2026-02-19T18:38:52.8570621+09:00","created_by":"unknown"}]}
{"id":"DRV-vha","title":"Audit logging service","description":"Source: docs/specs/SPEC.md § Security\nSchema: docs/specs/data-model.md § auditLogs table\n\n## Objective\nImplement centralized audit logging service for tracking all data changes.\n\n## Scope\n- Service function: createAuditLog(params)\n- Parameters:\n  - entityType: 'assignment' | 'user' | 'route' | 'warehouse' | etc.\n  - entityId: UUID of affected entity\n  - action: 'created' | 'updated' | 'assigned' | 'cancelled' | 'flagged' | etc.\n  - actorId: UUID of user who made change (null for system)\n  - actorType: 'user' | 'system'\n  - changes: { before: {...}, after: {...} }\n- Integrate into all mutation endpoints/services\n\n## Spec References\n- docs/specs/SPEC.md: Lines 347-350 (Audit logging requirements)\n- docs/specs/data-model.md: Lines 175-184 (auditLogs table)\n- docs/specs/data-model.md: Line 43 (actorTypeEnum)\n\n## Acceptance Criteria\n- All assignment changes logged (create, cancel, assign, complete)\n- All flag/unflag actions logged\n- All manager overrides logged with manager as actor\n- System actions (cron jobs) logged with actorType='system'\n- Changes include before/after state for updates\n- Logs queryable by entity for debugging\n- High-volume operations (bid scoring) may batch or skip detailed logging\n\n## Technical Constraints\n- Service in src/lib/server/services/audit.ts\n- Use jsonb for changes field\n- Index on entityType, entityId for queries\n- Called from within transaction when possible","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:31:36.3101416+09:00","created_by":"Matt","updated_at":"2026-02-05T20:39:08.032253+09:00","closed_at":"2026-02-05T20:39:08.032253+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-vha","depends_on_id":"DRV-zq5","type":"blocks","created_at":"2026-02-02T21:31:36.3170743+09:00","created_by":"Matt"}]}
{"id":"DRV-vhg","title":"Vercel cron configuration","description":"Source: docs/specs/SPEC.md § Scheduled Jobs\n\n## Objective\nConfigure Vercel Cron schedules in vercel.json for all scheduled jobs.\n\n## Scope\n- Create/update vercel.json with cron configuration\n- Cron jobs:\n  - /api/cron/lock-preferences: Sunday 23:59 Toronto\n  - /api/cron/close-bid-windows: Every minute\n  - /api/cron/performance-check: Daily 02:00 Toronto\n  - /api/cron/shift-reminders: Daily 06:00 Toronto\n- Set up CRON_SECRET environment variable\n- Document timezone handling\n\n## Spec References\n- docs/specs/SPEC.md: Lines 289-296 (Scheduled jobs table)\n- docs/adr/001-tech-stack.md: Lines 56-57 (Vercel Cron rationale)\n\n## Acceptance Criteria\n- vercel.json contains all cron schedules\n- Schedules use correct Vercel cron syntax\n- Toronto timezone handled correctly (Vercel uses UTC)\n- CRON_SECRET configured in Vercel dashboard\n- All cron endpoints verify CRON_SECRET header\n- Documentation of cron schedule calculations\n\n## Technical Constraints\n- Vercel cron uses UTC; convert Toronto times\n- Sunday 23:59 Toronto = Monday 04:59 UTC (EST) or 03:59 UTC (EDT)\n- Consider DST transitions\n- Max 60 second execution time per job","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:32:51.0843917+09:00","created_by":"Matt","updated_at":"2026-02-04T00:26:32.2443083+09:00","closed_at":"2026-02-04T00:26:32.2443083+09:00","labels":["checkpoint"],"dependencies":[{"issue_id":"DRV-vhg","depends_on_id":"DRV-e30","type":"blocks","created_at":"2026-02-02T21:32:51.1033161+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-5eo","type":"blocks","created_at":"2026-02-02T21:32:51.2966019+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-qen","type":"blocks","created_at":"2026-02-02T21:32:51.3062435+09:00","created_by":"Matt"},{"issue_id":"DRV-vhg","depends_on_id":"DRV-n1y","type":"blocks","created_at":"2026-02-02T21:32:51.3631388+09:00","created_by":"Matt"}]}
{"id":"DRV-vii","title":"FCM push failure handling lacks error taxonomy and token cleanup","description":"Push failure handling collapses to generic push_failed with no error taxonomy and no invalid-token remediation. Bulk fanout has limited per-token outcome instrumentation. Source: logs/nightly/2026-02-18/drv-xnb.1 finding #7.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:02:39.3685029+09:00","created_by":"Matt","updated_at":"2026-02-18T20:56:34.4494321+09:00","closed_at":"2026-02-18T20:56:34.4494321+09:00","close_reason":"Implemented FCM failure taxonomy + invalid-token cleanup. PR: https://github.com/orro3790/drive/pull/168","labels":["fcm","notifications","reliability"],"dependencies":[{"issue_id":"DRV-vii","depends_on_id":"DRV-1sft","type":"parent-child","created_at":"2026-02-18T12:47:27.0205323+09:00","created_by":"unknown"}]}
{"id":"DRV-vowj","title":"Add health-specific TENANT-* invariants for multi-tenant isolation","description":"DRV-b1l.4 Audit Finding #4: Health-side effects are org-aware in implementation, but org-boundary assertions are missing in health E2E scenarios. Existing tenant-isolation helper assertions are used in BID/NOS smoke, but health cron sections currently define only HLT-* and IDEMP-HLT-* invariants with no TENANT-* checks. Add health-specific TENANT-* invariants for notifications and state mutations (including negative assertions that org-B users do not receive org-A health side effects). Source: logs/nightly/2026-02-18/drv-b1l.4-health-scoring-and-intervention-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:07:52.8323438+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:22.7835103+09:00","closed_at":"2026-02-18T23:17:22.7835103+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["e2e-testing","health","multi-tenant"],"dependencies":[{"issue_id":"DRV-vowj","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:41.8918827+09:00","created_by":"unknown"}]}
{"id":"DRV-vtee","title":"Late-cancel threshold uses global 07:00 instead of per-route start time","description":"Late-cancel classification is anchored to global 07:00 via dispatchPolicy.shifts.startHourLocal, not per-route startTime. Routes starting after 07:00 can be marked late up to 4 hours early, incorrectly applying cancel_type='late' and downstream health penalties. Source: logs/nightly/2026-02-18/drv-xnb.7-late-cancellation-threshold-audit.md Finding #1","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:08:27.5471916+09:00","created_by":"Matt","updated_at":"2026-02-18T22:55:15.5381285+09:00","closed_at":"2026-02-18T22:55:15.5381285+09:00","close_reason":"Covered by DRV-brh implementation (PR #167): route-specific start time now drives late-cancel boundary.","labels":["business-logic","health","scheduling"],"dependencies":[{"issue_id":"DRV-vtee","depends_on_id":"DRV-5zym","type":"parent-child","created_at":"2026-02-18T12:47:09.5362034+09:00","created_by":"unknown"}]}
{"id":"DRV-vth","title":"Driver bid submission","description":"Source: docs/specs/SPEC.md § Bidding System\nSchema: docs/specs/data-model.md § bids table\n\n## Objective\nImplement ability for drivers to submit bids on open assignments.\n\n## Scope\n- API endpoints:\n  - GET /api/bids/available - List open bid windows for eligible driver\n  - POST /api/bids - Submit bid on an assignment\n  - GET /api/bids/mine - Get driver's pending/past bids\n- UI component for bid submission (in driver dashboard)\n- Validation:\n  - Driver not flagged\n  - Driver under weekly cap for that week\n  - Bid window still open\n  - Driver hasn't already bid on this assignment\n\n## Spec References\n- docs/specs/SPEC.md: Lines 121-127 (Notification/eligibility rules)\n- docs/specs/SPEC.md: Line 146 (Tie-breaking by earliest bid)\n- docs/specs/SPEC.md: Lines 219-226 (Weekly caps)\n- docs/specs/data-model.md: Lines 121-130 (bids table)\n- docs/specs/data-model.md: Lines 316-342 (canDriverBid query)\n\n## Acceptance Criteria\n- Driver can see list of open bid windows they're eligible for\n- Driver can submit bid with single tap/click\n- Bid rejected if driver is flagged\n- Bid rejected if driver already at weekly cap\n- Bid rejected if window is closed\n- Bid rejected if driver already bid on this assignment\n- Bid timestamp recorded for tie-breaking\n- Driver can see their pending bids with countdown to resolution\n\n## Technical Constraints\n- Bid.status starts as 'pending'\n- Bid.windowClosesAt copied from BidWindow.closesAt\n- Weekly cap check must count all non-cancelled assignments for that week\n- Use optimistic UI for bid submission","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:25:58.0639983+09:00","created_by":"Matt","updated_at":"2026-02-03T21:03:51.5279278+09:00","closed_at":"2026-02-03T21:03:51.5279278+09:00","close_reason":"Closed","external_ref":"gh-9","dependencies":[{"issue_id":"DRV-vth","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:25:58.0723411+09:00","created_by":"Matt"}]}
{"id":"DRV-vts5","title":"Add no-show noisy duplicate execution scenario for idempotency","description":"DRV-b1l.5 Audit Finding #4: Idempotency is covered for sequential reruns, but noisy duplicate execution coverage remains shallow. Nightly no-show scenario executes run1/run2 and asserts no duplicate open windows or alerts, but there is no dedicated no-show adversarial/concurrent duplicate-invocation scenario. Add a no-show noisy duplicate execution scenario (back-to-back or near-simultaneous invocations) with invariants for one open window per assignment and no duplicate alerts/fanout. Source: logs/nightly/2026-02-18/drv-b1l.5-no-show-and-emergency-reassignment-e2e-matrix-audit.md","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:09:52.4443762+09:00","created_by":"Matt","updated_at":"2026-02-19T19:54:01.4970493+09:00","closed_at":"2026-02-19T19:54:01.4970493+09:00","close_reason":"Closed","labels":["e2e-testing","idempotency","no-show"]}
{"id":"DRV-w6x","title":"Implement health, flagging, and reinstatement scenarios S9-S11","description":"Source: C:\\Users\\matto\\.claude\\plans\\zesty-questing-moon.md (Scenarios S9-S11)\n\n## Objective\nTest health scoring, driver flagging, and manager reinstatement flows.\n\n## File to Modify\nscripts/nightly/lifecycle-e2e.test.ts\n\n## Scenarios\n\n### S9: Health scoring verification\n- Import src/routes/api/cron/health-daily/+server.ts\n- Invoke health-daily cron (same invokeGet pattern as cron-e2e)\n- Query driverHealthSnapshots where evaluatedAt = anchorDate for the driver from S4\n- Assert: snapshot row exists\n- Assert: currentScore \u003e 0 (driver showed up and completed a shift)\n- Optionally verify breakdown: attendance points should be positive\n\n### S10: Flagging check\n- Pick the unreliable driver persona from seed\n  - Query users with role='driver' where NOT id = testDriverId (used in S1-S6)\n  - Or query driverMetrics for attendanceRate \u003c 80%\n- Import checkAndApplyFlag from src/lib/server/services/flagging.ts\n- Call checkAndApplyFlag(unreliableDriverId, orgAId) directly\n- Assert: result.isFlagged = true\n- Assert: result.warningSent = true (first time flagging)\n- Assert DB: user.isFlagged = true\n- Assert DB: user.flagWarningDate IS NOT NULL\n- Assert DB: notifications table has type='warning' for this driver\n\n### S11: Manager reinstatement\n- Ensure driverHealthState row exists for unreliable driver:\n  ```typescript\n  await db.insert(driverHealthState)\n    .values({\n      userId: unreliableDriverId,\n      currentScore: 40,\n      currentStars: 0,\n      assignmentPoolEligible: false,\n      requiresManagerIntervention: true,\n      hardStopApplied: true,\n      // other required fields\n    })\n    .onConflictDoUpdate({\n      target: driverHealthState.userId,\n      set: {\n        assignmentPoolEligible: false,\n        requiresManagerIntervention: true\n      }\n    });\n  ```\n- Find a manager user in same org:\n  ```typescript\n  const [manager] = await db.select()\n    .from(user)\n    .where(and(\n      eq(user.organizationId, orgAId),\n      eq(user.role, 'manager')\n    ))\n    .limit(1);\n  ```\n- Import src/routes/api/drivers/[id]/+server.ts\n- Call PATCH with createManagerLocals(manager.id, orgAId), params: { id: unreliableDriverId }, body: { reinstate: true }\n- Assert: status 200\n- Assert: response.driver.assignmentPoolEligible = true\n- Assert DB: driverHealthState.assignmentPoolEligible = true\n- Assert DB: driverHealthState.reinstatedAt IS NOT NULL\n- Assert DB: driverHealthState.requiresManagerIntervention = false\n\n## Business Rules Verified\n- Health scoring produces snapshots for active drivers\n- Flagging triggers when attendance drops below threshold\n- Manager can reinstate a hard-stopped driver\n- Reinstatement clears requiresManagerIntervention flag\n\n## Dependencies\n- DRV-09a (cancellation scenarios)\n\n## Acceptance Criteria\n- [ ] S9: Health snapshot exists with score \u003e 0\n- [ ] S10: Unreliable driver correctly flagged\n- [ ] S10: Warning notification created\n- [ ] S11: Manager successfully reinstates driver\n- [ ] S11: All health state flags correctly updated","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-14T19:44:19.4522503+09:00","created_by":"Matt","updated_at":"2026-02-14T20:49:46.8818028+09:00","closed_at":"2026-02-14T20:49:46.8818028+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-w6x","depends_on_id":"DRV-09a","type":"blocks","created_at":"2026-02-14T19:45:31.5070523+09:00","created_by":"Matt"}]}
{"id":"DRV-w84k","title":"Stakeholder-facing coverage docs overstate proven behavior and freshness","description":"Coverage checklist states lock and auto-drop behavior as proven. Scope caveats omit known High notification reliability gaps. Runbook freshness marker remains placeholder. Need Known Gaps (Critical/High) format with dated validation status and direct links to current-night evidence files. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md (references drv-xnb.12 audit)","status":"open","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:12:04.3443239+09:00","created_by":"Matt","updated_at":"2026-02-18T12:12:04.3443239+09:00","labels":["coverage","documentation","testing"],"dependencies":[{"issue_id":"DRV-w84k","depends_on_id":"DRV-b0dc","type":"parent-child","created_at":"2026-02-18T12:48:36.7288716+09:00","created_by":"unknown"}]}
{"id":"DRV-wil","title":"Configure Better Auth sendResetPassword hook","description":"Source: C:\\Users\\matto\\.claude\\plans\\virtual-tickling-robin.md (Files to Modify #1)\n\nAdd password reset email sending to Better Auth config.\n\nFILE TO MODIFY: src/lib/server/auth.ts\n\nCHANGES REQUIRED:\n1. Add import at top:\n   import { sendPasswordResetEmail } from './email';\n\n2. Modify emailAndPassword config object (currently lines 56-58):\n\nFROM:\nemailAndPassword: {\n  enabled: true\n}\n\nTO:\nemailAndPassword: {\n  enabled: true,\n  sendResetPassword: async ({ user, url }) =\u003e {\n    sendPasswordResetEmail(user.email, url).catch(err =\u003e {\n      logger.error({ email: user.email, error: err.message }, 'Password reset email failed');\n    });\n  },\n  resetPasswordTokenExpiresIn: 60 * 60 // 1 hour in seconds\n}\n\nIMPORTANT: \n- Do NOT await sendPasswordResetEmail (prevents timing attacks per Better Auth docs)\n- Use .catch() to log errors without blocking\n- Token expires in 1 hour (configurable via resetPasswordTokenExpiresIn)\n\nACCEPTANCE CRITERIA:\n- sendResetPassword hook configured in emailAndPassword\n- Import statement added for sendPasswordResetEmail\n- Logger import already exists (verify)\n- No await on email sending\n- Token expiry set to 1 hour","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T09:13:59.3538317+09:00","created_by":"Matt","updated_at":"2026-02-03T09:24:43.7714251+09:00","closed_at":"2026-02-03T09:24:43.7714251+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wil","depends_on_id":"DRV-dyz","type":"blocks","created_at":"2026-02-03T09:15:26.4007182+09:00","created_by":"Matt"}]}
{"id":"DRV-wjx","title":"Orchestrator pass/fail ignores report verdict fields","description":"Nightly orchestrator marks success/failure strictly from execSync exit codes. It never reads cron-e2e-report.json, lifecycle-e2e-report.json, or witness-ui-report.json to validate that artifact verdicts match orchestrator statuses. Source: logs/nightly/2026-02-18/drv-xnb.11-nightly-orchestrator-result-report-consistency-audit.md Finding 1","notes":"PR: https://github.com/orro3790/drive/pull/174","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:05:02.8804497+09:00","created_by":"Matt","updated_at":"2026-02-18T22:38:30.9189817+09:00","closed_at":"2026-02-18T22:37:59.2553687+09:00","close_reason":"Closed","labels":["nightly","observability","testing"],"dependencies":[{"issue_id":"DRV-wjx","depends_on_id":"DRV-bjka","type":"parent-child","created_at":"2026-02-18T12:48:04.6499694+09:00","created_by":"unknown"}]}
{"id":"DRV-wq4w","title":"Add NOS-003 bonus assertions for org-specific emergency bonus verification","description":"DRV-b1l.5 Audit Finding #3: Emergency bonus resolution from org dispatch settings is implemented but not proven by real-DB e2e assertions. No-show service reads runtime org bonus and passes it into emergency bid-window creation, but current real-DB no-show tests do not mutate per-org bonus values or assert resulting pay_bonus_percent on created windows. Add real-DB NOS-003 bonus assertions that set different organization_dispatch_settings.emergency_bonus_percent values per org and verify created no-show windows persist the expected pay_bonus_percent. Source: logs/nightly/2026-02-18/drv-b1l.5-no-show-and-emergency-reassignment-e2e-matrix-audit.md","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-18T12:09:30.7676246+09:00","created_by":"Matt","updated_at":"2026-02-18T23:17:23.1676944+09:00","closed_at":"2026-02-18T23:17:23.1676944+09:00","close_reason":"Implemented in PR #176 (https://github.com/orro3790/drive/pull/176): added real-DB SCH-003/SCH-004, HLT-001/002/003, NOS-001/002/003 scenarios plus tenant/idempotency leakage invariants. Local integration execution blocked until DATABASE_URL integration env is configured.","labels":["bidding","e2e-testing","no-show"],"dependencies":[{"issue_id":"DRV-wq4w","depends_on_id":"DRV-lvao","type":"parent-child","created_at":"2026-02-18T12:47:45.9725594+09:00","created_by":"unknown"}]}
{"id":"DRV-wv2","title":"Phase 3: Emergency Routes + 9 AM Auto-Detection","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3)\n\nAutomated no-show detection at 9 AM and emergency route fill with monetary incentive.\n\nConfirmed drivers who don't arrive by 9 AM are auto-detected. Emergency bid windows open with 20% pay bonus. First driver to accept gets the route instantly. Managers can also manually trigger emergency routes.\n\nKey outcomes:\n- Day-of no-shows detected automatically at 9 AM\n- Emergency routes with 20% bonus incentive\n- Notifications sent only to available (non-active) drivers\n- Manager manual override for emergency reopening\n","status":"closed","priority":3,"issue_type":"epic","created_at":"2026-02-06T17:09:28.4498853+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:36.2066885+09:00","closed_at":"2026-02-06T21:24:36.2066885+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2","depends_on_id":"DRV-odx","type":"blocks","created_at":"2026-02-06T17:15:42.6306953+09:00","created_by":"Matt"}]}
{"id":"DRV-wv2.1","title":"No-show detection overhaul: 9 AM + emergency windows","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3 \u003e Automated No-Show Detection)\n\nOverhaul no-show detection to use 9 AM cutoff and create emergency bid windows.\n\n## File: src/lib/server/services/noshow.ts\n\n### Changes:\n\n1. Change DEFAULT_SHIFT_START_HOUR from 7 to 9 (ARRIVAL_DEADLINE_HOUR = 9)\n\n2. Update detectNoShows() query to check for arrivedAt:\n   - Current: checks `isNull(shifts.startedAt)` (no shift started)\n   - New: checks for assignments where date=today, status='scheduled', confirmedAt IS NOT NULL, and either no shift record OR shift exists but arrivedAt IS NULL\n   - This catches: confirmed drivers who didn't press \"I'm On Site\"\n\n3. Change bid window creation to emergency mode:\n   ```typescript\n   await createBidWindow(candidate.assignmentId, {\n     mode: 'emergency',\n     trigger: 'no_show',\n     payBonusPercent: 20,\n     allowPastShift: true\n   });\n   ```\n\n4. Add notifyAvailableDriversForEmergency() call (see emergency notifications bead)\n\n5. Update driver metrics: increment noShows count\n   ```typescript\n   await db.update(driverMetrics)\n     .set({ noShows: sql`no_shows + 1` })\n     .where(eq(driverMetrics.userId, candidate.driverId));\n   ```\n\n## File: src/routes/api/cron/no-show-detection/+server.ts\n\n### Schedule change in vercel.json:\nFrom: `\"0 12 * * *\"` (12:00 UTC)\nTo: `\"0 13,14 * * *\"` (runs at both 13:00 and 14:00 UTC)\n\n### DST handling:\n- 13:00 UTC = 09:00 EDT (summer) — processes\n- 13:00 UTC = 08:00 EST (winter) — handler checks Toronto time, skips (before 9 AM)\n- 14:00 UTC = 10:00 EDT (summer) — idempotent, nothing to process\n- 14:00 UTC = 09:00 EST (winter) — processes\n- Handler must check Toronto time \u003e= 9:00 AM before processing\n\n## Dependencies\n- Phase 2 shift lifecycle (arrivedAt column must exist)\n- Phase 1 bidding overhaul (emergency mode support)\n- Phase 1 schema migration (noShows metric column)\n\n## Acceptance criteria\n- Detection runs at 9 AM Toronto time regardless of DST\n- Confirmed drivers without arrivedAt by 9 AM are detected as no-shows\n- Emergency bid windows created with mode='emergency', payBonusPercent=20\n- Driver noShows metric incremented\n- Manager alerts sent\n- Handler skips if called before 9 AM Toronto time\n- Second daily run is idempotent (no duplicate processing)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:13:56.4668708+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:32.1201192+09:00","closed_at":"2026-02-06T21:24:32.1201192+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2.1","depends_on_id":"DRV-wv2","type":"parent-child","created_at":"2026-02-06T17:13:56.4709695+09:00","created_by":"Matt"},{"issue_id":"DRV-wv2.1","depends_on_id":"DRV-wv2.2","type":"blocks","created_at":"2026-02-06T17:15:39.4242692+09:00","created_by":"Matt"}]}
{"id":"DRV-wv2.2","title":"Emergency notifications: available drivers query","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3 \u003e Available Drivers Query + Notification Template)\n\nImplement the available drivers query and emergency notification template.\n\n## File: src/lib/server/services/notifications.ts\n\n### New function: notifyAvailableDriversForEmergency(params)\n\n```typescript\ninterface EmergencyNotifyParams {\n  assignmentId: string;\n  routeName: string;\n  warehouseName: string;\n  date: string;\n  payBonusPercent: number;\n}\n\nasync function notifyAvailableDriversForEmergency(params: EmergencyNotifyParams): Promise\u003cnumber\u003e\n```\n\n### Available drivers query logic:\n```sql\nSELECT u.id FROM user u\nWHERE u.role = 'driver'\n  AND u.is_flagged = false\n  AND NOT EXISTS (\n    SELECT 1 FROM assignments a\n    WHERE a.user_id = u.id\n      AND a.status = 'active'\n      AND a.date = :today\n  )\n```\nThen filter by weekly cap using canDriverTakeAssignment() for each candidate.\n\n### Send bulk notification:\n- Type: 'emergency_route_available'\n- Title: \"Priority Route Available\"\n- Body: \"{routeName} at {warehouseName} — +{payBonusPercent}% bonus. First to accept gets it.\"\n- Data payload: { assignmentId, routeName, warehouseName, date, payBonusPercent, mode: 'emergency' }\n- Use sendBulkNotifications() for efficiency\n\n### Add notification template:\n```typescript\nemergency_route_available: {\n  title: 'Priority Route Available',\n  body: 'An urgent route needs a driver. Bonus pay available.'\n}\n```\n\n### Add to notification config (src/lib/config/notificationTypes.ts):\n- Icon: Zap or DollarSign (from existing icon set)\n- Accent color: var(--status-success) (green)\n\n## Dependencies\n- Schema migration (notification type enum)\n- Bidding service (emergency mode support)\n\n## Acceptance criteria\n- Query excludes flagged drivers\n- Query excludes drivers on active shifts today\n- Query excludes drivers over weekly cap\n- FCM push notifications sent with high priority\n- In-app notification records created\n- Notification includes bonus percentage and route details\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-06T17:14:08.2045884+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:31.0961913+09:00","closed_at":"2026-02-06T21:24:31.0961913+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2.2","depends_on_id":"DRV-wv2","type":"parent-child","created_at":"2026-02-06T17:14:08.2101044+09:00","created_by":"Matt"}]}
{"id":"DRV-wv2.3","title":"Manager emergency reopen endpoint","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3 \u003e Manager Manual Emergency Trigger)\n\nNew endpoint for managers to manually create emergency bid windows.\n\n## New endpoint: POST /api/assignments/[id]/emergency-reopen\n\nFile: src/routes/api/assignments/[id]/emergency-reopen/+server.ts\n\n### Logic:\n1. Auth: manager only (locals.user.role !== 'driver')\n2. Get assignment, verify it exists\n3. Verify manager has warehouse access:\n   ```typescript\n   const hasAccess = await canManagerAccessWarehouse(locals.user.id, assignment.warehouseId);\n   if (!hasAccess) throw error(403, 'No access to this warehouse');\n   ```\n4. Verify assignment.date = today (emergency is for same-day)\n5. Create emergency bid window:\n   ```typescript\n   const result = await createBidWindow(assignmentId, {\n     mode: 'emergency',\n     trigger: 'manager',\n     payBonusPercent: 20\n   });\n   ```\n6. If original driver exists (userId), increment their noShows metric\n7. Update assignment status to 'unfilled' if not already\n8. Call notifyAvailableDriversForEmergency()\n9. Create audit log\n10. Return json({ success: true, bidWindowId: result.bidWindowId, notifiedCount })\n\n### Use existing service functions:\n- canManagerAccessWarehouse() from src/lib/server/services/managers.ts\n- createBidWindow() from src/lib/server/services/bidding.ts\n- notifyAvailableDriversForEmergency() from notifications.ts\n\n## Dependencies\n- Bidding service overhaul (emergency mode)\n- Emergency notifications function\n\n## Acceptance criteria\n- Only managers can access this endpoint\n- Manager must have warehouse access for the assignment's warehouse\n- Only works for today's assignments\n- Emergency bid window created with mode='emergency', trigger='manager'\n- Available drivers notified\n- Original driver's noShows incremented (if applicable)\n- Audit log created\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:14:18.0503229+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:33.0946176+09:00","closed_at":"2026-02-06T21:24:33.0946176+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2.3","depends_on_id":"DRV-wv2","type":"parent-child","created_at":"2026-02-06T17:14:18.0581606+09:00","created_by":"Matt"},{"issue_id":"DRV-wv2.3","depends_on_id":"DRV-wv2.2","type":"blocks","created_at":"2026-02-06T17:15:40.052296+09:00","created_by":"Matt"}]}
{"id":"DRV-wv2.4","title":"Bids page UI: emergency route card styling","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3 \u003e UI Changes \u003e Bids page)\n\nAdd emergency route card styling to the bids page.\n\n## File: src/routes/(driver)/bids/+page.svelte\n\n### Emergency bid card design:\n\nWhen a bid window has mode='emergency', render a visually distinct card:\n\n1. **Green accent border**: `border: 2px solid var(--status-success)`\n2. **Priority label**: \"Priority Route\" with Zap icon (or lightning bolt from existing icon set)\n3. **Bonus badge**: green pill showing \"+20% Bonus\"\n   - Use Chip component with green variant\n   - Or custom styled span with `background: var(--status-success); color: white;`\n4. **Button text**: \"Accept Route\" instead of \"Place Bid\"\n   - Button variant=\"primary\" or custom green variant\n5. **No countdown timer**: emergency routes are first-come-first-served\n6. **Route details**: route name, warehouse name, date (same as standard cards)\n\n### Handling instant assignment response:\nWhen driver clicks \"Accept Route\" on emergency card:\n- Call bidsStore.placeBid(assignmentId)\n- API returns { status: 'won', bonusPercent: 20 } for instant assignment\n- Show success toast: \"Route assigned! +20% bonus\"\n- Remove card from available bids\n- Update dashboard (driver now has an active assignment)\n\n## File: src/lib/stores/bidsStore.svelte.ts\n\n### Handle instant assignment in placeBid():\n- Current: always creates pending bid\n- New: check response.status\n  - If 'won': toast success, remove from available, add to myBids as won\n  - If 'pending': existing behavior (add to pending)\n\n### Add emergency fields to bid window types:\n- mode: 'competitive' | 'instant' | 'emergency'\n- payBonusPercent: number\n\n## Dependencies\n- Bid placement endpoint (instant mode support)\n- Emergency notifications (available drivers receive notification → land on bids page)\n\n## Acceptance criteria\n- Emergency cards visually distinct (green border, bonus badge, Priority Route label)\n- \"Accept Route\" button (not \"Place Bid\")\n- No countdown timer on emergency cards\n- Clicking Accept assigns route immediately (instant mode)\n- Success toast shows bonus percentage\n- Standard bid cards unchanged\n- Mobile-friendly layout\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T17:14:38.9921049+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:34.0548662+09:00","closed_at":"2026-02-06T21:24:34.0548662+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2.4","depends_on_id":"DRV-wv2","type":"parent-child","created_at":"2026-02-06T17:14:38.9949489+09:00","created_by":"Matt"},{"issue_id":"DRV-wv2.4","depends_on_id":"DRV-wv2.1","type":"blocks","created_at":"2026-02-06T17:15:40.6881379+09:00","created_by":"Matt"}]}
{"id":"DRV-wv2.5","title":"Manager dashboard: emergency reopen button","description":"Source: C:\\Users\\matto\\.claude\\plans\\velvet-swinging-cat.md (Phase 3 \u003e UI Changes \u003e Manager dashboard)\n\nAdd emergency reopen action to the manager dashboard.\n\n## Manager route/assignment management pages\n\nIdentify the correct file(s) — likely in:\n- src/routes/(manager)/routes/+page.svelte (route list)\n- src/routes/(manager)/routes/[id]/+page.svelte (route detail)\n- Or wherever today's assignments are displayed for managers\n\n### Add \"Emergency Reopen\" button:\n- Appears on today's assignments that are unfilled or have a no-show\n- Condition: assignment.date = today AND (assignment.status = 'unfilled' OR no-show detected)\n- Button: variant=\"danger\" or warning style, text = \"Emergency Reopen\"\n- On click: show ConfirmationDialog\n\n### ConfirmationDialog:\n- Use existing ConfirmationDialog component from src/lib/components/ConfirmationDialog.svelte\n- Title: \"Create Emergency Route?\"\n- Body: \"This will notify all available drivers with a 20% bonus offer for {routeName}. The first driver to accept will be assigned immediately.\"\n- Confirm button: \"Send Emergency Notification\"\n- Cancel button: \"Cancel\"\n\n### On confirm:\n- POST /api/assignments/{id}/emergency-reopen\n- Show toast: \"Emergency notification sent to {notifiedCount} drivers\"\n- Update assignment display to show \"Emergency bidding active\"\n\n## Dependencies\n- Manager emergency reopen endpoint\n\n## Acceptance criteria\n- Button only appears on today's unfilled/no-show assignments\n- ConfirmationDialog shown before sending\n- API called on confirm, toast shows driver count\n- Manager with wrong warehouse access cannot see/use the button\n- Button disabled/hidden after emergency window already created\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-06T17:14:49.7776007+09:00","created_by":"Matt","updated_at":"2026-02-06T21:24:35.0433349+09:00","closed_at":"2026-02-06T21:24:35.0433349+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-wv2.5","depends_on_id":"DRV-wv2","type":"parent-child","created_at":"2026-02-06T17:14:49.7836289+09:00","created_by":"Matt"},{"issue_id":"DRV-wv2.5","depends_on_id":"DRV-wv2.3","type":"blocks","created_at":"2026-02-06T17:15:41.3980376+09:00","created_by":"Matt"}]}
{"id":"DRV-x1f4","title":"Signup join authorization non-atomic across reserve/assign/finalize phases","description":"Signup flow spans before hook, DB create hook, and after hook. Join assignment uses reservation context before finalization. Finalize failure records reconciliation without rollback/disable. Revocation permits reserved entries while finalize returns null when status is not reserved. Need atomic reserve-consume-provision with compensating control on finalize failure. Source: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md","notes":"PR: https://github.com/orro3790/drive/pull/162","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-18T12:09:20.5274974+09:00","created_by":"Matt","updated_at":"2026-02-18T19:09:27.9103916+09:00","closed_at":"2026-02-18T19:08:27.5526992+09:00","close_reason":"Closed","labels":["auth","critical","signup"],"dependencies":[{"issue_id":"DRV-x1f4","depends_on_id":"DRV-8lao","type":"parent-child","created_at":"2026-02-18T12:46:50.2813006+09:00","created_by":"unknown"}]}
{"id":"DRV-xf2","title":"Fix: svelte-check errors (NotificationPermissionCard)","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Unblock CI by fixing the TypeScript errors in NotificationPermissionCard.\n\nFiles\n- Update: src/lib/components/driver/NotificationPermissionCard.svelte\n\nImplementation Details\n- Fix Svelte 5 $state inference:\n  - Change to: let permissionStatus = $state\u003cPushPermissionStatus\u003e('unknown');\n  - Avoid literal-only inference that makes comparisons like permissionStatus === 'prompt' impossible.\n- Fix Button size typing:\n  - Replace size=\\\"sm\\\" with size=\\\"small\\\" (allowed: compact|xs|small|standard|large).\n\nAcceptance Criteria\n- pnpm check passes with 0 svelte-check errors.","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-02-15T22:57:20.9840071+09:00","created_by":"Matt","updated_at":"2026-02-15T23:06:06.437029+09:00","closed_at":"2026-02-15T23:06:06.437029+09:00","close_reason":"Closed"}
{"id":"DRV-xgp","title":"Driver schedule view","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Driver App\nSchema: docs/specs/data-model.md § assignments table\n\n## Objective\nImplement the driver's schedule view showing this week, next week, and ability to cancel.\n\n## Scope\n- API endpoints:\n  - GET /api/assignments/mine - Get current user's assignments\n  - POST /api/assignments/[id]/cancel - Cancel an assignment\n- UI page at src/routes/(app)/schedule/+page.svelte\n- Display:\n  - This week's assignments (Week N)\n  - Next week's assignments (Week N+1)\n  - Each assignment shows: date, route name, warehouse, status\n- Actions:\n  - Cancel assignment (with reason selection)\n\n## Spec References\n- docs/specs/SPEC.md: Line 237 (Schedule route description)\n- docs/specs/SPEC.md: Lines 161-181 (Availability \u0026 Confirmation)\n- docs/specs/SPEC.md: Lines 167-173 (Cancellation rules)\n- docs/specs/data-model.md: Lines 92-103 (assignments table)\n- docs/specs/data-model.md: Lines 23-31 (cancelReasonEnum)\n\n## Acceptance Criteria\n- Driver sees all their assignments for current and next week\n- Assignments show date, route, warehouse name, status\n- Driver can cancel any future assignment\n- Cancellation requires selecting a reason from enum\n- Late cancellation (\u003c 48h) shows warning that it affects metrics\n- Cancelled assignment triggers bid window for replacement\n- Assignment status updates to 'cancelled' immediately\n\n## Technical Constraints\n- Toronto timezone for \"today\" calculation\n- Join with routes and warehouses for display\n- Cancellation creates audit log entry\n- Cancellation must trigger bid window creation (call bidding service)","notes":"PR: https://github.com/orro3790/drive/pull/5","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:25:10.7974004+09:00","created_by":"Matt","updated_at":"2026-02-03T14:18:51.0515112+09:00","closed_at":"2026-02-03T14:18:51.0515112+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-xgp","depends_on_id":"DRV-4w6","type":"blocks","created_at":"2026-02-02T21:25:10.8012643+09:00","created_by":"Matt"}]}
{"id":"DRV-xgp.1","title":"Assignments query API for schedule","description":"Add GET /api/assignments/mine with Toronto-time week boundaries and joins for routes/warehouses.","acceptance_criteria":"Returns current and next week assignments with date, route, warehouse, and status.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T13:32:43.4740354+09:00","created_by":"Matt","updated_at":"2026-02-06T09:40:37.5329043+09:00","closed_at":"2026-02-06T09:40:37.5329043+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-xgp.1","depends_on_id":"DRV-xgp","type":"parent-child","created_at":"2026-02-03T13:32:43.4871203+09:00","created_by":"Matt"}]}
{"id":"DRV-xgp.2","title":"Assignment cancellation API with audit and bidding trigger","description":"Add POST /api/assignments/:id/cancel to validate reason, set status, create audit log, and trigger bid window creation.","acceptance_criteria":"Future assignment can be cancelled with enum reason; status set to cancelled; bid window triggered.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T13:32:44.2611119+09:00","created_by":"Matt","updated_at":"2026-02-06T10:55:21.6022892+09:00","closed_at":"2026-02-06T10:55:21.6022892+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-xgp.2","depends_on_id":"DRV-xgp","type":"parent-child","created_at":"2026-02-03T13:32:44.2662221+09:00","created_by":"Matt"}]}
{"id":"DRV-xgp.3","title":"Schedule UI with cancellation flow","description":"Build src/routes/(app)/schedule/+page.svelte with weekly sections and cancel dialog.","acceptance_criteria":"Shows this week and next week assignments; cancel requires reason; late-cancel warning displayed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-03T13:32:44.88857+09:00","created_by":"Matt","updated_at":"2026-02-06T10:54:36.7344594+09:00","closed_at":"2026-02-06T10:54:36.7344594+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-xgp.3","depends_on_id":"DRV-xgp","type":"parent-child","created_at":"2026-02-03T13:32:44.8924072+09:00","created_by":"Matt"}]}
{"id":"DRV-xnb","title":"Nightly audit campaign: unresolved high-risk gaps","description":"Overnight audit-only campaign focused on unresolved Critical/High findings and checklist gaps from recent nightly reports.","acceptance_criteria":"1) Execute 12 audit iterations with evidence. 2) Store reports under logs/nightly/\u003cdate\u003e/. 3) Produce fix-priority summary with Critical/High first. 4) Update checklist/docs for proven coverage and gaps.","status":"closed","priority":2,"issue_type":"epic","assignee":"drive","created_at":"2026-02-18T00:02:16.1418865+09:00","created_by":"Matt","updated_at":"2026-02-18T02:19:54.9217986+09:00","closed_at":"2026-02-18T02:19:54.9217986+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb-nightly-fix-priority-summary-critical-high.md","labels":["audit","nightly"]}
{"id":"DRV-xnb.1","title":"Audit delta re-verification of unresolved Critical/High findings","description":"Re-verify unresolved Critical/High findings from 2026-02-10 nightly audits and mark each fixed/open/regressed with evidence.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:29.9719329+09:00","created_by":"Matt","updated_at":"2026-02-18T01:32:49.9074564+09:00","closed_at":"2026-02-18T01:32:49.9074564+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.1-delta-reverification-critical-high.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.1","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:29.9762051+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.10","title":"Audit store mutation safety and offline guard parity","description":"Verify ensureOnlineForWrite coverage, runtime response validation, and optimistic rollback race safety across stores.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:44.3976736+09:00","created_by":"Matt","updated_at":"2026-02-18T01:41:51.0195999+09:00","closed_at":"2026-02-18T01:41:51.0195999+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.10-store-mutation-safety-and-offline-guard-parity-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.10","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:44.4028154+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.11","title":"Audit nightly orchestrator result/report consistency","description":"Validate that orchestrator pass/fail status aligns with witness and drill report verdicts and exit codes.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:46.0401812+09:00","created_by":"Matt","updated_at":"2026-02-18T01:46:30.3290031+09:00","closed_at":"2026-02-18T01:46:30.3290031+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.11-nightly-orchestrator-result-report-consistency-audit.md","labels":["audit","nightly","project-organization"],"dependencies":[{"issue_id":"DRV-xnb.11","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:46.0467093+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.12","title":"Audit checklist and docs alignment with current coverage","description":"Update nightly checklist docs to reflect proven behavior, known gaps, and current evidence locations.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:47.5382432+09:00","created_by":"Matt","updated_at":"2026-02-18T01:54:27.5946675+09:00","closed_at":"2026-02-18T01:54:27.5946675+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.12-audit-checklist-docs-alignment-with-current-coverage.md","labels":["audit","documentation-health","nightly"],"dependencies":[{"issue_id":"DRV-xnb.12","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:47.5460469+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.2","title":"Audit Toronto timezone and DST invariants in scheduling pipeline","description":"Validate scheduling/confirmations/auto-drop/no-show date math against Toronto-local boundaries including DST transitions.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:31.2404572+09:00","created_by":"Matt","updated_at":"2026-02-18T01:26:27.4224176+09:00","closed_at":"2026-02-18T01:26:27.4224176+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.2-toronto-timezone-and-dst-invariants-in-scheduling-pipeline-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.2","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:31.2444393+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.3","title":"Audit auto-drop transactional integrity and side-effect coupling","description":"Ensure auto-drop penalties, notifications, and audit writes only occur when replacement bid window creation succeeds.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:32.52327+09:00","created_by":"Matt","updated_at":"2026-02-18T01:20:01.2430803+09:00","closed_at":"2026-02-18T01:20:01.2430803+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.3-auto-drop-transactional-integrity-and-side-effect-coupling-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.3","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:32.5265498+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.4","title":"Audit preference lock-cycle enforcement correctness","description":"Verify Sunday lock semantics are enforced for the active cycle and cannot be bypassed after lock.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:33.9280606+09:00","created_by":"Matt","updated_at":"2026-02-18T01:15:58.59723+09:00","closed_at":"2026-02-18T01:15:58.59723+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.4-preference-lock-cycle-enforcement-correctness-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.4","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:33.9342414+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.5","title":"Audit onboarding allowlist TOCTOU and signup atomicity","description":"Evaluate race windows between signup authorization and onboarding consume/revoke paths; verify atomicity guarantees.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:35.41248+09:00","created_by":"Matt","updated_at":"2026-02-18T01:11:45.3026839+09:00","closed_at":"2026-02-18T01:11:45.3026839+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.5-onboarding-allowlist-toctou-and-signup-atomicity-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.5","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:35.4203363+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.6","title":"Audit route PATCH cross-warehouse authorization boundaries","description":"Verify managers cannot move routes to warehouses they do not control via update flows.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:37.2643913+09:00","created_by":"Matt","updated_at":"2026-02-18T01:07:20.8550051+09:00","closed_at":"2026-02-18T01:07:20.8550051+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.6-route-patch-cross-warehouse-authorization-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.6","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:37.2738451+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.7","title":"Audit late-cancellation threshold against true shift start","description":"Confirm late-cancel logic is derived from actual shift start timestamp, not midnight-relative approximations.","status":"closed","priority":1,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:39.3644663+09:00","created_by":"Matt","updated_at":"2026-02-18T01:04:24.2573341+09:00","closed_at":"2026-02-18T01:04:24.2573341+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.7-late-cancellation-threshold-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.7","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:39.369562+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.8","title":"Audit notification reliability and FCM error taxonomy","description":"Review transient vs terminal FCM error handling, invalid-token cleanup, and bulk fanout observability.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:41.0430665+09:00","created_by":"Matt","updated_at":"2026-02-18T01:50:51.355574+09:00","closed_at":"2026-02-18T01:50:51.355574+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.8-notification-reliability-and-fcm-error-taxonomy-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.8","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:41.0497376+09:00","created_by":"unknown"}]}
{"id":"DRV-xnb.9","title":"Audit API input and error-contract consistency","description":"Check malformed JSON handling, UUID path validation, and consistency of API error envelope across endpoints.","status":"closed","priority":2,"issue_type":"task","assignee":"drive","created_at":"2026-02-18T00:02:42.6614454+09:00","created_by":"Matt","updated_at":"2026-02-18T01:37:55.1402954+09:00","closed_at":"2026-02-18T01:37:55.1402954+09:00","close_reason":"Report: logs/nightly/2026-02-18/drv-xnb.9-api-input-and-error-contract-consistency-audit.md","labels":["audit","code-quality","nightly"],"dependencies":[{"issue_id":"DRV-xnb.9","depends_on_id":"DRV-xnb","type":"parent-child","created_at":"2026-02-18T00:02:42.6704001+09:00","created_by":"unknown"}]}
{"id":"DRV-xtb","title":"No-show detection","description":"Source: docs/specs/SPEC.md § Availability \u0026 Confirmation \u003e No-Show Definition\n\n## Objective\nImplement automatic no-show detection when driver doesn't start or cancel by shift time.\n\n## Scope\n- Service function: detectNoShows()\n- Logic: Find assignments where:\n  - date = today\n  - status = 'scheduled' (not started, not cancelled)\n  - shift start time has passed\n  - No shift record exists OR shift.startedAt is null\n- Action on no-show:\n  - Create bid window for replacement\n  - Count against driver's attendance (no explicit marking needed, just absence of shift)\n  - Consider: send manager notification?\n\n## Spec References\n- docs/specs/SPEC.md: Lines 175-181 (No-show definition)\n- docs/specs/SPEC.md: Lines 106-111 (Bid window triggers)\n- docs/specs/SPEC.md: Line 191 (Attendance rate calculation)\n\n## Acceptance Criteria\n- Assignments past start time without shift are detected\n- Bid window created for each no-show\n- Manager notified of no-shows (urgent_unfilled)\n- No-show affects attendance rate (absence of completedShift)\n- Detection can run multiple times without duplicate actions\n- Handles edge case: driver starts shift late (check startedAt exists)\n\n## Technical Constraints\n- Could be cron job OR triggered by bid window cron checking for stale assignments\n- \"Shift start time\" = assignment.date at some default hour (e.g., 07:00 Toronto)\n- Or: assignment doesn't have explicit time, just date — define cutoff (e.g., noon?)\n- Service in src/lib/server/services/noshow.ts\n\nNote: Spec doesn't define exact shift start time. May need to add default or make configurable.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-02T21:30:55.9918667+09:00","created_by":"Matt","updated_at":"2026-02-05T14:41:01.6801978+09:00","closed_at":"2026-02-05T14:41:01.6801978+09:00","close_reason":"Closed","labels":["autonomous"],"dependencies":[{"issue_id":"DRV-xtb","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:30:55.9990626+09:00","created_by":"Matt"},{"issue_id":"DRV-xtb","depends_on_id":"DRV-65d","type":"blocks","created_at":"2026-02-02T21:30:56.0505827+09:00","created_by":"Matt"}]}
{"id":"DRV-y5b0","title":"Route PATCH: normalize inaccessible-route response to prevent ID enumeration","description":"Handler fetches route by ID before access checks and returns 403 for inaccessible routes instead of uniform 404, which can leak that a route ID exists to unauthorized managers. Source: logs/nightly/2026-02-18/drv-xnb.6-route-patch-cross-warehouse-authorization-audit.md Finding #6","status":"open","priority":2,"issue_type":"bug","created_at":"2026-02-18T12:07:57.1580487+09:00","created_by":"Matt","updated_at":"2026-02-18T12:07:57.1580487+09:00","labels":["info-disclosure","routes","security"]}
{"id":"DRV-yn6","title":"Scope warehouses API by manager access","description":"Source: User-provided plan (DRV-ddq: Manager-to-Route Assignment and Alert Scoping)\n\n## Objective\nUpdate src/routes/api/warehouses/+server.ts to filter warehouses by manager access.\n\n## Changes to GET /api/warehouses\n\n### Import manager service\n```typescript\nimport { getManagerWarehouseIds } from \"$lib/server/services/managers\";\n```\n\n### Filter by accessible warehouses\n```typescript\nconst accessibleWarehouses = await getManagerWarehouseIds(locals.user.id);\n\nif (accessibleWarehouses.length === 0) {\n  return json({ warehouses: [] });\n}\n\nconst warehouseList = await db\n  .select({\n    id: warehouses.id,\n    name: warehouses.name,\n    address: warehouses.address,\n    createdBy: warehouses.createdBy,\n    createdAt: warehouses.createdAt,\n    updatedAt: warehouses.updatedAt,\n    routeCount: count(routes.id)\n  })\n  .from(warehouses)\n  .leftJoin(routes, eq(routes.warehouseId, warehouses.id))\n  .where(inArray(warehouses.id, accessibleWarehouses))\n  .groupBy(warehouses.id)\n  .orderBy(warehouses.name);\n```\n\n### Add inArray import\n```typescript\nimport { eq, count, inArray } from \"drizzle-orm\";\n```\n\n## Changes to POST /api/warehouses\n\n### Auto-assign creator to warehouse_managers\nAfter creating warehouse, add creator to warehouse_managers:\n```typescript\nconst [created] = await db\n  .insert(warehouses)\n  .values({\n    name,\n    address,\n    createdBy: locals.user.id\n  })\n  .returning();\n\n// Auto-assign creator as warehouse manager\nawait db.insert(warehouseManagers).values({\n  warehouseId: created.id,\n  userId: locals.user.id\n});\n```\n\n### Import warehouseManagers\n```typescript\nimport { warehouses, auditLogs, routes, warehouseManagers } from \"$lib/server/db/schema\";\n```\n\n## Files to Modify\n- src/routes/api/warehouses/+server.ts\n\n## Dependencies\n- DRV-4jy (manager access service)\n- DRV-sww (warehouse_managers table exists)\n\n## Acceptance Criteria\n- [ ] GET only returns warehouses manager has access to\n- [ ] GET returns empty array if no access\n- [ ] POST auto-assigns creator to warehouse_managers\n- [ ] New warehouses immediately visible to creator","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-04T11:24:36.9716797+09:00","created_by":"Matt","updated_at":"2026-02-04T14:24:07.4035163+09:00","closed_at":"2026-02-04T14:24:07.4035163+09:00","dependencies":[{"issue_id":"DRV-yn6","depends_on_id":"DRV-4jy","type":"blocks","created_at":"2026-02-04T11:26:39.5019297+09:00","created_by":"Matt"},{"issue_id":"DRV-yn6","depends_on_id":"DRV-sww","type":"blocks","created_at":"2026-02-04T11:26:42.706464+09:00","created_by":"Matt"},{"issue_id":"DRV-yn6","depends_on_id":"DRV-ddq","type":"parent-child","created_at":"2026-02-04T11:28:28.3435473+09:00","created_by":"Matt"}]}
{"id":"DRV-zbr","title":"CI: Versioned APK asset + verify embedded version","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Ensure GitHub Releases always contains a deterministic, versioned APK filename and that the APK embedded versionName/versionCode match the release tag/versionCode.\n\nFiles\n- Update: .github/workflows/release-please.yml\n- Update: .github/workflows/android-release.yml\n\nImplementation Details\n- Produce a versioned APK filename automatically (no manual renaming):\n  - drive-v${VERSION_NAME}.apk\n- Upload the versioned APK to the GitHub Release (keep app-release.apk if desired, but versioned should exist).\n- Add a workflow gate after building the APK:\n  - Locate aapt:\n    - Prefer $ANDROID_HOME/build-tools/\u003cversion\u003e/aapt (or install build-tools).\n  - Run: aapt dump badging \u003capk\u003e\n  - Assert embedded values:\n    - versionName == VERSION_NAME\n    - versionCode == VERSION_CODE\n  - Fail the workflow if mismatch.\n\nAcceptance Criteria\n- Latest release assets include drive-vX.Y.Z.apk.\n- Workflow fails if APK metadata does not match tag-derived version.","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-02-15T22:57:30.679896+09:00","created_by":"Matt","updated_at":"2026-02-15T23:20:14.7789767+09:00","closed_at":"2026-02-15T23:20:14.7789767+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-zbr","depends_on_id":"DRV-jwl","type":"blocks","created_at":"2026-02-15T22:58:06.6554751+09:00","created_by":"unknown"}]}
{"id":"DRV-zlc","title":"Test: GitHub release resolver parsing/selection","description":"Source: ralph/plans/MOB-android-update-pipeline.md\n\nObjective\n- Add unit tests for tag parsing, versionCode computation, and deterministic APK asset selection.\n\nFiles\n- Add: tests for src/lib/server/githubRelease.ts (location per repo conventions; example: src/lib/server/githubRelease.test.ts)\n\nTest Cases\n- Tag parsing:\n  - v1.2.3 -\u003e versionName 1.2.3, versionCode 10203\n  - 1.2.3 -\u003e versionName 1.2.3, versionCode 10203\n  - v1.2.3-alpha.1 -\u003e rejected/throws (stable-only policy)\n- Asset selection:\n  - Multiple .apk assets selects universal first; then drive-v*; then app-release.apk; else lexicographic\n  - No .apk assets -\u003e throws\n- Error fallback:\n  - When lastKnownGood exists, returns cached payload on fetch failure\n\nAcceptance Criteria\n- pnpm test passes.\n- Tests cover the policy encoded in ralph/plans/MOB-android-update-pipeline.md.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-15T22:57:48.9478318+09:00","created_by":"Matt","updated_at":"2026-02-15T23:18:18.5172029+09:00","closed_at":"2026-02-15T23:18:18.5172029+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-zlc","depends_on_id":"DRV-69n","type":"blocks","created_at":"2026-02-15T22:58:05.138579+09:00","created_by":"unknown"}]}
{"id":"DRV-zq5","title":"Database schema migration","description":"Source: docs/specs/data-model.md (Full schema)\nSpec: docs/specs/SPEC.md § Core Concepts \u003e Entities\n\n## Objective\nCreate the initial database migration with all tables, enums, relations, and indexes defined in data-model.md.\n\n## Scope\nImplement the complete Drizzle schema in src/lib/server/db/schema.ts:\n- 9 enums: userRoleEnum, assignmentStatusEnum, assignedByEnum, bidStatusEnum, bidWindowStatusEnum, cancelReasonEnum, notificationTypeEnum, actorTypeEnum\n- 11 tables: users, warehouses, routes, driverPreferences, assignments, shifts, bids, bidWindows, driverMetrics, routeCompletions, notifications, auditLogs\n- All relations defined in usersRelations, routesRelations, warehousesRelations, assignmentsRelations\n- 8 performance-critical indexes (see data-model.md lines 349-359)\n\n## Spec References\n- docs/specs/data-model.md: Lines 9-239 (complete schema definition)\n- docs/specs/data-model.md: Lines 349-359 (indexes)\n- docs/specs/SPEC.md: Lines 43-57 (entity descriptions)\n\n## Acceptance Criteria\n- All enums created and exported\n- All tables created with correct column types, constraints, defaults\n- All relations defined for query builder support\n- drizzle-kit generate produces clean migration\n- drizzle-kit push succeeds against Neon database\n- No TypeScript errors in schema file\n\n## Technical Constraints\n- Use uuid for all primary keys with defaultRandom()\n- All timestamps must include { withTimezone: true }\n- Use real (not decimal) for rate fields (0-1 range)\n- Arrays use .array() syntax for preferredDays and preferredRoutes","status":"closed","priority":0,"issue_type":"task","assignee":"drive","created_at":"2026-02-02T21:22:12.3925658+09:00","created_by":"Matt","updated_at":"2026-02-02T22:20:29.1743728+09:00","closed_at":"2026-02-02T22:20:29.1743728+09:00"}
{"id":"DRV-zxp","title":"Manager routes overview dashboard","description":"Source: docs/specs/SPEC.md § User Interfaces \u003e Manager Dashboard\n\n## Objective\nImplement the manager's main dashboard showing route coverage status with filtering.\n\n## Scope\n- UI page at src/routes/(manager)/+page.svelte (redirects to routes overview)\n- DataTable displaying all routes with:\n  - Route name, warehouse name\n  - Today's assignment status (assigned/unfilled/bidding)\n  - Assigned driver name (if any)\n  - Bid window status (if bidding)\n- Filters: warehouse, status, date picker\n- Row click: open side panel with details\n\n## Spec References\n- docs/specs/SPEC.md: Line 245 (Manager routes overview)\n- docs/specs/SPEC.md: Lines 253-260 (Manager capabilities)\n- docs/agent-guidelines.md: § TanStack Table patterns\n\n## Acceptance Criteria\n- All routes displayed with current day's assignment status\n- Filter by warehouse (dropdown)\n- Filter by status: all, assigned, unfilled, bidding\n- Filter by date (date picker, default today)\n- Table sortable by route name, warehouse, status\n- Row click shows assignment details in side panel\n- Real-time updates via SSE (separate bead)\n\n## Technical Constraints\n- Join routes, assignments, warehouses, users for display\n- Use DataTable component with column helpers\n- Side panel uses Drawer component\n- Default date = today (Toronto timezone)","notes":"PR: https://github.com/orro3790/drive/pull/11","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-02T21:29:54.6926101+09:00","created_by":"Matt","updated_at":"2026-02-03T22:05:41.6451631+09:00","closed_at":"2026-02-03T22:05:41.6451631+09:00","close_reason":"Closed","dependencies":[{"issue_id":"DRV-zxp","depends_on_id":"DRV-b9t","type":"blocks","created_at":"2026-02-02T21:29:54.6977807+09:00","created_by":"Matt"},{"issue_id":"DRV-zxp","depends_on_id":"DRV-obx","type":"blocks","created_at":"2026-02-02T21:29:54.703247+09:00","created_by":"Matt"}]}

name: ci

on:
  pull_request:
  merge_group:
  push:
    branches:
      - main

jobs:
  branch_policy:
    name: branch-policy
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Enforce develop-only merges to main
        run: |
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "::error::PRs to main must come from develop. Retarget this PR to develop with: gh pr edit ${{ github.event.number }} --base develop"
            exit 1
          fi

  lint:
    name: lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      BETTER_AUTH_SECRET: test-better-auth-secret
      FIREBASE_PROJECT_ID: test-project
      FIREBASE_CLIENT_EMAIL: test@example.com
      FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\\nTEST\\n-----END PRIVATE KEY-----\\n"
      CRON_SECRET: test-cron-secret

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate i18n artifacts for typecheck
        run: pnpm exec paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --emit-ts-declarations

      - name: Run typecheck
        run: pnpm check

  unit:
    name: unit
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      BETTER_AUTH_SECRET: test-better-auth-secret
      FIREBASE_PROJECT_ID: test-project
      FIREBASE_CLIENT_EMAIL: test@example.com
      FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\\nTEST\\n-----END PRIVATE KEY-----\\n"
      CRON_SECRET: test-cron-secret

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate i18n artifacts for tests
        run: pnpm exec paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --emit-ts-declarations

      - name: Run unit tests
        run: pnpm test

  e2e_smoke:
    name: e2e-smoke
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/drive_e2e
      BETTER_AUTH_SECRET: test-better-auth-secret
      CRON_SECRET: test-cron-secret
      FIREBASE_PROJECT_ID: test-project
      FIREBASE_CLIENT_EMAIL: test@example.com
      FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\\nTEST\\n-----END PRIVATE KEY-----\\n"

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: drive_e2e
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d drive_e2e"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate i18n artifacts for tests
        run: pnpm exec paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --emit-ts-declarations

      - name: Wait for Postgres
        run: |
          node - <<'NODE'
          const { Client } = require('pg');
          const url = process.env.DATABASE_URL;
          const deadline = Date.now() + 60_000;

          if (!url) {
            throw new Error('DATABASE_URL is required');
          }

          async function sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          }

          (async () => {
            let lastError;
            while (Date.now() < deadline) {
              try {
                const client = new Client({ connectionString: url });
                await client.connect();
                await client.query('select 1 as ok;');
                await client.end();
                console.log('Postgres is ready');
                return;
              } catch (error) {
                lastError = error;
                await sleep(1_000);
              }
            }

            console.error('Postgres did not become ready in time');
            throw lastError ?? new Error('Postgres not ready');
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

      - name: Apply schema for e2e database
        run: pnpm db:push

      - name: Ensure auth rate-limit table exists
        run: |
          node - <<'NODE'
          const { Client } = require('pg');

          (async () => {
            const client = new Client({ connectionString: process.env.DATABASE_URL });
            await client.connect();
            await client.query(`
              CREATE TABLE IF NOT EXISTS rate_limit (
                id text PRIMARY KEY,
                key text NOT NULL UNIQUE,
                count integer NOT NULL,
                last_request bigint NOT NULL
              );
            `);
            await client.end();
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Playwright UI smoke
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p logs/ci/e2e-smoke
          pnpm exec playwright test --grep @smoke --workers=1 2>&1 | tee logs/ci/e2e-smoke/playwright.log

      - name: Upload smoke artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-artifacts
          path: |
            logs/ci/e2e-smoke/**
            playwright-report/**
            test-results/**
          if-no-files-found: ignore
          retention-days: 14

  build:
    name: build
    runs-on: ubuntu-latest
    env:
      BETTER_AUTH_SECRET: test-better-auth-secret
      CRON_SECRET: test-cron-secret
      FIREBASE_PROJECT_ID: test-project
      FIREBASE_CLIENT_EMAIL: test@example.com
      FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\\nTEST\\n-----END PRIVATE KEY-----\\n"
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      BETTER_AUTH_TRUSTED_ORIGINS: https://example.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate i18n artifacts for build
        run: pnpm exec paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --emit-ts-declarations

      - name: Run build
        run: pnpm build

  integration_smoke:
    name: integration-smoke (non-blocking)
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    continue-on-error: true
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/drive_integration
      BETTER_AUTH_SECRET: test-better-auth-secret
      CRON_SECRET: test-cron-secret
      FIREBASE_PROJECT_ID: test-project
      FIREBASE_CLIENT_EMAIL: test@example.com
      FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\\nTEST\\n-----END PRIVATE KEY-----\\n"

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: drive_integration
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d drive_integration"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate i18n artifacts for tests
        run: pnpm exec paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --emit-ts-declarations

      - name: Wait for Postgres
        run: |
          node - <<'NODE'
          const { Client } = require('pg');
          const url = process.env.DATABASE_URL;
          const deadline = Date.now() + 60_000;

          if (!url) {
            throw new Error('DATABASE_URL is required');
          }

          async function sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          }

          (async () => {
            let lastError;
            while (Date.now() < deadline) {
              try {
                const client = new Client({ connectionString: url });
                await client.connect();
                await client.query('select 1 as ok;');
                await client.end();
                console.log('Postgres is ready');
                return;
              } catch (error) {
                lastError = error;
                await sleep(1_000);
              }
            }

            console.error('Postgres did not become ready in time');
            throw lastError ?? new Error('Postgres not ready');
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

      - name: Run integration smoke
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p logs/ci/integration-smoke tests/integration/.evidence
          pnpm test:integration:smoke 2>&1 | tee logs/ci/integration-smoke/vitest.log

      - name: Upload smoke artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-smoke-artifacts
          path: |
            logs/ci/integration-smoke/**
            tests/integration/.evidence/**
          if-no-files-found: ignore
          retention-days: 14
